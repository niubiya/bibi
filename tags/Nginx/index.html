<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Tag: Nginx
  
</title>

<meta name="description" content="Testing website">
<meta property="og:type" content="website">
<meta property="og:title" content="bibi">
<meta property="og:url" content="http://yxbibi.com/tags/Nginx/index.html">
<meta property="og:site_name" content="bibi">
<meta property="og:description" content="Testing website">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="bibi">
<meta name="twitter:description" content="Testing website">


  <link rel="alternative" href="/atom.xml" title="bibi" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">






</head>
<body class="monochrome">
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">bibi</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">bibi</a></h1>
    
    <div class="info">
      <div class="content">
        
          <div class="description">Testing website</div>
        
        
          <div class="author">Mode</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://cn.gravatar.com/avatar/35fef74d731255cd569c2c2b0b9e87e4?s=200"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">Category</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openresty/">Openresty</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zabbix/">Zabbix</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/centos/">centos</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/centos7/">centos7</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rsync/">rsync</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/text/">text</a><span class="category-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS服务器搭建/">DNS服务器搭建</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELK/">ELK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EMQ/">EMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Filebeat/">Filebeat</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JumpServer/">JumpServer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KONG/">KONG</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LVM/">LVM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memcached/">Memcached</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openresty/">Openresty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PXE-Kickstart-Cobbler/">PXE+Kickstart+Cobbler</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis3/">Redis3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rsync-inotify/">Rsync+inotify</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/">Zabbix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/app-install/">app install</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bibi/">bibi</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos7/">centos7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ftp虚拟用户创建过程/">ftp虚拟用户创建过程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hello/">hello</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lvm/">lvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rsync/">rsync</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">Archive</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">30</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/niubiya/bibi" title="bibi" target="_blank" rel="noopener">bibi</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/niubiya" title="niubiya" target="_blank" rel="noopener">niubiya</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          <h1>Nginx</h1>


  
  
    <div class="post-list">
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/08/Nginx调优/">
  Nginx
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/08/Nginx调优/"><span class="article-date">
  2019-08-08
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/Nginx/">Nginx</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="Nginx调优"><a href="#Nginx调优" class="headerlink" title="Nginx调优"></a>Nginx调优</h1><h2 id="一、Nginx调优选项参数"><a href="#一、Nginx调优选项参数" class="headerlink" title="一、Nginx调优选项参数"></a>一、Nginx调优选项参数</h2><h3 id="1-worker-processes"><a href="#1-worker-processes" class="headerlink" title="1.worker_processes"></a>1.worker_processes</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 8;</span><br><span class="line">nginx进程数，建议按照cpu数目来指定，一般跟cpu核数相同或为它的倍</span><br><span class="line">数。</span><br></pre></td></tr></table></figure>

<h3 id="2-worker-cpu-affinity"><a href="#2-worker-cpu-affinity" class="headerlink" title="2.worker_cpu_affinity"></a>2.worker_cpu_affinity</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000</span><br><span class="line">00010000 00100000 01000000 10000000;</span><br><span class="line">为每个进程分配cpu，上例中将8个进程分配到8个cpu，当然可以写多个，或</span><br><span class="line">者将一个进程分配到多个cpu。</span><br></pre></td></tr></table></figure>

<h3 id="3-worker-rlimit-nofile"><a href="#3-worker-rlimit-nofile" class="headerlink" title="3.worker_rlimit_nofile"></a>3.worker_rlimit_nofile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile 65535</span><br><span class="line">下面这个指令是指当一个nginx进程打开的最多文件描述符数目，理论值应该</span><br><span class="line">是系统的最多打开文件数（ulimit -n）与nginx进程数相除，但是nginx</span><br><span class="line">分配请求并不是那么均匀，所以最好与ulimit -n的值保持一致。</span><br></pre></td></tr></table></figure>

<h3 id="4-use-epoll"><a href="#4-use-epoll" class="headerlink" title="4.use epoll;"></a>4.use epoll;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use epoll;</span><br><span class="line">使用epoll的I/O模型，用这个模型来高效处理异步事件</span><br></pre></td></tr></table></figure>

<h3 id="5-accept-mutex"><a href="#5-accept-mutex" class="headerlink" title="5.accept_mutex"></a>5.accept_mutex</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">accept_mutex on;</span><br><span class="line">优化同一时刻只有一个请求而避免多个睡眠进程被唤醒的设置，on为防止被</span><br><span class="line">同时唤醒，默认为off，因此nginx刚安装完以后要进行适当的优化。</span><br></pre></td></tr></table></figure>

<h3 id="6-multi-accept"><a href="#6-multi-accept" class="headerlink" title="6.multi_accept"></a>6.multi_accept</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multi_accept on;</span><br><span class="line">打开同时接受多个新网络连接请求的功能。</span><br></pre></td></tr></table></figure>

<h3 id="7-server-tokens"><a href="#7-server-tokens" class="headerlink" title="7.server_tokens"></a>7.server_tokens</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server_tokens off;</span><br><span class="line">在http 模块当中配置</span><br></pre></td></tr></table></figure>

<h3 id="8-worker-connections"><a href="#8-worker-connections" class="headerlink" title="8.worker_connections"></a>8.worker_connections</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">worker_connections 65535;</span><br><span class="line">每个进程允许的最多连接数，理论上每台nginx服务器的最大连接数为</span><br><span class="line">worker_processes*worker_connections。</span><br></pre></td></tr></table></figure>

<h3 id="9-keepalive-timeout"><a href="#9-keepalive-timeout" class="headerlink" title="9.keepalive_timeout"></a>9.keepalive_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout 60;</span><br><span class="line">http连接超时时间，默认是60s，功能是使客户端到服务器端的连接在设定</span><br><span class="line">的时间内持续有效，当出现对服务器的后继请求时，该功能避免了建立或者重</span><br><span class="line">新建立连接。切记这个参数也不能设置过大！否则会导致许多无效的http连</span><br><span class="line">接占据着nginx的连接数，终nginx崩溃！</span><br><span class="line">keepalive_timeout 65 70;</span><br><span class="line">这是前端keepalive_timeout的一个延伸配置，前面65是告诉客户端我给</span><br><span class="line">你保持多久，后面一个是多久我就给断开连接了。</span><br></pre></td></tr></table></figure>

<h3 id="10-client-header-timeout"><a href="#10-client-header-timeout" class="headerlink" title="10.client_header_timeout"></a>10.client_header_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client_header_timeout 10s</span><br></pre></td></tr></table></figure>

<h3 id="11-client-header-timeout"><a href="#11-client-header-timeout" class="headerlink" title="11.client_header_timeout"></a>11.client_header_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_timeout 10s;</span><br><span class="line">都跟请求相关，就一起理解了说了，这两个参数是对请求头和请求体（想了解</span><br><span class="line">请求头和请求体的概念自己百度）的超时时间，就是从三次握手到第一次读取</span><br><span class="line">请求头和请求体失败的时间。比如当前服务器负载大、网络卡，恰好在第一次</span><br><span class="line">读取请求头或请求提时没有得到且时间超过10s了，tengine就会超时报错，</span><br><span class="line">对于我当前应用而言，60s显而是太长了，优化到10s。</span><br><span class="line">client_body_timeout 10s;</span><br></pre></td></tr></table></figure>

<h3 id="12-proxy-connect-timeout"><a href="#12-proxy-connect-timeout" class="headerlink" title="12.proxy_connect_timeout"></a>12.proxy_connect_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">在收到请求头后，会将请求转发到upstream里面的server，这个呢就是与</span><br><span class="line">对应的server连接的超时时间，设置时最大值不能超过75s，我这里的</span><br><span class="line">server和tengine是放在同一个交换机上的内网，所以将连接时间优化到</span><br><span class="line">10s，超过10s连接不上，说明业务有问题了。</span><br><span class="line">proxy_connect_timeout 10s</span><br></pre></td></tr></table></figure>

<h3 id="13-proxy-send-timeout"><a href="#13-proxy-send-timeout" class="headerlink" title="13.proxy_send_timeout"></a>13.proxy_send_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy_send_timeout 55s;</span><br><span class="line">在与upstream的server建立连接后，就会把请求往server发送，这个时间</span><br><span class="line">是两次数据的发送时间差，不是整个发送过程的。比如说负载大、网络卡，在</span><br><span class="line">tengine向server发送请求时突然卡了一下，然后继续发送，而这两次的时</span><br><span class="line">间差（其实就是两次write的时间差）超过了我设置的55s，tengine就会超</span><br><span class="line">时报错，对于这个参数，我当前优化的是55s。</span><br></pre></td></tr></table></figure>

<h3 id="14-proxy-read-timeout"><a href="#14-proxy-read-timeout" class="headerlink" title="14.proxy_read_timeout"></a>14.proxy_read_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy_read_timeout 60s;</span><br><span class="line">在将请求发送给upstream的server后，后端server就会回传数据，这个时</span><br><span class="line">间是两次收取数据的时间差，不是整个的接收时间。比如说负载大、网络卡，</span><br><span class="line">在第1次收到请求的数据时断了，然后过了60s后才收到后面的数据，这两个</span><br><span class="line">时间差(其实就是两次read的时间差)超过了设置的60s，</span><br><span class="line">tengine（nginx）就会超时报错，我当前走的是默认设置60s。</span><br></pre></td></tr></table></figure>

<h3 id="15-resolver-timeout"><a href="#15-resolver-timeout" class="headerlink" title="15.resolver_timeout"></a>15.resolver_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">resolver_timeout 10s;</span><br><span class="line"></span><br><span class="line">这个是dns解析超时时间，如果用作正向代理时就有用了，同时可以用</span><br><span class="line">resolver 127.0.0.1 valid=10m;指令来指定dns，后面是解析后缓存</span><br><span class="line">的有效时间。</span><br></pre></td></tr></table></figure>

<h3 id="16-fail-timeout"><a href="#16-fail-timeout" class="headerlink" title="16.fail_timeout"></a>16.fail_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server 127.0.0.1:9999 max_fails=20 fail_timeout=10s;</span><br><span class="line">这个是指某一个upstream的server如果失败20次后，不可以操作的时间，</span><br><span class="line">默认就是10s，其实可以另外的写法配在http中，我习惯直接配在server的</span><br><span class="line">后端。</span><br></pre></td></tr></table></figure>

<h3 id="17-send-timeout"><a href="#17-send-timeout" class="headerlink" title="17.send_timeout"></a>17.send_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">send_timeout 15;</span><br><span class="line">应客户端超时时间，这个超时时间仅限于两个活动之间的时间，如果超过这个</span><br><span class="line">时间，客户端没有任何活动，nginx关闭连接</span><br></pre></td></tr></table></figure>

<h3 id="18-client-header-buffer-size"><a href="#18-client-header-buffer-size" class="headerlink" title="18.client_header_buffer_size"></a>18.client_header_buffer_size</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client_header_buffer_size 4k;</span><br><span class="line">客户端请求头部的缓冲区大小，这个可以根据你的系统分页大小来设置，一般</span><br><span class="line">一个请求的头部大小不会超过1k，不过由于一般系统分页都要大于1k，所以</span><br><span class="line">这里设置为分页大小。分页大小可以用命令getconf PAGESIZE取得。</span><br></pre></td></tr></table></figure>

<h3 id="19-open-file-cache-max"><a href="#19-open-file-cache-max" class="headerlink" title="19.open_file_cache max"></a>19.open_file_cache max</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache max=102400 inactive=20s;</span><br><span class="line">下面这个参数将为打开文件指定缓存，默认是没有启用的，max指定缓存数</span><br><span class="line">量，建议和打开文件数一致，inactive是指经过多长时间文件没被请求后删</span><br><span class="line">除缓存。</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">下面这个是指多长时间检查一次缓存的有效信息。</span><br><span class="line">open_file_cache_min_uses 1;</span><br><span class="line">open_file_cache指令中的inactive参数时间内文件的最少使用次数，如</span><br><span class="line">果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文</span><br><span class="line">件在inactive时间内一次没被使用，它将被移除。</span><br></pre></td></tr></table></figure>

<h3 id="20-sendfile"><a href="#20-sendfile" class="headerlink" title="20.sendfile"></a>20.sendfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sendfile on;</span><br><span class="line">开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数</span><br><span class="line">来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载</span><br><span class="line">应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。</span><br></pre></td></tr></table></figure>

<h3 id="21-tcp-nopush"><a href="#21-tcp-nopush" class="headerlink" title="21.tcp_nopush"></a>21.tcp_nopush</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tcp_nopush on；</span><br><span class="line">必须在sendfile开启模式才有效，防止网路阻塞，积极的减少网络报文段的</span><br><span class="line">数量（将响应头和正文的开始部分一起发送，而不一个接一个的发送。）</span><br></pre></td></tr></table></figure>

<h3 id="22-reset-timeout-connection"><a href="#22-reset-timeout-connection" class="headerlink" title="22.reset_timeout_connection"></a>22.reset_timeout_connection</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reset_timeout_connection on;</span><br><span class="line">告诉nginx关闭不响应的客户端连接。这将会释放那个客户端所占有的内存空</span><br><span class="line">间。</span><br></pre></td></tr></table></figure>

<h3 id="23-gzip-重要"><a href="#23-gzip-重要" class="headerlink" title="23.gzip(重要)"></a>23.gzip(重要)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">一般我们需要压缩的内容有：文本，js，html，css，对于图片，视频，</span><br><span class="line">flash什么的不压缩，同时也要注意，我们使用gzip的功能是需要消耗CPU</span><br><span class="line">的！</span><br><span class="line">gzip on</span><br><span class="line">gzip_min_length 2k;</span><br><span class="line">gzip_buffers 4 32k;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line"></span><br><span class="line">gzip_typestext/plain text/css</span><br><span class="line">text/javascriptapplication/json application/javascript</span><br><span class="line">application/x-javascriptapplication/xml;</span><br><span class="line"></span><br><span class="line">示意</span><br><span class="line"></span><br><span class="line">gzip on; #开启压缩功能</span><br><span class="line">gzip_min_length 1k; 	#设置允许压缩的页面最小字节数，页面字节数从</span><br><span class="line">header头的Content-Length中获取，默认值是0，不管页面多大都进行压</span><br><span class="line">缩，建议设置成大于1K，如果小与1K可能会越压越大。</span><br><span class="line">gzip_buffers 4 32k; 	#压缩缓冲区大小，表示申请4个单位为32K的内存</span><br><span class="line">作为压缩结果流缓存，默认值是申请与原始数据大小相同的内存空间来存储</span><br><span class="line">gzip压缩结果。</span><br><span class="line">gzip_http_version 1.1; 	#压缩版本，用于设置识别HTTP协议版本，默</span><br><span class="line">认是1.1，目前大部分浏览器已经支持GZIP解压，使用默认即可</span><br><span class="line">gzip_comp_level 6; 		#压缩比例，用来指定GZIP压缩比，1压缩比最小，</span><br><span class="line">处理速度最快，9压缩比最大，传输速度快，但是处理慢，也比较消耗CPU资</span><br><span class="line">源。</span><br><span class="line">gzip_types text/css text/xml application/javascript; #用</span><br><span class="line">来指定压缩的类型，‘text/html’类型总是会被压缩。</span><br><span class="line">gzip_proxied expired no-cache no-store private auth;</span><br></pre></td></tr></table></figure>

<h3 id="24-expires"><a href="#24-expires" class="headerlink" title="24.expires"></a>24.expires</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">主要针对于图片，css，js等元素更改机会比较少的情况下使用，特别是图</span><br><span class="line">片，占用带宽大，我们完全可以设置图片在浏览器本地缓存365d，css，</span><br><span class="line">js，html可以缓存个10来天，这样用户第一次打开加载慢一点，第二次，就</span><br><span class="line">非常快了！缓存的时候，我们需要将需要缓存的拓展名列出来， Expires缓</span><br><span class="line">存配置在server字段里面</span><br><span class="line">location ~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$ &#123;</span><br><span class="line">expires 30d;</span><br><span class="line">#log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(js|css)$ &#123;</span><br><span class="line">expires 7d;</span><br><span class="line">log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log_not_found off;是否在error_log中记录不存在的错误。默认</span><br><span class="line"></span><br><span class="line">是。</span><br><span class="line"></span><br><span class="line">expire功能优点 （1）expires可以降低网站购买的带宽，节约成本（2）</span><br><span class="line">同时提升用户访问体验（3）减轻服务的压力，节约服务器成本，是web服务</span><br><span class="line">非常重要的功能。 expire功能缺点：被缓存的页面或数据更新了，用户看</span><br><span class="line">到的可能还是旧的内容，反而影响用户体验。解决办法：第一个缩短缓存时</span><br><span class="line">间，例如：1天，但不彻底，除非更新频率大于1天；第二个对缓存的对象改</span><br><span class="line">名。</span><br></pre></td></tr></table></figure>

<h3 id="25-防盗链"><a href="#25-防盗链" class="headerlink" title="25.防盗链"></a>25.防盗链</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">location ~*^.+\.</span><br><span class="line">(jpg|gif|png|swf|flv|wma|wmv|asf|mp3|mmf|zip|rar)$ &#123;</span><br><span class="line">valid_referers noneblocked www.benet.com benet.com;</span><br><span class="line">if($invalid_referer) &#123;</span><br><span class="line">#return 302 http://www.benet.com/img/nolink.jpg;</span><br><span class="line">return 404;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">access_log off;</span><br><span class="line">&#125;</span><br><span class="line">参数可以使如下形式：</span><br><span class="line">none 意思是不存在的Referer头(表示空的，也就是直接访问，比如直接在</span><br><span class="line">浏览器打开一个图片)</span><br><span class="line">blocked 意为根据防火墙伪装Referer头，如：“Referer:XXXXXXX”。</span><br><span class="line">server_names 为一个或多个服务器的列表，0.5.33版本以后可以在名称</span><br><span class="line">中使用“*”通配符。</span><br></pre></td></tr></table></figure>

<h3 id="主配置文件"><a href="#主配置文件" class="headerlink" title="主配置文件"></a>主配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> #user root;</span><br><span class="line"></span><br><span class="line">worker_processes 2;</span><br><span class="line">worker_cpu_affinity 0001 0010;</span><br><span class="line">worker_rlimit_nofile 102400;</span><br><span class="line">error_log /home/sc_nginx/logs/errorlog/main-error.log;</span><br><span class="line">error_log /home/sc_nginx/logs/errorlog/main-error.log</span><br><span class="line">notice;</span><br><span class="line">error_log /home/sc_nginx/logs/errorlog/main-error.log</span><br><span class="line">info;</span><br><span class="line">pid /home/sc_nginx/logs/nginx.pid;</span><br><span class="line">events &#123;</span><br><span class="line">use epoll;</span><br><span class="line">worker_connections 102400;</span><br><span class="line">accept_mutex on;</span><br><span class="line">multi_accept on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">include mime.types;</span><br><span class="line">default_type application/octet-stream;</span><br><span class="line">sendfile on;</span><br><span class="line">keepalive_timeout 60 75;</span><br><span class="line">keepalive_requests 1000;</span><br><span class="line">server_tokens off;</span><br><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">default upgrade;</span><br><span class="line">&apos;&apos; close;</span><br><span class="line">&#125;</span><br><span class="line">log_format main &apos;$remote_addr - $remote_user</span><br><span class="line">[$time_local] &quot;$request&quot; &apos;</span><br><span class="line">&apos;$status $body_bytes_sent</span><br><span class="line">&quot;$http_referer&quot; &apos;</span><br><span class="line">&apos;&quot;$http_user_agent&quot;</span><br><span class="line">$http_x_forwarded_for&apos;;</span><br><span class="line">log_format main_json</span><br><span class="line">&apos;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&apos;</span><br><span class="line">&apos;&quot;host&quot;:&quot;$server_addr&quot;,&apos;</span><br><span class="line">&apos;&quot;clientip&quot;:&quot;$remote_addr&quot;,&apos;</span><br><span class="line">&apos;&quot;size&quot;:$body_bytes_sent,&apos;</span><br><span class="line">&apos;&quot;responsetime&quot;:$request_time,&apos;</span><br><span class="line">&apos;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&apos;</span><br><span class="line">&apos;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&apos;</span><br><span class="line">&apos;&quot;http_host&quot;:&quot;$host&quot;,&apos;</span><br><span class="line">&apos;&quot;url&quot;:&quot;$uri&quot;,&apos;</span><br><span class="line">&apos;&quot;domain&quot;:&quot;$host&quot;,&apos;</span><br><span class="line">&apos;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&apos;</span><br><span class="line">&apos;&quot;referer&quot;:&quot;$http_referer&quot;,&apos;</span><br><span class="line">&apos;&quot;agent&quot;:&quot;$http_user_agent&quot;,&apos;</span><br><span class="line">&apos;&quot;status&quot;:&quot;$status&quot;&#125;&apos;;</span><br><span class="line">gzip on;</span><br><span class="line">gzip_min_length 1k;</span><br><span class="line">gzip_buffers 4 16k;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_comp_level 2;</span><br><span class="line">gzip_types text/plain application/javascript</span><br><span class="line">application/x-javascript text/javascript text/css</span><br><span class="line">application/xml application/xml+rss;</span><br><span class="line">gzip_vary on;</span><br><span class="line">gzip_proxied expired no-cache no-store private</span><br><span class="line">auth;</span><br><span class="line">gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br><span class="line"></span><br><span class="line">upstream new_shop_ant &#123; #新商城前端</span><br><span class="line">server 127.0.0.1:8080;</span><br><span class="line">server 127.0.0.1:9080 backup;</span><br><span class="line">&#125;</span><br><span class="line">upstream new_shop &#123; #新商城管理</span><br><span class="line">端</span><br><span class="line">server 127.0.0.1:8081;</span><br><span class="line">server 127.0.0.1:9081 backup;</span><br><span class="line">&#125;</span><br><span class="line">upstream wechat &#123; #微信对接</span><br><span class="line">server 192.168.101.59:6705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">server 192.168.101.61:6705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">upstream open &#123; #开放平台</span><br><span class="line">server 192.168.101.59:7705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">server 192.168.101.61:7705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">upstream ew &#123; #交易平台</span><br><span class="line">server 192.168.101.59:8705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">server 192.168.101.61:8705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">upstream vmims &#123; #商户管理端</span><br><span class="line">server 192.168.101.59:9705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">server 192.168.101.61:9705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">include conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="websocket配置"><a href="#websocket配置" class="headerlink" title="websocket配置"></a>websocket配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">default upgrade;</span><br><span class="line">&apos;&apos; close;</span><br><span class="line">&#125;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line"></span><br><span class="line">子配置文件</span><br></pre></td></tr></table></figure>

<h3 id="①shop-新商城前端展示和后台管理"><a href="#①shop-新商城前端展示和后台管理" class="headerlink" title="①shop(新商城前端展示和后台管理)"></a>①shop(新商城前端展示和后台管理)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name mall.eguagua.cn;</span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/mall_access.log main;</span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/mall_error.log ;</span><br><span class="line">client_header_timeout 120s; #调大点</span><br><span class="line">client_body_timeout 120s; #调大点</span><br><span class="line">client_max_body_size 100m; #主要是这个参</span><br><span class="line">数，限制了上传文件大大小</span><br><span class="line">client_body_buffer_size 256k;</span><br><span class="line">location = /MP_verify_hhvX6XfZQCOwWWpf.txt &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">proxy_pass http://new_shop_ant;</span><br><span class="line">&#125;</span><br><span class="line">location /coalition-admin-api &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://new_shop;</span><br><span class="line">&#125;</span><br><span class="line">location ~* .*\.(css|js)$ &#123;</span><br><span class="line">expires 7d;</span><br><span class="line">log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">proxy_pass http://new_shop_ant;</span><br><span class="line">&#125;</span><br><span class="line">location ~* .*\.(jpg|jpeg|gif|png|ico|pdf|txt)$</span><br><span class="line">&#123;</span><br><span class="line">expires 7d;</span><br><span class="line">log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">proxy_pass http://new_shop_ant;</span><br><span class="line">&#125;</span><br><span class="line">location ~ /coalition-admin-api/.*\.(css|js)$ &#123;</span><br><span class="line">expires 7d;</span><br><span class="line">log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">proxy_pass http://new_shop;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="②ew-交易中心"><a href="#②ew-交易中心" class="headerlink" title="②ew(交易中心)"></a>②ew(交易中心)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name egege.eguagua.cn;</span><br><span class="line"></span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/egege_access.log main;</span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/egege_error.log ;</span><br><span class="line">location = /wifi_welcome.html &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line">location = /MP_verify_hhvX6XfZQCOwWWpf.txt &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://ew;</span><br><span class="line"></span><br><span class="line">#try_files $uri /weihu.html;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">location /test/ &#123;</span><br><span class="line">proxy_set_header Host $http_host;</span><br><span class="line"></span><br><span class="line">#proxy_pass http://127.0.0.1:9305/;</span><br><span class="line"></span><br><span class="line">proxy_pass http://10.168.171.105:1994/;</span><br><span class="line">proxy_redirect default;</span><br><span class="line">#try_files $uri /weihu.html;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="③open-开放平台"><a href="#③open-开放平台" class="headerlink" title="③open(开放平台)"></a>③open(开放平台)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name open.eguagua.cn;</span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/open_access.log main;</span><br><span class="line"></span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/open_error.log ;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://open;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="④vmims-商户管理端"><a href="#④vmims-商户管理端" class="headerlink" title="④vmims(商户管理端)"></a>④vmims(商户管理端)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name vmims.eguagua.cn;</span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/vmims_access.log main;</span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/vmims_error.log ;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://vmims;</span><br><span class="line">&#125;</span><br><span class="line">location /ws/ &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line"></span><br><span class="line">⑤wechat(微信调试)</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://vmims/ws/;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="⑤wechat-微信调试"><a href="#⑤wechat-微信调试" class="headerlink" title="⑤wechat(微信调试)"></a>⑤wechat(微信调试)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name wechat.eguagua.cn;</span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/wechat_access.log main;</span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/wechat_error.log ;</span><br><span class="line">if ( $host = wechat.eguagua.cn ) &#123;</span><br><span class="line">rewrite</span><br><span class="line">^/test/egege/hatch_selector/wechatAuth</span><br><span class="line">http://egege.eguagua.cn/egege/hatch_selector/wechatAuth</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://wechat;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、内核参数调优"><a href="#二、内核参数调优" class="headerlink" title="二、内核参数调优"></a>二、内核参数调优</h2><h3 id="1-选项参数"><a href="#1-选项参数" class="headerlink" title="1.选项参数"></a>1.选项参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">fs.file-max = 204800 # 这个参数表示进程（比如一个</span><br><span class="line">worker进程）可以同时打开的最大句柄数，这个参数直线限制最大并发连接</span><br><span class="line">数，需根据实际情况配置。</span><br><span class="line">fs.nr_open = 204800 # nr_open定义是单进程最大</span><br><span class="line">file-handles，file-handles（即文件句柄）</span><br><span class="line">net.ipv4.tcp_syncookies = 1 # 开启SYN</span><br><span class="line">Cookies，当出现SYN等待队列溢出时，启用cookies来处理。</span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line">kernel.shmmax = 68719476736</span><br><span class="line">kernel.shmall = 4294967296</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 3500 # 这个参数表示操作系统允</span><br><span class="line">许TIME_WAIT套接字数量的最大值，如果超过这个数字，TIME_WAIT套接字</span><br><span class="line">将立刻被清除并打印警告信息。该参数默认为180000，过多的TIME_WAIT套</span><br><span class="line">接字会使Web服务器变慢。</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line">net.ipv4.tcp_rmem = 10240 87380 12582912 # 这个参数定义了</span><br><span class="line">TCP接受缓存（用于TCP接受滑动窗口）的最小值、默认值、最大值。</span><br><span class="line">net.ipv4.tcp_wmem = 10240 87380 12582912 # 这个参数定义了</span><br><span class="line">TCP发送缓存（用于TCP发送滑动窗口）的最小值、默认值、最大值。</span><br><span class="line">net.core.wmem_default = 8388608 # 这个参数表示内核套接字接受</span><br><span class="line">缓存区默认的大小。</span><br><span class="line">net.core.rmem_default = 8388608 # 这个参数表示内核套接字发送</span><br><span class="line">缓存区默认的大小。</span><br><span class="line">net.core.rmem_max = 16777216 # 这个参数表示内核套接字接受</span><br><span class="line">缓存区的最大大小。</span><br><span class="line">net.core.wmem_max = 16777216 # 这个参数表示内核套接字发送</span><br><span class="line">缓存区的最大大小。</span><br><span class="line">net.core.netdev_max_backlog = 262144 # 每个网络接口接收数</span><br><span class="line">据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数</span><br><span class="line">目。</span><br><span class="line">net.core.somaxconn = 40960 # web 应用中</span><br><span class="line">listen 函数的 backlog 默认会给我们内核参数的</span><br><span class="line">net.core.somaxconn 限制到128，而nginx定义的</span><br><span class="line">NGX_LISTEN_BACKLOG 默认为511，所以有必要调整这个值。</span><br></pre></td></tr></table></figure>

<h3 id="注：对于一个TCP连接，Server与Client需要通过三次握手来建立网络"><a href="#注：对于一个TCP连接，Server与Client需要通过三次握手来建立网络" class="headerlink" title="注：对于一个TCP连接，Server与Client需要通过三次握手来建立网络"></a>注：对于一个TCP连接，Server与Client需要通过三次握手来建立网络</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">连接.当三次握手成功后,我们可以看到端口的状态由LISTEN转变为</span><br><span class="line">ESTABLISHED,接着这条链路上就可以开始传送数据了.每一个处于监听</span><br><span class="line">(Listen)状态的端口,都有自己的监听队列.监听队列的长度与如</span><br><span class="line">somaxconn参数和使用该端口的程序中listen()函数有关</span><br><span class="line"></span><br><span class="line"># somaxconn参数:定义了系统中每一个端口最大的监听队列的长度,这是个</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">全局的参数,默认值为128，对于一个经常处理新连接的高负载 web服务环境</span><br><span class="line">来说，默认的 128 太小了。大多数环境这个值建议增加到 1024 或者更</span><br><span class="line">多。大的侦听队列对防止拒绝服务 DoS 攻击也会有所帮助。</span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800 # 系统中最多有多少个TCP</span><br><span class="line">套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤儿连接将</span><br><span class="line">即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单的DoS攻击，不</span><br><span class="line">能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之</span><br><span class="line">后)。</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144 # 这个参数标示TCP三次</span><br><span class="line">握手建立阶段接受SYN请求队列的最大长度，默认为1024，将其设置得大一</span><br><span class="line">些可以使出现Nginx繁忙来不及accept新连接的情况时，Linux不至于丢失</span><br><span class="line">客户端发起的连接请求。</span><br><span class="line">net.ipv4.tcp_timestamps = 0 # 时间戳可以避免序列</span><br><span class="line">号的卷绕。一个1Gbps的链路肯定会遇到以前用过的序列号。时间戳能够让内</span><br><span class="line">核接受这种“异常”的数据包。</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144 # 记录的那些尚未收到</span><br><span class="line">客户端确认信息的连接请求的最大值。对于有128M内存的系统而言，缺省值</span><br><span class="line">是1024，小内存的系统则是128。</span><br><span class="line">net.ipv4.tcp_synack_retries = 1 # 为了打开对端的连</span><br><span class="line">接，内核需要发送一个SYN并附带一个回应前面一个SYN的ACK。也就是所谓</span><br><span class="line">三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送SYN+ACK</span><br><span class="line">包的数量。</span><br><span class="line">net.ipv4.tcp_syn_retries = 1 # 在内核放弃建立连接</span><br><span class="line">之前发送SYN包的数量。</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1 # 启用timewait快速回</span><br><span class="line">收。</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1 # 开启重用。允许将</span><br><span class="line">TIME-WAIT sockets重新用于新的TCP连接。这对于服务器来说很有意义，</span><br><span class="line">因为服务器上总会有大量TIME-WAIT状态的连接。</span><br><span class="line">net.ipv4.tcp_mem = 94500000 915000000 927000000</span><br><span class="line">net.ipv4.tcp_fin_timeout = 1 # 如果套接字由本端要</span><br><span class="line">求关闭，这个参数 决定了它保持在FIN-WAIT-2状态的时间。对端可以出错</span><br><span class="line">并永远不关闭连接，甚至意外当机。缺省值是60秒。2.2 内核的通常值是</span><br><span class="line">180秒，你可以按这个设置，但要记住的是，即使你的机器是一个轻载的WEB</span><br><span class="line">服务器，也有因为大量的死套接字而内存溢出的风险，FIN- WAIT-2的危险</span><br><span class="line">性比FIN-WAIT-1要小，因为它最多只能吃掉1.5K内存，但是它们的生存期</span><br><span class="line">长些。</span><br><span class="line">net.ipv4.tcp_keepalive_time = 30 # 这个参数表示当</span><br><span class="line">keepalive启用时，TCP发送keepalive消息的频度。默认是2小时，若将</span><br><span class="line">其设置的小一些，可以更快地清理无效的连接。</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3 # 果对方不予应答，探</span><br><span class="line">测包的发送次数</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 15 # keepalive探测包</span><br><span class="line">的发送间隔</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65535 # 允许系统打开</span><br><span class="line">的端口范围。</span><br><span class="line">net.ipv4.tcp_sack = 1 # 启用有选择的应答</span><br><span class="line">（Selective Acknowledgment），这可以通过有选择地应答乱序接收到</span><br><span class="line">的报文来提高性能（这样可以让发送者只发送丢失的报文段）；（对于广域网</span><br><span class="line">通信来说）这个选项应该启用，但是这会增加对 CPU 的占用。</span><br><span class="line">net.ipv4.tcp_slow_start_after_idle = 0 # 关闭tcp的连接传输</span><br><span class="line">的慢启动，即先休止一段时间，再初始化拥塞窗口。</span><br><span class="line">net.ipv4.icmp_echo_ignore_broadcasts = 1 # 避免放大攻击，拒</span><br><span class="line">绝ping</span><br><span class="line">net.ipv4.icmp_ignore_bogus_error_responses = 1 # 开启恶意</span><br><span class="line">icmp错误消息保护</span><br><span class="line"></span><br><span class="line">net.inet.udp.checksum=1 # 防止不正确的udp</span><br><span class="line">包的攻击</span><br><span class="line"></span><br><span class="line">关于timewait快速回收</span><br><span class="line"></span><br><span class="line">不要轻易打开</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1 # 启用timewait快速回</span><br><span class="line">收。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_recycle = 0</span><br><span class="line">实际上，net.ipv4.tcp_tw_recycle功能的开启，要需要</span><br><span class="line">net.ipv4.tcp_timestamps（一般系统默认是开启这个功能的）这个开关</span><br><span class="line">开启后才有效果；</span><br><span class="line">当tcp_tw_recycle 开启时（tcp_timestamps 同时开启，快速回收</span><br><span class="line">socket 的效果达到），对于位于NAT设备后面的 Client来说，是一场灾</span><br><span class="line">难！</span><br><span class="line">会导致到NAT设备后面的Client连接Server不稳定（有的 Client 能连接</span><br><span class="line">server，有的 Client 不能连接 server）。</span><br><span class="line">也就是说，tcp_tw_recycle这个功能，是为内部网络（网络环境自己可控 ”</span><br><span class="line">——不存在NAT 的情况）设计的，对于公网环境下，不宜使用。</span><br><span class="line">通常来说，回收TIME_WAIT状态的socket是因为“无法主动连接远端”，因为</span><br><span class="line">无可用的端口，而不应该是要回收内存（没有必要）。</span><br><span class="line">即：需求是Client的需求，Server会有“端口不够用”的问题吗？</span><br><span class="line">除非是前端机，需要大量的连接后端服务，也就是充当着Client的角色。</span><br><span class="line">正确的解决这个总是办法应该是：</span><br><span class="line">net.ipv4.ip_local_port_range = 9000 6553 #默认值范围较小</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 10000 #默认值较小，还可适当调小</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 10</span><br></pre></td></tr></table></figure>

<h3 id="2-方案"><a href="#2-方案" class="headerlink" title="2.方案"></a>2.方案</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">fs.file-max = 204800</span><br><span class="line">fs.nr_open = 204800</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 25600</span><br><span class="line">net.core.netdev_max_backlog = 262144</span><br><span class="line">net.core.rmem_default=262144 # 接收套接字缓冲区大小的默认值</span><br><span class="line">net.core.wmem_default=262144 # 发送套接字缓冲区大小的默认值</span><br><span class="line">net.core.rmem_max=16777216 # 接收套接字缓冲区大小的最大值</span><br><span class="line">net.core.wmem_max=16777216 # 发送套接字缓冲区大小的最大值</span><br><span class="line">net.core.optmem_max=16777216 # socket buffer的最大初始化</span><br><span class="line">值,默认10K</span><br><span class="line">net.core.somaxconn = 40960</span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144</span><br><span class="line">net.ipv4.tcp_timestamps = 0 # 选择不开启</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 0 # 选择不开启</span><br><span class="line">net.ipv4.tcp_tw_reuse = 0 # 选择不开启</span><br><span class="line">net.ipv4.tcp_fin_timeout = 15</span><br><span class="line">net.ipv4.tcp_keepalive_time = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 15</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65535</span><br><span class="line">net.ipv4.tcp_sack = 1 # 谨慎开启</span><br><span class="line">net.ipv4.tcp_slow_start_after_idle = 0</span><br><span class="line">net.ipv4.icmp_echo_ignore_broadcasts = 0 # 选择不开启，允许</span><br><span class="line">ping</span><br><span class="line">net.ipv4.icmp_ignore_bogus_error_responses = 1</span><br><span class="line">net.inet.udp.checksum=1</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  
    </div>
  






          <div class="main-footer">
  
    © 2020 bibi - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

</body>
</html>
