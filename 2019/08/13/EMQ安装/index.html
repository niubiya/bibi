<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    EMQ
  
</title>

<meta name="description" content="一、EMQ安装1.安装包文件1234567891011[emqtt@lp ~]$ unzip emqttd-centos7-v2.3.11.zip[emqtt@lp ~]$ cd emqttd/[emqtt@lp emqttd]$ lsbin data erts-9.0 etc hook_lua lib log releases# 其中在bin下有很多命令；etc有配置文件；[emqtt@lp e">
<meta name="keywords" content="linux,EMQ">
<meta property="og:type" content="article">
<meta property="og:title" content="EMQ">
<meta property="og:url" content="http://yxbibi.com/2019/08/13/EMQ安装/index.html">
<meta property="og:site_name" content="bibi">
<meta property="og:description" content="一、EMQ安装1.安装包文件1234567891011[emqtt@lp ~]$ unzip emqttd-centos7-v2.3.11.zip[emqtt@lp ~]$ cd emqttd/[emqtt@lp emqttd]$ lsbin data erts-9.0 etc hook_lua lib log releases# 其中在bin下有很多命令；etc有配置文件；[emqtt@lp e">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yxbibi.com/img/QQ%E5%9B%BE%E7%89%8720000.png">
<meta property="og:image" content="http://yxbibi.com/img/QQ%E5%9B%BE%E7%89%8720001.png">
<meta property="og:image" content="http://yxbibi.com/img/QQ%E5%9B%BE%E7%89%8720002.png">
<meta property="og:updated_time" content="2019-12-12T12:10:23.256Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="EMQ">
<meta name="twitter:description" content="一、EMQ安装1.安装包文件1234567891011[emqtt@lp ~]$ unzip emqttd-centos7-v2.3.11.zip[emqtt@lp ~]$ cd emqttd/[emqtt@lp emqttd]$ lsbin data erts-9.0 etc hook_lua lib log releases# 其中在bin下有很多命令；etc有配置文件；[emqtt@lp e">
<meta name="twitter:image" content="http://yxbibi.com/img/QQ%E5%9B%BE%E7%89%8720000.png">


  <link rel="alternative" href="/atom.xml" title="bibi" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">






</head>
<body class="monochrome">
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">bibi</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">bibi</a></h1>
    
    <div class="info">
      <div class="content">
        
          <div class="description">Testing website</div>
        
        
          <div class="author">Mode</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://cn.gravatar.com/avatar/35fef74d731255cd569c2c2b0b9e87e4?s=200"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">Category</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openresty/">Openresty</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zabbix/">Zabbix</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/centos/">centos</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/centos7/">centos7</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rsync/">rsync</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/text/">text</a><span class="category-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS服务器搭建/">DNS服务器搭建</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELK/">ELK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EMQ/">EMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Filebeat/">Filebeat</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JumpServer/">JumpServer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KONG/">KONG</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LVM/">LVM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memcached/">Memcached</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openresty/">Openresty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PXE-Kickstart-Cobbler/">PXE+Kickstart+Cobbler</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis3/">Redis3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rsync-inotify/">Rsync+inotify</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/">Zabbix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/app-install/">app install</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bibi/">bibi</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos7/">centos7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ftp虚拟用户创建过程/">ftp虚拟用户创建过程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hello/">hello</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lvm/">lvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rsync/">rsync</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">Archive</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">30</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/niubiya/bibi" title="bibi" target="_blank" rel="noopener">bibi</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/niubiya" title="niubiya" target="_blank" rel="noopener">niubiya</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          <article id="post-EMQ安装" class="article article-type-post">
  
    <h1 class="article-header">
      EMQ
    </h1>
  
  

  <div class="article-info">
    <span class="article-date">
  2019-08-13
</span>

    
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/EMQ/">EMQ</a></li></ul></li></ul>
	</span>


    
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/EMQ/">EMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


  </div>
  <div class="article-entry">
    <h2 id="一、EMQ安装"><a href="#一、EMQ安装" class="headerlink" title="一、EMQ安装"></a>一、EMQ安装</h2><h3 id="1-安装包文件"><a href="#1-安装包文件" class="headerlink" title="1.安装包文件"></a>1.安装包文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ unzip emqttd-centos7-v2.3.11.zip</span><br><span class="line">[emqtt@lp ~]$ cd emqttd/</span><br><span class="line">[emqtt@lp emqttd]$ ls</span><br><span class="line">bin data erts-9.0 etc hook_lua lib log releases</span><br><span class="line"></span><br><span class="line"># 其中在bin下有很多命令；etc有配置文件；</span><br><span class="line"></span><br><span class="line">[emqtt@lp emqttd]$ ./bin/emqttd start # 启动命令</span><br><span class="line">emqttd 2.3.11 is started successfully!</span><br><span class="line">[emqtt@lp emqttd]$ ./bin/emqttd restart # 重启命令</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<h3 id="2-检查情况"><a href="#2-检查情况" class="headerlink" title="2.检查情况"></a>2.检查情况</h3><p>控制台调试模式启动，检查 EMQ 是否可正常启动:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ cd emqttd &amp;&amp; ./bin/emqttd console</span><br><span class="line">Exec: /home/emqtt/emqttd/erts-9.0/bin/erlexec -boot</span><br><span class="line">/home/emqtt/emqttd/releases/2.3.11/emqttd -mode embedded</span><br><span class="line">-boot_var ERTS_LIB_DIR /home/emqtt/emqttd/erts-</span><br><span class="line">9.0/../lib -mnesia dir</span><br><span class="line">&quot;/home/emqtt/emqttd/data/mnesia/emq@127.0.0.1&quot; -config</span><br><span class="line">/home/emqtt/emqttd/data/configs/app.2018.08.06.00.30.12.</span><br><span class="line">config -args_file</span><br><span class="line">/home/emqtt/emqttd/data/configs/vm.2018.08.06.00.30.12.a</span><br><span class="line">rgs -vm_args</span><br><span class="line">/home/emqtt/emqttd/data/configs/vm.2018.08.06.00.30.12.a</span><br><span class="line">rgs -- console</span><br><span class="line">Root: /home/emqtt/emqttd</span><br><span class="line">/home/emqtt/emqttd</span><br><span class="line">Erlang/OTP 20 [erts-9.0][source] [64-bit][smp:2:2]</span><br><span class="line">[ds:2:2:10][async-threads:32] [hipe][kernel-poll:true]</span><br><span class="line"></span><br><span class="line">=INFO REPORT==== 6-Aug-2018::00:30:16 ===</span><br><span class="line">alarm_handler: &#123;set,&#123;system_memory_high_watermark,</span><br><span class="line">[]&#125;&#125;</span><br><span class="line">starting emqttd on node &apos;emq@127.0.0.1&apos;</span><br><span class="line">emqttd ctl is starting...[ok]</span><br><span class="line">emqttd hook is starting...[ok]</span><br><span class="line">emqttd router is starting...[ok]</span><br><span class="line">emqttd pubsub is starting...[ok]</span><br><span class="line">emqttd stats is starting...[ok]</span><br><span class="line">emqttd metrics is starting...[ok]</span><br><span class="line">emqttd pooler is starting...[ok]</span><br><span class="line">emqttd trace is starting...[ok]</span><br><span class="line">emqttd client manager is starting...[ok]</span><br><span class="line">emqttd session manager is starting...[ok]</span><br><span class="line">emqttd session supervisor is starting...[ok]</span><br><span class="line">emqttd wsclient supervisor is starting...[ok]</span><br><span class="line">emqttd broker is starting...[ok]</span><br><span class="line">emqttd alarm is starting...[ok]</span><br><span class="line">emqttd mod supervisor is starting...[ok]</span><br><span class="line">emqttd bridge supervisor is starting...[ok]</span><br><span class="line">emqttd access control is starting...[ok]</span><br><span class="line">emqttd system monitor is starting...[ok]</span><br><span class="line">emqttd 2.3.11 is running now</span><br><span class="line">Eshell V9.0 (abort with ^G)</span><br><span class="line">(emq@127.0.0.1)1&gt; Load emq_mod_presence module</span><br><span class="line">successfully.</span><br><span class="line">dashboard:http listen on 0.0.0.0:18083 with 4 acceptors.</span><br><span class="line">mqtt:tcp listen on 127.0.0.1:11883 with 4 acceptors.</span><br><span class="line">mqtt:tcp listen on 0.0.0.0:1883 with 64 acceptors.</span><br><span class="line">mqtt:ws listen on 0.0.0.0:8083 with 4 acceptors.</span><br><span class="line">mqtt:ssl listen on 0.0.0.0:8883 with 16 acceptors.</span><br><span class="line">mqtt:wss listen on 0.0.0.0:8084 with 4 acceptors.</span><br><span class="line">mqtt:api listen on 0.0.0.0:8080 with 4 acceptors.</span><br><span class="line">BREAK: (a)bort (c)ontinue (p)roc info (i)nfo (l)oaded</span><br><span class="line">(v)ersion (k)ill (D)b-tables (d)istribution</span><br><span class="line">^C[os_mon] memory supervisor port (memsup): Erlang has</span><br><span class="line">closed</span><br><span class="line">[os_mon] cpu supervisor port (cpu_sup): Erlang has</span><br><span class="line">closed</span><br></pre></td></tr></table></figure>

<h2 id="二、压力测试工具"><a href="#二、压力测试工具" class="headerlink" title="二、压力测试工具"></a>二、压力测试工具</h2><h3 id="1-下载安装benchmark"><a href="#1-下载安装benchmark" class="headerlink" title="1.下载安装benchmark"></a>1.下载安装benchmark</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ unzip emqtt_benchmark-master.zip # 这个下载</span><br><span class="line">会比较难</span><br><span class="line">[emqtt@lp ~]$ cd emqtt_benchmark-master/</span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">/usr/bin/env: escript: No such file or directory</span><br><span class="line">make: *** [get-deps] Error 127</span><br><span class="line"></span><br><span class="line"># 可以看到编译会出现问题，这样的问题是没有安装Erlang，因为这项服务</span><br><span class="line"></span><br><span class="line">是用这个Erlang来写的，因此必须要编译这个语言环境</span><br></pre></td></tr></table></figure>

<h3 id="2-部署Erlang-环境"><a href="#2-部署Erlang-环境" class="headerlink" title="2.部署Erlang 环境"></a>2.部署Erlang 环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 这个包的地址我已经收藏了，需要找到这个版本务必记住R16B03，然后下</span><br><span class="line"></span><br><span class="line">载下来解压</span><br><span class="line">[emqtt@lp ~]$ tar xvf otp_src_20.3.tar.gz</span><br><span class="line"></span><br><span class="line"># 这里我是用root用户进行操作，因为是安装一个语言环境，所以需要全局</span><br><span class="line"></span><br><span class="line">都起作用，那么就选择这样了</span><br><span class="line">[root@lp otp_src_20.3]# ./configure --</span><br><span class="line">prefix=/usr/local/erlang</span><br><span class="line">[root@lp otp_src_20.3]# make &amp;&amp; make install</span><br><span class="line">[root@lp otp_src_20.3]# vim /etc/profile</span><br><span class="line">export PATH=$PATH:/usr/local/erlang/bin</span><br><span class="line">[root@lp otp_src_20.3]# source /etc/profile</span><br><span class="line"></span><br><span class="line"># 测试安装版本以及完整性</span><br><span class="line"></span><br><span class="line">[root@lp emqtt_benchmark-master]# erl</span><br><span class="line">Erlang R16B03-1 (erts-5.10.4) [source][64-bit]</span><br><span class="line">[smp:2:2][async-threads:10] [kernel-poll:false]</span><br><span class="line">Eshell V5.10.4 (abort with ^G)</span><br></pre></td></tr></table></figure>

<h3 id="3-编译安装benchmark又遇问题（大坑必看）"><a href="#3-编译安装benchmark又遇问题（大坑必看）" class="headerlink" title="3.编译安装benchmark又遇问题（大坑必看）"></a>3.编译安装benchmark又遇问题（大坑必看）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt_benchmark-master]# make</span><br><span class="line">Uncaught error in rebar_core: &#123;&apos;EXIT&apos;,</span><br><span class="line">&#123;undef,</span><br><span class="line">[&#123;crypto,start,[],[]&#125;,</span><br><span class="line">&#123;rebar,run_aux,2,</span><br><span class="line">[&#123;file,&quot;src/rebar.erl&quot;&#125;,&#123;line,165&#125;]&#125;,</span><br><span class="line">&#123;rebar,main,1,</span><br><span class="line">[&#123;file,&quot;src/rebar.erl&quot;&#125;,&#123;line,58&#125;]&#125;,</span><br><span class="line">&#123;escript,run,2,</span><br><span class="line"></span><br><span class="line">[&#123;file,&quot;escript.erl&quot;&#125;,</span><br><span class="line">&#123;line,747&#125;]&#125;,</span><br><span class="line">&#123;escript,start,1,</span><br><span class="line">[&#123;file,&quot;escript.erl&quot;&#125;,</span><br><span class="line">&#123;line,277&#125;]&#125;,</span><br><span class="line">&#123;init,start_it,1,[]&#125;,</span><br><span class="line">&#123;init,start_em,1,[]&#125;]&#125;&#125;</span><br><span class="line">make: *** [get-deps] Error 1</span><br><span class="line"></span><br><span class="line"># 真是崩溃，这个问题....说明erlang的版本太低，需要升级！！！</span><br><span class="line"></span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">==&gt; emqtt_benchmark-master (get-deps)</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">ERROR: Dependency dir /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc failed application validation with</span><br><span class="line">reason:</span><br><span class="line">&#123;missing_app_file,&quot;/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc&quot;&#125;.</span><br><span class="line">ERROR: &apos;get-deps&apos; failed while processing</span><br><span class="line">/home/emqtt/emqtt_benchmark-master: rebar_abort</span><br><span class="line">make: *** [get-deps] Error 1</span><br><span class="line"></span><br><span class="line"># 这个问题是由于make之后，按下crtl+C取消了，这样就导致deps当中有</span><br><span class="line"></span><br><span class="line">文件emqttc，但是里面的东西却还没有下载完成，那么就会报这样的错误，</span><br><span class="line">这种情况下就把deps文件下的东西清空，然后再次make</span><br><span class="line"></span><br><span class="line"># 又遇到问题了，下载不动这些资源，</span><br><span class="line"></span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line"></span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/goldrush to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">==&gt; lager (get-deps)</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/goldrush to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">Pulling goldrush from</span><br><span class="line">&#123;git,&quot;https://github.com/basho/goldrush.git&quot;,</span><br><span class="line">&#123;tag,&quot;0.1.9&quot;&#125;&#125;</span><br><span class="line">Cloning into &apos;goldrush&apos;...</span><br><span class="line"></span><br><span class="line"># 比如卡在“goldrush”的下载上，但是有个曲线救国的方式就是自己把这</span><br><span class="line"></span><br><span class="line">些依赖包下载下来，我最后算了一下，一共是有五个包，这里我通过浏览器的</span><br><span class="line">方式下载，注意看当中</span><br><span class="line">的“&#123;git,&quot;https://github.com/basho/goldrush.git&quot;,”，这个就</span><br><span class="line">是web地址，https://github.com/basho/goldrush，然后进去吧zip</span><br><span class="line">包下载下来，移动到deps当中，并且是创建好的goldrush目录</span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ ls deps</span><br><span class="line">emqttc gen_logger getopt goldrush lager</span><br><span class="line"></span><br><span class="line"># 就是这5个包的文件夹，都要解压以后相应的把内容放在其中，例如：</span><br><span class="line"></span><br><span class="line">[emqtt@lp ~]$ zip getopt-master.zip</span><br><span class="line">[emqtt@lp ~]$ cp -rf getopt-master/* emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt/</span><br><span class="line"></span><br><span class="line"># 后面的包都需要这么做。</span><br></pre></td></tr></table></figure>

<h3 id="4-编译benchmark"><a href="#4-编译benchmark" class="headerlink" title="4.编译benchmark"></a>4.编译benchmark</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">==&gt; goldrush (get-deps)</span><br><span class="line">==&gt; lager (get-deps)</span><br><span class="line">==&gt; gen_logger (get-deps)</span><br><span class="line">==&gt; emqttc (get-deps)</span><br><span class="line">==&gt; emqtt_benchmark-master (get-deps)</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">Pulling getopt from</span><br><span class="line">&#123;git,&quot;https://github.com/jcomellas/getopt.git&quot;,</span><br><span class="line">&#123;branch,&quot;master&quot;&#125;&#125;</span><br><span class="line">Cloning into &apos;getopt&apos;...</span><br><span class="line">^Cmake: *** [get-deps] Interrupt</span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">==&gt; goldrush (get-deps)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">==&gt; lager (get-deps)</span><br><span class="line">==&gt; gen_logger (get-deps)</span><br><span class="line">==&gt; emqttc (get-deps)</span><br><span class="line">==&gt; getopt (get-deps)</span><br><span class="line">==&gt; emqtt_benchmark-master (get-deps)</span><br><span class="line">==&gt; goldrush (compile)</span><br><span class="line">Compiled src/gr_sup.erl</span><br><span class="line">Compiled src/gr_param_sup.erl</span><br><span class="line">Compiled src/gre.erl</span><br><span class="line">Compiled src/gr_manager_sup.erl</span><br><span class="line">Compiled src/gr_manager.erl</span><br><span class="line">Compiled src/gr_counter_sup.erl</span><br><span class="line">Compiled src/gr_context.erl</span><br><span class="line">Compiled src/gr_param.erl</span><br><span class="line">Compiled src/gr_app.erl</span><br><span class="line">Compiled src/glc_run.erl</span><br><span class="line">Compiled src/gr_counter.erl</span><br><span class="line">Compiled src/glc_ops.erl</span><br><span class="line">Compiled src/glc_lib.erl</span><br><span class="line">Compiled src/glc.erl</span><br><span class="line">Compiled src/glc_code.erl</span><br><span class="line">==&gt; lager (compile)</span><br><span class="line">Compiled src/lager_util.erl</span><br><span class="line">Compiled src/lager_transform.erl</span><br><span class="line">Compiled src/lager_sup.erl</span><br><span class="line">Compiled src/lager_msg.erl</span><br><span class="line">Compiled src/lager_manager_killer.erl</span><br><span class="line">Compiled src/lager_handler_watcher_sup.erl</span><br><span class="line">Compiled src/lager_handler_watcher.erl</span><br><span class="line">Compiled src/lager_trunc_io.erl</span><br><span class="line">Compiled src/lager_stdlib.erl</span><br><span class="line">Compiled src/lager_format.erl</span><br><span class="line">Compiled src/lager_default_formatter.erl</span><br><span class="line">Compiled src/lager_crash_log.erl</span><br><span class="line">Compiled src/lager_file_backend.erl</span><br><span class="line">Compiled src/lager_config.erl</span><br><span class="line">Compiled src/lager_console_backend.erl</span><br><span class="line">Compiled src/lager_common_test_backend.erl</span><br><span class="line">Compiled src/lager_backend_throttle.erl</span><br><span class="line">Compiled src/lager_app.erl</span><br><span class="line">Compiled src/error_logger_lager_h.erl</span><br><span class="line">Compiled src/lager.erl</span><br><span class="line">==&gt; gen_logger (compile)</span><br><span class="line">Compiled src/gen_logger.erl</span><br><span class="line">Compiled src/console_logger.erl</span><br><span class="line">Compiled src/error_logger_logger.erl</span><br><span class="line">Compiled src/lager_logger.erl</span><br><span class="line">==&gt; emqttc (compile)</span><br><span class="line"></span><br><span class="line">Compiled src/emqttc_topic.erl</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc_socket.erl:204: Warning:</span><br><span class="line">gen_fsm:send_all_state_event/2 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc_socket.erl:215: Warning:</span><br><span class="line">gen_fsm:send_all_state_event/2 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc_socket.erl:233: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc_socket.erl:242: Warning:</span><br><span class="line">gen_fsm:send_all_state_event/2 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:cast/2</span><br><span class="line">Compiled src/emqttc_socket.erl</span><br><span class="line">Compiled src/emqttc_serialiser.erl</span><br><span class="line">Compiled src/emqttc_reconnector.erl</span><br><span class="line">Compiled src/emqttc_packet.erl</span><br><span class="line">Compiled src/emqttc_parser.erl</span><br><span class="line">Compiled src/emqttc_opts.erl</span><br><span class="line">Compiled src/emqttc_protocol.erl</span><br><span class="line">Compiled src/emqttc_keepalive.erl</span><br><span class="line">Compiled src/emqttc_message.erl</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:170: Warning:</span><br><span class="line">gen_fsm:start_link/3 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:start_link/3</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:193: Warning:</span><br><span class="line">gen_fsm:start_link/4 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:start_link/4</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:201: Warning:</span><br><span class="line">gen_fsm:sync_send_all_state_event/2 is deprecated and</span><br><span class="line">will be removed in a future release; use</span><br><span class="line">gen_statem:call/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:254: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:262: Warning:</span><br><span class="line">gen_fsm:sync_send_event/2 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:call/2</span><br><span class="line"></span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:335: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:338: Warning:</span><br><span class="line">gen_fsm:sync_send_event/3 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:call/3</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:350: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:358: Warning:</span><br><span class="line">gen_fsm:sync_send_event/3 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:call/3</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:366: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:488: Warning:</span><br><span class="line">gen_fsm:cancel_timer/1 is deprecated and will be removed</span><br><span class="line">in a future release; use erlang:cancel_timer/1</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:505: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:658: Warning: variable</span><br><span class="line">&apos;Logger&apos; is unused</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:658: Warning: variable</span><br><span class="line">&apos;Name&apos; is unused</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:770: Warning:</span><br><span class="line">gen_fsm:cancel_timer/1 is deprecated and will be removed</span><br><span class="line">in a future release; use erlang:cancel_timer/1</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:962: Warning:</span><br><span class="line">gen_fsm:start_timer/2 is deprecated and will be removed</span><br><span class="line">in a future release; use erlang:start_timer/3</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:1052: Warning:</span><br><span class="line">gen_fsm:reply/2 is deprecated and will be removed in a</span><br><span class="line">future release; use gen_statem:reply/2</span><br><span class="line"></span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:1065: Warning:</span><br><span class="line">gen_fsm:reply/2 is deprecated and will be removed in a</span><br><span class="line">future release; use gen_statem:reply/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:1076: Warning:</span><br><span class="line">gen_fsm:reply/2 is deprecated and will be removed in a</span><br><span class="line">future release; use gen_statem:reply/2</span><br><span class="line">Compiled src/emqttc.erl</span><br><span class="line">==&gt; getopt (compile)</span><br><span class="line">Compiled src/getopt.erl</span><br><span class="line">==&gt; emqtt_benchmark-master (compile)</span><br><span class="line">src/emqtt_benchmark.erl:95: Warning: random:seed/1: the</span><br><span class="line">&apos;random&apos; module is deprecated; use the &apos;rand&apos; module</span><br><span class="line">instead</span><br><span class="line">src/emqtt_benchmark.erl:196: Warning: random:uniform/1:</span><br><span class="line">the &apos;random&apos; module is deprecated; use the &apos;rand&apos; module</span><br><span class="line">instead</span><br><span class="line">Compiled src/emqtt_benchmark.erl</span><br><span class="line">==&gt; emqtt_benchmark-master (xref)</span><br><span class="line"></span><br><span class="line"># 注意前面的提示：</span><br><span class="line"></span><br><span class="line">==&gt; goldrush (get-deps)</span><br><span class="line">==&gt; lager (get-deps)</span><br><span class="line">==&gt; gen_logger (get-deps)</span><br><span class="line">==&gt; emqttc (get-deps)</span><br><span class="line">==&gt; emqtt_benchmark-master (get-deps)</span><br><span class="line"></span><br><span class="line"># 说明5个包都加载好了</span><br></pre></td></tr></table></figure>

<h3 id="5-测试"><a href="#5-测试" class="headerlink" title="5.测试"></a>5.测试</h3><p>为了保证测试的可行性，需要更改内核参数配置以及emq自身的配置文件</p>
<h4 id="①更改内核参数"><a href="#①更改内核参数" class="headerlink" title="①更改内核参数"></a>①更改内核参数</h4><p>系统全局允许分配的最大文件句柄数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">fs.file-max = 2097152 # 系统所有进程可打开的文件数量</span><br><span class="line">fs.nr_open=2097152</span><br><span class="line">net.core.somaxconn=65536 # backlog - Socket 监听队列长度</span><br><span class="line">[root@lp emqtt]# sysctl -p</span><br></pre></td></tr></table></figure>

<p>设置服务最大文件句柄数:</p>
<p>一般只有用到systemctl去启动的时候，这个才会生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/systemd/system.conf</span><br><span class="line">DefaultLimitNOFILE=1048576</span><br></pre></td></tr></table></figure>

<p>持久化设置允许用户/进程打开文件句柄数:</p>
<ul>
<li><ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">- - nofile 1048576</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<p>TCP 协议栈网络参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">sysctl -w net.core.somaxconn=32768 # 监听队列的最大长度</span><br><span class="line">sysctl -w net.ipv4.tcp_max_syn_backlog=16384 # Tcp syn队</span><br><span class="line">列的最大长度 ，但是有可能会造成syn攻击</span><br><span class="line">sysctl -w net.core.netdev_max_backlog=16384 # 每个网络接口</span><br><span class="line">接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最</span><br><span class="line">大数目</span><br></pre></td></tr></table></figure>

<p>可用知名端口范围:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_local_port_range=&apos;1000 65535&apos;</span><br></pre></td></tr></table></figure>

<p>TCP Socket 读写 Buffer 设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.core.rmem_default=262144 # 接收套接字缓冲区大小的默认值</span><br><span class="line">net.core.wmem_default=262144 # 发送套接字缓冲区大小的默认值</span><br><span class="line">net.core.rmem_max=16777216 # 接收套接字缓冲区大小的最大值</span><br><span class="line">net.core.wmem_max=16777216 # 发送套接字缓冲区大小的最大值</span><br><span class="line">net.core.optmem_max=16777216 # socket buffer的最大初始化</span><br><span class="line">值,默认10K</span><br><span class="line">#sysctl -w net.ipv4.tcp_mem=&apos;16777216 16777216 16777216&apos;</span><br><span class="line">net.ipv4.tcp_rmem=&apos;1024 4096 16777216&apos;</span><br><span class="line">net.ipv4.tcp_wmem=&apos;1024 4096 16777216&apos;</span><br><span class="line"></span><br><span class="line"># 为自动调优定义每个 socket 使用的内存。</span><br><span class="line"></span><br><span class="line"># 第一个值是为 socket 的发送缓冲区分配的最少字节数。</span><br><span class="line"></span><br><span class="line"># 第二个值是默认值（该值会被 wmem_default 覆盖），缓冲区在系统负</span><br><span class="line"></span><br><span class="line">载不重的情况下可以增长到这个值。</span><br><span class="line"></span><br><span class="line"># 第三个值是发送缓冲区空间的最大字节数（该值会被 wmem_max 覆</span><br><span class="line"></span><br><span class="line">盖）。</span><br></pre></td></tr></table></figure>

<p>TCP 连接追踪设置: （和firewall的开启有关系）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.nf_conntrack_max=1000000</span><br><span class="line">net.netfilter.nf_conntrack_max=1000000</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait=30</span><br><span class="line"></span><br><span class="line"># nf_conntrack用1个哈希表记录已建立的连接，包括其他机器到本机、本</span><br><span class="line"></span><br><span class="line">机到其他机器、本机到本机（例如 ping 127.0.0.1 也会被跟踪）。</span><br><span class="line"></span><br><span class="line"># 如果连接进来比释放的快，把哈希表塞满了，新连接的数据包会被丢掉，</span><br><span class="line"></span><br><span class="line">此时netfilter变成了一个黑洞，导致拒绝服务。 这发生在3层（网络</span><br><span class="line">层），应用程序毫无办法。</span><br><span class="line"></span><br><span class="line"># 默认值参考以下公式：（使用内存的 1/16384）</span><br><span class="line"></span><br><span class="line"># CONNTRACK_MAX = RAMSIZE (in bytes) / 16384 / (ARCH /</span><br><span class="line"></span><br><span class="line">32)</span><br><span class="line">#（ARCH为你机器CPU的架构，64或32）</span><br><span class="line"></span><br><span class="line"># HASHSIZE = CONNTRACK_MAX / 4</span><br><span class="line"></span><br><span class="line">推荐bucket至少 262144，max至少 1048576，不够再继续加</span><br><span class="line">调优的基本思路是先看 /proc/net/nf_conntrack ，哪种协议哪种状态</span><br><span class="line">的连接最多，改小对应的超时参数</span><br><span class="line">注意要充分测试，确保不影响业务。</span><br><span class="line"></span><br><span class="line"># 一篇博客关于这方面的调优推荐</span><br><span class="line"></span><br><span class="line">net.netfilter.nf_conntrack_max=1048576</span><br><span class="line">net.nf_conntrack_max=1048576</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait=30</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait=30</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait=15</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established=300</span><br></pre></td></tr></table></figure>

<p>TIME-WAIT Socket 最大数量、回收与重用设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.tcp_max_tw_buckets=1048576</span><br><span class="line"></span><br><span class="line"># 注意: 不建议开启該设置，NAT模式下可能引起连接RST</span><br><span class="line"></span><br><span class="line"># net.ipv4.tcp_tw_recycle = 1</span><br><span class="line"></span><br><span class="line"># net.ipv4.tcp_tw_reuse = 1</span><br></pre></td></tr></table></figure>

<p>FIN-WAIT-2 Socket 超时设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.tcp_fin_timeout = 15</span><br></pre></td></tr></table></figure>

<h4 id="②虚拟机Erlang-参数"><a href="#②虚拟机Erlang-参数" class="headerlink" title="②虚拟机Erlang 参数"></a>②虚拟机Erlang 参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ vim emqttd/etc/emq.conf</span><br><span class="line">node.process_limit = 2097152</span><br><span class="line">node.max_ports = 1048576</span><br></pre></td></tr></table></figure>

<h4 id="③EMQ-消息服务器参数"><a href="#③EMQ-消息服务器参数" class="headerlink" title="③EMQ 消息服务器参数"></a>③EMQ 消息服务器参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ vim emqttd/etc/emq.conf</span><br><span class="line">listener.tcp.external = 0.0.0.0:1883</span><br><span class="line">listener.tcp.external.acceptors = 64</span><br><span class="line">listener.tcp.external.max_clients = 1000000</span><br></pre></td></tr></table></figure>

<p>Sub Benchmark</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp emqtt_benchmark-master]$ ./emqtt_bench_sub --</span><br><span class="line">help</span><br><span class="line">Usage: emqtt_bench_sub [--help &lt;help&gt;][-h []] [-p</span><br><span class="line">[&lt;port&gt;]][-c []][-i []][-t ]</span><br><span class="line">[-q [&lt;qos&gt;]][-u ] [-P &lt;password&gt;][-k []][-C []][--ifaddr ]</span><br><span class="line">--help help information</span><br><span class="line">-h, --host mqtt server hostname or IP address</span><br><span class="line">[default: localhost]</span><br><span class="line">-p, --port mqtt server port number [default:</span><br><span class="line">1883]</span><br><span class="line">-c, --count max count of clients [default: 200]</span><br><span class="line">-n, --startnumber start number [default: 0]</span><br><span class="line">-i, --interval interval of connecting to the</span><br><span class="line">broker [default: 10]</span><br><span class="line">-t, --topic topic subscribe, support %u, %c, %i</span><br><span class="line">variables</span><br><span class="line">-q, --qos subscribe qos [default: 0]</span><br><span class="line">-u, --username username for connecting to server</span><br><span class="line">-P, --password password for connecting to server</span><br><span class="line">-k, --keepalive keep alive in seconds [default:</span><br><span class="line">300]</span><br><span class="line">-C, --clean clean session [default: true]</span><br><span class="line">--ifaddr local ipaddress or interface</span><br><span class="line">address</span><br></pre></td></tr></table></figure>

<p>Pub Benchmark</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./emqtt_bench_pub --help</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Usage: emqtt_bench_pub [--help &lt;help&gt;][-h []] [-p</span><br><span class="line">[&lt;port&gt;]][-c []] [-i [&lt;interval&gt;]][-I []] [-u</span><br><span class="line">&lt;username&gt;][-P ] [-t &lt;topic&gt;][-s []]</span><br><span class="line">[-q [&lt;qos&gt;]][-r []] [-k</span><br><span class="line">[&lt;keepalive&gt;]][-C []] [--ifaddr</span><br><span class="line">&lt;ifaddr&gt;]</span><br><span class="line">--help help information</span><br><span class="line">-h, --host mqtt server hostname or IP</span><br><span class="line">address [default:</span><br><span class="line">localhost]</span><br><span class="line">-p, --port mqtt server port number</span><br><span class="line">[default: 1883]</span><br><span class="line">-c, --count max count of clients [default:</span><br><span class="line">200]</span><br><span class="line">-n, --startnumber start number [default: 0]</span><br><span class="line">-i, --interval interval of connecting to the</span><br><span class="line">broker [default: 10]</span><br><span class="line">-I, --interval_of_msg interval of publishing</span><br><span class="line">message(ms) [default: 1000]</span><br><span class="line">-u, --username username for connecting to</span><br><span class="line">server</span><br><span class="line">-P, --password password for connecting to</span><br><span class="line">server</span><br><span class="line">-t, --topic topic subscribe, support %u,</span><br><span class="line">%c, %i variables</span><br><span class="line">-s, --size payload size [default: 256]</span><br><span class="line">-q, --qos subscribe qos [default: 0]</span><br><span class="line">-r, --retain retain message [default: false]</span><br><span class="line">-k, --keepalive keep alive in seconds [default:</span><br><span class="line">300]</span><br><span class="line">-C, --clean clean session [default: true]</span><br><span class="line">--ifaddr local ipaddress or interface</span><br><span class="line">address</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp emqtt_benchmark-master]$ ./emqtt_bench_pub -c</span><br><span class="line">100 -I 10 -t bench/%i -s 256</span><br><span class="line">21:08:18.085 [info] Application lager started on node</span><br><span class="line">nonode@nohost</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">21:08:18.087 [info] Application emqttc started on node</span><br><span class="line">nonode@nohost</span><br><span class="line">21:08:18.088 [info] Application emqtt_benchmark started</span><br><span class="line">on node nonode@nohost</span><br><span class="line">conneted: 1</span><br><span class="line">conneted: 2</span><br><span class="line">conneted: 3</span><br><span class="line">conneted: 4</span><br><span class="line">conneted: 5</span><br><span class="line">conneted: 6</span><br><span class="line">conneted: 7</span><br><span class="line">conneted: 8</span><br><span class="line">conneted: 9</span><br><span class="line">conneted: 10</span><br><span class="line">conneted: 11</span><br><span class="line">conneted: 12</span><br><span class="line">conneted: 13</span><br><span class="line">conneted: 14</span><br><span class="line">conneted: 15</span><br><span class="line">conneted: 16</span><br><span class="line">conneted: 17</span><br><span class="line">conneted: 18</span><br><span class="line">conneted: 19</span><br><span class="line">conneted: 20</span><br><span class="line">conneted: 21</span><br><span class="line">conneted: 22</span><br><span class="line">conneted: 23</span><br><span class="line">conneted: 24</span><br><span class="line">conneted: 25</span><br><span class="line">conneted: 26</span><br><span class="line">conneted: 27</span><br><span class="line">conneted: 28</span><br><span class="line">conneted: 29</span><br><span class="line">conneted: 30</span><br><span class="line">conneted: 31</span><br><span class="line">conneted: 32</span><br><span class="line">conneted: 33</span><br><span class="line">conneted: 34</span><br><span class="line">conneted: 35</span><br><span class="line">conneted: 36</span><br><span class="line">conneted: 37</span><br><span class="line">conneted: 38</span><br><span class="line">conneted: 39</span><br><span class="line">conneted: 40</span><br><span class="line">conneted: 41</span><br><span class="line">conneted: 42</span><br><span class="line">conneted: 43</span><br><span class="line">conneted: 44</span><br><span class="line"></span><br><span class="line">conneted: 45</span><br><span class="line">conneted: 46</span><br><span class="line">conneted: 47</span><br><span class="line">conneted: 48</span><br><span class="line">conneted: 49</span><br><span class="line">conneted: 50</span><br><span class="line">conneted: 51</span><br><span class="line">conneted: 52</span><br><span class="line">conneted: 53</span><br><span class="line">conneted: 54</span><br><span class="line">conneted: 55</span><br><span class="line">conneted: 56</span><br><span class="line">conneted: 57</span><br><span class="line">conneted: 58</span><br><span class="line">conneted: 59</span><br><span class="line">conneted: 60</span><br><span class="line">conneted: 61</span><br><span class="line">conneted: 62</span><br><span class="line">conneted: 63</span><br><span class="line">conneted: 64</span><br><span class="line">conneted: 65</span><br><span class="line">conneted: 66</span><br><span class="line">conneted: 67</span><br><span class="line">conneted: 68</span><br><span class="line">conneted: 69</span><br><span class="line">conneted: 70</span><br><span class="line">conneted: 71</span><br><span class="line">conneted: 72</span><br><span class="line">conneted: 73</span><br><span class="line">conneted: 74</span><br><span class="line">conneted: 75</span><br><span class="line">conneted: 76</span><br><span class="line">conneted: 77</span><br><span class="line">conneted: 78</span><br><span class="line">conneted: 79</span><br><span class="line">conneted: 80</span><br><span class="line">conneted: 81</span><br><span class="line">sent(1001): total=3899, rate=3899(msg/sec)</span><br><span class="line">conneted: 82</span><br><span class="line">conneted: 83</span><br><span class="line">conneted: 84</span><br><span class="line">conneted: 85</span><br><span class="line">conneted: 86</span><br><span class="line">conneted: 87</span><br><span class="line">conneted: 88</span><br><span class="line">conneted: 89</span><br><span class="line">conneted: 90</span><br><span class="line">conneted: 91</span><br><span class="line"></span><br><span class="line">conneted: 92</span><br><span class="line">conneted: 93</span><br><span class="line">conneted: 94</span><br><span class="line">conneted: 95</span><br><span class="line">conneted: 96</span><br><span class="line">conneted: 97</span><br><span class="line">conneted: 98</span><br><span class="line">conneted: 99</span><br><span class="line">conneted: 100</span><br><span class="line">sent(2001): total=13561, rate=9662(msg/sec)</span><br><span class="line">sent(3001): total=23564, rate=10003(msg/sec)</span><br><span class="line">sent(4001): total=33570, rate=10006(msg/sec)</span><br><span class="line">sent(5001): total=43578, rate=10008(msg/sec)</span><br><span class="line">sent(6002): total=53576, rate=9998(msg/sec)</span><br><span class="line">sent(7002): total=63571, rate=9995(msg/sec)</span><br><span class="line">sent(8002): total=73587, rate=10016(msg/sec)</span><br><span class="line">sent(9006): total=83565, rate=9978(msg/sec)</span><br><span class="line">sent(10002): total=93565, rate=10000(msg/sec)</span><br><span class="line">sent(11001): total=103515, rate=9950(msg/sec)</span><br><span class="line">sent(12001): total=113556, rate=10041(msg/sec)</span><br><span class="line">sent(13004): total=123590, rate=10034(msg/sec)</span><br><span class="line">sent(14003): total=133580, rate=9990(msg/sec)</span><br><span class="line">sent(15000): total=143531, rate=9951(msg/sec)</span><br><span class="line">sent(16006): total=153589, rate=10058(msg/sec)</span><br><span class="line">sent(17004): total=163585, rate=9996(msg/sec)</span><br><span class="line">sent(18002): total=173555, rate=9970(msg/sec)</span><br><span class="line">sent(19003): total=183530, rate=9975(msg/sec)</span><br><span class="line">sent(20003): total=193570, rate=10040(msg/sec)</span><br><span class="line">sent(21003): total=203556, rate=9986(msg/sec)</span><br><span class="line">sent(22004): total=213552, rate=9996(msg/sec)</span><br><span class="line">sent(23001): total=223534, rate=9982(msg/sec)</span><br><span class="line">sent(24002): total=233579, rate=10045(msg/sec)</span><br><span class="line">sent(25004): total=243607, rate=10028(msg/sec)</span><br><span class="line">sent(26002): total=253571, rate=9964(msg/sec)</span><br><span class="line">sent(27002): total=263535, rate=9964(msg/sec)</span><br><span class="line">sent(28003): total=273574, rate=10039(msg/sec)</span><br><span class="line">sent(29004): total=283575, rate=10001(msg/sec)</span><br><span class="line">sent(30004): total=293558, rate=9983(msg/sec)</span><br><span class="line">sent(31000): total=303537, rate=9979(msg/sec)</span><br><span class="line">sent(32004): total=313589, rate=10052(msg/sec)</span><br><span class="line">sent(33004): total=323592, rate=10003(msg/sec)</span><br><span class="line">sent(34004): total=333585, rate=9993(msg/sec)</span><br><span class="line">sent(35004): total=343563, rate=9978(msg/sec)</span><br><span class="line">sent(36002): total=353553, rate=9990(msg/sec)</span><br><span class="line">sent(37008): total=363561, rate=10008(msg/sec)</span><br><span class="line">sent(38004): total=373574, rate=10013(msg/sec)</span><br><span class="line">sent(39004): total=383552, rate=9978(msg/sec)</span><br><span class="line">sent(40005): total=393573, rate=10021(msg/sec)</span><br><span class="line"></span><br><span class="line">sent(41005): total=403559, rate=9986(msg/sec)</span><br><span class="line">sent(42015): total=413605, rate=10046(msg/sec)</span><br><span class="line">sent(43003): total=423574, rate=9969(msg/sec)</span><br><span class="line">sent(44002): total=433552, rate=9978(msg/sec)</span><br><span class="line">sent(45005): total=443570, rate=10018(msg/sec)</span><br><span class="line">sent(46000): total=453536, rate=9966(msg/sec)</span><br><span class="line">sent(47001): total=463565, rate=10029(msg/sec)</span><br><span class="line">sent(48004): total=473590, rate=10025(msg/sec)</span><br><span class="line">sent(49012): total=483560, rate=9970(msg/sec)</span><br><span class="line">sent(50002): total=493528, rate=9968(msg/sec)</span><br><span class="line">sent(51004): total=503592, rate=10064(msg/sec)</span><br><span class="line">sent(52003): total=513577, rate=9985(msg/sec)</span><br><span class="line">sent(53002): total=523538, rate=9961(msg/sec)</span><br><span class="line">sent(54008): total=533602, rate=10064(msg/sec)</span><br><span class="line">sent(55004): total=543539, rate=9937(msg/sec)</span><br><span class="line">sent(56004): total=553545, rate=10006(msg/sec)</span><br><span class="line">sent(57002): total=563556, rate=10011(msg/sec)</span><br><span class="line">sent(58004): total=573528, rate=9972(msg/sec)</span><br><span class="line">sent(59006): total=583608, rate=10080(msg/sec)</span><br><span class="line">sent(60004): total=593552, rate=9944(msg/sec)</span><br><span class="line">sent(61002): total=603495, rate=9943(msg/sec)</span><br><span class="line">sent(62003): total=613581, rate=10086(msg/sec)</span><br><span class="line">sent(63005): total=623551, rate=9970(msg/sec)</span><br><span class="line">sent(64007): total=633556, rate=10005(msg/sec)</span><br><span class="line">sent(65006): total=643588, rate=10032(msg/sec)</span><br><span class="line">sent(66010): total=653559, rate=9971(msg/sec)</span><br><span class="line">sent(67006): total=663559, rate=10000(msg/sec)</span><br><span class="line">sent(68005): total=673559, rate=10000(msg/sec)</span><br><span class="line">sent(69006): total=683589, rate=10030(msg/sec)</span><br><span class="line">sent(70018): total=693634, rate=10045(msg/sec)</span><br><span class="line">sent(71008): total=703568, rate=9934(msg/sec)</span><br><span class="line">sent(72016): total=713592, rate=10024(msg/sec)</span><br><span class="line">sent(73006): total=723602, rate=10010(msg/sec)</span><br><span class="line">sent(74004): total=733581, rate=9979(msg/sec)</span><br><span class="line">sent(75015): total=743593, rate=10012(msg/sec)</span><br><span class="line">sent(76006): total=753533, rate=9940(msg/sec)</span><br><span class="line">sent(77016): total=763560, rate=10027(msg/sec)</span><br><span class="line">sent(78007): total=773563, rate=10003(msg/sec)</span><br><span class="line">sent(79007): total=783541, rate=9978(msg/sec)</span><br><span class="line">sent(80014): total=793549, rate=10008(msg/sec)</span><br><span class="line">sent(81018): total=803514, rate=9965(msg/sec)</span><br><span class="line">sent(82006): total=813533, rate=10019(msg/sec)</span><br><span class="line">sent(83013): total=823551, rate=10018(msg/sec)</span><br><span class="line">sent(84021): total=833455, rate=9904(msg/sec)</span><br><span class="line">sent(85007): total=843510, rate=10055(msg/sec)</span><br><span class="line">sent(86018): total=853485, rate=9975(msg/sec)</span><br><span class="line">sent(87016): total=863449, rate=9964(msg/sec)</span><br><span class="line">sent(88009): total=873440, rate=9991(msg/sec)</span><br><span class="line"></span><br><span class="line">sent(89015): total=883132, rate=9692(msg/sec)</span><br><span class="line">sent(90035): total=892878, rate=9746(msg/sec)</span><br><span class="line">sent(91161): total=902805, rate=9927(msg/sec)</span><br><span class="line">sent(92453): total=912682, rate=9877(msg/sec)</span><br><span class="line">sent(93755): total=922701, rate=10019(msg/sec)</span><br><span class="line">sent(95034): total=932882, rate=10181(msg/sec)</span><br><span class="line">sent(96240): total=942679, rate=9797(msg/sec)</span><br><span class="line">sent(97483): total=952734, rate=10055(msg/sec)</span><br><span class="line">sent(98772): total=962904, rate=10170(msg/sec)</span><br><span class="line">sent(100124): total=972869, rate=9965(msg/sec)</span><br><span class="line">sent(101529): total=982883, rate=10014(msg/sec)</span><br><span class="line">sent(102938): total=992867, rate=9984(msg/sec)</span><br><span class="line">sent(104714): total=1002897, rate=10030(msg/sec)</span><br><span class="line">sent(106113): total=1012913, rate=10016(msg/sec)</span><br><span class="line">sent(107381): total=1022744, rate=9831(msg/sec)</span><br><span class="line">sent(108738): total=1032766, rate=10022(msg/sec)</span><br><span class="line">sent(110016): total=1042760, rate=9994(msg/sec)</span><br><span class="line">sent(111547): total=1052673, rate=9913(msg/sec)</span><br><span class="line">sent(112924): total=1062830, rate=10157(msg/sec)</span><br></pre></td></tr></table></figure>

<h2 id="三、EMQ概念"><a href="#三、EMQ概念" class="headerlink" title="三、EMQ概念"></a>三、EMQ概念</h2><h4 id="1-部署架构"><a href="#1-部署架构" class="headerlink" title="1.部署架构"></a>1.部署架构</h4><p>典型部署结构:</p>
<p><img src="/img/QQ%E5%9B%BE%E7%89%8720000.png" alt="QQ截图20000.png"></p>
<p>LB (负载均衡器) 负责分发设备的 MQTT 连接与消息到 EMQ 集群，LB 提高<br>EMQ 集群可用性、实现负载平衡以及动态扩容。<br>部署架构推荐在 LB 终结 SSL 连接。设备与 LB 之间 TLS 安全连接，LB 与<br>EMQ 之间普通 TCP 连接。这种部署模式下 EMQ 单集群可轻松支持100万设<br>备。<br>国内公有云部署推荐青云(EMQ 合作伙伴)，国外部署推荐 AWS 。私有部署推<br>荐使用 HAProxy 作为 LB。<br>EMQ 默认开启的 MQTT 服务 TCP 端口:</p>
<table>
<thead>
<tr>
<th>1883</th>
<th>MQTT 协议端口</th>
</tr>
</thead>
<tbody><tr>
<td>8883</td>
<td>MQTT/SSL 端口</td>
</tr>
<tr>
<td>8083</td>
<td>MQTT/WebSocket 端口</td>
</tr>
<tr>
<td>8084</td>
<td>MQTT/WebSocket/SSL 端口</td>
</tr>
</tbody></table>
<p>防火墙根据使用的 MQTT 接入方式，开启上述端口的访问权限。</p>
<p>EMQ 节点集群使用的 TCP 端口:</p>
<table>
<thead>
<tr>
<th>4369</th>
<th>集群节点发现端口</th>
</tr>
</thead>
<tbody><tr>
<td>6369</td>
<td>集群节点控制通道</td>
</tr>
</tbody></table>
<p>集群节点间如有防护墙，需开启上述 TCP 端口互访权限。</p>
<ol>
<li>创建 VPC 网络。</li>
<li>VPC 网络内创建 EMQ 集群’私有网络’，例如: 192.168.0.0/24</li>
<li>私有网络内创建两台 EMQ 主机，例如:</li>
</ol>
<table>
<thead>
<tr>
<th>EMQ2</th>
<th>192.168.0.2</th>
</tr>
</thead>
<tbody><tr>
<td>emq2</td>
<td>192.168.0.3</td>
</tr>
</tbody></table>
<ol start="4">
<li><p>安装并集群 EMQ 主机，具体配置请参考安装集群章节。</p>
</li>
<li><p>创建 LB(负载均衡器) 并指定公网 IP 地址。</p>
</li>
<li><p>在 LB 上创建 MQTT TCP 监听器:</p>
<p><img src="/img/QQ%E5%9B%BE%E7%89%8720001.png" alt="QQ图片20001.png"></p>
</li>
</ol>
<p>或创建 SSL 监听器，并终结 SSL 在 LB :</p>
<ol>
<li><p>MQTT 客户端连接 LB 公网地址测试。</p>
<p><img src="/img/QQ%E5%9B%BE%E7%89%8720002.png" alt="QQ图片20002.png"></p>
</li>
</ol>
<p>HAProxy -&gt; EMQ 集群</p>
<p>HAProxy 作为 LB 部署 EMQ 集群，并终结 SSL 连接:</p>
<ol>
<li>创建 EMQ 集群节点，例如:</li>
</ol>
<table>
<thead>
<tr>
<th>节点</th>
<th>IP 地址</th>
</tr>
</thead>
<tbody><tr>
<td>emq1</td>
<td>192.168.0.2</td>
</tr>
<tr>
<td>emq2</td>
<td>192.168.0.3</td>
</tr>
</tbody></table>
<ol>
<li>配置 /etc/haproxy/haproxy.cfg，示例:<br> 2.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">listen mqtt-ssl</span><br><span class="line">bind *:8883 ssl crt /etc/ssl/emqttd/emq.pem</span><br><span class="line">no-sslv3</span><br><span class="line">mode tcp</span><br><span class="line">maxconn 50000</span><br><span class="line">timeout client 600s</span><br><span class="line">default_backend emq_cluster</span><br><span class="line">backend emq_cluster</span><br><span class="line">mode tcp</span><br><span class="line">balance source</span><br><span class="line">timeout server 50s</span><br><span class="line">timeout check 5000</span><br><span class="line">server emq1 192.168.0.2:1883 check inter</span><br><span class="line">10000 fall 2 rise 5 weight 1</span><br><span class="line">server emq2 192.168.0.3:1883 check inter</span><br><span class="line">10000 fall 2 rise 5 weight 1</span><br><span class="line">source 0.0.0.0 usesrc clientip</span><br></pre></td></tr></table></figure>

<h4 id="2-配置文件详解"><a href="#2-配置文件详解" class="headerlink" title="2.配置文件详解"></a>2.配置文件详解</h4><p>EMQ 2.0 消息服务器通过 etc/ 目录下配置文件进行设置，主要配置文件包括:</p>
<table>
<thead>
<tr>
<th>配置文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>etc/emq.conf</td>
<td>EMQ 2.0 消息服务器配置文件</td>
</tr>
<tr>
<td>etc/acl.conf</td>
<td>EMQ 2.0 默认ACL规则配置文件</td>
</tr>
<tr>
<td>etc/plugins/*.conf</td>
<td>EMQ 2.0 各类插件配置文件</td>
</tr>
</tbody></table>
<h5 id="①EMQ-集群设置"><a href="#①EMQ-集群设置" class="headerlink" title="①EMQ 集群设置"></a>①EMQ 集群设置</h5><p>集群名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Cluster name</span><br><span class="line"></span><br><span class="line">cluster.name = emqcl</span><br></pre></td></tr></table></figure>

<p>自动发现策略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## Cluster dis-covery strategy: manual | static | mcast |</span><br><span class="line"></span><br><span class="line">dns | etcd | k8s</span><br><span class="line">cluster.dis-covery = manual</span><br></pre></td></tr></table></figure>

<p>启用集群自愈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Cluster Autoheal: on | off</span><br><span class="line"></span><br><span class="line">cluster.autoheal = on</span><br></pre></td></tr></table></figure>

<p>节点自动清除</p>
<p>自动清除宕机节点:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Clean down node of the cluster</span><br><span class="line"></span><br><span class="line">cluster.autoclean = 5m</span><br></pre></td></tr></table></figure>

<p>EMQ 集群自动发现</p>
<p>EMQ R2.3 版本支持多种策略的节点自动发现与集群:</p>
<table>
<thead>
<tr>
<th>策略</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>manual</td>
<td>手工命令创建集群</td>
</tr>
<tr>
<td>static</td>
<td>静态节点列表自动集群</td>
</tr>
<tr>
<td>mcast</td>
<td>UDP 组播方式自动集群</td>
</tr>
<tr>
<td>dns</td>
<td>DNS A 记录自动集群</td>
</tr>
<tr>
<td>etcd</td>
<td>通过 etcd 自动集群</td>
</tr>
<tr>
<td>k8s</td>
<td>Kubernetes 服务自动集群</td>
</tr>
</tbody></table>
<p>manual 手动创建集群</p>
<p>默认配置为手动创建集群，节点通过 ./bin/emqttd_ctl join 命令加入:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = manual</span><br></pre></td></tr></table></figure>

<p>基于 static 节点列表自动集群</p>
<p>配置固定的节点列表，自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = static</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with static node list</span><br><span class="line"></span><br><span class="line">cluster.static.seeds = emq1@127.0.0.1,ekka2@127.0.0.1</span><br></pre></td></tr></table></figure>

<p>基于 mcast 组播自动集群</p>
<p>基于 UDP 组播自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = mcast</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with multicast</span><br><span class="line"></span><br><span class="line">cluster.mcast.addr = 239.192.0.1</span><br><span class="line">cluster.mcast.ports = 4369,4370</span><br><span class="line">cluster.mcast.iface = 0.0.0.0</span><br><span class="line">cluster.mcast.ttl = 255</span><br><span class="line">cluster.mcast.loop = on</span><br></pre></td></tr></table></figure>

<p>基于 DNS A 记录自动集群</p>
<p>基于 DNS A 记录自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = dns</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with DNS</span><br><span class="line"></span><br><span class="line">cluster.dns.name = localhost</span><br><span class="line">cluster.dns.app = ekka</span><br></pre></td></tr></table></figure>

<p>基于 etcd 自动集群</p>
<p>基于 etcd _ 自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = etcd</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with Etcd</span><br><span class="line"></span><br><span class="line">cluster.etcd.server = http://127.0.0.1:2379</span><br><span class="line">cluster.etcd.prefix = emqcl</span><br><span class="line">cluster.etcd.node_ttl = 1m</span><br></pre></td></tr></table></figure>

<p>基于 Kubernetes 自动集群</p>
<p>Kubernetes _ 下自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = k8s</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with k8s</span><br><span class="line"></span><br><span class="line">cluster.k8s.apiserver = http://10.110.111.204:8080</span><br><span class="line">cluster.k8s.service_name = ekka</span><br><span class="line"></span><br><span class="line">## Address Type: ip | dns</span><br><span class="line"></span><br><span class="line">cluster.k8s.address_type = ip</span><br><span class="line"></span><br><span class="line">## The Erlang application name</span><br><span class="line"></span><br><span class="line">cluster.k8s.app_name = ekka</span><br></pre></td></tr></table></figure>

<p>EMQ 节点与 Cookie</p>
<p>Erlang 节点名称、分布式节点间通信 Cookie:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## Node name</span><br><span class="line"></span><br><span class="line">node.name = emqttd@127.0.0.1</span><br><span class="line"></span><br><span class="line">## Cookie for distributed node</span><br><span class="line"></span><br><span class="line">node.cookie = emq_dist_cookie</span><br></pre></td></tr></table></figure>

<p>注解</p>
<p>Erlang/OTP 平台应用多由分布的 Erlang 节点(进程)组成，每个 Erlang 节点<br>(进程)需指配一个节点名，用于节点间通信互访。 所有互相通信的 Erlang 节<br>点(进程)间通过一个共用的 Cookie 进行安全认证。<br>EMQ 节点连接方式<br>EMQ 节点基于 Erlang/OTP 平台的 TCPv4, TCPv6 或 TLS 协议连接:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">## Specify the erlang distributed protocol.</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">## Value: Enum</span><br><span class="line"></span><br><span class="line">## - inet_tcp: the default; handles TCP streams with</span><br><span class="line"></span><br><span class="line">IPv4 addressing.</span><br><span class="line"></span><br><span class="line">## - inet6_tcp: handles TCP with IPv6 addressing.</span><br><span class="line"></span><br><span class="line">## - inet_tls: using TLS for Erlang Distribution.</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">## vm.args: -proto_dist inet_tcp</span><br><span class="line"></span><br><span class="line">node.proto_dist = inet_tcp</span><br><span class="line"></span><br><span class="line">## Specify SSL Options in the file if using SSL for</span><br><span class="line"></span><br><span class="line">Erlang Distribution.</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">## Value: File</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">## vm.args: -ssl_dist_optfile &lt;File&gt;</span><br><span class="line"></span><br><span class="line">## node.ssl_dist_optfile = &#123;&#123; platform_etc_dir</span><br><span class="line"></span><br><span class="line">&#125;&#125;/ssl_dist.conf</span><br></pre></td></tr></table></figure>

<h5 id="②Erlang-虚拟机参数"><a href="#②Erlang-虚拟机参数" class="headerlink" title="②Erlang 虚拟机参数"></a>②Erlang 虚拟机参数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">## SMP support: enable, auto, disable</span><br><span class="line"></span><br><span class="line">node.smp = auto</span><br><span class="line"></span><br><span class="line">## Enable kernel poll</span><br><span class="line"></span><br><span class="line">node.kernel_poll = on</span><br><span class="line"></span><br><span class="line">## async thread pool</span><br><span class="line"></span><br><span class="line">node.async_threads = 32</span><br><span class="line"></span><br><span class="line">## Erlang Process Limit</span><br><span class="line"></span><br><span class="line">node.process_limit = 256000</span><br><span class="line"></span><br><span class="line">## Sets the maximum number of simultaneously existing</span><br><span class="line"></span><br><span class="line">ports for this system</span><br><span class="line">node.max_ports = 65536</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">## Set the distribution buffer busy limit</span><br><span class="line"></span><br><span class="line">(dist_buf_busy_limit)</span><br><span class="line">node.dist_buffer_size = 32MB</span><br><span class="line"></span><br><span class="line">## Max ETS Tables.</span><br><span class="line"></span><br><span class="line">## Note that mnesia and SSL will create temporary ets</span><br><span class="line"></span><br><span class="line">tables.</span><br><span class="line">node.max_ets_tables = 256000</span><br><span class="line"></span><br><span class="line">## Tweak GC to run more often</span><br><span class="line"></span><br><span class="line">node.fullsweep_after = 1000</span><br><span class="line"></span><br><span class="line">## Crash dump</span><br><span class="line"></span><br><span class="line">node.crash_dump = log/crash.dump</span><br><span class="line"></span><br><span class="line">## Distributed node ticktime</span><br><span class="line"></span><br><span class="line">node.dist_net_ticktime = 60</span><br><span class="line"></span><br><span class="line">## Distributed node port range</span><br><span class="line"></span><br><span class="line">## node.dist_listen_min = 6000</span><br><span class="line"></span><br><span class="line">## node.dist_listen_max = 6999</span><br></pre></td></tr></table></figure>

<p>Erlang 虚拟机主要参数说明:</p>
<p>| NODE.PROCESS_LIMIT   | ERLANG 虚拟机允许的最大进程数，一个 MQTT<br><br>连接会消耗2个 ERLANG 进程，所以参数值 &gt; 最</p>
<p>大连接数 * 2 |<br>| ——————– | ———————————————————— |<br>| node.max_ports       | Erlang 虚拟机允许的最大 Port 数量，一个 MQTT<br><br>连接消耗1个 Port，所以参数值 &gt; 最大连接数 |<br>| node.dist_listen_min | Erlang 分布节点间通信使用 TCP 连接端口范围。<br><br>注: 节点间如有防火墙，需要配置该端口段 |<br>| node.dist_listen_max | Erlang 分布节点间通信使用 TCP 连接端口范围。<br><br>注: 节点间如有防火墙，需要配置该端口段 |</p>
<h5 id="③日志参数配置"><a href="#③日志参数配置" class="headerlink" title="③日志参数配置"></a>③日志参数配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">##### console 日志</span><br><span class="line"></span><br><span class="line">## Console log. Enum: off, file, console, both</span><br><span class="line"></span><br><span class="line">log.console = console</span><br><span class="line"></span><br><span class="line">## Console log level. Enum: debug, info, notice,</span><br><span class="line"></span><br><span class="line">warning, error, critical, alert, emergency</span><br><span class="line">log.console.level = error</span><br><span class="line"></span><br><span class="line">## Console log file</span><br><span class="line"></span><br><span class="line">## log.console.file = log/console.log</span><br></pre></td></tr></table></figure>

<p>error 日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Error log file</span><br><span class="line"></span><br><span class="line">log.error.file = log/error.log</span><br></pre></td></tr></table></figure>

<p>crash 日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## Enable the crash log. Enum: on, off</span><br><span class="line"></span><br><span class="line">log.crash = on</span><br><span class="line">log.crash.file = log/crash.log</span><br></pre></td></tr></table></figure>

<p>syslog 日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## Syslog. Enum: on, off</span><br><span class="line"></span><br><span class="line">log.syslog = on</span><br><span class="line"></span><br><span class="line">## syslog level. Enum: debug, info, notice, warning,</span><br><span class="line"></span><br><span class="line">error, critical, alert, emergency</span><br><span class="line">log.syslog.level = error</span><br></pre></td></tr></table></figure>

<h5 id="④MQTT-协议参数配置"><a href="#④MQTT-协议参数配置" class="headerlink" title="④MQTT 协议参数配置"></a>④MQTT 协议参数配置</h5><p>ClientId 最大允许长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Max ClientId Length Allowed.</span><br><span class="line"></span><br><span class="line">mqtt.max_clientid_len = 1024</span><br></pre></td></tr></table></figure>

<p>MQTT 最大报文尺寸</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Max Packet Size Allowed, 64K by default.</span><br><span class="line"></span><br><span class="line">mqtt.max_packet_size = 64KB</span><br></pre></td></tr></table></figure>

<p>客户端连接闲置时间</p>
<p>设置 MQTT 客户端最大允许闲置时间(Socket 连接建立，但未收到 CONNECT<br>报文):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Client Idle Timeout (Second)</span><br><span class="line"></span><br><span class="line">mqtt.client.idle_timeout = 30</span><br></pre></td></tr></table></figure>

<p>启用客户端连接统计</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">## Enable client Stats: on | off</span><br><span class="line">mqtt.client.enable_stats = off</span><br></pre></td></tr></table></figure>

<p>强制 GC 设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Force GC: integer. Value 0 disabled the Force GC.</span><br><span class="line"></span><br><span class="line">mqtt.conn.force_gc_count = 100</span><br></pre></td></tr></table></figure>

<h5 id="⑤匿名认证与-ACL-文件"><a href="#⑤匿名认证与-ACL-文件" class="headerlink" title="⑤匿名认证与 ACL 文件"></a>⑤匿名认证与 ACL 文件</h5><p>是否开启匿名认证<br>默认开启，允许任意客户端登录:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Allow Anonymous authentication</span><br><span class="line"></span><br><span class="line">mqtt.allow_anonymous = true</span><br></pre></td></tr></table></figure>

<p>默认访问控制(ACL)文件<br>EMQ 支持基于 etc/acl.conf 文件或 MySQL、 PostgreSQL 等插件的访问控制规<br>则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## ACL nomatch</span><br><span class="line"></span><br><span class="line">mqtt.acl_nomatch = allow</span><br><span class="line"></span><br><span class="line">## Default ACL File</span><br><span class="line"></span><br><span class="line">mqtt.acl_file = etc/acl.conf</span><br></pre></td></tr></table></figure>

<p>etc/acl.conf 访问控制规则定义:<br>允许|拒绝 用户|IP地址|ClientID 发布|订阅 主题列表<br>访问控制规则采用 Erlang 元组格式，访问控制模块逐条匹配规则:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">Client -&gt; | Rule1 | --nomatch--&gt; | Rule2 | --nomatch--&gt;</span><br><span class="line">| Rule3 | --&gt; Default</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">| |</span><br><span class="line">|</span><br><span class="line">match match</span><br><span class="line">match</span><br><span class="line">\|/ \|/</span><br><span class="line">\|/</span><br><span class="line">allow | deny allow | deny</span><br><span class="line">allow | deny</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">etc/acl.conf 默认访问规则设置:</span><br><span class="line"></span><br><span class="line">%% 允许&apos;dashboard&apos;用户订阅 &apos;$SYS/#&apos;</span><br><span class="line">&#123;allow, &#123;user, &quot;dashboard&quot;&#125;, subscribe, [&quot;$SYS/#&quot;]&#125;.</span><br><span class="line">%% 允许本机用户发布订阅全部主题</span><br><span class="line">&#123;allow, &#123;ipaddr, &quot;127.0.0.1&quot;&#125;, pubsub, [&quot;$SYS/#&quot;, &quot;#&quot;]&#125;.</span><br><span class="line">%% 拒绝用户订阅&apos;$SYS#&apos;与&apos;#&apos;主题</span><br><span class="line">&#123;deny, all, subscribe, [&quot;$SYS/#&quot;, &#123;eq, &quot;#&quot;&#125;]&#125;.</span><br><span class="line">%% 上述规则无匹配，允许</span><br><span class="line">&#123;allow, all&#125;.</span><br></pre></td></tr></table></figure>

<p>注解<br>默认规则只允许本机用户订阅’$SYS/#’与’#’<br>EMQ 消息服务器接收到 MQTT 客户端发布(PUBLISH)或订阅(SUBSCRIBE)请<br>求时，会逐条匹配 ACL 访问控制规则，直到匹配成功返回 allow 或 deny。</p>
<h5 id="⑥MQTT-会话参数设置"><a href="#⑥MQTT-会话参数设置" class="headerlink" title="⑥MQTT 会话参数设置"></a>⑥MQTT 会话参数设置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">## Upgrade QoS?</span><br><span class="line"></span><br><span class="line">mqtt.session.upgrade_qos = off</span><br><span class="line"></span><br><span class="line">## Max number of QoS 1 and 2 messages that can be</span><br><span class="line"></span><br><span class="line">“inflight” at one time.</span><br><span class="line"></span><br><span class="line">## 0 means no limit</span><br><span class="line"></span><br><span class="line">mqtt.session.max_inflight = 32</span><br><span class="line"></span><br><span class="line">## Retry Interval for redelivering QoS1/2 messages.</span><br><span class="line"></span><br><span class="line">mqtt.session.retry_interval = 20s</span><br><span class="line"></span><br><span class="line">## Max Packets that Awaiting PUBREL, 0 means no limit</span><br><span class="line"></span><br><span class="line">mqtt.session.max_awaiting_rel = 100</span><br><span class="line"></span><br><span class="line">## Awaiting PUBREL Timeout</span><br><span class="line"></span><br><span class="line">mqtt.session.await_rel_timeout = 20s</span><br><span class="line"></span><br><span class="line">## Enable Statistics: on | off</span><br><span class="line"></span><br><span class="line">mqtt.session.enable_stats = off</span><br><span class="line"></span><br><span class="line">## Expired after 1 day:</span><br><span class="line"></span><br><span class="line">## w - week</span><br><span class="line"></span><br><span class="line">## d - day</span><br><span class="line"></span><br><span class="line">## h - hour</span><br><span class="line"></span><br><span class="line">## m - minute</span><br><span class="line"></span><br><span class="line">## s - second</span><br><span class="line"></span><br><span class="line">mqtt.session.expiry_interval = 2h</span><br></pre></td></tr></table></figure>

<h5 id="⑦MQTT-消息队列参数设置"><a href="#⑦MQTT-消息队列参数设置" class="headerlink" title="⑦MQTT 消息队列参数设置"></a>⑦MQTT 消息队列参数设置</h5><p>EMQ 消息服务器会话通过队列缓存 Qos1/Qos2 消息:</p>
<ol>
<li><p>持久会话(Session)的离线消息</p>
</li>
<li><p>飞行窗口满而延迟下发的消息<br> 队列参数设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">## Type: simple | priority</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.type = simple</span><br><span class="line"></span><br><span class="line">## Topic Priority: 0~255, Default is 0</span><br><span class="line"></span><br><span class="line">## mqtt.mqueue.priority = topic/1=10,topic/2=8</span><br><span class="line"></span><br><span class="line">## Max queue length. Enqueued messages when persistent</span><br><span class="line"></span><br><span class="line">client disconnected,</span><br><span class="line"></span><br><span class="line">## or inflight window is full. 0 means no limit.</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.max_length = 0</span><br><span class="line"></span><br><span class="line">## Low-water mark of queued messages</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.low_watermark = 20%</span><br><span class="line"></span><br><span class="line">## High-water mark of queued messages</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.high_watermark = 60%</span><br><span class="line"></span><br><span class="line">## Queue Qos0 messages?</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.store_qos0 = true</span><br></pre></td></tr></table></figure>

<p>队列参数说明:</p>
<p>| MQUEUE.TYPE           | 队列类型。SIMPLE: 简单队列，PRIORITY: 优先<br><br>级队列 |<br>| ——————— | —————————————————– |<br>| mqueue.priority       | 主题(Topic)队列优先级设置                             |<br>| mqueue.max_length     | 队列长度, infinity 表示不限制                         |<br>| mqueue.low_watermark  | 解除告警水位线                                        |<br>| mqueue.high_watermark | 队列满告警水位线                                      |<br>| mqueue.qos0           | 是否缓存 QoS0 消息                                    |</p>
<p>Broker 参数设置</p>
<p>broker_sys_interval 设置系统发布 $SYS 消息周期:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. System Interval of publishing broker $SYS Messages</span><br><span class="line"></span><br><span class="line">   mqtt.broker.sys_interval = 60s</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>发布订阅(PubSub)参数设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">## PubSub Pool Size. Default should be scheduler</span><br><span class="line"></span><br><span class="line">numbers.</span><br><span class="line">mqtt.pubsub.pool_size = 8</span><br><span class="line">mqtt.pubsub.by_clientid = true</span><br><span class="line"></span><br><span class="line">## Subscribe Asynchronously</span><br><span class="line"></span><br><span class="line">mqtt.pubsub.async = true</span><br></pre></td></tr></table></figure>

<p>桥接(Bridge)参数设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## Bridge Queue Size</span><br><span class="line"></span><br><span class="line">mqtt.bridge.max_queue_len = 10000</span><br><span class="line"></span><br><span class="line">## Ping Interval of bridge node. Unit: Second</span><br><span class="line"></span><br><span class="line">mqtt.bridge.ping_down_interval = 1s</span><br></pre></td></tr></table></figure>

<p>插件(Plugin) 配置目录设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## Dir of plugins&apos; config</span><br><span class="line"></span><br><span class="line">mqtt.plugins.etc_dir = etc/plugins/</span><br><span class="line"></span><br><span class="line">## File to store loaded plugin names.</span><br><span class="line"></span><br><span class="line">mqtt.plugins.loaded_file = data/loaded_plugins</span><br></pre></td></tr></table></figure>

<h5 id="⑧MQTT-Listeners-参数说明"><a href="#⑧MQTT-Listeners-参数说明" class="headerlink" title="⑧MQTT Listeners 参数说明"></a>⑧MQTT Listeners 参数说明</h5><p>EMQ 消息服务器支持 MQTT、MQTT/SSL、MQTT/WS 协议服务端，可通过<br>listener.tcp|ssl|ws|wss|.* 设置端口、最大允许连接数等参数。<br>EMQ 2.2 消息服务器默认开启的 TCP 服务端口包括:</p>
<table>
<thead>
<tr>
<th>1883</th>
<th>MQTT 协议端口</th>
</tr>
</thead>
<tbody><tr>
<td>8883</td>
<td>MQTT/SSL 端口</td>
</tr>
<tr>
<td>8083</td>
<td>MQTT/WebSocket 端口</td>
</tr>
<tr>
<td>8080</td>
<td>HTTP 管理 API 端口</td>
</tr>
<tr>
<td>8084</td>
<td>MQTT/WebSocket/SSL 端口</td>
</tr>
</tbody></table>
<p>Listener 参数说明:</p>
<table>
<thead>
<tr>
<th>LISTENER.TCP.${NAME}.ACCEPTORS</th>
<th>TCP ACCEPTOR 池</th>
</tr>
</thead>
<tbody><tr>
<td>listener.tcp.${name}.max_clients</td>
<td>最大允许 TCP 连接数</td>
</tr>
<tr>
<td>listener.tcp.${name}.rate_limit</td>
<td>连接限速配置，例如限速10KB/秒:</td>
</tr>
<tr>
<td><br>“100,10”</td>
<td></td>
</tr>
</tbody></table>
<p>MQTT/TCP 监听器 - 1883<br>EMQ 2.2 版本支持配置多个 MQTT 协议监听器，例如配置 external、internal<br>两个监听器:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## External TCP Listener</span><br><span class="line"></span><br><span class="line">## External TCP Listener: 1883, 127.0.0.1:1883, ::1:1883</span><br><span class="line"></span><br><span class="line">listener.tcp.external = 0.0.0.0:1883</span><br><span class="line"></span><br><span class="line">## Size of acceptor pool</span><br><span class="line"></span><br><span class="line">listener.tcp.external.acceptors = 16</span><br><span class="line"></span><br><span class="line">## Maximum number of concurrent clients</span><br><span class="line"></span><br><span class="line">listener.tcp.external.max_clients = 102400</span><br><span class="line">#listener.tcp.external.mountpoint = external/</span><br><span class="line"></span><br><span class="line">## Rate Limit. Format is &apos;burst,rate&apos;, Unit is KB/Sec</span><br><span class="line"></span><br><span class="line">#listener.tcp.external.rate_limit = 100,10</span><br><span class="line">#listener.tcp.external.access.1 = allow 192.168.0.0/24</span><br><span class="line">listener.tcp.external.access.2 = allow all</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">## Proxy Protocol V1/2</span><br><span class="line"></span><br><span class="line">## listener.tcp.external.proxy_protocol = on</span><br><span class="line"></span><br><span class="line">## listener.tcp.external.proxy_protocol_timeout = 3s</span><br><span class="line"></span><br><span class="line">## TCP Socket Options</span><br><span class="line"></span><br><span class="line">listener.tcp.external.backlog = 1024</span><br><span class="line">#listener.tcp.external.recbuf = 4KB</span><br><span class="line">#listener.tcp.external.sndbuf = 4KB</span><br><span class="line">listener.tcp.external.buffer = 4KB</span><br><span class="line">listener.tcp.external.nodelay = true</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Internal TCP Listener</span><br><span class="line"></span><br><span class="line">## Internal TCP Listener: 11883, 127.0.0.1:11883,</span><br><span class="line"></span><br><span class="line">::1:11883</span><br><span class="line">listener.tcp.internal = 127.0.0.1:11883</span><br><span class="line"></span><br><span class="line">## Size of acceptor pool</span><br><span class="line"></span><br><span class="line">listener.tcp.internal.acceptors = 16</span><br><span class="line"></span><br><span class="line">## Maximum number of concurrent clients</span><br><span class="line"></span><br><span class="line">listener.tcp.internal.max_clients = 102400</span><br><span class="line">#listener.tcp.external.mountpoint = internal/</span><br><span class="line"></span><br><span class="line">## Rate Limit. Format is &apos;burst,rate&apos;, Unit is KB/Sec</span><br><span class="line"></span><br><span class="line">## listener.tcp.internal.rate_limit = 1000,100</span><br><span class="line"></span><br><span class="line">## TCP Socket Options</span><br><span class="line"></span><br><span class="line">listener.tcp.internal.backlog = 512</span><br><span class="line">listener.tcp.internal.tune_buffer = on</span><br><span class="line">listener.tcp.internal.buffer = 1MB</span><br><span class="line">listener.tcp.internal.recbuf = 4KB</span><br><span class="line">listener.tcp.internal.sndbuf = 1MB</span><br><span class="line">listener.tcp.internal.nodelay = true</span><br></pre></td></tr></table></figure>

<p>MQTT/SSL 监听器 - 8883</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## External SSL Listener</span><br><span class="line"></span><br><span class="line">listener.ssl.external = 8883</span><br><span class="line"></span><br><span class="line">## Size of acceptor pool</span><br><span class="line"></span><br><span class="line">listener.ssl.external.acceptors = 16</span><br><span class="line"></span><br><span class="line">## Maximum number of concurrent clients</span><br><span class="line"></span><br><span class="line">listener.ssl.external.max_clients = 1024</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.mountpoint = inbound/</span><br><span class="line"></span><br><span class="line">## Rate Limit. Format is &apos;burst,rate&apos;, Unit is KB/Sec</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.rate_limit = 100,10</span><br><span class="line"></span><br><span class="line">## Proxy Protocol V1/2</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.proxy_protocol = on</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.proxy_protocol_timeout = 3s</span><br><span class="line"></span><br><span class="line">listener.ssl.external.access.1 = allow all</span><br><span class="line"></span><br><span class="line">## SSL Options</span><br><span class="line"></span><br><span class="line">listener.ssl.external.handshake_timeout = 15</span><br><span class="line">listener.ssl.external.keyfile = etc/certs/key.pem</span><br><span class="line">listener.ssl.external.certfile = etc/certs/cert.pem</span><br><span class="line"></span><br><span class="line">## 开启双向认证</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.cacertfile =</span><br><span class="line"></span><br><span class="line">etc/certs/cacert.pem</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.verify = verify_peer</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.fail_if_no_peer_cert = true</span><br></pre></td></tr></table></figure>

<p>MQTT/WebSocket 监听器 - 8083</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## External MQTT/WebSocket Listener</span><br><span class="line"></span><br><span class="line">listener.ws.external = 8083</span><br><span class="line">listener.ws.external.acceptors = 4</span><br><span class="line">listener.ws.external.max_clients = 64</span><br><span class="line">listener.ws.external.access.1 = allow all</span><br></pre></td></tr></table></figure>

<p>MQTT/WebSocket/SSL 监听器 - 8084</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## External MQTT/WebSocket/SSL Listener</span><br><span class="line"></span><br><span class="line">listener.wss.external = 8084</span><br><span class="line">listener.wss.external.acceptors = 4</span><br><span class="line">listener.wss.external.max_clients = 64</span><br><span class="line">listener.wss.external.access.1 = allow all</span><br><span class="line"></span><br><span class="line">## SSL Options</span><br><span class="line"></span><br><span class="line">listener.wss.external.handshake_timeout = 15s</span><br><span class="line">listener.wss.external.keyfile = &#123;&#123; platform_etc_dir</span><br><span class="line">&#125;&#125;/certs/key.pem</span><br><span class="line">listener.wss.external.certfile = &#123;&#123; platform_etc_dir</span><br><span class="line">&#125;&#125;/certs/cert.pem</span><br><span class="line"></span><br><span class="line">## listener.wss.external.cacertfile = &#123;&#123;</span><br><span class="line"></span><br><span class="line">platform_etc_dir &#125;&#125;/certs/cacert.pem</span><br><span class="line"></span><br><span class="line">## listener.wss.external.verify = verify_peer</span><br><span class="line"></span><br><span class="line">## listener.wss.external.fail_if_no_peer_cert = true</span><br></pre></td></tr></table></figure>

<p>HTTP API 监听器 - 8080</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## HTTP Management API Listener</span><br><span class="line"></span><br><span class="line">listener.api.mgmt = 127.0.0.1:8080</span><br><span class="line">listener.api.mgmt.acceptors = 4</span><br><span class="line">listener.api.mgmt.max_clients = 64</span><br><span class="line">listener.api.mgmt.access.1 = allow all</span><br></pre></td></tr></table></figure>

<h5 id="⑨Erlang-虚拟机监控设置"><a href="#⑨Erlang-虚拟机监控设置" class="headerlink" title="⑨Erlang 虚拟机监控设置"></a>⑨Erlang 虚拟机监控设置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">## Long GC, don&apos;t monitor in production mode for:</span><br><span class="line"></span><br><span class="line">sysmon.long_gc = false</span><br><span class="line"></span><br><span class="line">## Long Schedule(ms)</span><br><span class="line"></span><br><span class="line">sysmon.long_schedule = 240</span><br><span class="line"></span><br><span class="line">## 8M words. 32MB on 32-bit VM, 64MB on 64-bit VM.</span><br><span class="line"></span><br><span class="line">sysmon.large_heap = 8MB</span><br><span class="line"></span><br><span class="line">## Busy Port</span><br><span class="line"></span><br><span class="line">sysmon.busy_port = false</span><br><span class="line"></span><br><span class="line">## Busy Dist Port</span><br><span class="line"></span><br><span class="line">sysmon.busy_dist_port = true</span><br></pre></td></tr></table></figure>

<h5 id="⑩扩展插件配置文件"><a href="#⑩扩展插件配置文件" class="headerlink" title="⑩扩展插件配置文件"></a>⑩扩展插件配置文件</h5><p>EMQ 2.2 插件配置文件，全部在 etc/plugins/ 目录:</p>
<table>
<thead>
<tr>
<th>配置文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>etc/plugins/emq_mod_presence</td>
<td>客户端上下线状态消息发布</td>
</tr>
<tr>
<td>etc/plugins/emq_mod_retainer</td>
<td>Retain 消息存储插件</td>
</tr>
<tr>
<td>etc/plugins/emq_mod_subscription</td>
<td>客户端上线自动主题订阅</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_username.conf</td>
<td>用户名、密码认证插件</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_clientid.conf</td>
<td>ClientId 认证插件</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_http.conf</td>
<td>HTTP 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_mongo.conf</td>
<td>MongoDB 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_mysql.conf</td>
<td>MySQL 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_pgsql.conf</td>
<td>Postgre 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_redis.conf</td>
<td>Redis 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_web_hook.conf</td>
<td>Web Hook 插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_lua_hook.conf</td>
<td>Lua Hook 插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_coap.conf</td>
<td>CoAP 协议服务器配置</td>
</tr>
<tr>
<td>etc/plugins/emq_dashboard.conf</td>
<td>Dashboard 控制台插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_plugin_template.conf</td>
<td>示例插件模版</td>
</tr>
<tr>
<td>etc/plugins/emq_recon.conf</td>
<td>Recon 调试插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_reloader.conf</td>
<td>热加载插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_sn.conf</td>
<td>MQTT-SN 协议插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_stomp.conf</td>
<td>Stomp 协议插件配置</td>
</tr>
</tbody></table>
<h2 id="3-管理命令解析"><a href="#3-管理命令解析" class="headerlink" title="3.管理命令解析"></a>3.管理命令解析</h2><p>EMQ 消息服务器提供了 ./bin/emqttd_ctl的管理命令行。</p>
<h5 id="①启动服务器"><a href="#①启动服务器" class="headerlink" title="①启动服务器"></a>①启动服务器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$ ./bin/emqttd</span><br><span class="line">start</span><br><span class="line">Node &apos;emq@127.0.0.1&apos; is started</span><br><span class="line">emqttd 2.3.11 is running</span><br></pre></td></tr></table></figure>

<h5 id="②status-命令"><a href="#②status-命令" class="headerlink" title="②status 命令"></a>②status 命令</h5><p>查询 EMQ 消息服务器运行状态:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl status</span><br><span class="line">Node &apos;emqttd@127.0.0.1&apos; is started</span><br><span class="line">emqttd 2.0 is running</span><br></pre></td></tr></table></figure>

<h5 id="③broker-命令"><a href="#③broker-命令" class="headerlink" title="③broker 命令"></a>③broker 命令</h5><p>broker 命令查询服务器基本信息，启动时间，统计数据与性能数据。</p>
<table>
<thead>
<tr>
<th>BROKER</th>
<th>查询 EMQ 消息服务器描述、版本、启动时间</th>
</tr>
</thead>
<tbody><tr>
<td>broker</td>
<td>查询核心的 Erlang PubSub 进程状态(调试)</td>
</tr>
<tr>
<td>pubsub</td>
<td></td>
</tr>
<tr>
<td>broker</td>
<td>查询连接(Client)、会话(Session)、主题(Topic)、 订阅</td>
</tr>
<tr>
<td><br>(Subscription)、路由(Route)统计信息</td>
<td></td>
</tr>
<tr>
<td>stats</td>
<td></td>
</tr>
<tr>
<td>broker</td>
<td>查询 MQTT 报文(Packet)、消息(Message)收发统计</td>
</tr>
<tr>
<td>metrics</td>
<td></td>
</tr>
</tbody></table>
<p>查询 EMQ 消息服务器基本信息包括版本、启动时间等:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl broker</span><br><span class="line">sysdescr : Erlang MQTT Broker</span><br><span class="line">version : 2.3.6</span><br><span class="line">uptime : 25 days,3 hours, 38 minutes, 10 seconds</span><br><span class="line">datetime : 2018-08-08 16:52:08</span><br></pre></td></tr></table></figure>

<p>broker stats<br>查询服务器客户端连接(Client)、会话(Session)、主题(Topic)、订阅<br>(Subscription)、路由(Route)统计:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl broker stats</span><br><span class="line">clients/count : 519</span><br><span class="line">clients/max : 810</span><br><span class="line">retained/count : 3821</span><br><span class="line">retained/max : 3821</span><br><span class="line">routes/count : 557</span><br><span class="line">routes/max : 814</span><br><span class="line">sessions/count : 556</span><br><span class="line">sessions/max : 814</span><br><span class="line">subscribers/count : 1111</span><br><span class="line">subscribers/max : 1625</span><br><span class="line">subscriptions/count : 1111</span><br><span class="line">subscriptions/max : 1625</span><br><span class="line">topics/count : 557</span><br><span class="line">topics/max : 814</span><br></pre></td></tr></table></figure>

<p>broker metrics</p>
<p>查询服务器流量(Bytes)、MQTT报文(Packets)、消息(Messages)收发统计:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl broker metrics</span><br><span class="line">bytes/received : 1116429069</span><br><span class="line">bytes/sent : 1114027032</span><br><span class="line">messages/dropped : 50313</span><br><span class="line">messages/qos0/received : 0</span><br><span class="line">messages/qos0/sent : 0</span><br><span class="line">messages/qos1/received : 7837778</span><br><span class="line">messages/qos1/sent : 7954830</span><br><span class="line">messages/qos2/dropped : 0</span><br><span class="line">messages/qos2/received : 0</span><br><span class="line">messages/qos2/sent : 0</span><br><span class="line">messages/received : 7837778</span><br><span class="line">messages/retained : 3821</span><br><span class="line">messages/sent : 7954830</span><br><span class="line">packets/connack : 64632</span><br><span class="line">packets/connect : 67040</span><br><span class="line">packets/disconnect : 0</span><br><span class="line">packets/pingreq : 25769</span><br><span class="line">packets/pingresp : 25769</span><br><span class="line">packets/puback/missed : 402</span><br><span class="line">packets/puback/received : 7931899</span><br><span class="line">packets/puback/sent : 7837778</span><br><span class="line">packets/pubcomp/missed : 0</span><br><span class="line">packets/pubcomp/received: 0</span><br><span class="line">packets/pubcomp/sent : 0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">packets/publish/received: 7837778</span><br><span class="line">packets/publish/sent : 7954830</span><br><span class="line">packets/pubrec/missed : 0</span><br><span class="line">packets/pubrec/received : 0</span><br><span class="line">packets/pubrec/sent : 0</span><br><span class="line">packets/pubrel/missed : 0</span><br><span class="line">packets/pubrel/received : 0</span><br><span class="line">packets/pubrel/sent : 0</span><br><span class="line">packets/received : 15985446</span><br><span class="line">packets/sent : 16005957</span><br><span class="line">packets/suback : 122948</span><br><span class="line">packets/subscribe : 122960</span><br><span class="line">packets/unsuback : 0</span><br><span class="line">packets/unsubscribe : 0</span><br></pre></td></tr></table></figure>

<h5 id="④cluster-命令"><a href="#④cluster-命令" class="headerlink" title="④cluster 命令"></a>④cluster 命令</h5><p>cluster 命令集群多个 EMQ 消息服务器节点(进程):</p>
<table>
<thead>
<tr>
<th>CLUSTER JOIN</th>
<th>加入集群</th>
</tr>
</thead>
<tbody><tr>
<td>cluster leave</td>
<td>离开集群</td>
</tr>
<tr>
<td>cluster remove</td>
<td>从集群删除节点</td>
</tr>
<tr>
<td>cluster status</td>
<td>查询集群状态</td>
</tr>
</tbody></table>
<p>cluster 命令集群本机两个 EMQ 节点示例:</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>节点名</th>
<th>MQTT 端口</th>
</tr>
</thead>
<tbody><tr>
<td>emqttd1</td>
<td><a href="mailto:emqttd1@127.0.0.1" target="_blank" rel="noopener">emqttd1@127.0.0.1</a></td>
<td>1883</td>
</tr>
<tr>
<td>emqttd2</td>
<td><a href="mailto:emqttd2@127.0.0.1" target="_blank" rel="noopener">emqttd2@127.0.0.1</a></td>
<td>2883</td>
</tr>
</tbody></table>
<p>启动 emqttd1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd emqttd1 &amp;&amp; ./bin/emqttd start</span><br></pre></td></tr></table></figure>

<p>启动 emqttd2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd emqttd2 &amp;&amp; ./bin/emqttd start</span><br></pre></td></tr></table></figure>

<p>emqttd2 节点与 emqttd1 集群，emqttd2 目录下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl cluster join emqttd1@127.0.0.1</span><br><span class="line">Join the cluster successfully.</span><br><span class="line">Cluster status: [&#123;running_nodes,</span><br><span class="line">[&apos;emqttd1@127.0.0.1&apos;,&apos;emqttd2@127.0.0.1&apos;]&#125;]</span><br></pre></td></tr></table></figure>

<p>任意节点目录下查询集群状态:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl cluster status</span><br><span class="line">Cluster status: [&#123;running_nodes,</span><br><span class="line">[&apos;emqttd2@127.0.0.1&apos;,&apos;emqttd1@127.0.0.1&apos;]&#125;]</span><br></pre></td></tr></table></figure>

<p>集群消息路由测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># emqttd1节点上订阅x</span><br><span class="line"></span><br><span class="line">mosquitto_sub -t x -q 1 -p 1883</span><br><span class="line"></span><br><span class="line"># emqttd2节点上向x发布消息</span><br><span class="line"></span><br><span class="line">mosquitto_pub -t x -q 1 -p 2883 -m hello</span><br></pre></td></tr></table></figure>

<p>emqttd2 节点离开集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd emqttd2 &amp;&amp; ./bin/emqttd_ctl cluster leave</span><br></pre></td></tr></table></figure>

<p>emqttd1 节点下删除 emqttd2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd emqttd1 &amp;&amp; ./bin/emqttd_ctl cluster remove</span><br><span class="line">emqttd2@127.0.0.1</span><br></pre></td></tr></table></figure>

<h5 id="⑤clients-命令"><a href="#⑤clients-命令" class="headerlink" title="⑤clients 命令"></a>⑤clients 命令</h5><p>clients 命令查询连接的 MQTT 客户端。</p>
<table>
<thead>
<tr>
<th>CLIENTS LIST</th>
<th>查询全部客户端连接</th>
</tr>
</thead>
<tbody><tr>
<td>clients show</td>
<td>根据 ClientId 查询客户端</td>
</tr>
<tr>
<td>clients kick</td>
<td>根据 ClientId 踢出客户端</td>
</tr>
</tbody></table>
<p>clients list<br>查询全部客户端连接:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl clients list</span><br><span class="line">Client(867967027640038, clean_sess=false,</span><br><span class="line">username=tt867967027640038,</span><br><span class="line">peername=223.104.255.3:11240, connected_at=1533698992)</span><br><span class="line">Client(egege_web_1_1, clean_sess=true,</span><br><span class="line">username=egege_web, peername=10.161.139.95:47564,</span><br><span class="line">connected_at=1533022825)</span><br><span class="line">Client(sc_vmims_01_2_1, clean_sess=true, username=vmims,</span><br><span class="line">peername=10.161.139.95:39606, connected_at=1533559450)</span><br></pre></td></tr></table></figure>

<p>返回 Client 对象的属性:</p>
<table>
<thead>
<tr>
<th>CLEAN_SESS</th>
<th>清除会话标记</th>
</tr>
</thead>
<tbody><tr>
<td>username</td>
<td>用户名</td>
</tr>
<tr>
<td>peername</td>
<td>对端 TCP 地址</td>
</tr>
<tr>
<td>connected_at</td>
<td>客户端连接时间</td>
</tr>
</tbody></table>
<p>clients show<br>根据 ClientId 查询客户端:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl clients show &quot;867967027640038&quot;</span><br><span class="line">Client(867967027640038, clean_sess=false,</span><br><span class="line">username=tt867967027640038,</span><br><span class="line">peername=223.104.255.3:11240, connected_at=1533698992)</span><br></pre></td></tr></table></figure>

<p>clients kick<br>根据 ClientId 踢出客户端:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl clients kick &quot;867967027640038&quot;</span><br></pre></td></tr></table></figure>

<h5 id="⑥sessions-命令"><a href="#⑥sessions-命令" class="headerlink" title="⑥sessions 命令"></a>⑥sessions 命令</h5><p>sessions 命令查询 MQTT 连接会话。EMQ 消息服务器会为每个连接创建会<br>话。创建临时(transient)会话 –&gt; clean_session 标记 true；创建持久会话<br>(persistent) –&gt; clean_session 标记为 false。</p>
<table>
<thead>
<tr>
<th>SESSIONS LIST</th>
<th>查询全部会话</th>
</tr>
</thead>
<tbody><tr>
<td>sessions list persistent</td>
<td>查询全部持久会话</td>
</tr>
<tr>
<td>sessions list transient</td>
<td>查询全部临时会话</td>
</tr>
<tr>
<td>sessions show</td>
<td>根据 ClientID 查询会话</td>
</tr>
</tbody></table>
<p>sessions list</p>
<p>查询全部会话:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl sessions list</span><br><span class="line">Session(867967027640038, clean_sess=false,</span><br><span class="line">subscriptions=2, max_inflight=2, inflight=0,</span><br><span class="line">mqueue_len=0, mqueue_dropped=0, awaiting_rel=0,</span><br><span class="line">deliver_msg=2, enqueue_msg=0, created_at=1533619718)</span><br><span class="line">Session(egege_web_1_1, clean_sess=true, subscriptions=2,</span><br><span class="line">max_inflight=2, inflight=0, mqueue_len=0,</span><br><span class="line">mqueue_dropped=800, awaiting_rel=0, deliver_msg=3157831,</span><br><span class="line">enqueue_msg=40061, created_at=1533022825)</span><br><span class="line">Session(sc_vmims_01_2_1, clean_sess=true,</span><br><span class="line">subscriptions=1, max_inflight=2, inflight=0,</span><br><span class="line">mqueue_len=0, mqueue_dropped=899, awaiting_rel=0,</span><br><span class="line">deliver_msg=5115, enqueue_msg=1942,</span><br><span class="line">created_at=1533559450)</span><br></pre></td></tr></table></figure>

<p>返回 Session 对象属性:</p>
<table>
<thead>
<tr>
<th>CLEAN_SESS</th>
<th>FALSE: 持久会话，TRUE: 临时会话</th>
</tr>
</thead>
<tbody><tr>
<td>max_inflight</td>
<td>飞行窗口(最大允许同时下发消息数)</td>
</tr>
<tr>
<td>inflight_queue</td>
<td>当前正在下发的消息数</td>
</tr>
<tr>
<td>message_queue</td>
<td>当前缓存消息数</td>
</tr>
<tr>
<td>message_dropped</td>
<td>会话丢掉的消息数</td>
</tr>
<tr>
<td>awaiting_rel</td>
<td>等待客户端发送 PUBREL 的 QoS2 消息数</td>
</tr>
<tr>
<td>awaiting_ack</td>
<td>等待客户端响应 PUBACK 的 QoS1/2 消息数</td>
</tr>
<tr>
<td>awaiting_comp</td>
<td>等待客户端响应 PUBCOMP 的 QoS2 消息数</td>
</tr>
<tr>
<td>created_at</td>
<td>会话创建时间戳</td>
</tr>
</tbody></table>
<p>sessions list persistent<br>查询全部持久会话:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl sessions list persistent</span><br><span class="line">Session(867967027640038, clean_sess=false,</span><br><span class="line">subscriptions=2, max_inflight=2, inflight=0,</span><br><span class="line">mqueue_len=0, mqueue_dropped=0, awaiting_rel=0,</span><br><span class="line">deliver_msg=2, enqueue_msg=0, created_at=1533619718)</span><br></pre></td></tr></table></figure>

<p>sessions list transient<br>查询全部临时会话:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl sessions list transient</span><br><span class="line">Session(mosqsub/44101-airlee.lo, clean_sess=true,</span><br><span class="line">max_inflight=100, inflight_queue=0, message_queue=0,</span><br><span class="line">message_dropped=0, awaiting_rel=0, awaiting_ack=0,</span><br><span class="line">awaiting_comp=0, created_at=1452935401)</span><br></pre></td></tr></table></figure>

<p>sessions show<br>根据 ClientId 查询会话:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl sessions list transient</span><br><span class="line">Session(egege_web_1_1, clean_sess=true, subscriptions=2,</span><br><span class="line">max_inflight=2, inflight=2, mqueue_len=0,</span><br><span class="line">mqueue_dropped=800, awaiting_rel=0, deliver_msg=3159156,</span><br><span class="line">enqueue_msg=40071, created_at=1533022825)</span><br><span class="line">Session(sc_vmims_01_2_1, clean_sess=true,</span><br><span class="line">subscriptions=1, max_inflight=2, inflight=0,</span><br><span class="line">mqueue_len=0, mqueue_dropped=899, awaiting_rel=0,</span><br><span class="line">deliver_msg=5126, enqueue_msg=1942,</span><br><span class="line">created_at=1533559450)</span><br></pre></td></tr></table></figure>

<h5 id="⑦routes-命令"><a href="#⑦routes-命令" class="headerlink" title="⑦routes 命令"></a>⑦routes 命令</h5><p>routes 命令查询路由表。<br>routes list<br>查询全部路由:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl routes list</span><br><span class="line">terminal/server/866855039562970 -&gt;</span><br><span class="line">emq_sc_01@10.24.253.192</span><br><span class="line">terminal/+/health -&gt; emq_sc_01@10.24.253.192</span><br><span class="line">terminal/client/+ -&gt; emq_sc_01@10.24.253.192</span><br><span class="line">terminal/server/event/100 -&gt; emq_sc_01@10.24.253.192</span><br></pre></td></tr></table></figure>

<h5 id="⑧topics-命令"><a href="#⑧topics-命令" class="headerlink" title="⑧topics 命令"></a>⑧topics 命令</h5><p>topics 命令查询当前的主题(Topic)表。<br>topics list<br>查询全部主题(Topic):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl topics list</span><br><span class="line">terminal/server/866855039410527</span><br><span class="line">terminal/client/+</span><br><span class="line">terminal/+/health</span><br></pre></td></tr></table></figure>

<p>topics show<br>查询某个主题(Topic):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl topics show &apos;$SYS/brokers&apos;</span><br><span class="line">$SYS/brokers: static</span><br></pre></td></tr></table></figure>

<h5 id="⑨subscriptions-命令"><a href="#⑨subscriptions-命令" class="headerlink" title="⑨subscriptions 命令"></a>⑨subscriptions 命令</h5><p>subscriptions 命令查询消息服务器的订阅(Subscription)表。</p>
<table>
<thead>
<tr>
<th>SUBSCRIPTIONS LIST</th>
<th>查询全部订阅</th>
</tr>
</thead>
<tbody><tr>
<td>subscriptions show</td>
<td>查询某个 ClientId 的订阅</td>
</tr>
</tbody></table>
<p>subscriptions list<br>查询全部订阅:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl subscriptions list</span><br><span class="line">867187036659701&lt;10186.9605.17&gt; -&gt;</span><br><span class="line">terminal/server/event/100</span><br><span class="line">867187036659701&lt;10186.9605.17&gt; -&gt;</span><br><span class="line">terminal/server/867187036659701</span><br></pre></td></tr></table></figure>

<p>subscriptions show<br>查询某个 Client 的订阅:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl subscriptions show 867967027640038</span><br><span class="line">867967027640038&lt;10186.17806.17&gt; -&gt;</span><br><span class="line">terminal/server/867967027640038</span><br><span class="line">qos : 1</span><br><span class="line">867967027640038&lt;10186.17806.17&gt; -&gt;</span><br><span class="line">terminal/server/event/100</span><br><span class="line">qos : 1</span><br></pre></td></tr></table></figure>

<h5 id="⑩plugins-命令"><a href="#⑩plugins-命令" class="headerlink" title="⑩plugins 命令"></a>⑩plugins 命令</h5><p>plugins 命令用于加载、卸载、查询插件应用。EMQ 消息服务器通过插件扩展<br>认证、定制功能，插件置于 plugins/ 目录下。</p>
<table>
<thead>
<tr>
<th>PLUGINS LIST</th>
<th>列出全部插件(PLUGIN)</th>
</tr>
</thead>
<tbody><tr>
<td>plugins load</td>
<td>加载插件(Plugin)</td>
</tr>
<tr>
<td>plugins unload</td>
<td>卸载插件(Plugin)</td>
</tr>
</tbody></table>
<p>plugins list<br>列出全部插件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl plugins list</span><br><span class="line">Plugin(emq_auth_clientid, version=2.3.6,</span><br><span class="line">description=Authentication with ClientId/Password,</span><br><span class="line">active=false)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Plugin(emq_auth_http, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with HTTP API,</span><br><span class="line">active=false)</span><br><span class="line">Plugin(emq_auth_jwt, version=2.3.6,</span><br><span class="line">description=Authentication with JWT, active=false)</span><br><span class="line">Plugin(emq_auth_ldap, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with LDAP, active=false)</span><br><span class="line">Plugin(emq_auth_mongo, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with MongoDB,</span><br><span class="line">active=false)</span><br><span class="line">Plugin(emq_auth_mysql, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with MySQL, active=true)</span><br><span class="line">Plugin(emq_auth_pgsql, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with PostgreSQL,</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">active=false)</span><br><span class="line">Plugin(emq_auth_redis, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with Redis, active=false)</span><br><span class="line">Plugin(emq_auth_username, version=2.3.6,</span><br><span class="line">description=Authentication with Username/Password,</span><br><span class="line">active=false)</span><br><span class="line">Plugin(emq_coap, version=2.3.6, description=CoAP</span><br><span class="line">Gateway, active=false)</span><br><span class="line">Plugin(emq_dashboard, version=2.3.6, description=EMQ Web</span><br><span class="line">Dashboard, active=true)</span><br><span class="line">Plugin(emq_lua_hook, version=2.3.6, description=EMQ</span><br><span class="line">Hooks in lua, active=false)</span><br><span class="line">Plugin(emq_modules, version=2.3.6, description=EMQ</span><br><span class="line">Modules, active=true)</span><br><span class="line">Plugin(emq_plugin_template, version=2.3.6,</span><br><span class="line">description=EMQ Plugin Template, active=false)</span><br><span class="line">Plugin(emq_recon, version=2.3.6, description=Recon</span><br><span class="line">Plugin, active=true)</span><br><span class="line">Plugin(emq_reloader, version=2.3.6, description=Reloader</span><br><span class="line">Plugin, active=false)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Plugin(emq_retainer, version=2.3.6, description=EMQ</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Retainer, active=true)</span><br><span class="line">Plugin(emq_sn, version=2.3.6, description=MQTT-SN</span><br><span class="line">Gateway, active=false)</span><br><span class="line">Plugin(emq_stomp, version=2.3.6, description=Stomp</span><br><span class="line">Protocol Plugin, active=false)</span><br><span class="line">Plugin(emq_web_hook, version=2.3.6, description=EMQ</span><br><span class="line">Webhook Plugin, active=false)</span><br></pre></td></tr></table></figure>

<p>插件属性:</p>
<table>
<thead>
<tr>
<th>VERSION</th>
<th>插件版本</th>
</tr>
</thead>
<tbody><tr>
<td>description</td>
<td>插件描述</td>
</tr>
<tr>
<td>active</td>
<td>是否已加载</td>
</tr>
</tbody></table>
<p>load<br>加载插件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl plugins load emq_lua_hook</span><br><span class="line">Start apps: [emq_lua_hook]</span><br><span class="line">Plugin emq_lua_hook loaded successfully.</span><br></pre></td></tr></table></figure>

<p>unload<br>卸载插件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp emqttd]$ ./bin/emqttd_ctl plugins unload</span><br><span class="line">emq_lua_hook</span><br><span class="line">Plugin emq_lua_hook unloaded successfully.</span><br></pre></td></tr></table></figure>

<h5 id="⑩-①bridges-命令"><a href="#⑩-①bridges-命令" class="headerlink" title="⑩+①bridges 命令"></a>⑩+①bridges 命令</h5><p>bridges 命令用于在多台 EMQ 服务器节点间创建桥接:</p>
<hr>
<p>Publisher –&gt; | node1 | –Bridge Forward–&gt; | node2 | –&gt;<br>Subscriber</p>
<hr>
<table>
<thead>
<tr>
<th>BRIDGES LIST</th>
<th>查询全部桥接</th>
</tr>
</thead>
<tbody><tr>
<td>bridges options</td>
<td>查询创建桥接选项</td>
</tr>
<tr>
<td>bridges start</td>
<td>创建桥接</td>
</tr>
<tr>
<td>bridges start</td>
<td>创建桥接并带选项设置</td>
</tr>
<tr>
<td>bridges stop</td>
<td>删除桥接</td>
</tr>
</tbody></table>
<p>创建一条 emqttd1 -&gt; emqttd2 节点的桥接，转发传感器主题(Topic)消息到<br>emqttd2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl bridges start emqttd2@127.0.0.1</span><br><span class="line">sensor/#</span><br><span class="line">bridge is started.</span><br><span class="line">$ ./bin/emqttd_ctl bridges list</span><br><span class="line">bridge: emqttd1@127.0.0.1--sensor/#--&gt;emqttd2@127.0.0.1</span><br></pre></td></tr></table></figure>

<p>测试 emqttd1–sensor/#–&gt;emqttd2 的桥接:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#emqttd2节点上</span><br><span class="line">mosquitto_sub -t sensor/# -p 2883 -d</span><br><span class="line">#emqttd1节点上</span><br><span class="line">mosquitto_pub -t sensor/1/temperature -m &quot;37.5&quot; -d</span><br></pre></td></tr></table></figure>

<p>bridge options<br>查询 bridge 创建选项设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl bridges options</span><br><span class="line">Options:</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qos = 0 | 1 | 2</span><br><span class="line">prefix = string</span><br><span class="line">suffix = string</span><br><span class="line">queue = integer</span><br><span class="line">Example:</span><br><span class="line">qos=2,prefix=abc/,suffix=/yxz,queue=1000</span><br></pre></td></tr></table></figure>

<p>bridges stop<br>删除 emqttd1–sensor/#–&gt;emqttd2 的桥接:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl bridges stop emqttd2@127.0.0.1</span><br><span class="line">sensor/#</span><br><span class="line">bridge is stopped.</span><br></pre></td></tr></table></figure>

<h5 id="⑩-②vm-命令"><a href="#⑩-②vm-命令" class="headerlink" title="⑩+②vm 命令"></a>⑩+②vm 命令</h5><p>vm 命令用于查询 Erlang 虚拟机负载、内存、进程、IO 信息。</p>
<table>
<thead>
<tr>
<th>VM ALL</th>
<th>查询 VM 全部信息</th>
</tr>
</thead>
<tbody><tr>
<td>vm load</td>
<td>查询 VM 负载</td>
</tr>
<tr>
<td>vm memory</td>
<td>查询 VM 内存</td>
</tr>
<tr>
<td>vm process</td>
<td>查询 VM Erlang 进程数量</td>
</tr>
<tr>
<td>vm io</td>
<td>查询 VM io 最大文件句柄</td>
</tr>
</tbody></table>
<p>vm all</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm all</span><br><span class="line">cpu/load1 : 0.00</span><br><span class="line">cpu/load5 : 0.03</span><br><span class="line">cpu/load15 : 0.05</span><br><span class="line">memory/total : 61039832</span><br><span class="line">memory/processes : 10484664</span><br><span class="line">memory/processes_used : 10482256</span><br><span class="line">memory/system : 50555168</span><br><span class="line">memory/atom : 1213657</span><br><span class="line">memory/atom_used : 1196893</span><br><span class="line">memory/binary : 1478648</span><br><span class="line">memory/code : 28024188</span><br><span class="line">memory/ets : 7885264</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">process/limit : 262144</span><br><span class="line">process/count : 1437</span><br><span class="line">io/max_fds : 65535</span><br><span class="line">io/active_fds : 1</span><br><span class="line">ports/count : 571</span><br><span class="line">ports/limit : 65536</span><br></pre></td></tr></table></figure>

<p>vm load<br>查询 VM 负载:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm load</span><br><span class="line">cpu/load1 : 0.21</span><br><span class="line">cpu/load5 : 0.07</span><br><span class="line">cpu/load15 : 0.06</span><br></pre></td></tr></table></figure>

<p>vm memory<br>查询 VM 内存:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm memory</span><br><span class="line">memory/total : 61099792</span><br><span class="line">memory/processes : 10540696</span><br><span class="line">memory/processes_used : 10539864</span><br><span class="line">memory/system : 50559096</span><br><span class="line">memory/atom : 1213657</span><br><span class="line">memory/atom_used : 1196963</span><br><span class="line">memory/binary : 1470992</span><br><span class="line">memory/code : 28024188</span><br><span class="line">memory/ets : 7891376</span><br></pre></td></tr></table></figure>

<p>vm process<br>查询 Erlang 进程数量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm process</span><br><span class="line">process/limit : 262144</span><br><span class="line">process/count : 1443</span><br></pre></td></tr></table></figure>

<p>vm io</p>
<p>查询 IO 最大句柄数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm io</span><br><span class="line">io/max_fds : 65535</span><br><span class="line">io/active_fds : 1</span><br></pre></td></tr></table></figure>

<h5 id="⑩-③trace-命令"><a href="#⑩-③trace-命令" class="headerlink" title="⑩+③trace 命令"></a>⑩+③trace 命令</h5><p>trace 命令用于追踪某个客户端或 Topic，打印日志信息到文件。</p>
<table>
<thead>
<tr>
<th>TRACE LIST</th>
<th>查询全部开启的追踪</th>
</tr>
</thead>
<tbody><tr>
<td>trace client</td>
<td>开启 Client 追踪，日志到文件</td>
</tr>
<tr>
<td>trace client off</td>
<td>关闭 Client 追踪</td>
</tr>
<tr>
<td>trace topic</td>
<td>开启 Topic 追踪，日志到文件</td>
</tr>
<tr>
<td>trace topic off</td>
<td>关闭 Topic 追踪</td>
</tr>
</tbody></table>
<p>trace client<br>开启 Client 追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace client 867967027640038 demolog</span><br><span class="line">trace client 867967027640038 successfully.</span><br><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace list</span><br><span class="line">trace client 867967027640038 -&gt; demolog</span><br></pre></td></tr></table></figure>

<p>trace client off<br>关闭 Client 追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace client 867967027640038 off</span><br><span class="line">stop tracing client 867967027640038 successfully.</span><br><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace list</span><br></pre></td></tr></table></figure>

<p>trace topic<br>开启 Topic 追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace client terminal/client/+</span><br><span class="line">demolog</span><br><span class="line">trace client terminal/client/+ successfully.</span><br><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace list</span><br><span class="line">trace client terminal/client/+ -&gt; demolog</span><br></pre></td></tr></table></figure>

<p>trace topic off<br>关闭 Topic 追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace client terminal/client/+ off</span><br><span class="line">stop tracing client terminal/client/+ successfully.</span><br></pre></td></tr></table></figure>

<p>trace list<br>列出全部开启的追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace list</span><br><span class="line">trace client terminal/client/+ -&gt; demolog</span><br></pre></td></tr></table></figure>

<h5 id="⑩-④listeners"><a href="#⑩-④listeners" class="headerlink" title="⑩+④listeners"></a>⑩+④listeners</h5><p>listeners 命令用于查询开启的 TCP 服务监听器:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./bin/emqttd_ctl listeners</span><br><span class="line">listener on mqtt:api:0.0.0.0:8080</span><br><span class="line">acceptors : 4</span><br><span class="line">max_clients : 64</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br><span class="line">listener on mqtt:wss:8084</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">acceptors : 4</span><br><span class="line">max_clients : 64</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br><span class="line">listener on mqtt:ssl:8883</span><br><span class="line">acceptors : 16</span><br><span class="line">max_clients : 1024</span><br><span class="line">current_clients : 0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown_count : [&#123;auth_failure,2&#125;,&#123;closed,1&#125;]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listener on mqtt:ws:8083</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">acceptors : 4</span><br><span class="line">max_clients : 102400</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br><span class="line">listener on mqtt:tcp:0.0.0.0:1883</span><br><span class="line">acceptors : 16</span><br><span class="line">max_clients : 102400</span><br><span class="line">current_clients : 547</span><br><span class="line">shutdown_count : [&#123;idle_timeout,73588&#125;,</span><br><span class="line">&#123;keepalive_timeout,39659&#125;,&#123;conflict,19126&#125;,</span><br><span class="line">&#123;protocol_bad_connect,2413&#125;,&#123;closed,298&#125;,</span><br><span class="line">&#123;parser_error,5&#125;,&#123;auth_failure,2386&#125;]</span><br><span class="line">listener on mqtt:tcp:127.0.0.1:11883</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">acceptors : 4</span><br><span class="line">max_clients : 102400</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br><span class="line">listener on dashboard:http:18083</span><br><span class="line">acceptors : 4</span><br><span class="line">max_clients : 512</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br></pre></td></tr></table></figure>

<p>listener 参数说明:</p>
<table>
<thead>
<tr>
<th>ACCEPTORS</th>
<th>TCP ACCEPTOR 池</th>
</tr>
</thead>
<tbody><tr>
<td>max_clients</td>
<td>最大允许连接数</td>
</tr>
<tr>
<td>current_clients</td>
<td>当前连接数</td>
</tr>
<tr>
<td>shutdown_count</td>
<td>Socket 关闭原因统计</td>
</tr>
</tbody></table>
<p>重启监听端口:<br>listeners restart</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl listeners restart mqtt:tcp</span><br><span class="line">127.0.0.1:11883</span><br><span class="line">Restart mqtt:tcp listener on 127.0.0.1:11883</span><br><span class="line">successfully.</span><br></pre></td></tr></table></figure>

<p>停止监听端口:<br>listeners stop</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$ [emqtt@lp</span><br><span class="line">emqttd]$ ./bin/emqttd_ctl listeners stop mqtt:tcp</span><br><span class="line">127.0.0.1:11883</span><br><span class="line">Stop mqtt:tcp listener on 127.0.0.1:11883 successfully.</span><br></pre></td></tr></table></figure>

<p>一旦停止无法启动，需要重启emq</p>
<h5 id="⑩-⑤mnesia-命令"><a href="#⑩-⑤mnesia-命令" class="headerlink" title="⑩+⑤mnesia 命令"></a>⑩+⑤mnesia 命令</h5><p>查询 mnesia 数据库系统状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl mnesia</span><br><span class="line">===&gt; System info in version &quot;4.15&quot;, debug level = none</span><br><span class="line">&lt;===</span><br><span class="line">opt_disc. Directory</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;/home/emqtt/emqttd/data/mnesia/emq@127.0.0.1&quot; is used.</span><br><span class="line">use fallback at restart = false</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">running db nodes = [&apos;emq@127.0.0.1&apos;]</span><br><span class="line">stopped db nodes = []</span><br><span class="line">master node tables = []</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remote = []</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ram_copies =</span><br><span class="line">[mqtt_retained,mqtt_route,mqtt_session,mqtt_trie,</span><br><span class="line">mqtt_trie_node]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">disc_copies = [mqtt_admin,schema]</span><br><span class="line">disc_only_copies = [][&#123;&apos;emq@127.0.0.1&apos;,disc_copies&#125;] = [mqtt_admin,schema][&#123;&apos;emq@127.0.0.1&apos;,ram_copies&#125;] =</span><br><span class="line">[mqtt_retained,mqtt_route,mqtt_trie_node,</span><br><span class="line">mqtt_trie,mqtt_session]</span><br><span class="line">2 transactions committed, 8 aborted, 0 restarted, 0</span><br><span class="line">logged to disc</span><br><span class="line">0 held locks, 0 in queue; 0 local transactions, 0 remote</span><br><span class="line">0 transactions waits for other nodes: []</span><br></pre></td></tr></table></figure>

<h5 id="⑩-⑥admins-命令"><a href="#⑩-⑥admins-命令" class="headerlink" title="⑩+⑥admins 命令"></a>⑩+⑥admins 命令</h5><p>Dashboard 插件会自动注册 admins 命令，用于创建、删除管理员账号，重置<br>管理员密码。</p>
<table>
<thead>
<tr>
<th>ADMINS ADD</th>
<th>创建 ADMIN 账号</th>
</tr>
</thead>
<tbody><tr>
<td>admins passwd</td>
<td>重置 admin 密码</td>
</tr>
<tr>
<td>ADMINS ADD</td>
<td>创建 ADMIN 账号</td>
</tr>
<tr>
<td>admins del</td>
<td>删除 admin 账号</td>
</tr>
</tbody></table>
<p>admins add<br>创建 admin 账户:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl admins add zhendong 666666</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<p>admins passwd<br>重置 admin 账户密码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl admins passwd zhendong 666</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<p>admins del<br>删除 admin 账户:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl admins del zhendong</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>


  </div>
  <footer class="article-footer">
    
  <div class="cc">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/deed.en" target="_blank" title="Attribution-ShareAlike">
      <img src="/images/cc/cc.png">
      
          <img src="/images/cc/by.png">
        
          <img src="/images/cc/sa.png">
      
      <span>
        This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.
      </span>
    </a>
  </div>


    

  </footer>
</article>







          <div class="main-footer">
  
    © 2020 bibi - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

</body>
</html>
