<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Archive
  
</title>

<meta name="description" content="Testing website">
<meta property="og:type" content="website">
<meta property="og:title" content="bibi">
<meta property="og:url" content="http://yxbibi.com/archives/page/2/index.html">
<meta property="og:site_name" content="bibi">
<meta property="og:description" content="Testing website">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="bibi">
<meta name="twitter:description" content="Testing website">


  <link rel="alternative" href="/atom.xml" title="bibi" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">






</head>
<body class="monochrome">
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">bibi</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">bibi</a></h1>
    
    <div class="info">
      <div class="content">
        
          <div class="description">Testing website</div>
        
        
          <div class="author">Mode</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://cn.gravatar.com/avatar/35fef74d731255cd569c2c2b0b9e87e4?s=200"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">Category</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openresty/">Openresty</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zabbix/">Zabbix</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/centos/">centos</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/centos7/">centos7</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rsync/">rsync</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/text/">text</a><span class="category-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS服务器搭建/">DNS服务器搭建</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELK/">ELK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EMQ/">EMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Filebeat/">Filebeat</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JumpServer/">JumpServer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KONG/">KONG</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LVM/">LVM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memcached/">Memcached</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openresty/">Openresty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PXE-Kickstart-Cobbler/">PXE+Kickstart+Cobbler</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis3/">Redis3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rsync-inotify/">Rsync+inotify</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/">Zabbix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/app-install/">app install</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bibi/">bibi</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos7/">centos7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ftp虚拟用户创建过程/">ftp虚拟用户创建过程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hello/">hello</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lvm/">lvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rsync/">rsync</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">Archive</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">30</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/niubiya/bibi" title="bibi" target="_blank" rel="noopener">bibi</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/niubiya" title="niubiya" target="_blank" rel="noopener">niubiya</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          

  
  
    
      
      
      <section class="archives-wrap">
        <div class="archive-year-wrap">
          <h1><a href="/archives/2019" class="archive-year">2019</a></h1>
        </div>
        <div class="post-list">
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/13/Tomcat调优/">
  Tomcat
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/13/Tomcat调优/"><span class="article-date">
  2019-08-13
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/Tomcat/">Tomcat</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tomcat/">Tomcat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="Tomcat调优"><a href="#Tomcat调优" class="headerlink" title="Tomcat调优"></a>Tomcat调优</h1><h2 id="一、Tomcat简介"><a href="#一、Tomcat简介" class="headerlink" title="一、Tomcat简介"></a>一、Tomcat简介</h2><h3 id="①工作方式选择"><a href="#①工作方式选择" class="headerlink" title="①工作方式选择"></a>①工作方式选择</h3><p>为了提升性能，首先就要对代码进行动静分离，让 Tomcat 只负责 jsp 文件的<br>解析工作。如采用 Apache 和 Tomcat 的整合方式，他们之间的连接方案有三<br>种选择，JK、http_proxy 和 ajp_proxy。相对于 JK 的连接方式，后两种在配<br>置上比较简单的，灵活性方面也一点都不逊色。但就稳定性而言不像JK 这样<br>久经考验，所以建议采用 JK 的连接方式。</p>
<h3 id="②Connector-连接器的配置"><a href="#②Connector-连接器的配置" class="headerlink" title="②Connector 连接器的配置"></a>②Connector 连接器的配置</h3><p>之前文件介绍过的 Tomcat 连接器的三种方式： bio、nio 和 apr，三种方式<br>性能差别很大，apr 的性能最优， bio 的性能最差。而 Tomcat 7 使用的<br>Connector 默认就启用的 Apr 协议，但需要系统安装 Apr 库，否则就会使用<br>bio 方式。</p>
<h3 id="③配置文件优化"><a href="#③配置文件优化" class="headerlink" title="③配置文件优化"></a>③配置文件优化</h3><p>配置文件优化其实就是对 server.xml 优化，可以提大大提高 Tomcat 的处理<br>请求的能力，下面我们来看 Tomcat 容器内的优化。<br>默认配置下，Tomcat 会为每个连接器创建一个绑定的线程池（最大线程数<br>200），服务启动时，默认创建了 5 个空闲线程随时等待用户请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server&gt;代表整个Servlet容器组件，是最顶层元素，可以包含一个或多个</span><br><span class="line">&lt;Service&gt;元素</span><br><span class="line">&lt;Service&gt;包含一个&lt;Engine&gt;元素以及一个或多个</span><br><span class="line">&lt;Connector&gt;元素，这些&lt;Connector&gt;共享一个&lt;Engine&gt;</span><br><span class="line">&lt;Connector/&gt;代表和客户程序实际交互的组件，负责接收</span><br><span class="line">客户请求，以及向客户返回响应</span><br><span class="line">&lt;Engine&gt;每个&lt;Service&gt;元素只能包含一个&lt;Engine&gt;元</span><br><span class="line">素，它处理在同一个&lt;Service&gt;中所有&lt;Connector&gt;接收到的客户请求</span><br><span class="line">&lt;Host&gt;在一个&lt;Engine&gt;中可以包含多个</span><br><span class="line">&lt;Host&gt;,它代表一个虚拟主机(即一个服务器程序可以部署在多个有不同IP的</span><br><span class="line">服务器主机上)，它可以包含一个或多个应用</span><br><span class="line">&lt;Context&gt;使用最频繁的元素，代</span><br><span class="line">表了运行在虚拟主机上的单个web应用</span><br><span class="line">&lt;/Host&gt;</span><br><span class="line">&lt;/Engine&gt;</span><br><span class="line">&lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br></pre></td></tr></table></figure>

<h2 id="二、优化"><a href="#二、优化" class="headerlink" title="二、优化"></a>二、优化</h2><h3 id="1-隐藏HTTP头部信息"><a href="#1-隐藏HTTP头部信息" class="headerlink" title="1.隐藏HTTP头部信息"></a>1.隐藏HTTP头部信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sc_vmims@replenishment apache-tomcat-8.5.9]$ vim</span><br><span class="line">conf/server.xml</span><br><span class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">server=&quot;Egaga-Web&quot;/&gt;</span><br><span class="line">&lt;!-- 主要是 server的配置 记得nginx那里也需要配置，</span><br><span class="line">尤其是响应头的nginx的server信息--&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-Connector的配置"><a href="#2-Connector的配置" class="headerlink" title="2.Connector的配置"></a>2.Connector的配置</h3><p>通过ps -Lf pid |wc -l 统计当前vmism的线程数是81，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=&quot;9905&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">minSpareThreads=&quot;15&quot;</span><br><span class="line">maxConnections=&quot;475&quot;</span><br><span class="line">maxThreads=&quot;1000&quot;</span><br><span class="line">enableLookups=&quot;false&quot;</span><br><span class="line">acceptAccount=&quot;300&quot;</span><br><span class="line">acceptCount=&quot;1000&quot;</span><br><span class="line">connectionUploadTimeout=&quot;150000&quot;</span><br><span class="line">disableUploadTimeout=&quot;false&quot;</span><br><span class="line">connectionTimeout=&quot;20000&quot;</span><br><span class="line">keepAliveTimeout=&quot;120000&quot;</span><br><span class="line"></span><br><span class="line">maxKeepAliveRequests=&quot;1000&quot;</span><br><span class="line">URIEncoding=&quot;UTF-8&quot;</span><br><span class="line">tcpNoDelay=&quot;ture&quot;</span><br><span class="line">server=&quot;Egaga-Web&quot;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>其中和最大连接数相关的参数为maxThreads 和 acceptCount 。如果要加大<br>并发连接数，应同时加大这两个参数。<br>allowTrace：是否禁用http trace方法，默认值fales<br>asyncTimeout：异步请求的默认超时时间（以毫秒为单位）。 如果未指定，<br>则此属性设置为默认值为30000（30秒）<br>maxHeaderCount：容器允许的请求中的最大header数。 包含比指定限制更<br>多的header的请求将被拒绝。 小于0表示无限制，默认值100。<br>maxParameterCount：POST的最大值（以字节为单位），将由容器FORM<br>URL参数解析来处理。若小于0则不限制，默认为2097152（2MB）。 请注<br>意，FailedRequestFilter可用于拒绝超出此限制的请求。<br>maxPostSize：在FORM或CLIENT-CERT身份验证期间，将由容器保存/缓冲<br>的POST的最大大小（以字节为单位）。 对于这两种类型的身份验证，POST<br>将在用户进行身份验证之前进行保存/缓冲。 对于CLIENT-CERT认证，POST<br>在SSL握手期间进行缓冲，缓冲区在处理请求时清空。 对于FORM身份验证，<br>POST将被保存，同时用户被重定向到登录表单，并保留，直到用户成功认证<br>或与身份验证请求相关联的会话过期。 可以通过将此属性设置为-1来禁用该<br>限制。 将属性设置为零将在身份验证期间禁用POST数据的保存。 如果未指<br>定，此属性设置为4096（4kb）<br>acceptorThreadCount：用于接受连接的线程数。 在多CPU机器上增加此<br>值，尽管您绝对不会需要超过2.另外，通过大量的非保持活动连接，您也可以<br>增加此值。 默认值为1。<br>maxConnections：服务器在任何给定时间接受和处理的最大连接数。当达到<br>这个数字时，服务器将接受一个进一步的连接，但不会处理。这个附加连接将<br>被阻塞，直到正在处理的连接数降到maxConnections以下，服务器再次开始<br>接受并重新处理新的连接。请注意，一旦达到限制，操作系统仍然可以接受基<br>于acceptCount设置的连接。默认值因连接器类型而异。对于BIO，默认值是<br>maxThreads的值，除非使用Executor，在这种情况下，默认值将是执行器的<br>maxThreads值。对于NIO和NIO2，默认值为10000.对于APR / native，默认值<br>为8192。请注意，对于Windows上的APR / native，配置的值将减少到小于或<br>等于maxConnections的1024的最高倍数。这是出于性能原因。如果设置<br>为-1，则禁用maxConnections功能，并且不计算连接。 在服务器关闭连接之<br>前，可以流水线的最大HTTP请求数。 将此属性设置为1将禁用HTTP / 1.0保持<br>活动，以及HTTP / 1.1保持活动和流水线。 将其设置为-1将允许无限量的流水<br>线或保持活动的HTTP请求。 如果未指定，则此属性设置为100。</p>
<p>maxThreads：此连接器要创建的请求处理线程的最大数量，因此确定可以处<br>理的最大并发请求数。 如果未指定，则此属性设置为200.如果执行程序与此连<br>接器相关联，则此属性将被忽略，因为连接器将使用执行程序而不是内部线程<br>池执行任务。 请注意，如果配置了执行程序，则为此属性设置的任何值都将<br>被正确记录，但会将其（例如通过JMX）报告为-1，以表明它不被使用。<br>minSpareThreads ：Tomcat初始化时创建的 socket 线程数<br>tcpNoDelay：If set to true , the TCP_NO_DELAY option will be set on the<br>server socket, which improves performance under most circumstances. This<br>is set to true by default. （对于持久连接会有用）<br>enableLookups ：是否反查域名，取值为： true 或 false 。为了提高处理能<br>力，应设置为 false<br>redirectPort： 在需要基于安全通道的场合，把客户请求转发到基于SSL 的<br>redirectPort 端口<br>acceptAccount： 监听端口队列最大数，满了之后客户请求会被拒绝（不能小<br>于maxSpareThreads ）<br>acceptCount：允许的最大连接数，应大于等于maxThreads ，默认值为 100<br>disableUploadTimeout：上传时是否使用超时机制。<br>connectionUploadTimeout：上传超时时间，毕竟文件上传可能需要消耗更<br>多的时间，这个根据你自己的业务需要自己调，以使Servlet有较长的时间来完<br>成它的执行，需要与上一个参数一起配合使用才会生效。<br>connectionTimeout： 连接器在接受连接后等待的请求URI行的毫秒数。 使<br>用值-1表示无（即无穷大）超时。 默认值为60000（即60秒），但请注意<br>Tomcat附带的标准server.xml将其设置为20000（即20秒）。 除非<br>disableUploadTimeout设置为false，否则读取请求主体（如果有的话）也将使<br>用此超时。<br>keepAliveTimeout：连接器在关闭连接之前等待另一个HTTP请求的毫秒<br>数。 默认值是使用为connectionTimeout属性设置的值。 使用值-1表示无（即<br>无穷大）超时。<br>maxKeepAliveRequests：表示在服务器关闭之前，该连接最大支持的请求<br>数。超过该请求数的连接也将被关闭，1表示禁用，-1表示不限制个数，默认<br>100个，一般设置在100~200之间。<br>URIEncoding： URL统一编码<br>maxThreads是指Tomcat线程池做多能起的线程数，而maxConnections则<br>是Tomcat一瞬间做多能够处理的并发连接数。比如maxThreads=1000，<br>maxConnections=800，假设某一瞬间的并发时1000，那么最终Tomcat的线程<br>数将会是800，即同时处理800个请求，剩余200进入队列“排队”，如果<br>acceptCount=100，那么有100个请求会被拒掉。 注意：根据前面所说，只是</p>
<p>并发那一瞬间Tomcat会起800个线程处理请求，但是稳定后，某一瞬间可能只<br>有很少的线程处于RUNNABLE状态，大部分线程是TIMED_WAITING，如果你<br>的应用处理时间够快的话。所以真正决定Tomcat最大可能达到的线程数是<br>maxConnections这个参数和并发数，当并发数超过这个参数则请求会排队，<br>这时响应的快慢就看你的程序性能了。</p>
<h3 id="3-禁用Tomcat管理界面"><a href="#3-禁用Tomcat管理界面" class="headerlink" title="3.禁用Tomcat管理界面"></a>3.禁用Tomcat管理界面</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_vmims@replenishment apache-tomcat-8.5.9]$ mv</span><br><span class="line">webapps/* /tmp</span><br><span class="line">[sc_vmims@replenishment apache-tomcat-8.5.9]$ rm -rf</span><br><span class="line">conf/Catalina/localhost/*</span><br></pre></td></tr></table></figure>

<h3 id="4-删除-tomcat-users-xml-所有用户权限"><a href="#4-删除-tomcat-users-xml-所有用户权限" class="headerlink" title="4.删除 tomcat-users.xml 所有用户权限"></a>4.删除 tomcat-users.xml 所有用户权限</h3><p>将tomcat-users标签当中的参数全部删除</p>
<p>conf/tomcat-users.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;</span><br><span class="line">&lt;tomcat-users&gt;</span><br><span class="line">&lt;/tomcat-users&gt;</span><br></pre></td></tr></table></figure>

<h3 id="5-Host的配置"><a href="#5-Host的配置" class="headerlink" title="5.Host的配置"></a>5.Host的配置</h3><p>每个Host Component都是一个容器，每个标签都表示一个virtual host，在默<br>认的&lt;server.xml&gt;中，Host的配置如下：</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt;&lt;Host name=&quot;localhost&quot;</span><br><span class="line">&gt;appBase=&quot;webapps&quot;</span><br><span class="line">&gt;unpackWARs=&quot;false&quot;</span><br><span class="line">&gt;autoDeploy=&quot;false&quot;</span><br><span class="line">&gt;deployXML=&quot;false&quot;</span><br><span class="line">&gt;</span><br><span class="line">&gt;&gt; &lt;Valve</span><br><span class="line">&gt;&gt; className=&quot;org.apache.catalina.valves.AccessLogValve&quot;</span><br><span class="line">&gt;&gt; directory=&quot;/home/sc_vmims/logs/localhost_access_log&quot;</span><br><span class="line">&gt;&gt; prefix=&quot;localhost_access_&quot; suffix=&quot;.log&quot;</span><br><span class="line">&gt;&gt; pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span><br><span class="line">&gt;&gt; /&gt;</span><br><span class="line">&gt;&gt; &lt;Context</span><br><span class="line">&gt;&gt; docBase=&quot;/home/sc_vmims/project/vmims&quot;</span><br><span class="line">&gt;&gt; reloadable=&quot;false&quot;</span><br><span class="line">&gt;&gt; path=&quot;/&quot;</span><br><span class="line">&gt;&gt; unpackWAR=&quot;false&quot;</span><br><span class="line">&gt;</span><br><span class="line">&gt;&gt; &lt;/Context&gt;</span><br><span class="line">&gt;&gt; &lt;/Host&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<h4 id="Host标签的属性："><a href="#Host标签的属性：" class="headerlink" title="Host标签的属性："></a>Host标签的属性：</h4><p>name：virtual host的名称<br>appBase：web应用程序文件存放的位置，相对路径为CATALINA_HOMEM<br>autoDeploy ：设为true，则web.xml发生变化时，tomcat自动重新部署程<br>序。实现这个功能必需允许后台处理<br>unpackWARs：tomcat在webapps文件夹中发现war文件时，是否自动将其解<br>压<br>workdir：tomcat使用这个目录来放工作着的servlet和jsp（以servlet形<br>式），这里面的servlet都是是编译好的class文件。默认为<br>$CATALINA_HOME/work<br>backgroundProcessingDelay：单位为秒，在这个属性所定义的时间之后，<br>此Engine将进入后台处理。如果该值为负，则直接进入后台处理。后台处理一<br>般用于处理低优先级的任务。<br>deployOnStartup：若为true，则当这个Engine启动时，tomcat将自动部署<br>这个host，默认为true<br>deployXML： 这个属性的目的是为了提高tomcat的安全性，控制web应用程<br>序是否能使用META-INF/contex.xml。如果设为false，则各应用程序只能访问<br>$CATALINA_HOME/conf///.xml。默认值为True。</p>
<h4 id="context标签的属性："><a href="#context标签的属性：" class="headerlink" title="context标签的属性："></a>context标签的属性：</h4><p>className：Context的java类，默认为<br>org.apache.catalina.core.StandardContext<br>docBase：在这个Context下运行的web应用程序的文档根目录，通常被称为<br>Context root。如果web应用程序是以war文件的方式部署的。<br>path：表示web应用程序的context路径。如果你想将这个web应用程序作为此<br>host的默认应用程序，使用这个值：“”；默认值为docBase，war包名，或者应<br>用程序Context文件名<br>reloadable：默认值为false。设置tocmat是否应该监视/WEB-INF/classes<br>和/WEB-INF/lib中的变化，如果有发生改变，则自动重新部署<br>unloadDelay：tomcat等待web应用程序卸载的微秒数，默认为2000</p>
<p>unpackWAR：默认为true。设置tomcat自动解压docBase中的war文件。<br>workdir：为在这个host中运行的servlet定义一个工作目录。这个host下的应<br>用程序可以通过javax.servlet.context.tempdir属性来活动这个目录的位置。默<br>认为CATALINA_HOME/work<br>override：指示本地的context.xml（war中的META-INF/context.xml）是否<br>可以覆盖全局的context.xml（CATALINA_HOME/conf/context.xml），默认<br>值为false<br>allowLinking：在像linux这种允许符号链接（symbolic link）的操作系统<br>中，这个选项为True则运行该文件被链接到web应用程序树之外。在windows<br>中，这个选项必需为false。默认值为false<br>antiJARLocking：使用特殊的类加载器来尽量避免JAR文件的锁定，默认为<br>false。<br>antiResourceLocking：使用特殊方法来尽量避免文件锁定，默认为false。<br>backgroundProcessDelay：单位为秒，在这个属性所定义的时间之后，此<br>Engine将进入后台处理。如果该值为负，则直接进入后台处理。后台处理一般<br>用于处理低优先级的任务。<br>catcheMaxSize：设置资源代码（resource code）的最大值，默认为10240，<br>单位为KB<br>catcheTTL：验证cache的间隔时间，单位为微秒，默认值为5000<br>cachingAllowed：决定静态资源（配置文件，图片等）是否可以加载进cache<br>中，默认为true<br>caseSensitive：决定tocmat是否进行大小写检查，默认为true<br>cookies：使用cookie来进行session管理，默认为true。如果设为false，则需<br>要使用url重写的方式维护session<br>crossContext：当使用ServletContext.getContext()方法时，允许同一个<br>virtual host下的程序跨Context访问，默认为false<br>privileged：默认值为false，大部分程序这个值设为false就可以了<br>processTlds：设置当Context启动时对TLD进行预处理，默认为true<br>swallowOutput：默认为false。设置System.out和System.error的内容是否应<br>该记录到日志文件中<br>tldNamespacheAware：设置tld的处理和验证是否是namespace-aware，默<br>认为false</p>
<p>useNaming：默认为true。给web应用程序创建一个JavaEE-JNDI兼容的<br>InitialContext。如果web应用程序使用数据库连接，这个选项是必需的<br>wrapperClass：设置一个实现了org.apache.catalina.Wrapper接口的类r来包<br>装servlets</p>
<h4 id="6-最终优化方案"><a href="#6-最终优化方案" class="headerlink" title="6.最终优化方案"></a>6.最终优化方案</h4><p>在配置文件当中，主要是对连接器Connector和Host标签进行设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=&quot;9905&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">minSpareThreads=&quot;15&quot;</span><br><span class="line">maxConnections=&quot;475&quot;</span><br><span class="line">maxThreads=&quot;1000&quot;</span><br><span class="line">enableLookups=&quot;false&quot;</span><br><span class="line">acceptAccount=&quot;300&quot;</span><br><span class="line">acceptCount=&quot;1000&quot;</span><br><span class="line">connectionUploadTimeout=&quot;150000&quot;</span><br><span class="line">disableUploadTimeout=&quot;false&quot;</span><br><span class="line">connectionTimeout=&quot;20000&quot;</span><br><span class="line">keepAliveTimeout=&quot;120000&quot;</span><br><span class="line">maxKeepAliveRequests=&quot;1000&quot;</span><br><span class="line">URIEncoding=&quot;UTF-8&quot;</span><br><span class="line">tcpNoDelay=&quot;ture&quot;</span><br><span class="line">server=&quot;Egaga-Web&quot;</span><br><span class="line">/&gt;</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">&lt;Host name=&quot;localhost&quot;</span><br><span class="line">appBase=&quot;webapps&quot;</span><br><span class="line">unpackWARs=&quot;false&quot;</span><br><span class="line">autoDeploy=&quot;false&quot;</span><br><span class="line">deployXML=&quot;false&quot;&gt;</span><br><span class="line">&lt;Valve</span><br><span class="line">className=&quot;org.apache.catalina.valves.AccessLogValve&quot;</span><br><span class="line">directory=&quot;/home/sc_vmims/logs/localhost_access_log&quot;</span><br><span class="line">prefix=&quot;localhost_access_&quot; suffix=&quot;.log&quot;</span><br><span class="line">pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span><br><span class="line">/&gt;</span><br><span class="line">&lt;Context</span><br><span class="line">docBase=&quot;/home/sc_vmims/project/vmims&quot;</span><br><span class="line">reloadable=&quot;false&quot;</span><br><span class="line">path=&quot;/&quot;</span><br><span class="line">unpackWAR=&quot;false&quot;&gt;</span><br><span class="line">&lt;/Context&gt;</span><br><span class="line">&lt;/Host&gt;</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/13/EMQ安装/">
  EMQ
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/13/EMQ安装/"><span class="article-date">
  2019-08-13
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/EMQ/">EMQ</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/EMQ/">EMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h2 id="一、EMQ安装"><a href="#一、EMQ安装" class="headerlink" title="一、EMQ安装"></a>一、EMQ安装</h2><h3 id="1-安装包文件"><a href="#1-安装包文件" class="headerlink" title="1.安装包文件"></a>1.安装包文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ unzip emqttd-centos7-v2.3.11.zip</span><br><span class="line">[emqtt@lp ~]$ cd emqttd/</span><br><span class="line">[emqtt@lp emqttd]$ ls</span><br><span class="line">bin data erts-9.0 etc hook_lua lib log releases</span><br><span class="line"></span><br><span class="line"># 其中在bin下有很多命令；etc有配置文件；</span><br><span class="line"></span><br><span class="line">[emqtt@lp emqttd]$ ./bin/emqttd start # 启动命令</span><br><span class="line">emqttd 2.3.11 is started successfully!</span><br><span class="line">[emqtt@lp emqttd]$ ./bin/emqttd restart # 重启命令</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<h3 id="2-检查情况"><a href="#2-检查情况" class="headerlink" title="2.检查情况"></a>2.检查情况</h3><p>控制台调试模式启动，检查 EMQ 是否可正常启动:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ cd emqttd &amp;&amp; ./bin/emqttd console</span><br><span class="line">Exec: /home/emqtt/emqttd/erts-9.0/bin/erlexec -boot</span><br><span class="line">/home/emqtt/emqttd/releases/2.3.11/emqttd -mode embedded</span><br><span class="line">-boot_var ERTS_LIB_DIR /home/emqtt/emqttd/erts-</span><br><span class="line">9.0/../lib -mnesia dir</span><br><span class="line">&quot;/home/emqtt/emqttd/data/mnesia/emq@127.0.0.1&quot; -config</span><br><span class="line">/home/emqtt/emqttd/data/configs/app.2018.08.06.00.30.12.</span><br><span class="line">config -args_file</span><br><span class="line">/home/emqtt/emqttd/data/configs/vm.2018.08.06.00.30.12.a</span><br><span class="line">rgs -vm_args</span><br><span class="line">/home/emqtt/emqttd/data/configs/vm.2018.08.06.00.30.12.a</span><br><span class="line">rgs -- console</span><br><span class="line">Root: /home/emqtt/emqttd</span><br><span class="line">/home/emqtt/emqttd</span><br><span class="line">Erlang/OTP 20 [erts-9.0][source] [64-bit][smp:2:2]</span><br><span class="line">[ds:2:2:10][async-threads:32] [hipe][kernel-poll:true]</span><br><span class="line"></span><br><span class="line">=INFO REPORT==== 6-Aug-2018::00:30:16 ===</span><br><span class="line">alarm_handler: &#123;set,&#123;system_memory_high_watermark,</span><br><span class="line">[]&#125;&#125;</span><br><span class="line">starting emqttd on node &apos;emq@127.0.0.1&apos;</span><br><span class="line">emqttd ctl is starting...[ok]</span><br><span class="line">emqttd hook is starting...[ok]</span><br><span class="line">emqttd router is starting...[ok]</span><br><span class="line">emqttd pubsub is starting...[ok]</span><br><span class="line">emqttd stats is starting...[ok]</span><br><span class="line">emqttd metrics is starting...[ok]</span><br><span class="line">emqttd pooler is starting...[ok]</span><br><span class="line">emqttd trace is starting...[ok]</span><br><span class="line">emqttd client manager is starting...[ok]</span><br><span class="line">emqttd session manager is starting...[ok]</span><br><span class="line">emqttd session supervisor is starting...[ok]</span><br><span class="line">emqttd wsclient supervisor is starting...[ok]</span><br><span class="line">emqttd broker is starting...[ok]</span><br><span class="line">emqttd alarm is starting...[ok]</span><br><span class="line">emqttd mod supervisor is starting...[ok]</span><br><span class="line">emqttd bridge supervisor is starting...[ok]</span><br><span class="line">emqttd access control is starting...[ok]</span><br><span class="line">emqttd system monitor is starting...[ok]</span><br><span class="line">emqttd 2.3.11 is running now</span><br><span class="line">Eshell V9.0 (abort with ^G)</span><br><span class="line">(emq@127.0.0.1)1&gt; Load emq_mod_presence module</span><br><span class="line">successfully.</span><br><span class="line">dashboard:http listen on 0.0.0.0:18083 with 4 acceptors.</span><br><span class="line">mqtt:tcp listen on 127.0.0.1:11883 with 4 acceptors.</span><br><span class="line">mqtt:tcp listen on 0.0.0.0:1883 with 64 acceptors.</span><br><span class="line">mqtt:ws listen on 0.0.0.0:8083 with 4 acceptors.</span><br><span class="line">mqtt:ssl listen on 0.0.0.0:8883 with 16 acceptors.</span><br><span class="line">mqtt:wss listen on 0.0.0.0:8084 with 4 acceptors.</span><br><span class="line">mqtt:api listen on 0.0.0.0:8080 with 4 acceptors.</span><br><span class="line">BREAK: (a)bort (c)ontinue (p)roc info (i)nfo (l)oaded</span><br><span class="line">(v)ersion (k)ill (D)b-tables (d)istribution</span><br><span class="line">^C[os_mon] memory supervisor port (memsup): Erlang has</span><br><span class="line">closed</span><br><span class="line">[os_mon] cpu supervisor port (cpu_sup): Erlang has</span><br><span class="line">closed</span><br></pre></td></tr></table></figure>

<h2 id="二、压力测试工具"><a href="#二、压力测试工具" class="headerlink" title="二、压力测试工具"></a>二、压力测试工具</h2><h3 id="1-下载安装benchmark"><a href="#1-下载安装benchmark" class="headerlink" title="1.下载安装benchmark"></a>1.下载安装benchmark</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ unzip emqtt_benchmark-master.zip # 这个下载</span><br><span class="line">会比较难</span><br><span class="line">[emqtt@lp ~]$ cd emqtt_benchmark-master/</span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">/usr/bin/env: escript: No such file or directory</span><br><span class="line">make: *** [get-deps] Error 127</span><br><span class="line"></span><br><span class="line"># 可以看到编译会出现问题，这样的问题是没有安装Erlang，因为这项服务</span><br><span class="line"></span><br><span class="line">是用这个Erlang来写的，因此必须要编译这个语言环境</span><br></pre></td></tr></table></figure>

<h3 id="2-部署Erlang-环境"><a href="#2-部署Erlang-环境" class="headerlink" title="2.部署Erlang 环境"></a>2.部署Erlang 环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 这个包的地址我已经收藏了，需要找到这个版本务必记住R16B03，然后下</span><br><span class="line"></span><br><span class="line">载下来解压</span><br><span class="line">[emqtt@lp ~]$ tar xvf otp_src_20.3.tar.gz</span><br><span class="line"></span><br><span class="line"># 这里我是用root用户进行操作，因为是安装一个语言环境，所以需要全局</span><br><span class="line"></span><br><span class="line">都起作用，那么就选择这样了</span><br><span class="line">[root@lp otp_src_20.3]# ./configure --</span><br><span class="line">prefix=/usr/local/erlang</span><br><span class="line">[root@lp otp_src_20.3]# make &amp;&amp; make install</span><br><span class="line">[root@lp otp_src_20.3]# vim /etc/profile</span><br><span class="line">export PATH=$PATH:/usr/local/erlang/bin</span><br><span class="line">[root@lp otp_src_20.3]# source /etc/profile</span><br><span class="line"></span><br><span class="line"># 测试安装版本以及完整性</span><br><span class="line"></span><br><span class="line">[root@lp emqtt_benchmark-master]# erl</span><br><span class="line">Erlang R16B03-1 (erts-5.10.4) [source][64-bit]</span><br><span class="line">[smp:2:2][async-threads:10] [kernel-poll:false]</span><br><span class="line">Eshell V5.10.4 (abort with ^G)</span><br></pre></td></tr></table></figure>

<h3 id="3-编译安装benchmark又遇问题（大坑必看）"><a href="#3-编译安装benchmark又遇问题（大坑必看）" class="headerlink" title="3.编译安装benchmark又遇问题（大坑必看）"></a>3.编译安装benchmark又遇问题（大坑必看）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt_benchmark-master]# make</span><br><span class="line">Uncaught error in rebar_core: &#123;&apos;EXIT&apos;,</span><br><span class="line">&#123;undef,</span><br><span class="line">[&#123;crypto,start,[],[]&#125;,</span><br><span class="line">&#123;rebar,run_aux,2,</span><br><span class="line">[&#123;file,&quot;src/rebar.erl&quot;&#125;,&#123;line,165&#125;]&#125;,</span><br><span class="line">&#123;rebar,main,1,</span><br><span class="line">[&#123;file,&quot;src/rebar.erl&quot;&#125;,&#123;line,58&#125;]&#125;,</span><br><span class="line">&#123;escript,run,2,</span><br><span class="line"></span><br><span class="line">[&#123;file,&quot;escript.erl&quot;&#125;,</span><br><span class="line">&#123;line,747&#125;]&#125;,</span><br><span class="line">&#123;escript,start,1,</span><br><span class="line">[&#123;file,&quot;escript.erl&quot;&#125;,</span><br><span class="line">&#123;line,277&#125;]&#125;,</span><br><span class="line">&#123;init,start_it,1,[]&#125;,</span><br><span class="line">&#123;init,start_em,1,[]&#125;]&#125;&#125;</span><br><span class="line">make: *** [get-deps] Error 1</span><br><span class="line"></span><br><span class="line"># 真是崩溃，这个问题....说明erlang的版本太低，需要升级！！！</span><br><span class="line"></span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">==&gt; emqtt_benchmark-master (get-deps)</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">ERROR: Dependency dir /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc failed application validation with</span><br><span class="line">reason:</span><br><span class="line">&#123;missing_app_file,&quot;/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc&quot;&#125;.</span><br><span class="line">ERROR: &apos;get-deps&apos; failed while processing</span><br><span class="line">/home/emqtt/emqtt_benchmark-master: rebar_abort</span><br><span class="line">make: *** [get-deps] Error 1</span><br><span class="line"></span><br><span class="line"># 这个问题是由于make之后，按下crtl+C取消了，这样就导致deps当中有</span><br><span class="line"></span><br><span class="line">文件emqttc，但是里面的东西却还没有下载完成，那么就会报这样的错误，</span><br><span class="line">这种情况下就把deps文件下的东西清空，然后再次make</span><br><span class="line"></span><br><span class="line"># 又遇到问题了，下载不动这些资源，</span><br><span class="line"></span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line"></span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/goldrush to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">==&gt; lager (get-deps)</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/goldrush to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">Pulling goldrush from</span><br><span class="line">&#123;git,&quot;https://github.com/basho/goldrush.git&quot;,</span><br><span class="line">&#123;tag,&quot;0.1.9&quot;&#125;&#125;</span><br><span class="line">Cloning into &apos;goldrush&apos;...</span><br><span class="line"></span><br><span class="line"># 比如卡在“goldrush”的下载上，但是有个曲线救国的方式就是自己把这</span><br><span class="line"></span><br><span class="line">些依赖包下载下来，我最后算了一下，一共是有五个包，这里我通过浏览器的</span><br><span class="line">方式下载，注意看当中</span><br><span class="line">的“&#123;git,&quot;https://github.com/basho/goldrush.git&quot;,”，这个就</span><br><span class="line">是web地址，https://github.com/basho/goldrush，然后进去吧zip</span><br><span class="line">包下载下来，移动到deps当中，并且是创建好的goldrush目录</span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ ls deps</span><br><span class="line">emqttc gen_logger getopt goldrush lager</span><br><span class="line"></span><br><span class="line"># 就是这5个包的文件夹，都要解压以后相应的把内容放在其中，例如：</span><br><span class="line"></span><br><span class="line">[emqtt@lp ~]$ zip getopt-master.zip</span><br><span class="line">[emqtt@lp ~]$ cp -rf getopt-master/* emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt/</span><br><span class="line"></span><br><span class="line"># 后面的包都需要这么做。</span><br></pre></td></tr></table></figure>

<h3 id="4-编译benchmark"><a href="#4-编译benchmark" class="headerlink" title="4.编译benchmark"></a>4.编译benchmark</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">==&gt; goldrush (get-deps)</span><br><span class="line">==&gt; lager (get-deps)</span><br><span class="line">==&gt; gen_logger (get-deps)</span><br><span class="line">==&gt; emqttc (get-deps)</span><br><span class="line">==&gt; emqtt_benchmark-master (get-deps)</span><br><span class="line">WARN: Expected /home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/getopt to be an app dir (containing</span><br><span class="line">ebin/*.app), but no .app found.</span><br><span class="line">Pulling getopt from</span><br><span class="line">&#123;git,&quot;https://github.com/jcomellas/getopt.git&quot;,</span><br><span class="line">&#123;branch,&quot;master&quot;&#125;&#125;</span><br><span class="line">Cloning into &apos;getopt&apos;...</span><br><span class="line">^Cmake: *** [get-deps] Interrupt</span><br><span class="line">[emqtt@lp emqtt_benchmark-master]$ make</span><br><span class="line">==&gt; goldrush (get-deps)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">==&gt; lager (get-deps)</span><br><span class="line">==&gt; gen_logger (get-deps)</span><br><span class="line">==&gt; emqttc (get-deps)</span><br><span class="line">==&gt; getopt (get-deps)</span><br><span class="line">==&gt; emqtt_benchmark-master (get-deps)</span><br><span class="line">==&gt; goldrush (compile)</span><br><span class="line">Compiled src/gr_sup.erl</span><br><span class="line">Compiled src/gr_param_sup.erl</span><br><span class="line">Compiled src/gre.erl</span><br><span class="line">Compiled src/gr_manager_sup.erl</span><br><span class="line">Compiled src/gr_manager.erl</span><br><span class="line">Compiled src/gr_counter_sup.erl</span><br><span class="line">Compiled src/gr_context.erl</span><br><span class="line">Compiled src/gr_param.erl</span><br><span class="line">Compiled src/gr_app.erl</span><br><span class="line">Compiled src/glc_run.erl</span><br><span class="line">Compiled src/gr_counter.erl</span><br><span class="line">Compiled src/glc_ops.erl</span><br><span class="line">Compiled src/glc_lib.erl</span><br><span class="line">Compiled src/glc.erl</span><br><span class="line">Compiled src/glc_code.erl</span><br><span class="line">==&gt; lager (compile)</span><br><span class="line">Compiled src/lager_util.erl</span><br><span class="line">Compiled src/lager_transform.erl</span><br><span class="line">Compiled src/lager_sup.erl</span><br><span class="line">Compiled src/lager_msg.erl</span><br><span class="line">Compiled src/lager_manager_killer.erl</span><br><span class="line">Compiled src/lager_handler_watcher_sup.erl</span><br><span class="line">Compiled src/lager_handler_watcher.erl</span><br><span class="line">Compiled src/lager_trunc_io.erl</span><br><span class="line">Compiled src/lager_stdlib.erl</span><br><span class="line">Compiled src/lager_format.erl</span><br><span class="line">Compiled src/lager_default_formatter.erl</span><br><span class="line">Compiled src/lager_crash_log.erl</span><br><span class="line">Compiled src/lager_file_backend.erl</span><br><span class="line">Compiled src/lager_config.erl</span><br><span class="line">Compiled src/lager_console_backend.erl</span><br><span class="line">Compiled src/lager_common_test_backend.erl</span><br><span class="line">Compiled src/lager_backend_throttle.erl</span><br><span class="line">Compiled src/lager_app.erl</span><br><span class="line">Compiled src/error_logger_lager_h.erl</span><br><span class="line">Compiled src/lager.erl</span><br><span class="line">==&gt; gen_logger (compile)</span><br><span class="line">Compiled src/gen_logger.erl</span><br><span class="line">Compiled src/console_logger.erl</span><br><span class="line">Compiled src/error_logger_logger.erl</span><br><span class="line">Compiled src/lager_logger.erl</span><br><span class="line">==&gt; emqttc (compile)</span><br><span class="line"></span><br><span class="line">Compiled src/emqttc_topic.erl</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc_socket.erl:204: Warning:</span><br><span class="line">gen_fsm:send_all_state_event/2 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc_socket.erl:215: Warning:</span><br><span class="line">gen_fsm:send_all_state_event/2 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc_socket.erl:233: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc_socket.erl:242: Warning:</span><br><span class="line">gen_fsm:send_all_state_event/2 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:cast/2</span><br><span class="line">Compiled src/emqttc_socket.erl</span><br><span class="line">Compiled src/emqttc_serialiser.erl</span><br><span class="line">Compiled src/emqttc_reconnector.erl</span><br><span class="line">Compiled src/emqttc_packet.erl</span><br><span class="line">Compiled src/emqttc_parser.erl</span><br><span class="line">Compiled src/emqttc_opts.erl</span><br><span class="line">Compiled src/emqttc_protocol.erl</span><br><span class="line">Compiled src/emqttc_keepalive.erl</span><br><span class="line">Compiled src/emqttc_message.erl</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:170: Warning:</span><br><span class="line">gen_fsm:start_link/3 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:start_link/3</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:193: Warning:</span><br><span class="line">gen_fsm:start_link/4 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:start_link/4</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:201: Warning:</span><br><span class="line">gen_fsm:sync_send_all_state_event/2 is deprecated and</span><br><span class="line">will be removed in a future release; use</span><br><span class="line">gen_statem:call/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:254: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:262: Warning:</span><br><span class="line">gen_fsm:sync_send_event/2 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:call/2</span><br><span class="line"></span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:335: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:338: Warning:</span><br><span class="line">gen_fsm:sync_send_event/3 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:call/3</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:350: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:358: Warning:</span><br><span class="line">gen_fsm:sync_send_event/3 is deprecated and will be</span><br><span class="line">removed in a future release; use gen_statem:call/3</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:366: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:488: Warning:</span><br><span class="line">gen_fsm:cancel_timer/1 is deprecated and will be removed</span><br><span class="line">in a future release; use erlang:cancel_timer/1</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:505: Warning:</span><br><span class="line">gen_fsm:send_event/2 is deprecated and will be removed</span><br><span class="line">in a future release; use gen_statem:cast/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:658: Warning: variable</span><br><span class="line">&apos;Logger&apos; is unused</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:658: Warning: variable</span><br><span class="line">&apos;Name&apos; is unused</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:770: Warning:</span><br><span class="line">gen_fsm:cancel_timer/1 is deprecated and will be removed</span><br><span class="line">in a future release; use erlang:cancel_timer/1</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:962: Warning:</span><br><span class="line">gen_fsm:start_timer/2 is deprecated and will be removed</span><br><span class="line">in a future release; use erlang:start_timer/3</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:1052: Warning:</span><br><span class="line">gen_fsm:reply/2 is deprecated and will be removed in a</span><br><span class="line">future release; use gen_statem:reply/2</span><br><span class="line"></span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:1065: Warning:</span><br><span class="line">gen_fsm:reply/2 is deprecated and will be removed in a</span><br><span class="line">future release; use gen_statem:reply/2</span><br><span class="line">/home/emqtt/emqtt_benchmarkmaster/</span><br><span class="line">deps/emqttc/src/emqttc.erl:1076: Warning:</span><br><span class="line">gen_fsm:reply/2 is deprecated and will be removed in a</span><br><span class="line">future release; use gen_statem:reply/2</span><br><span class="line">Compiled src/emqttc.erl</span><br><span class="line">==&gt; getopt (compile)</span><br><span class="line">Compiled src/getopt.erl</span><br><span class="line">==&gt; emqtt_benchmark-master (compile)</span><br><span class="line">src/emqtt_benchmark.erl:95: Warning: random:seed/1: the</span><br><span class="line">&apos;random&apos; module is deprecated; use the &apos;rand&apos; module</span><br><span class="line">instead</span><br><span class="line">src/emqtt_benchmark.erl:196: Warning: random:uniform/1:</span><br><span class="line">the &apos;random&apos; module is deprecated; use the &apos;rand&apos; module</span><br><span class="line">instead</span><br><span class="line">Compiled src/emqtt_benchmark.erl</span><br><span class="line">==&gt; emqtt_benchmark-master (xref)</span><br><span class="line"></span><br><span class="line"># 注意前面的提示：</span><br><span class="line"></span><br><span class="line">==&gt; goldrush (get-deps)</span><br><span class="line">==&gt; lager (get-deps)</span><br><span class="line">==&gt; gen_logger (get-deps)</span><br><span class="line">==&gt; emqttc (get-deps)</span><br><span class="line">==&gt; emqtt_benchmark-master (get-deps)</span><br><span class="line"></span><br><span class="line"># 说明5个包都加载好了</span><br></pre></td></tr></table></figure>

<h3 id="5-测试"><a href="#5-测试" class="headerlink" title="5.测试"></a>5.测试</h3><p>为了保证测试的可行性，需要更改内核参数配置以及emq自身的配置文件</p>
<h4 id="①更改内核参数"><a href="#①更改内核参数" class="headerlink" title="①更改内核参数"></a>①更改内核参数</h4><p>系统全局允许分配的最大文件句柄数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">fs.file-max = 2097152 # 系统所有进程可打开的文件数量</span><br><span class="line">fs.nr_open=2097152</span><br><span class="line">net.core.somaxconn=65536 # backlog - Socket 监听队列长度</span><br><span class="line">[root@lp emqtt]# sysctl -p</span><br></pre></td></tr></table></figure>

<p>设置服务最大文件句柄数:</p>
<p>一般只有用到systemctl去启动的时候，这个才会生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/systemd/system.conf</span><br><span class="line">DefaultLimitNOFILE=1048576</span><br></pre></td></tr></table></figure>

<p>持久化设置允许用户/进程打开文件句柄数:</p>
<ul>
<li><ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">- - nofile 1048576</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<p>TCP 协议栈网络参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">sysctl -w net.core.somaxconn=32768 # 监听队列的最大长度</span><br><span class="line">sysctl -w net.ipv4.tcp_max_syn_backlog=16384 # Tcp syn队</span><br><span class="line">列的最大长度 ，但是有可能会造成syn攻击</span><br><span class="line">sysctl -w net.core.netdev_max_backlog=16384 # 每个网络接口</span><br><span class="line">接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最</span><br><span class="line">大数目</span><br></pre></td></tr></table></figure>

<p>可用知名端口范围:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_local_port_range=&apos;1000 65535&apos;</span><br></pre></td></tr></table></figure>

<p>TCP Socket 读写 Buffer 设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.core.rmem_default=262144 # 接收套接字缓冲区大小的默认值</span><br><span class="line">net.core.wmem_default=262144 # 发送套接字缓冲区大小的默认值</span><br><span class="line">net.core.rmem_max=16777216 # 接收套接字缓冲区大小的最大值</span><br><span class="line">net.core.wmem_max=16777216 # 发送套接字缓冲区大小的最大值</span><br><span class="line">net.core.optmem_max=16777216 # socket buffer的最大初始化</span><br><span class="line">值,默认10K</span><br><span class="line">#sysctl -w net.ipv4.tcp_mem=&apos;16777216 16777216 16777216&apos;</span><br><span class="line">net.ipv4.tcp_rmem=&apos;1024 4096 16777216&apos;</span><br><span class="line">net.ipv4.tcp_wmem=&apos;1024 4096 16777216&apos;</span><br><span class="line"></span><br><span class="line"># 为自动调优定义每个 socket 使用的内存。</span><br><span class="line"></span><br><span class="line"># 第一个值是为 socket 的发送缓冲区分配的最少字节数。</span><br><span class="line"></span><br><span class="line"># 第二个值是默认值（该值会被 wmem_default 覆盖），缓冲区在系统负</span><br><span class="line"></span><br><span class="line">载不重的情况下可以增长到这个值。</span><br><span class="line"></span><br><span class="line"># 第三个值是发送缓冲区空间的最大字节数（该值会被 wmem_max 覆</span><br><span class="line"></span><br><span class="line">盖）。</span><br></pre></td></tr></table></figure>

<p>TCP 连接追踪设置: （和firewall的开启有关系）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.nf_conntrack_max=1000000</span><br><span class="line">net.netfilter.nf_conntrack_max=1000000</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait=30</span><br><span class="line"></span><br><span class="line"># nf_conntrack用1个哈希表记录已建立的连接，包括其他机器到本机、本</span><br><span class="line"></span><br><span class="line">机到其他机器、本机到本机（例如 ping 127.0.0.1 也会被跟踪）。</span><br><span class="line"></span><br><span class="line"># 如果连接进来比释放的快，把哈希表塞满了，新连接的数据包会被丢掉，</span><br><span class="line"></span><br><span class="line">此时netfilter变成了一个黑洞，导致拒绝服务。 这发生在3层（网络</span><br><span class="line">层），应用程序毫无办法。</span><br><span class="line"></span><br><span class="line"># 默认值参考以下公式：（使用内存的 1/16384）</span><br><span class="line"></span><br><span class="line"># CONNTRACK_MAX = RAMSIZE (in bytes) / 16384 / (ARCH /</span><br><span class="line"></span><br><span class="line">32)</span><br><span class="line">#（ARCH为你机器CPU的架构，64或32）</span><br><span class="line"></span><br><span class="line"># HASHSIZE = CONNTRACK_MAX / 4</span><br><span class="line"></span><br><span class="line">推荐bucket至少 262144，max至少 1048576，不够再继续加</span><br><span class="line">调优的基本思路是先看 /proc/net/nf_conntrack ，哪种协议哪种状态</span><br><span class="line">的连接最多，改小对应的超时参数</span><br><span class="line">注意要充分测试，确保不影响业务。</span><br><span class="line"></span><br><span class="line"># 一篇博客关于这方面的调优推荐</span><br><span class="line"></span><br><span class="line">net.netfilter.nf_conntrack_max=1048576</span><br><span class="line">net.nf_conntrack_max=1048576</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait=30</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait=30</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait=15</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established=300</span><br></pre></td></tr></table></figure>

<p>TIME-WAIT Socket 最大数量、回收与重用设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.tcp_max_tw_buckets=1048576</span><br><span class="line"></span><br><span class="line"># 注意: 不建议开启該设置，NAT模式下可能引起连接RST</span><br><span class="line"></span><br><span class="line"># net.ipv4.tcp_tw_recycle = 1</span><br><span class="line"></span><br><span class="line"># net.ipv4.tcp_tw_reuse = 1</span><br></pre></td></tr></table></figure>

<p>FIN-WAIT-2 Socket 超时设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lp emqtt]# vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.tcp_fin_timeout = 15</span><br></pre></td></tr></table></figure>

<h4 id="②虚拟机Erlang-参数"><a href="#②虚拟机Erlang-参数" class="headerlink" title="②虚拟机Erlang 参数"></a>②虚拟机Erlang 参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ vim emqttd/etc/emq.conf</span><br><span class="line">node.process_limit = 2097152</span><br><span class="line">node.max_ports = 1048576</span><br></pre></td></tr></table></figure>

<h4 id="③EMQ-消息服务器参数"><a href="#③EMQ-消息服务器参数" class="headerlink" title="③EMQ 消息服务器参数"></a>③EMQ 消息服务器参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp ~]$ vim emqttd/etc/emq.conf</span><br><span class="line">listener.tcp.external = 0.0.0.0:1883</span><br><span class="line">listener.tcp.external.acceptors = 64</span><br><span class="line">listener.tcp.external.max_clients = 1000000</span><br></pre></td></tr></table></figure>

<p>Sub Benchmark</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp emqtt_benchmark-master]$ ./emqtt_bench_sub --</span><br><span class="line">help</span><br><span class="line">Usage: emqtt_bench_sub [--help &lt;help&gt;][-h []] [-p</span><br><span class="line">[&lt;port&gt;]][-c []][-i []][-t ]</span><br><span class="line">[-q [&lt;qos&gt;]][-u ] [-P &lt;password&gt;][-k []][-C []][--ifaddr ]</span><br><span class="line">--help help information</span><br><span class="line">-h, --host mqtt server hostname or IP address</span><br><span class="line">[default: localhost]</span><br><span class="line">-p, --port mqtt server port number [default:</span><br><span class="line">1883]</span><br><span class="line">-c, --count max count of clients [default: 200]</span><br><span class="line">-n, --startnumber start number [default: 0]</span><br><span class="line">-i, --interval interval of connecting to the</span><br><span class="line">broker [default: 10]</span><br><span class="line">-t, --topic topic subscribe, support %u, %c, %i</span><br><span class="line">variables</span><br><span class="line">-q, --qos subscribe qos [default: 0]</span><br><span class="line">-u, --username username for connecting to server</span><br><span class="line">-P, --password password for connecting to server</span><br><span class="line">-k, --keepalive keep alive in seconds [default:</span><br><span class="line">300]</span><br><span class="line">-C, --clean clean session [default: true]</span><br><span class="line">--ifaddr local ipaddress or interface</span><br><span class="line">address</span><br></pre></td></tr></table></figure>

<p>Pub Benchmark</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./emqtt_bench_pub --help</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Usage: emqtt_bench_pub [--help &lt;help&gt;][-h []] [-p</span><br><span class="line">[&lt;port&gt;]][-c []] [-i [&lt;interval&gt;]][-I []] [-u</span><br><span class="line">&lt;username&gt;][-P ] [-t &lt;topic&gt;][-s []]</span><br><span class="line">[-q [&lt;qos&gt;]][-r []] [-k</span><br><span class="line">[&lt;keepalive&gt;]][-C []] [--ifaddr</span><br><span class="line">&lt;ifaddr&gt;]</span><br><span class="line">--help help information</span><br><span class="line">-h, --host mqtt server hostname or IP</span><br><span class="line">address [default:</span><br><span class="line">localhost]</span><br><span class="line">-p, --port mqtt server port number</span><br><span class="line">[default: 1883]</span><br><span class="line">-c, --count max count of clients [default:</span><br><span class="line">200]</span><br><span class="line">-n, --startnumber start number [default: 0]</span><br><span class="line">-i, --interval interval of connecting to the</span><br><span class="line">broker [default: 10]</span><br><span class="line">-I, --interval_of_msg interval of publishing</span><br><span class="line">message(ms) [default: 1000]</span><br><span class="line">-u, --username username for connecting to</span><br><span class="line">server</span><br><span class="line">-P, --password password for connecting to</span><br><span class="line">server</span><br><span class="line">-t, --topic topic subscribe, support %u,</span><br><span class="line">%c, %i variables</span><br><span class="line">-s, --size payload size [default: 256]</span><br><span class="line">-q, --qos subscribe qos [default: 0]</span><br><span class="line">-r, --retain retain message [default: false]</span><br><span class="line">-k, --keepalive keep alive in seconds [default:</span><br><span class="line">300]</span><br><span class="line">-C, --clean clean session [default: true]</span><br><span class="line">--ifaddr local ipaddress or interface</span><br><span class="line">address</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp emqtt_benchmark-master]$ ./emqtt_bench_pub -c</span><br><span class="line">100 -I 10 -t bench/%i -s 256</span><br><span class="line">21:08:18.085 [info] Application lager started on node</span><br><span class="line">nonode@nohost</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">21:08:18.087 [info] Application emqttc started on node</span><br><span class="line">nonode@nohost</span><br><span class="line">21:08:18.088 [info] Application emqtt_benchmark started</span><br><span class="line">on node nonode@nohost</span><br><span class="line">conneted: 1</span><br><span class="line">conneted: 2</span><br><span class="line">conneted: 3</span><br><span class="line">conneted: 4</span><br><span class="line">conneted: 5</span><br><span class="line">conneted: 6</span><br><span class="line">conneted: 7</span><br><span class="line">conneted: 8</span><br><span class="line">conneted: 9</span><br><span class="line">conneted: 10</span><br><span class="line">conneted: 11</span><br><span class="line">conneted: 12</span><br><span class="line">conneted: 13</span><br><span class="line">conneted: 14</span><br><span class="line">conneted: 15</span><br><span class="line">conneted: 16</span><br><span class="line">conneted: 17</span><br><span class="line">conneted: 18</span><br><span class="line">conneted: 19</span><br><span class="line">conneted: 20</span><br><span class="line">conneted: 21</span><br><span class="line">conneted: 22</span><br><span class="line">conneted: 23</span><br><span class="line">conneted: 24</span><br><span class="line">conneted: 25</span><br><span class="line">conneted: 26</span><br><span class="line">conneted: 27</span><br><span class="line">conneted: 28</span><br><span class="line">conneted: 29</span><br><span class="line">conneted: 30</span><br><span class="line">conneted: 31</span><br><span class="line">conneted: 32</span><br><span class="line">conneted: 33</span><br><span class="line">conneted: 34</span><br><span class="line">conneted: 35</span><br><span class="line">conneted: 36</span><br><span class="line">conneted: 37</span><br><span class="line">conneted: 38</span><br><span class="line">conneted: 39</span><br><span class="line">conneted: 40</span><br><span class="line">conneted: 41</span><br><span class="line">conneted: 42</span><br><span class="line">conneted: 43</span><br><span class="line">conneted: 44</span><br><span class="line"></span><br><span class="line">conneted: 45</span><br><span class="line">conneted: 46</span><br><span class="line">conneted: 47</span><br><span class="line">conneted: 48</span><br><span class="line">conneted: 49</span><br><span class="line">conneted: 50</span><br><span class="line">conneted: 51</span><br><span class="line">conneted: 52</span><br><span class="line">conneted: 53</span><br><span class="line">conneted: 54</span><br><span class="line">conneted: 55</span><br><span class="line">conneted: 56</span><br><span class="line">conneted: 57</span><br><span class="line">conneted: 58</span><br><span class="line">conneted: 59</span><br><span class="line">conneted: 60</span><br><span class="line">conneted: 61</span><br><span class="line">conneted: 62</span><br><span class="line">conneted: 63</span><br><span class="line">conneted: 64</span><br><span class="line">conneted: 65</span><br><span class="line">conneted: 66</span><br><span class="line">conneted: 67</span><br><span class="line">conneted: 68</span><br><span class="line">conneted: 69</span><br><span class="line">conneted: 70</span><br><span class="line">conneted: 71</span><br><span class="line">conneted: 72</span><br><span class="line">conneted: 73</span><br><span class="line">conneted: 74</span><br><span class="line">conneted: 75</span><br><span class="line">conneted: 76</span><br><span class="line">conneted: 77</span><br><span class="line">conneted: 78</span><br><span class="line">conneted: 79</span><br><span class="line">conneted: 80</span><br><span class="line">conneted: 81</span><br><span class="line">sent(1001): total=3899, rate=3899(msg/sec)</span><br><span class="line">conneted: 82</span><br><span class="line">conneted: 83</span><br><span class="line">conneted: 84</span><br><span class="line">conneted: 85</span><br><span class="line">conneted: 86</span><br><span class="line">conneted: 87</span><br><span class="line">conneted: 88</span><br><span class="line">conneted: 89</span><br><span class="line">conneted: 90</span><br><span class="line">conneted: 91</span><br><span class="line"></span><br><span class="line">conneted: 92</span><br><span class="line">conneted: 93</span><br><span class="line">conneted: 94</span><br><span class="line">conneted: 95</span><br><span class="line">conneted: 96</span><br><span class="line">conneted: 97</span><br><span class="line">conneted: 98</span><br><span class="line">conneted: 99</span><br><span class="line">conneted: 100</span><br><span class="line">sent(2001): total=13561, rate=9662(msg/sec)</span><br><span class="line">sent(3001): total=23564, rate=10003(msg/sec)</span><br><span class="line">sent(4001): total=33570, rate=10006(msg/sec)</span><br><span class="line">sent(5001): total=43578, rate=10008(msg/sec)</span><br><span class="line">sent(6002): total=53576, rate=9998(msg/sec)</span><br><span class="line">sent(7002): total=63571, rate=9995(msg/sec)</span><br><span class="line">sent(8002): total=73587, rate=10016(msg/sec)</span><br><span class="line">sent(9006): total=83565, rate=9978(msg/sec)</span><br><span class="line">sent(10002): total=93565, rate=10000(msg/sec)</span><br><span class="line">sent(11001): total=103515, rate=9950(msg/sec)</span><br><span class="line">sent(12001): total=113556, rate=10041(msg/sec)</span><br><span class="line">sent(13004): total=123590, rate=10034(msg/sec)</span><br><span class="line">sent(14003): total=133580, rate=9990(msg/sec)</span><br><span class="line">sent(15000): total=143531, rate=9951(msg/sec)</span><br><span class="line">sent(16006): total=153589, rate=10058(msg/sec)</span><br><span class="line">sent(17004): total=163585, rate=9996(msg/sec)</span><br><span class="line">sent(18002): total=173555, rate=9970(msg/sec)</span><br><span class="line">sent(19003): total=183530, rate=9975(msg/sec)</span><br><span class="line">sent(20003): total=193570, rate=10040(msg/sec)</span><br><span class="line">sent(21003): total=203556, rate=9986(msg/sec)</span><br><span class="line">sent(22004): total=213552, rate=9996(msg/sec)</span><br><span class="line">sent(23001): total=223534, rate=9982(msg/sec)</span><br><span class="line">sent(24002): total=233579, rate=10045(msg/sec)</span><br><span class="line">sent(25004): total=243607, rate=10028(msg/sec)</span><br><span class="line">sent(26002): total=253571, rate=9964(msg/sec)</span><br><span class="line">sent(27002): total=263535, rate=9964(msg/sec)</span><br><span class="line">sent(28003): total=273574, rate=10039(msg/sec)</span><br><span class="line">sent(29004): total=283575, rate=10001(msg/sec)</span><br><span class="line">sent(30004): total=293558, rate=9983(msg/sec)</span><br><span class="line">sent(31000): total=303537, rate=9979(msg/sec)</span><br><span class="line">sent(32004): total=313589, rate=10052(msg/sec)</span><br><span class="line">sent(33004): total=323592, rate=10003(msg/sec)</span><br><span class="line">sent(34004): total=333585, rate=9993(msg/sec)</span><br><span class="line">sent(35004): total=343563, rate=9978(msg/sec)</span><br><span class="line">sent(36002): total=353553, rate=9990(msg/sec)</span><br><span class="line">sent(37008): total=363561, rate=10008(msg/sec)</span><br><span class="line">sent(38004): total=373574, rate=10013(msg/sec)</span><br><span class="line">sent(39004): total=383552, rate=9978(msg/sec)</span><br><span class="line">sent(40005): total=393573, rate=10021(msg/sec)</span><br><span class="line"></span><br><span class="line">sent(41005): total=403559, rate=9986(msg/sec)</span><br><span class="line">sent(42015): total=413605, rate=10046(msg/sec)</span><br><span class="line">sent(43003): total=423574, rate=9969(msg/sec)</span><br><span class="line">sent(44002): total=433552, rate=9978(msg/sec)</span><br><span class="line">sent(45005): total=443570, rate=10018(msg/sec)</span><br><span class="line">sent(46000): total=453536, rate=9966(msg/sec)</span><br><span class="line">sent(47001): total=463565, rate=10029(msg/sec)</span><br><span class="line">sent(48004): total=473590, rate=10025(msg/sec)</span><br><span class="line">sent(49012): total=483560, rate=9970(msg/sec)</span><br><span class="line">sent(50002): total=493528, rate=9968(msg/sec)</span><br><span class="line">sent(51004): total=503592, rate=10064(msg/sec)</span><br><span class="line">sent(52003): total=513577, rate=9985(msg/sec)</span><br><span class="line">sent(53002): total=523538, rate=9961(msg/sec)</span><br><span class="line">sent(54008): total=533602, rate=10064(msg/sec)</span><br><span class="line">sent(55004): total=543539, rate=9937(msg/sec)</span><br><span class="line">sent(56004): total=553545, rate=10006(msg/sec)</span><br><span class="line">sent(57002): total=563556, rate=10011(msg/sec)</span><br><span class="line">sent(58004): total=573528, rate=9972(msg/sec)</span><br><span class="line">sent(59006): total=583608, rate=10080(msg/sec)</span><br><span class="line">sent(60004): total=593552, rate=9944(msg/sec)</span><br><span class="line">sent(61002): total=603495, rate=9943(msg/sec)</span><br><span class="line">sent(62003): total=613581, rate=10086(msg/sec)</span><br><span class="line">sent(63005): total=623551, rate=9970(msg/sec)</span><br><span class="line">sent(64007): total=633556, rate=10005(msg/sec)</span><br><span class="line">sent(65006): total=643588, rate=10032(msg/sec)</span><br><span class="line">sent(66010): total=653559, rate=9971(msg/sec)</span><br><span class="line">sent(67006): total=663559, rate=10000(msg/sec)</span><br><span class="line">sent(68005): total=673559, rate=10000(msg/sec)</span><br><span class="line">sent(69006): total=683589, rate=10030(msg/sec)</span><br><span class="line">sent(70018): total=693634, rate=10045(msg/sec)</span><br><span class="line">sent(71008): total=703568, rate=9934(msg/sec)</span><br><span class="line">sent(72016): total=713592, rate=10024(msg/sec)</span><br><span class="line">sent(73006): total=723602, rate=10010(msg/sec)</span><br><span class="line">sent(74004): total=733581, rate=9979(msg/sec)</span><br><span class="line">sent(75015): total=743593, rate=10012(msg/sec)</span><br><span class="line">sent(76006): total=753533, rate=9940(msg/sec)</span><br><span class="line">sent(77016): total=763560, rate=10027(msg/sec)</span><br><span class="line">sent(78007): total=773563, rate=10003(msg/sec)</span><br><span class="line">sent(79007): total=783541, rate=9978(msg/sec)</span><br><span class="line">sent(80014): total=793549, rate=10008(msg/sec)</span><br><span class="line">sent(81018): total=803514, rate=9965(msg/sec)</span><br><span class="line">sent(82006): total=813533, rate=10019(msg/sec)</span><br><span class="line">sent(83013): total=823551, rate=10018(msg/sec)</span><br><span class="line">sent(84021): total=833455, rate=9904(msg/sec)</span><br><span class="line">sent(85007): total=843510, rate=10055(msg/sec)</span><br><span class="line">sent(86018): total=853485, rate=9975(msg/sec)</span><br><span class="line">sent(87016): total=863449, rate=9964(msg/sec)</span><br><span class="line">sent(88009): total=873440, rate=9991(msg/sec)</span><br><span class="line"></span><br><span class="line">sent(89015): total=883132, rate=9692(msg/sec)</span><br><span class="line">sent(90035): total=892878, rate=9746(msg/sec)</span><br><span class="line">sent(91161): total=902805, rate=9927(msg/sec)</span><br><span class="line">sent(92453): total=912682, rate=9877(msg/sec)</span><br><span class="line">sent(93755): total=922701, rate=10019(msg/sec)</span><br><span class="line">sent(95034): total=932882, rate=10181(msg/sec)</span><br><span class="line">sent(96240): total=942679, rate=9797(msg/sec)</span><br><span class="line">sent(97483): total=952734, rate=10055(msg/sec)</span><br><span class="line">sent(98772): total=962904, rate=10170(msg/sec)</span><br><span class="line">sent(100124): total=972869, rate=9965(msg/sec)</span><br><span class="line">sent(101529): total=982883, rate=10014(msg/sec)</span><br><span class="line">sent(102938): total=992867, rate=9984(msg/sec)</span><br><span class="line">sent(104714): total=1002897, rate=10030(msg/sec)</span><br><span class="line">sent(106113): total=1012913, rate=10016(msg/sec)</span><br><span class="line">sent(107381): total=1022744, rate=9831(msg/sec)</span><br><span class="line">sent(108738): total=1032766, rate=10022(msg/sec)</span><br><span class="line">sent(110016): total=1042760, rate=9994(msg/sec)</span><br><span class="line">sent(111547): total=1052673, rate=9913(msg/sec)</span><br><span class="line">sent(112924): total=1062830, rate=10157(msg/sec)</span><br></pre></td></tr></table></figure>

<h2 id="三、EMQ概念"><a href="#三、EMQ概念" class="headerlink" title="三、EMQ概念"></a>三、EMQ概念</h2><h4 id="1-部署架构"><a href="#1-部署架构" class="headerlink" title="1.部署架构"></a>1.部署架构</h4><p>典型部署结构:</p>
<p><img src="/img/QQ%E5%9B%BE%E7%89%8720000.png" alt="QQ截图20000.png"></p>
<p>LB (负载均衡器) 负责分发设备的 MQTT 连接与消息到 EMQ 集群，LB 提高<br>EMQ 集群可用性、实现负载平衡以及动态扩容。<br>部署架构推荐在 LB 终结 SSL 连接。设备与 LB 之间 TLS 安全连接，LB 与<br>EMQ 之间普通 TCP 连接。这种部署模式下 EMQ 单集群可轻松支持100万设<br>备。<br>国内公有云部署推荐青云(EMQ 合作伙伴)，国外部署推荐 AWS 。私有部署推<br>荐使用 HAProxy 作为 LB。<br>EMQ 默认开启的 MQTT 服务 TCP 端口:</p>
<table>
<thead>
<tr>
<th>1883</th>
<th>MQTT 协议端口</th>
</tr>
</thead>
<tbody><tr>
<td>8883</td>
<td>MQTT/SSL 端口</td>
</tr>
<tr>
<td>8083</td>
<td>MQTT/WebSocket 端口</td>
</tr>
<tr>
<td>8084</td>
<td>MQTT/WebSocket/SSL 端口</td>
</tr>
</tbody></table>
<p>防火墙根据使用的 MQTT 接入方式，开启上述端口的访问权限。</p>
<p>EMQ 节点集群使用的 TCP 端口:</p>
<table>
<thead>
<tr>
<th>4369</th>
<th>集群节点发现端口</th>
</tr>
</thead>
<tbody><tr>
<td>6369</td>
<td>集群节点控制通道</td>
</tr>
</tbody></table>
<p>集群节点间如有防护墙，需开启上述 TCP 端口互访权限。</p>
<ol>
<li>创建 VPC 网络。</li>
<li>VPC 网络内创建 EMQ 集群’私有网络’，例如: 192.168.0.0/24</li>
<li>私有网络内创建两台 EMQ 主机，例如:</li>
</ol>
<table>
<thead>
<tr>
<th>EMQ2</th>
<th>192.168.0.2</th>
</tr>
</thead>
<tbody><tr>
<td>emq2</td>
<td>192.168.0.3</td>
</tr>
</tbody></table>
<ol start="4">
<li><p>安装并集群 EMQ 主机，具体配置请参考安装集群章节。</p>
</li>
<li><p>创建 LB(负载均衡器) 并指定公网 IP 地址。</p>
</li>
<li><p>在 LB 上创建 MQTT TCP 监听器:</p>
<p><img src="/img/QQ%E5%9B%BE%E7%89%8720001.png" alt="QQ图片20001.png"></p>
</li>
</ol>
<p>或创建 SSL 监听器，并终结 SSL 在 LB :</p>
<ol>
<li><p>MQTT 客户端连接 LB 公网地址测试。</p>
<p><img src="/img/QQ%E5%9B%BE%E7%89%8720002.png" alt="QQ图片20002.png"></p>
</li>
</ol>
<p>HAProxy -&gt; EMQ 集群</p>
<p>HAProxy 作为 LB 部署 EMQ 集群，并终结 SSL 连接:</p>
<ol>
<li>创建 EMQ 集群节点，例如:</li>
</ol>
<table>
<thead>
<tr>
<th>节点</th>
<th>IP 地址</th>
</tr>
</thead>
<tbody><tr>
<td>emq1</td>
<td>192.168.0.2</td>
</tr>
<tr>
<td>emq2</td>
<td>192.168.0.3</td>
</tr>
</tbody></table>
<ol>
<li>配置 /etc/haproxy/haproxy.cfg，示例:<br> 2.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">listen mqtt-ssl</span><br><span class="line">bind *:8883 ssl crt /etc/ssl/emqttd/emq.pem</span><br><span class="line">no-sslv3</span><br><span class="line">mode tcp</span><br><span class="line">maxconn 50000</span><br><span class="line">timeout client 600s</span><br><span class="line">default_backend emq_cluster</span><br><span class="line">backend emq_cluster</span><br><span class="line">mode tcp</span><br><span class="line">balance source</span><br><span class="line">timeout server 50s</span><br><span class="line">timeout check 5000</span><br><span class="line">server emq1 192.168.0.2:1883 check inter</span><br><span class="line">10000 fall 2 rise 5 weight 1</span><br><span class="line">server emq2 192.168.0.3:1883 check inter</span><br><span class="line">10000 fall 2 rise 5 weight 1</span><br><span class="line">source 0.0.0.0 usesrc clientip</span><br></pre></td></tr></table></figure>

<h4 id="2-配置文件详解"><a href="#2-配置文件详解" class="headerlink" title="2.配置文件详解"></a>2.配置文件详解</h4><p>EMQ 2.0 消息服务器通过 etc/ 目录下配置文件进行设置，主要配置文件包括:</p>
<table>
<thead>
<tr>
<th>配置文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>etc/emq.conf</td>
<td>EMQ 2.0 消息服务器配置文件</td>
</tr>
<tr>
<td>etc/acl.conf</td>
<td>EMQ 2.0 默认ACL规则配置文件</td>
</tr>
<tr>
<td>etc/plugins/*.conf</td>
<td>EMQ 2.0 各类插件配置文件</td>
</tr>
</tbody></table>
<h5 id="①EMQ-集群设置"><a href="#①EMQ-集群设置" class="headerlink" title="①EMQ 集群设置"></a>①EMQ 集群设置</h5><p>集群名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Cluster name</span><br><span class="line"></span><br><span class="line">cluster.name = emqcl</span><br></pre></td></tr></table></figure>

<p>自动发现策略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## Cluster dis-covery strategy: manual | static | mcast |</span><br><span class="line"></span><br><span class="line">dns | etcd | k8s</span><br><span class="line">cluster.dis-covery = manual</span><br></pre></td></tr></table></figure>

<p>启用集群自愈</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Cluster Autoheal: on | off</span><br><span class="line"></span><br><span class="line">cluster.autoheal = on</span><br></pre></td></tr></table></figure>

<p>节点自动清除</p>
<p>自动清除宕机节点:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Clean down node of the cluster</span><br><span class="line"></span><br><span class="line">cluster.autoclean = 5m</span><br></pre></td></tr></table></figure>

<p>EMQ 集群自动发现</p>
<p>EMQ R2.3 版本支持多种策略的节点自动发现与集群:</p>
<table>
<thead>
<tr>
<th>策略</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>manual</td>
<td>手工命令创建集群</td>
</tr>
<tr>
<td>static</td>
<td>静态节点列表自动集群</td>
</tr>
<tr>
<td>mcast</td>
<td>UDP 组播方式自动集群</td>
</tr>
<tr>
<td>dns</td>
<td>DNS A 记录自动集群</td>
</tr>
<tr>
<td>etcd</td>
<td>通过 etcd 自动集群</td>
</tr>
<tr>
<td>k8s</td>
<td>Kubernetes 服务自动集群</td>
</tr>
</tbody></table>
<p>manual 手动创建集群</p>
<p>默认配置为手动创建集群，节点通过 ./bin/emqttd_ctl join 命令加入:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = manual</span><br></pre></td></tr></table></figure>

<p>基于 static 节点列表自动集群</p>
<p>配置固定的节点列表，自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = static</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with static node list</span><br><span class="line"></span><br><span class="line">cluster.static.seeds = emq1@127.0.0.1,ekka2@127.0.0.1</span><br></pre></td></tr></table></figure>

<p>基于 mcast 组播自动集群</p>
<p>基于 UDP 组播自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = mcast</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with multicast</span><br><span class="line"></span><br><span class="line">cluster.mcast.addr = 239.192.0.1</span><br><span class="line">cluster.mcast.ports = 4369,4370</span><br><span class="line">cluster.mcast.iface = 0.0.0.0</span><br><span class="line">cluster.mcast.ttl = 255</span><br><span class="line">cluster.mcast.loop = on</span><br></pre></td></tr></table></figure>

<p>基于 DNS A 记录自动集群</p>
<p>基于 DNS A 记录自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = dns</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with DNS</span><br><span class="line"></span><br><span class="line">cluster.dns.name = localhost</span><br><span class="line">cluster.dns.app = ekka</span><br></pre></td></tr></table></figure>

<p>基于 etcd 自动集群</p>
<p>基于 etcd _ 自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = etcd</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with Etcd</span><br><span class="line"></span><br><span class="line">cluster.etcd.server = http://127.0.0.1:2379</span><br><span class="line">cluster.etcd.prefix = emqcl</span><br><span class="line">cluster.etcd.node_ttl = 1m</span><br></pre></td></tr></table></figure>

<p>基于 Kubernetes 自动集群</p>
<p>Kubernetes _ 下自动发现并创建集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cluster.dis-covery = k8s</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Cluster with k8s</span><br><span class="line"></span><br><span class="line">cluster.k8s.apiserver = http://10.110.111.204:8080</span><br><span class="line">cluster.k8s.service_name = ekka</span><br><span class="line"></span><br><span class="line">## Address Type: ip | dns</span><br><span class="line"></span><br><span class="line">cluster.k8s.address_type = ip</span><br><span class="line"></span><br><span class="line">## The Erlang application name</span><br><span class="line"></span><br><span class="line">cluster.k8s.app_name = ekka</span><br></pre></td></tr></table></figure>

<p>EMQ 节点与 Cookie</p>
<p>Erlang 节点名称、分布式节点间通信 Cookie:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## Node name</span><br><span class="line"></span><br><span class="line">node.name = emqttd@127.0.0.1</span><br><span class="line"></span><br><span class="line">## Cookie for distributed node</span><br><span class="line"></span><br><span class="line">node.cookie = emq_dist_cookie</span><br></pre></td></tr></table></figure>

<p>注解</p>
<p>Erlang/OTP 平台应用多由分布的 Erlang 节点(进程)组成，每个 Erlang 节点<br>(进程)需指配一个节点名，用于节点间通信互访。 所有互相通信的 Erlang 节<br>点(进程)间通过一个共用的 Cookie 进行安全认证。<br>EMQ 节点连接方式<br>EMQ 节点基于 Erlang/OTP 平台的 TCPv4, TCPv6 或 TLS 协议连接:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">## Specify the erlang distributed protocol.</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">## Value: Enum</span><br><span class="line"></span><br><span class="line">## - inet_tcp: the default; handles TCP streams with</span><br><span class="line"></span><br><span class="line">IPv4 addressing.</span><br><span class="line"></span><br><span class="line">## - inet6_tcp: handles TCP with IPv6 addressing.</span><br><span class="line"></span><br><span class="line">## - inet_tls: using TLS for Erlang Distribution.</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">## vm.args: -proto_dist inet_tcp</span><br><span class="line"></span><br><span class="line">node.proto_dist = inet_tcp</span><br><span class="line"></span><br><span class="line">## Specify SSL Options in the file if using SSL for</span><br><span class="line"></span><br><span class="line">Erlang Distribution.</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">## Value: File</span><br><span class="line"></span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">## vm.args: -ssl_dist_optfile &lt;File&gt;</span><br><span class="line"></span><br><span class="line">## node.ssl_dist_optfile = &#123;&#123; platform_etc_dir</span><br><span class="line"></span><br><span class="line">&#125;&#125;/ssl_dist.conf</span><br></pre></td></tr></table></figure>

<h5 id="②Erlang-虚拟机参数"><a href="#②Erlang-虚拟机参数" class="headerlink" title="②Erlang 虚拟机参数"></a>②Erlang 虚拟机参数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">## SMP support: enable, auto, disable</span><br><span class="line"></span><br><span class="line">node.smp = auto</span><br><span class="line"></span><br><span class="line">## Enable kernel poll</span><br><span class="line"></span><br><span class="line">node.kernel_poll = on</span><br><span class="line"></span><br><span class="line">## async thread pool</span><br><span class="line"></span><br><span class="line">node.async_threads = 32</span><br><span class="line"></span><br><span class="line">## Erlang Process Limit</span><br><span class="line"></span><br><span class="line">node.process_limit = 256000</span><br><span class="line"></span><br><span class="line">## Sets the maximum number of simultaneously existing</span><br><span class="line"></span><br><span class="line">ports for this system</span><br><span class="line">node.max_ports = 65536</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">## Set the distribution buffer busy limit</span><br><span class="line"></span><br><span class="line">(dist_buf_busy_limit)</span><br><span class="line">node.dist_buffer_size = 32MB</span><br><span class="line"></span><br><span class="line">## Max ETS Tables.</span><br><span class="line"></span><br><span class="line">## Note that mnesia and SSL will create temporary ets</span><br><span class="line"></span><br><span class="line">tables.</span><br><span class="line">node.max_ets_tables = 256000</span><br><span class="line"></span><br><span class="line">## Tweak GC to run more often</span><br><span class="line"></span><br><span class="line">node.fullsweep_after = 1000</span><br><span class="line"></span><br><span class="line">## Crash dump</span><br><span class="line"></span><br><span class="line">node.crash_dump = log/crash.dump</span><br><span class="line"></span><br><span class="line">## Distributed node ticktime</span><br><span class="line"></span><br><span class="line">node.dist_net_ticktime = 60</span><br><span class="line"></span><br><span class="line">## Distributed node port range</span><br><span class="line"></span><br><span class="line">## node.dist_listen_min = 6000</span><br><span class="line"></span><br><span class="line">## node.dist_listen_max = 6999</span><br></pre></td></tr></table></figure>

<p>Erlang 虚拟机主要参数说明:</p>
<p>| NODE.PROCESS_LIMIT   | ERLANG 虚拟机允许的最大进程数，一个 MQTT<br><br>连接会消耗2个 ERLANG 进程，所以参数值 &gt; 最</p>
<p>大连接数 * 2 |<br>| ——————– | ———————————————————— |<br>| node.max_ports       | Erlang 虚拟机允许的最大 Port 数量，一个 MQTT<br><br>连接消耗1个 Port，所以参数值 &gt; 最大连接数 |<br>| node.dist_listen_min | Erlang 分布节点间通信使用 TCP 连接端口范围。<br><br>注: 节点间如有防火墙，需要配置该端口段 |<br>| node.dist_listen_max | Erlang 分布节点间通信使用 TCP 连接端口范围。<br><br>注: 节点间如有防火墙，需要配置该端口段 |</p>
<h5 id="③日志参数配置"><a href="#③日志参数配置" class="headerlink" title="③日志参数配置"></a>③日志参数配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">##### console 日志</span><br><span class="line"></span><br><span class="line">## Console log. Enum: off, file, console, both</span><br><span class="line"></span><br><span class="line">log.console = console</span><br><span class="line"></span><br><span class="line">## Console log level. Enum: debug, info, notice,</span><br><span class="line"></span><br><span class="line">warning, error, critical, alert, emergency</span><br><span class="line">log.console.level = error</span><br><span class="line"></span><br><span class="line">## Console log file</span><br><span class="line"></span><br><span class="line">## log.console.file = log/console.log</span><br></pre></td></tr></table></figure>

<p>error 日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Error log file</span><br><span class="line"></span><br><span class="line">log.error.file = log/error.log</span><br></pre></td></tr></table></figure>

<p>crash 日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## Enable the crash log. Enum: on, off</span><br><span class="line"></span><br><span class="line">log.crash = on</span><br><span class="line">log.crash.file = log/crash.log</span><br></pre></td></tr></table></figure>

<p>syslog 日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## Syslog. Enum: on, off</span><br><span class="line"></span><br><span class="line">log.syslog = on</span><br><span class="line"></span><br><span class="line">## syslog level. Enum: debug, info, notice, warning,</span><br><span class="line"></span><br><span class="line">error, critical, alert, emergency</span><br><span class="line">log.syslog.level = error</span><br></pre></td></tr></table></figure>

<h5 id="④MQTT-协议参数配置"><a href="#④MQTT-协议参数配置" class="headerlink" title="④MQTT 协议参数配置"></a>④MQTT 协议参数配置</h5><p>ClientId 最大允许长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Max ClientId Length Allowed.</span><br><span class="line"></span><br><span class="line">mqtt.max_clientid_len = 1024</span><br></pre></td></tr></table></figure>

<p>MQTT 最大报文尺寸</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Max Packet Size Allowed, 64K by default.</span><br><span class="line"></span><br><span class="line">mqtt.max_packet_size = 64KB</span><br></pre></td></tr></table></figure>

<p>客户端连接闲置时间</p>
<p>设置 MQTT 客户端最大允许闲置时间(Socket 连接建立，但未收到 CONNECT<br>报文):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Client Idle Timeout (Second)</span><br><span class="line"></span><br><span class="line">mqtt.client.idle_timeout = 30</span><br></pre></td></tr></table></figure>

<p>启用客户端连接统计</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">## Enable client Stats: on | off</span><br><span class="line">mqtt.client.enable_stats = off</span><br></pre></td></tr></table></figure>

<p>强制 GC 设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Force GC: integer. Value 0 disabled the Force GC.</span><br><span class="line"></span><br><span class="line">mqtt.conn.force_gc_count = 100</span><br></pre></td></tr></table></figure>

<h5 id="⑤匿名认证与-ACL-文件"><a href="#⑤匿名认证与-ACL-文件" class="headerlink" title="⑤匿名认证与 ACL 文件"></a>⑤匿名认证与 ACL 文件</h5><p>是否开启匿名认证<br>默认开启，允许任意客户端登录:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## Allow Anonymous authentication</span><br><span class="line"></span><br><span class="line">mqtt.allow_anonymous = true</span><br></pre></td></tr></table></figure>

<p>默认访问控制(ACL)文件<br>EMQ 支持基于 etc/acl.conf 文件或 MySQL、 PostgreSQL 等插件的访问控制规<br>则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## ACL nomatch</span><br><span class="line"></span><br><span class="line">mqtt.acl_nomatch = allow</span><br><span class="line"></span><br><span class="line">## Default ACL File</span><br><span class="line"></span><br><span class="line">mqtt.acl_file = etc/acl.conf</span><br></pre></td></tr></table></figure>

<p>etc/acl.conf 访问控制规则定义:<br>允许|拒绝 用户|IP地址|ClientID 发布|订阅 主题列表<br>访问控制规则采用 Erlang 元组格式，访问控制模块逐条匹配规则:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">Client -&gt; | Rule1 | --nomatch--&gt; | Rule2 | --nomatch--&gt;</span><br><span class="line">| Rule3 | --&gt; Default</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">| |</span><br><span class="line">|</span><br><span class="line">match match</span><br><span class="line">match</span><br><span class="line">\|/ \|/</span><br><span class="line">\|/</span><br><span class="line">allow | deny allow | deny</span><br><span class="line">allow | deny</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">etc/acl.conf 默认访问规则设置:</span><br><span class="line"></span><br><span class="line">%% 允许&apos;dashboard&apos;用户订阅 &apos;$SYS/#&apos;</span><br><span class="line">&#123;allow, &#123;user, &quot;dashboard&quot;&#125;, subscribe, [&quot;$SYS/#&quot;]&#125;.</span><br><span class="line">%% 允许本机用户发布订阅全部主题</span><br><span class="line">&#123;allow, &#123;ipaddr, &quot;127.0.0.1&quot;&#125;, pubsub, [&quot;$SYS/#&quot;, &quot;#&quot;]&#125;.</span><br><span class="line">%% 拒绝用户订阅&apos;$SYS#&apos;与&apos;#&apos;主题</span><br><span class="line">&#123;deny, all, subscribe, [&quot;$SYS/#&quot;, &#123;eq, &quot;#&quot;&#125;]&#125;.</span><br><span class="line">%% 上述规则无匹配，允许</span><br><span class="line">&#123;allow, all&#125;.</span><br></pre></td></tr></table></figure>

<p>注解<br>默认规则只允许本机用户订阅’$SYS/#’与’#’<br>EMQ 消息服务器接收到 MQTT 客户端发布(PUBLISH)或订阅(SUBSCRIBE)请<br>求时，会逐条匹配 ACL 访问控制规则，直到匹配成功返回 allow 或 deny。</p>
<h5 id="⑥MQTT-会话参数设置"><a href="#⑥MQTT-会话参数设置" class="headerlink" title="⑥MQTT 会话参数设置"></a>⑥MQTT 会话参数设置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">## Upgrade QoS?</span><br><span class="line"></span><br><span class="line">mqtt.session.upgrade_qos = off</span><br><span class="line"></span><br><span class="line">## Max number of QoS 1 and 2 messages that can be</span><br><span class="line"></span><br><span class="line">“inflight” at one time.</span><br><span class="line"></span><br><span class="line">## 0 means no limit</span><br><span class="line"></span><br><span class="line">mqtt.session.max_inflight = 32</span><br><span class="line"></span><br><span class="line">## Retry Interval for redelivering QoS1/2 messages.</span><br><span class="line"></span><br><span class="line">mqtt.session.retry_interval = 20s</span><br><span class="line"></span><br><span class="line">## Max Packets that Awaiting PUBREL, 0 means no limit</span><br><span class="line"></span><br><span class="line">mqtt.session.max_awaiting_rel = 100</span><br><span class="line"></span><br><span class="line">## Awaiting PUBREL Timeout</span><br><span class="line"></span><br><span class="line">mqtt.session.await_rel_timeout = 20s</span><br><span class="line"></span><br><span class="line">## Enable Statistics: on | off</span><br><span class="line"></span><br><span class="line">mqtt.session.enable_stats = off</span><br><span class="line"></span><br><span class="line">## Expired after 1 day:</span><br><span class="line"></span><br><span class="line">## w - week</span><br><span class="line"></span><br><span class="line">## d - day</span><br><span class="line"></span><br><span class="line">## h - hour</span><br><span class="line"></span><br><span class="line">## m - minute</span><br><span class="line"></span><br><span class="line">## s - second</span><br><span class="line"></span><br><span class="line">mqtt.session.expiry_interval = 2h</span><br></pre></td></tr></table></figure>

<h5 id="⑦MQTT-消息队列参数设置"><a href="#⑦MQTT-消息队列参数设置" class="headerlink" title="⑦MQTT 消息队列参数设置"></a>⑦MQTT 消息队列参数设置</h5><p>EMQ 消息服务器会话通过队列缓存 Qos1/Qos2 消息:</p>
<ol>
<li><p>持久会话(Session)的离线消息</p>
</li>
<li><p>飞行窗口满而延迟下发的消息<br> 队列参数设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">## Type: simple | priority</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.type = simple</span><br><span class="line"></span><br><span class="line">## Topic Priority: 0~255, Default is 0</span><br><span class="line"></span><br><span class="line">## mqtt.mqueue.priority = topic/1=10,topic/2=8</span><br><span class="line"></span><br><span class="line">## Max queue length. Enqueued messages when persistent</span><br><span class="line"></span><br><span class="line">client disconnected,</span><br><span class="line"></span><br><span class="line">## or inflight window is full. 0 means no limit.</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.max_length = 0</span><br><span class="line"></span><br><span class="line">## Low-water mark of queued messages</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.low_watermark = 20%</span><br><span class="line"></span><br><span class="line">## High-water mark of queued messages</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.high_watermark = 60%</span><br><span class="line"></span><br><span class="line">## Queue Qos0 messages?</span><br><span class="line"></span><br><span class="line">mqtt.mqueue.store_qos0 = true</span><br></pre></td></tr></table></figure>

<p>队列参数说明:</p>
<p>| MQUEUE.TYPE           | 队列类型。SIMPLE: 简单队列，PRIORITY: 优先<br><br>级队列 |<br>| ——————— | —————————————————– |<br>| mqueue.priority       | 主题(Topic)队列优先级设置                             |<br>| mqueue.max_length     | 队列长度, infinity 表示不限制                         |<br>| mqueue.low_watermark  | 解除告警水位线                                        |<br>| mqueue.high_watermark | 队列满告警水位线                                      |<br>| mqueue.qos0           | 是否缓存 QoS0 消息                                    |</p>
<p>Broker 参数设置</p>
<p>broker_sys_interval 设置系统发布 $SYS 消息周期:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. System Interval of publishing broker $SYS Messages</span><br><span class="line"></span><br><span class="line">   mqtt.broker.sys_interval = 60s</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>发布订阅(PubSub)参数设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">## PubSub Pool Size. Default should be scheduler</span><br><span class="line"></span><br><span class="line">numbers.</span><br><span class="line">mqtt.pubsub.pool_size = 8</span><br><span class="line">mqtt.pubsub.by_clientid = true</span><br><span class="line"></span><br><span class="line">## Subscribe Asynchronously</span><br><span class="line"></span><br><span class="line">mqtt.pubsub.async = true</span><br></pre></td></tr></table></figure>

<p>桥接(Bridge)参数设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## Bridge Queue Size</span><br><span class="line"></span><br><span class="line">mqtt.bridge.max_queue_len = 10000</span><br><span class="line"></span><br><span class="line">## Ping Interval of bridge node. Unit: Second</span><br><span class="line"></span><br><span class="line">mqtt.bridge.ping_down_interval = 1s</span><br></pre></td></tr></table></figure>

<p>插件(Plugin) 配置目录设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## Dir of plugins&apos; config</span><br><span class="line"></span><br><span class="line">mqtt.plugins.etc_dir = etc/plugins/</span><br><span class="line"></span><br><span class="line">## File to store loaded plugin names.</span><br><span class="line"></span><br><span class="line">mqtt.plugins.loaded_file = data/loaded_plugins</span><br></pre></td></tr></table></figure>

<h5 id="⑧MQTT-Listeners-参数说明"><a href="#⑧MQTT-Listeners-参数说明" class="headerlink" title="⑧MQTT Listeners 参数说明"></a>⑧MQTT Listeners 参数说明</h5><p>EMQ 消息服务器支持 MQTT、MQTT/SSL、MQTT/WS 协议服务端，可通过<br>listener.tcp|ssl|ws|wss|.* 设置端口、最大允许连接数等参数。<br>EMQ 2.2 消息服务器默认开启的 TCP 服务端口包括:</p>
<table>
<thead>
<tr>
<th>1883</th>
<th>MQTT 协议端口</th>
</tr>
</thead>
<tbody><tr>
<td>8883</td>
<td>MQTT/SSL 端口</td>
</tr>
<tr>
<td>8083</td>
<td>MQTT/WebSocket 端口</td>
</tr>
<tr>
<td>8080</td>
<td>HTTP 管理 API 端口</td>
</tr>
<tr>
<td>8084</td>
<td>MQTT/WebSocket/SSL 端口</td>
</tr>
</tbody></table>
<p>Listener 参数说明:</p>
<table>
<thead>
<tr>
<th>LISTENER.TCP.${NAME}.ACCEPTORS</th>
<th>TCP ACCEPTOR 池</th>
</tr>
</thead>
<tbody><tr>
<td>listener.tcp.${name}.max_clients</td>
<td>最大允许 TCP 连接数</td>
</tr>
<tr>
<td>listener.tcp.${name}.rate_limit</td>
<td>连接限速配置，例如限速10KB/秒:</td>
</tr>
<tr>
<td><br>“100,10”</td>
<td></td>
</tr>
</tbody></table>
<p>MQTT/TCP 监听器 - 1883<br>EMQ 2.2 版本支持配置多个 MQTT 协议监听器，例如配置 external、internal<br>两个监听器:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## External TCP Listener</span><br><span class="line"></span><br><span class="line">## External TCP Listener: 1883, 127.0.0.1:1883, ::1:1883</span><br><span class="line"></span><br><span class="line">listener.tcp.external = 0.0.0.0:1883</span><br><span class="line"></span><br><span class="line">## Size of acceptor pool</span><br><span class="line"></span><br><span class="line">listener.tcp.external.acceptors = 16</span><br><span class="line"></span><br><span class="line">## Maximum number of concurrent clients</span><br><span class="line"></span><br><span class="line">listener.tcp.external.max_clients = 102400</span><br><span class="line">#listener.tcp.external.mountpoint = external/</span><br><span class="line"></span><br><span class="line">## Rate Limit. Format is &apos;burst,rate&apos;, Unit is KB/Sec</span><br><span class="line"></span><br><span class="line">#listener.tcp.external.rate_limit = 100,10</span><br><span class="line">#listener.tcp.external.access.1 = allow 192.168.0.0/24</span><br><span class="line">listener.tcp.external.access.2 = allow all</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">## Proxy Protocol V1/2</span><br><span class="line"></span><br><span class="line">## listener.tcp.external.proxy_protocol = on</span><br><span class="line"></span><br><span class="line">## listener.tcp.external.proxy_protocol_timeout = 3s</span><br><span class="line"></span><br><span class="line">## TCP Socket Options</span><br><span class="line"></span><br><span class="line">listener.tcp.external.backlog = 1024</span><br><span class="line">#listener.tcp.external.recbuf = 4KB</span><br><span class="line">#listener.tcp.external.sndbuf = 4KB</span><br><span class="line">listener.tcp.external.buffer = 4KB</span><br><span class="line">listener.tcp.external.nodelay = true</span><br><span class="line"></span><br><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## Internal TCP Listener</span><br><span class="line"></span><br><span class="line">## Internal TCP Listener: 11883, 127.0.0.1:11883,</span><br><span class="line"></span><br><span class="line">::1:11883</span><br><span class="line">listener.tcp.internal = 127.0.0.1:11883</span><br><span class="line"></span><br><span class="line">## Size of acceptor pool</span><br><span class="line"></span><br><span class="line">listener.tcp.internal.acceptors = 16</span><br><span class="line"></span><br><span class="line">## Maximum number of concurrent clients</span><br><span class="line"></span><br><span class="line">listener.tcp.internal.max_clients = 102400</span><br><span class="line">#listener.tcp.external.mountpoint = internal/</span><br><span class="line"></span><br><span class="line">## Rate Limit. Format is &apos;burst,rate&apos;, Unit is KB/Sec</span><br><span class="line"></span><br><span class="line">## listener.tcp.internal.rate_limit = 1000,100</span><br><span class="line"></span><br><span class="line">## TCP Socket Options</span><br><span class="line"></span><br><span class="line">listener.tcp.internal.backlog = 512</span><br><span class="line">listener.tcp.internal.tune_buffer = on</span><br><span class="line">listener.tcp.internal.buffer = 1MB</span><br><span class="line">listener.tcp.internal.recbuf = 4KB</span><br><span class="line">listener.tcp.internal.sndbuf = 1MB</span><br><span class="line">listener.tcp.internal.nodelay = true</span><br></pre></td></tr></table></figure>

<p>MQTT/SSL 监听器 - 8883</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## External SSL Listener</span><br><span class="line"></span><br><span class="line">listener.ssl.external = 8883</span><br><span class="line"></span><br><span class="line">## Size of acceptor pool</span><br><span class="line"></span><br><span class="line">listener.ssl.external.acceptors = 16</span><br><span class="line"></span><br><span class="line">## Maximum number of concurrent clients</span><br><span class="line"></span><br><span class="line">listener.ssl.external.max_clients = 1024</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.mountpoint = inbound/</span><br><span class="line"></span><br><span class="line">## Rate Limit. Format is &apos;burst,rate&apos;, Unit is KB/Sec</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.rate_limit = 100,10</span><br><span class="line"></span><br><span class="line">## Proxy Protocol V1/2</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.proxy_protocol = on</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.proxy_protocol_timeout = 3s</span><br><span class="line"></span><br><span class="line">listener.ssl.external.access.1 = allow all</span><br><span class="line"></span><br><span class="line">## SSL Options</span><br><span class="line"></span><br><span class="line">listener.ssl.external.handshake_timeout = 15</span><br><span class="line">listener.ssl.external.keyfile = etc/certs/key.pem</span><br><span class="line">listener.ssl.external.certfile = etc/certs/cert.pem</span><br><span class="line"></span><br><span class="line">## 开启双向认证</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.cacertfile =</span><br><span class="line"></span><br><span class="line">etc/certs/cacert.pem</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.verify = verify_peer</span><br><span class="line"></span><br><span class="line">## listener.ssl.external.fail_if_no_peer_cert = true</span><br></pre></td></tr></table></figure>

<p>MQTT/WebSocket 监听器 - 8083</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## External MQTT/WebSocket Listener</span><br><span class="line"></span><br><span class="line">listener.ws.external = 8083</span><br><span class="line">listener.ws.external.acceptors = 4</span><br><span class="line">listener.ws.external.max_clients = 64</span><br><span class="line">listener.ws.external.access.1 = allow all</span><br></pre></td></tr></table></figure>

<p>MQTT/WebSocket/SSL 监听器 - 8084</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## External MQTT/WebSocket/SSL Listener</span><br><span class="line"></span><br><span class="line">listener.wss.external = 8084</span><br><span class="line">listener.wss.external.acceptors = 4</span><br><span class="line">listener.wss.external.max_clients = 64</span><br><span class="line">listener.wss.external.access.1 = allow all</span><br><span class="line"></span><br><span class="line">## SSL Options</span><br><span class="line"></span><br><span class="line">listener.wss.external.handshake_timeout = 15s</span><br><span class="line">listener.wss.external.keyfile = &#123;&#123; platform_etc_dir</span><br><span class="line">&#125;&#125;/certs/key.pem</span><br><span class="line">listener.wss.external.certfile = &#123;&#123; platform_etc_dir</span><br><span class="line">&#125;&#125;/certs/cert.pem</span><br><span class="line"></span><br><span class="line">## listener.wss.external.cacertfile = &#123;&#123;</span><br><span class="line"></span><br><span class="line">platform_etc_dir &#125;&#125;/certs/cacert.pem</span><br><span class="line"></span><br><span class="line">## listener.wss.external.verify = verify_peer</span><br><span class="line"></span><br><span class="line">## listener.wss.external.fail_if_no_peer_cert = true</span><br></pre></td></tr></table></figure>

<p>HTTP API 监听器 - 8080</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## ##------------------------------------------------------</span><br><span class="line"></span><br><span class="line">## HTTP Management API Listener</span><br><span class="line"></span><br><span class="line">listener.api.mgmt = 127.0.0.1:8080</span><br><span class="line">listener.api.mgmt.acceptors = 4</span><br><span class="line">listener.api.mgmt.max_clients = 64</span><br><span class="line">listener.api.mgmt.access.1 = allow all</span><br></pre></td></tr></table></figure>

<h5 id="⑨Erlang-虚拟机监控设置"><a href="#⑨Erlang-虚拟机监控设置" class="headerlink" title="⑨Erlang 虚拟机监控设置"></a>⑨Erlang 虚拟机监控设置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">## Long GC, don&apos;t monitor in production mode for:</span><br><span class="line"></span><br><span class="line">sysmon.long_gc = false</span><br><span class="line"></span><br><span class="line">## Long Schedule(ms)</span><br><span class="line"></span><br><span class="line">sysmon.long_schedule = 240</span><br><span class="line"></span><br><span class="line">## 8M words. 32MB on 32-bit VM, 64MB on 64-bit VM.</span><br><span class="line"></span><br><span class="line">sysmon.large_heap = 8MB</span><br><span class="line"></span><br><span class="line">## Busy Port</span><br><span class="line"></span><br><span class="line">sysmon.busy_port = false</span><br><span class="line"></span><br><span class="line">## Busy Dist Port</span><br><span class="line"></span><br><span class="line">sysmon.busy_dist_port = true</span><br></pre></td></tr></table></figure>

<h5 id="⑩扩展插件配置文件"><a href="#⑩扩展插件配置文件" class="headerlink" title="⑩扩展插件配置文件"></a>⑩扩展插件配置文件</h5><p>EMQ 2.2 插件配置文件，全部在 etc/plugins/ 目录:</p>
<table>
<thead>
<tr>
<th>配置文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>etc/plugins/emq_mod_presence</td>
<td>客户端上下线状态消息发布</td>
</tr>
<tr>
<td>etc/plugins/emq_mod_retainer</td>
<td>Retain 消息存储插件</td>
</tr>
<tr>
<td>etc/plugins/emq_mod_subscription</td>
<td>客户端上线自动主题订阅</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_username.conf</td>
<td>用户名、密码认证插件</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_clientid.conf</td>
<td>ClientId 认证插件</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_http.conf</td>
<td>HTTP 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_mongo.conf</td>
<td>MongoDB 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_mysql.conf</td>
<td>MySQL 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_pgsql.conf</td>
<td>Postgre 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_auth_redis.conf</td>
<td>Redis 认证插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_web_hook.conf</td>
<td>Web Hook 插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_lua_hook.conf</td>
<td>Lua Hook 插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_coap.conf</td>
<td>CoAP 协议服务器配置</td>
</tr>
<tr>
<td>etc/plugins/emq_dashboard.conf</td>
<td>Dashboard 控制台插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_plugin_template.conf</td>
<td>示例插件模版</td>
</tr>
<tr>
<td>etc/plugins/emq_recon.conf</td>
<td>Recon 调试插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_reloader.conf</td>
<td>热加载插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_sn.conf</td>
<td>MQTT-SN 协议插件配置</td>
</tr>
<tr>
<td>etc/plugins/emq_stomp.conf</td>
<td>Stomp 协议插件配置</td>
</tr>
</tbody></table>
<h2 id="3-管理命令解析"><a href="#3-管理命令解析" class="headerlink" title="3.管理命令解析"></a>3.管理命令解析</h2><p>EMQ 消息服务器提供了 ./bin/emqttd_ctl的管理命令行。</p>
<h5 id="①启动服务器"><a href="#①启动服务器" class="headerlink" title="①启动服务器"></a>①启动服务器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$ ./bin/emqttd</span><br><span class="line">start</span><br><span class="line">Node &apos;emq@127.0.0.1&apos; is started</span><br><span class="line">emqttd 2.3.11 is running</span><br></pre></td></tr></table></figure>

<h5 id="②status-命令"><a href="#②status-命令" class="headerlink" title="②status 命令"></a>②status 命令</h5><p>查询 EMQ 消息服务器运行状态:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl status</span><br><span class="line">Node &apos;emqttd@127.0.0.1&apos; is started</span><br><span class="line">emqttd 2.0 is running</span><br></pre></td></tr></table></figure>

<h5 id="③broker-命令"><a href="#③broker-命令" class="headerlink" title="③broker 命令"></a>③broker 命令</h5><p>broker 命令查询服务器基本信息，启动时间，统计数据与性能数据。</p>
<table>
<thead>
<tr>
<th>BROKER</th>
<th>查询 EMQ 消息服务器描述、版本、启动时间</th>
</tr>
</thead>
<tbody><tr>
<td>broker</td>
<td>查询核心的 Erlang PubSub 进程状态(调试)</td>
</tr>
<tr>
<td>pubsub</td>
<td></td>
</tr>
<tr>
<td>broker</td>
<td>查询连接(Client)、会话(Session)、主题(Topic)、 订阅</td>
</tr>
<tr>
<td><br>(Subscription)、路由(Route)统计信息</td>
<td></td>
</tr>
<tr>
<td>stats</td>
<td></td>
</tr>
<tr>
<td>broker</td>
<td>查询 MQTT 报文(Packet)、消息(Message)收发统计</td>
</tr>
<tr>
<td>metrics</td>
<td></td>
</tr>
</tbody></table>
<p>查询 EMQ 消息服务器基本信息包括版本、启动时间等:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl broker</span><br><span class="line">sysdescr : Erlang MQTT Broker</span><br><span class="line">version : 2.3.6</span><br><span class="line">uptime : 25 days,3 hours, 38 minutes, 10 seconds</span><br><span class="line">datetime : 2018-08-08 16:52:08</span><br></pre></td></tr></table></figure>

<p>broker stats<br>查询服务器客户端连接(Client)、会话(Session)、主题(Topic)、订阅<br>(Subscription)、路由(Route)统计:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl broker stats</span><br><span class="line">clients/count : 519</span><br><span class="line">clients/max : 810</span><br><span class="line">retained/count : 3821</span><br><span class="line">retained/max : 3821</span><br><span class="line">routes/count : 557</span><br><span class="line">routes/max : 814</span><br><span class="line">sessions/count : 556</span><br><span class="line">sessions/max : 814</span><br><span class="line">subscribers/count : 1111</span><br><span class="line">subscribers/max : 1625</span><br><span class="line">subscriptions/count : 1111</span><br><span class="line">subscriptions/max : 1625</span><br><span class="line">topics/count : 557</span><br><span class="line">topics/max : 814</span><br></pre></td></tr></table></figure>

<p>broker metrics</p>
<p>查询服务器流量(Bytes)、MQTT报文(Packets)、消息(Messages)收发统计:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl broker metrics</span><br><span class="line">bytes/received : 1116429069</span><br><span class="line">bytes/sent : 1114027032</span><br><span class="line">messages/dropped : 50313</span><br><span class="line">messages/qos0/received : 0</span><br><span class="line">messages/qos0/sent : 0</span><br><span class="line">messages/qos1/received : 7837778</span><br><span class="line">messages/qos1/sent : 7954830</span><br><span class="line">messages/qos2/dropped : 0</span><br><span class="line">messages/qos2/received : 0</span><br><span class="line">messages/qos2/sent : 0</span><br><span class="line">messages/received : 7837778</span><br><span class="line">messages/retained : 3821</span><br><span class="line">messages/sent : 7954830</span><br><span class="line">packets/connack : 64632</span><br><span class="line">packets/connect : 67040</span><br><span class="line">packets/disconnect : 0</span><br><span class="line">packets/pingreq : 25769</span><br><span class="line">packets/pingresp : 25769</span><br><span class="line">packets/puback/missed : 402</span><br><span class="line">packets/puback/received : 7931899</span><br><span class="line">packets/puback/sent : 7837778</span><br><span class="line">packets/pubcomp/missed : 0</span><br><span class="line">packets/pubcomp/received: 0</span><br><span class="line">packets/pubcomp/sent : 0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">packets/publish/received: 7837778</span><br><span class="line">packets/publish/sent : 7954830</span><br><span class="line">packets/pubrec/missed : 0</span><br><span class="line">packets/pubrec/received : 0</span><br><span class="line">packets/pubrec/sent : 0</span><br><span class="line">packets/pubrel/missed : 0</span><br><span class="line">packets/pubrel/received : 0</span><br><span class="line">packets/pubrel/sent : 0</span><br><span class="line">packets/received : 15985446</span><br><span class="line">packets/sent : 16005957</span><br><span class="line">packets/suback : 122948</span><br><span class="line">packets/subscribe : 122960</span><br><span class="line">packets/unsuback : 0</span><br><span class="line">packets/unsubscribe : 0</span><br></pre></td></tr></table></figure>

<h5 id="④cluster-命令"><a href="#④cluster-命令" class="headerlink" title="④cluster 命令"></a>④cluster 命令</h5><p>cluster 命令集群多个 EMQ 消息服务器节点(进程):</p>
<table>
<thead>
<tr>
<th>CLUSTER JOIN</th>
<th>加入集群</th>
</tr>
</thead>
<tbody><tr>
<td>cluster leave</td>
<td>离开集群</td>
</tr>
<tr>
<td>cluster remove</td>
<td>从集群删除节点</td>
</tr>
<tr>
<td>cluster status</td>
<td>查询集群状态</td>
</tr>
</tbody></table>
<p>cluster 命令集群本机两个 EMQ 节点示例:</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>节点名</th>
<th>MQTT 端口</th>
</tr>
</thead>
<tbody><tr>
<td>emqttd1</td>
<td><a href="mailto:emqttd1@127.0.0.1" target="_blank" rel="noopener">emqttd1@127.0.0.1</a></td>
<td>1883</td>
</tr>
<tr>
<td>emqttd2</td>
<td><a href="mailto:emqttd2@127.0.0.1" target="_blank" rel="noopener">emqttd2@127.0.0.1</a></td>
<td>2883</td>
</tr>
</tbody></table>
<p>启动 emqttd1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd emqttd1 &amp;&amp; ./bin/emqttd start</span><br></pre></td></tr></table></figure>

<p>启动 emqttd2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd emqttd2 &amp;&amp; ./bin/emqttd start</span><br></pre></td></tr></table></figure>

<p>emqttd2 节点与 emqttd1 集群，emqttd2 目录下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl cluster join emqttd1@127.0.0.1</span><br><span class="line">Join the cluster successfully.</span><br><span class="line">Cluster status: [&#123;running_nodes,</span><br><span class="line">[&apos;emqttd1@127.0.0.1&apos;,&apos;emqttd2@127.0.0.1&apos;]&#125;]</span><br></pre></td></tr></table></figure>

<p>任意节点目录下查询集群状态:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl cluster status</span><br><span class="line">Cluster status: [&#123;running_nodes,</span><br><span class="line">[&apos;emqttd2@127.0.0.1&apos;,&apos;emqttd1@127.0.0.1&apos;]&#125;]</span><br></pre></td></tr></table></figure>

<p>集群消息路由测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># emqttd1节点上订阅x</span><br><span class="line"></span><br><span class="line">mosquitto_sub -t x -q 1 -p 1883</span><br><span class="line"></span><br><span class="line"># emqttd2节点上向x发布消息</span><br><span class="line"></span><br><span class="line">mosquitto_pub -t x -q 1 -p 2883 -m hello</span><br></pre></td></tr></table></figure>

<p>emqttd2 节点离开集群:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd emqttd2 &amp;&amp; ./bin/emqttd_ctl cluster leave</span><br></pre></td></tr></table></figure>

<p>emqttd1 节点下删除 emqttd2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd emqttd1 &amp;&amp; ./bin/emqttd_ctl cluster remove</span><br><span class="line">emqttd2@127.0.0.1</span><br></pre></td></tr></table></figure>

<h5 id="⑤clients-命令"><a href="#⑤clients-命令" class="headerlink" title="⑤clients 命令"></a>⑤clients 命令</h5><p>clients 命令查询连接的 MQTT 客户端。</p>
<table>
<thead>
<tr>
<th>CLIENTS LIST</th>
<th>查询全部客户端连接</th>
</tr>
</thead>
<tbody><tr>
<td>clients show</td>
<td>根据 ClientId 查询客户端</td>
</tr>
<tr>
<td>clients kick</td>
<td>根据 ClientId 踢出客户端</td>
</tr>
</tbody></table>
<p>clients list<br>查询全部客户端连接:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl clients list</span><br><span class="line">Client(867967027640038, clean_sess=false,</span><br><span class="line">username=tt867967027640038,</span><br><span class="line">peername=223.104.255.3:11240, connected_at=1533698992)</span><br><span class="line">Client(egege_web_1_1, clean_sess=true,</span><br><span class="line">username=egege_web, peername=10.161.139.95:47564,</span><br><span class="line">connected_at=1533022825)</span><br><span class="line">Client(sc_vmims_01_2_1, clean_sess=true, username=vmims,</span><br><span class="line">peername=10.161.139.95:39606, connected_at=1533559450)</span><br></pre></td></tr></table></figure>

<p>返回 Client 对象的属性:</p>
<table>
<thead>
<tr>
<th>CLEAN_SESS</th>
<th>清除会话标记</th>
</tr>
</thead>
<tbody><tr>
<td>username</td>
<td>用户名</td>
</tr>
<tr>
<td>peername</td>
<td>对端 TCP 地址</td>
</tr>
<tr>
<td>connected_at</td>
<td>客户端连接时间</td>
</tr>
</tbody></table>
<p>clients show<br>根据 ClientId 查询客户端:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl clients show &quot;867967027640038&quot;</span><br><span class="line">Client(867967027640038, clean_sess=false,</span><br><span class="line">username=tt867967027640038,</span><br><span class="line">peername=223.104.255.3:11240, connected_at=1533698992)</span><br></pre></td></tr></table></figure>

<p>clients kick<br>根据 ClientId 踢出客户端:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl clients kick &quot;867967027640038&quot;</span><br></pre></td></tr></table></figure>

<h5 id="⑥sessions-命令"><a href="#⑥sessions-命令" class="headerlink" title="⑥sessions 命令"></a>⑥sessions 命令</h5><p>sessions 命令查询 MQTT 连接会话。EMQ 消息服务器会为每个连接创建会<br>话。创建临时(transient)会话 –&gt; clean_session 标记 true；创建持久会话<br>(persistent) –&gt; clean_session 标记为 false。</p>
<table>
<thead>
<tr>
<th>SESSIONS LIST</th>
<th>查询全部会话</th>
</tr>
</thead>
<tbody><tr>
<td>sessions list persistent</td>
<td>查询全部持久会话</td>
</tr>
<tr>
<td>sessions list transient</td>
<td>查询全部临时会话</td>
</tr>
<tr>
<td>sessions show</td>
<td>根据 ClientID 查询会话</td>
</tr>
</tbody></table>
<p>sessions list</p>
<p>查询全部会话:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl sessions list</span><br><span class="line">Session(867967027640038, clean_sess=false,</span><br><span class="line">subscriptions=2, max_inflight=2, inflight=0,</span><br><span class="line">mqueue_len=0, mqueue_dropped=0, awaiting_rel=0,</span><br><span class="line">deliver_msg=2, enqueue_msg=0, created_at=1533619718)</span><br><span class="line">Session(egege_web_1_1, clean_sess=true, subscriptions=2,</span><br><span class="line">max_inflight=2, inflight=0, mqueue_len=0,</span><br><span class="line">mqueue_dropped=800, awaiting_rel=0, deliver_msg=3157831,</span><br><span class="line">enqueue_msg=40061, created_at=1533022825)</span><br><span class="line">Session(sc_vmims_01_2_1, clean_sess=true,</span><br><span class="line">subscriptions=1, max_inflight=2, inflight=0,</span><br><span class="line">mqueue_len=0, mqueue_dropped=899, awaiting_rel=0,</span><br><span class="line">deliver_msg=5115, enqueue_msg=1942,</span><br><span class="line">created_at=1533559450)</span><br></pre></td></tr></table></figure>

<p>返回 Session 对象属性:</p>
<table>
<thead>
<tr>
<th>CLEAN_SESS</th>
<th>FALSE: 持久会话，TRUE: 临时会话</th>
</tr>
</thead>
<tbody><tr>
<td>max_inflight</td>
<td>飞行窗口(最大允许同时下发消息数)</td>
</tr>
<tr>
<td>inflight_queue</td>
<td>当前正在下发的消息数</td>
</tr>
<tr>
<td>message_queue</td>
<td>当前缓存消息数</td>
</tr>
<tr>
<td>message_dropped</td>
<td>会话丢掉的消息数</td>
</tr>
<tr>
<td>awaiting_rel</td>
<td>等待客户端发送 PUBREL 的 QoS2 消息数</td>
</tr>
<tr>
<td>awaiting_ack</td>
<td>等待客户端响应 PUBACK 的 QoS1/2 消息数</td>
</tr>
<tr>
<td>awaiting_comp</td>
<td>等待客户端响应 PUBCOMP 的 QoS2 消息数</td>
</tr>
<tr>
<td>created_at</td>
<td>会话创建时间戳</td>
</tr>
</tbody></table>
<p>sessions list persistent<br>查询全部持久会话:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl sessions list persistent</span><br><span class="line">Session(867967027640038, clean_sess=false,</span><br><span class="line">subscriptions=2, max_inflight=2, inflight=0,</span><br><span class="line">mqueue_len=0, mqueue_dropped=0, awaiting_rel=0,</span><br><span class="line">deliver_msg=2, enqueue_msg=0, created_at=1533619718)</span><br></pre></td></tr></table></figure>

<p>sessions list transient<br>查询全部临时会话:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl sessions list transient</span><br><span class="line">Session(mosqsub/44101-airlee.lo, clean_sess=true,</span><br><span class="line">max_inflight=100, inflight_queue=0, message_queue=0,</span><br><span class="line">message_dropped=0, awaiting_rel=0, awaiting_ack=0,</span><br><span class="line">awaiting_comp=0, created_at=1452935401)</span><br></pre></td></tr></table></figure>

<p>sessions show<br>根据 ClientId 查询会话:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl sessions list transient</span><br><span class="line">Session(egege_web_1_1, clean_sess=true, subscriptions=2,</span><br><span class="line">max_inflight=2, inflight=2, mqueue_len=0,</span><br><span class="line">mqueue_dropped=800, awaiting_rel=0, deliver_msg=3159156,</span><br><span class="line">enqueue_msg=40071, created_at=1533022825)</span><br><span class="line">Session(sc_vmims_01_2_1, clean_sess=true,</span><br><span class="line">subscriptions=1, max_inflight=2, inflight=0,</span><br><span class="line">mqueue_len=0, mqueue_dropped=899, awaiting_rel=0,</span><br><span class="line">deliver_msg=5126, enqueue_msg=1942,</span><br><span class="line">created_at=1533559450)</span><br></pre></td></tr></table></figure>

<h5 id="⑦routes-命令"><a href="#⑦routes-命令" class="headerlink" title="⑦routes 命令"></a>⑦routes 命令</h5><p>routes 命令查询路由表。<br>routes list<br>查询全部路由:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl routes list</span><br><span class="line">terminal/server/866855039562970 -&gt;</span><br><span class="line">emq_sc_01@10.24.253.192</span><br><span class="line">terminal/+/health -&gt; emq_sc_01@10.24.253.192</span><br><span class="line">terminal/client/+ -&gt; emq_sc_01@10.24.253.192</span><br><span class="line">terminal/server/event/100 -&gt; emq_sc_01@10.24.253.192</span><br></pre></td></tr></table></figure>

<h5 id="⑧topics-命令"><a href="#⑧topics-命令" class="headerlink" title="⑧topics 命令"></a>⑧topics 命令</h5><p>topics 命令查询当前的主题(Topic)表。<br>topics list<br>查询全部主题(Topic):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl topics list</span><br><span class="line">terminal/server/866855039410527</span><br><span class="line">terminal/client/+</span><br><span class="line">terminal/+/health</span><br></pre></td></tr></table></figure>

<p>topics show<br>查询某个主题(Topic):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl topics show &apos;$SYS/brokers&apos;</span><br><span class="line">$SYS/brokers: static</span><br></pre></td></tr></table></figure>

<h5 id="⑨subscriptions-命令"><a href="#⑨subscriptions-命令" class="headerlink" title="⑨subscriptions 命令"></a>⑨subscriptions 命令</h5><p>subscriptions 命令查询消息服务器的订阅(Subscription)表。</p>
<table>
<thead>
<tr>
<th>SUBSCRIPTIONS LIST</th>
<th>查询全部订阅</th>
</tr>
</thead>
<tbody><tr>
<td>subscriptions show</td>
<td>查询某个 ClientId 的订阅</td>
</tr>
</tbody></table>
<p>subscriptions list<br>查询全部订阅:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl subscriptions list</span><br><span class="line">867187036659701&lt;10186.9605.17&gt; -&gt;</span><br><span class="line">terminal/server/event/100</span><br><span class="line">867187036659701&lt;10186.9605.17&gt; -&gt;</span><br><span class="line">terminal/server/867187036659701</span><br></pre></td></tr></table></figure>

<p>subscriptions show<br>查询某个 Client 的订阅:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl subscriptions show 867967027640038</span><br><span class="line">867967027640038&lt;10186.17806.17&gt; -&gt;</span><br><span class="line">terminal/server/867967027640038</span><br><span class="line">qos : 1</span><br><span class="line">867967027640038&lt;10186.17806.17&gt; -&gt;</span><br><span class="line">terminal/server/event/100</span><br><span class="line">qos : 1</span><br></pre></td></tr></table></figure>

<h5 id="⑩plugins-命令"><a href="#⑩plugins-命令" class="headerlink" title="⑩plugins 命令"></a>⑩plugins 命令</h5><p>plugins 命令用于加载、卸载、查询插件应用。EMQ 消息服务器通过插件扩展<br>认证、定制功能，插件置于 plugins/ 目录下。</p>
<table>
<thead>
<tr>
<th>PLUGINS LIST</th>
<th>列出全部插件(PLUGIN)</th>
</tr>
</thead>
<tbody><tr>
<td>plugins load</td>
<td>加载插件(Plugin)</td>
</tr>
<tr>
<td>plugins unload</td>
<td>卸载插件(Plugin)</td>
</tr>
</tbody></table>
<p>plugins list<br>列出全部插件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl plugins list</span><br><span class="line">Plugin(emq_auth_clientid, version=2.3.6,</span><br><span class="line">description=Authentication with ClientId/Password,</span><br><span class="line">active=false)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Plugin(emq_auth_http, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with HTTP API,</span><br><span class="line">active=false)</span><br><span class="line">Plugin(emq_auth_jwt, version=2.3.6,</span><br><span class="line">description=Authentication with JWT, active=false)</span><br><span class="line">Plugin(emq_auth_ldap, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with LDAP, active=false)</span><br><span class="line">Plugin(emq_auth_mongo, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with MongoDB,</span><br><span class="line">active=false)</span><br><span class="line">Plugin(emq_auth_mysql, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with MySQL, active=true)</span><br><span class="line">Plugin(emq_auth_pgsql, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with PostgreSQL,</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">active=false)</span><br><span class="line">Plugin(emq_auth_redis, version=2.3.6,</span><br><span class="line">description=Authentication/ACL with Redis, active=false)</span><br><span class="line">Plugin(emq_auth_username, version=2.3.6,</span><br><span class="line">description=Authentication with Username/Password,</span><br><span class="line">active=false)</span><br><span class="line">Plugin(emq_coap, version=2.3.6, description=CoAP</span><br><span class="line">Gateway, active=false)</span><br><span class="line">Plugin(emq_dashboard, version=2.3.6, description=EMQ Web</span><br><span class="line">Dashboard, active=true)</span><br><span class="line">Plugin(emq_lua_hook, version=2.3.6, description=EMQ</span><br><span class="line">Hooks in lua, active=false)</span><br><span class="line">Plugin(emq_modules, version=2.3.6, description=EMQ</span><br><span class="line">Modules, active=true)</span><br><span class="line">Plugin(emq_plugin_template, version=2.3.6,</span><br><span class="line">description=EMQ Plugin Template, active=false)</span><br><span class="line">Plugin(emq_recon, version=2.3.6, description=Recon</span><br><span class="line">Plugin, active=true)</span><br><span class="line">Plugin(emq_reloader, version=2.3.6, description=Reloader</span><br><span class="line">Plugin, active=false)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Plugin(emq_retainer, version=2.3.6, description=EMQ</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Retainer, active=true)</span><br><span class="line">Plugin(emq_sn, version=2.3.6, description=MQTT-SN</span><br><span class="line">Gateway, active=false)</span><br><span class="line">Plugin(emq_stomp, version=2.3.6, description=Stomp</span><br><span class="line">Protocol Plugin, active=false)</span><br><span class="line">Plugin(emq_web_hook, version=2.3.6, description=EMQ</span><br><span class="line">Webhook Plugin, active=false)</span><br></pre></td></tr></table></figure>

<p>插件属性:</p>
<table>
<thead>
<tr>
<th>VERSION</th>
<th>插件版本</th>
</tr>
</thead>
<tbody><tr>
<td>description</td>
<td>插件描述</td>
</tr>
<tr>
<td>active</td>
<td>是否已加载</td>
</tr>
</tbody></table>
<p>load<br>加载插件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl plugins load emq_lua_hook</span><br><span class="line">Start apps: [emq_lua_hook]</span><br><span class="line">Plugin emq_lua_hook loaded successfully.</span><br></pre></td></tr></table></figure>

<p>unload<br>卸载插件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[emqtt@lp emqttd]$ ./bin/emqttd_ctl plugins unload</span><br><span class="line">emq_lua_hook</span><br><span class="line">Plugin emq_lua_hook unloaded successfully.</span><br></pre></td></tr></table></figure>

<h5 id="⑩-①bridges-命令"><a href="#⑩-①bridges-命令" class="headerlink" title="⑩+①bridges 命令"></a>⑩+①bridges 命令</h5><p>bridges 命令用于在多台 EMQ 服务器节点间创建桥接:</p>
<hr>
<p>Publisher –&gt; | node1 | –Bridge Forward–&gt; | node2 | –&gt;<br>Subscriber</p>
<hr>
<table>
<thead>
<tr>
<th>BRIDGES LIST</th>
<th>查询全部桥接</th>
</tr>
</thead>
<tbody><tr>
<td>bridges options</td>
<td>查询创建桥接选项</td>
</tr>
<tr>
<td>bridges start</td>
<td>创建桥接</td>
</tr>
<tr>
<td>bridges start</td>
<td>创建桥接并带选项设置</td>
</tr>
<tr>
<td>bridges stop</td>
<td>删除桥接</td>
</tr>
</tbody></table>
<p>创建一条 emqttd1 -&gt; emqttd2 节点的桥接，转发传感器主题(Topic)消息到<br>emqttd2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl bridges start emqttd2@127.0.0.1</span><br><span class="line">sensor/#</span><br><span class="line">bridge is started.</span><br><span class="line">$ ./bin/emqttd_ctl bridges list</span><br><span class="line">bridge: emqttd1@127.0.0.1--sensor/#--&gt;emqttd2@127.0.0.1</span><br></pre></td></tr></table></figure>

<p>测试 emqttd1–sensor/#–&gt;emqttd2 的桥接:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#emqttd2节点上</span><br><span class="line">mosquitto_sub -t sensor/# -p 2883 -d</span><br><span class="line">#emqttd1节点上</span><br><span class="line">mosquitto_pub -t sensor/1/temperature -m &quot;37.5&quot; -d</span><br></pre></td></tr></table></figure>

<p>bridge options<br>查询 bridge 创建选项设置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl bridges options</span><br><span class="line">Options:</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qos = 0 | 1 | 2</span><br><span class="line">prefix = string</span><br><span class="line">suffix = string</span><br><span class="line">queue = integer</span><br><span class="line">Example:</span><br><span class="line">qos=2,prefix=abc/,suffix=/yxz,queue=1000</span><br></pre></td></tr></table></figure>

<p>bridges stop<br>删除 emqttd1–sensor/#–&gt;emqttd2 的桥接:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/emqttd_ctl bridges stop emqttd2@127.0.0.1</span><br><span class="line">sensor/#</span><br><span class="line">bridge is stopped.</span><br></pre></td></tr></table></figure>

<h5 id="⑩-②vm-命令"><a href="#⑩-②vm-命令" class="headerlink" title="⑩+②vm 命令"></a>⑩+②vm 命令</h5><p>vm 命令用于查询 Erlang 虚拟机负载、内存、进程、IO 信息。</p>
<table>
<thead>
<tr>
<th>VM ALL</th>
<th>查询 VM 全部信息</th>
</tr>
</thead>
<tbody><tr>
<td>vm load</td>
<td>查询 VM 负载</td>
</tr>
<tr>
<td>vm memory</td>
<td>查询 VM 内存</td>
</tr>
<tr>
<td>vm process</td>
<td>查询 VM Erlang 进程数量</td>
</tr>
<tr>
<td>vm io</td>
<td>查询 VM io 最大文件句柄</td>
</tr>
</tbody></table>
<p>vm all</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm all</span><br><span class="line">cpu/load1 : 0.00</span><br><span class="line">cpu/load5 : 0.03</span><br><span class="line">cpu/load15 : 0.05</span><br><span class="line">memory/total : 61039832</span><br><span class="line">memory/processes : 10484664</span><br><span class="line">memory/processes_used : 10482256</span><br><span class="line">memory/system : 50555168</span><br><span class="line">memory/atom : 1213657</span><br><span class="line">memory/atom_used : 1196893</span><br><span class="line">memory/binary : 1478648</span><br><span class="line">memory/code : 28024188</span><br><span class="line">memory/ets : 7885264</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">process/limit : 262144</span><br><span class="line">process/count : 1437</span><br><span class="line">io/max_fds : 65535</span><br><span class="line">io/active_fds : 1</span><br><span class="line">ports/count : 571</span><br><span class="line">ports/limit : 65536</span><br></pre></td></tr></table></figure>

<p>vm load<br>查询 VM 负载:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm load</span><br><span class="line">cpu/load1 : 0.21</span><br><span class="line">cpu/load5 : 0.07</span><br><span class="line">cpu/load15 : 0.06</span><br></pre></td></tr></table></figure>

<p>vm memory<br>查询 VM 内存:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm memory</span><br><span class="line">memory/total : 61099792</span><br><span class="line">memory/processes : 10540696</span><br><span class="line">memory/processes_used : 10539864</span><br><span class="line">memory/system : 50559096</span><br><span class="line">memory/atom : 1213657</span><br><span class="line">memory/atom_used : 1196963</span><br><span class="line">memory/binary : 1470992</span><br><span class="line">memory/code : 28024188</span><br><span class="line">memory/ets : 7891376</span><br></pre></td></tr></table></figure>

<p>vm process<br>查询 Erlang 进程数量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm process</span><br><span class="line">process/limit : 262144</span><br><span class="line">process/count : 1443</span><br></pre></td></tr></table></figure>

<p>vm io</p>
<p>查询 IO 最大句柄数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl vm io</span><br><span class="line">io/max_fds : 65535</span><br><span class="line">io/active_fds : 1</span><br></pre></td></tr></table></figure>

<h5 id="⑩-③trace-命令"><a href="#⑩-③trace-命令" class="headerlink" title="⑩+③trace 命令"></a>⑩+③trace 命令</h5><p>trace 命令用于追踪某个客户端或 Topic，打印日志信息到文件。</p>
<table>
<thead>
<tr>
<th>TRACE LIST</th>
<th>查询全部开启的追踪</th>
</tr>
</thead>
<tbody><tr>
<td>trace client</td>
<td>开启 Client 追踪，日志到文件</td>
</tr>
<tr>
<td>trace client off</td>
<td>关闭 Client 追踪</td>
</tr>
<tr>
<td>trace topic</td>
<td>开启 Topic 追踪，日志到文件</td>
</tr>
<tr>
<td>trace topic off</td>
<td>关闭 Topic 追踪</td>
</tr>
</tbody></table>
<p>trace client<br>开启 Client 追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace client 867967027640038 demolog</span><br><span class="line">trace client 867967027640038 successfully.</span><br><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace list</span><br><span class="line">trace client 867967027640038 -&gt; demolog</span><br></pre></td></tr></table></figure>

<p>trace client off<br>关闭 Client 追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace client 867967027640038 off</span><br><span class="line">stop tracing client 867967027640038 successfully.</span><br><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace list</span><br></pre></td></tr></table></figure>

<p>trace topic<br>开启 Topic 追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace client terminal/client/+</span><br><span class="line">demolog</span><br><span class="line">trace client terminal/client/+ successfully.</span><br><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace list</span><br><span class="line">trace client terminal/client/+ -&gt; demolog</span><br></pre></td></tr></table></figure>

<p>trace topic off<br>关闭 Topic 追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace client terminal/client/+ off</span><br><span class="line">stop tracing client terminal/client/+ successfully.</span><br></pre></td></tr></table></figure>

<p>trace list<br>列出全部开启的追踪:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl trace list</span><br><span class="line">trace client terminal/client/+ -&gt; demolog</span><br></pre></td></tr></table></figure>

<h5 id="⑩-④listeners"><a href="#⑩-④listeners" class="headerlink" title="⑩+④listeners"></a>⑩+④listeners</h5><p>listeners 命令用于查询开启的 TCP 服务监听器:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./bin/emqttd_ctl listeners</span><br><span class="line">listener on mqtt:api:0.0.0.0:8080</span><br><span class="line">acceptors : 4</span><br><span class="line">max_clients : 64</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br><span class="line">listener on mqtt:wss:8084</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">acceptors : 4</span><br><span class="line">max_clients : 64</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br><span class="line">listener on mqtt:ssl:8883</span><br><span class="line">acceptors : 16</span><br><span class="line">max_clients : 1024</span><br><span class="line">current_clients : 0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown_count : [&#123;auth_failure,2&#125;,&#123;closed,1&#125;]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listener on mqtt:ws:8083</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">acceptors : 4</span><br><span class="line">max_clients : 102400</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br><span class="line">listener on mqtt:tcp:0.0.0.0:1883</span><br><span class="line">acceptors : 16</span><br><span class="line">max_clients : 102400</span><br><span class="line">current_clients : 547</span><br><span class="line">shutdown_count : [&#123;idle_timeout,73588&#125;,</span><br><span class="line">&#123;keepalive_timeout,39659&#125;,&#123;conflict,19126&#125;,</span><br><span class="line">&#123;protocol_bad_connect,2413&#125;,&#123;closed,298&#125;,</span><br><span class="line">&#123;parser_error,5&#125;,&#123;auth_failure,2386&#125;]</span><br><span class="line">listener on mqtt:tcp:127.0.0.1:11883</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">acceptors : 4</span><br><span class="line">max_clients : 102400</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br><span class="line">listener on dashboard:http:18083</span><br><span class="line">acceptors : 4</span><br><span class="line">max_clients : 512</span><br><span class="line">current_clients : 0</span><br><span class="line">shutdown_count : []</span><br></pre></td></tr></table></figure>

<p>listener 参数说明:</p>
<table>
<thead>
<tr>
<th>ACCEPTORS</th>
<th>TCP ACCEPTOR 池</th>
</tr>
</thead>
<tbody><tr>
<td>max_clients</td>
<td>最大允许连接数</td>
</tr>
<tr>
<td>current_clients</td>
<td>当前连接数</td>
</tr>
<tr>
<td>shutdown_count</td>
<td>Socket 关闭原因统计</td>
</tr>
</tbody></table>
<p>重启监听端口:<br>listeners restart</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl listeners restart mqtt:tcp</span><br><span class="line">127.0.0.1:11883</span><br><span class="line">Restart mqtt:tcp listener on 127.0.0.1:11883</span><br><span class="line">successfully.</span><br></pre></td></tr></table></figure>

<p>停止监听端口:<br>listeners stop</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$ [emqtt@lp</span><br><span class="line">emqttd]$ ./bin/emqttd_ctl listeners stop mqtt:tcp</span><br><span class="line">127.0.0.1:11883</span><br><span class="line">Stop mqtt:tcp listener on 127.0.0.1:11883 successfully.</span><br></pre></td></tr></table></figure>

<p>一旦停止无法启动，需要重启emq</p>
<h5 id="⑩-⑤mnesia-命令"><a href="#⑩-⑤mnesia-命令" class="headerlink" title="⑩+⑤mnesia 命令"></a>⑩+⑤mnesia 命令</h5><p>查询 mnesia 数据库系统状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl mnesia</span><br><span class="line">===&gt; System info in version &quot;4.15&quot;, debug level = none</span><br><span class="line">&lt;===</span><br><span class="line">opt_disc. Directory</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;/home/emqtt/emqttd/data/mnesia/emq@127.0.0.1&quot; is used.</span><br><span class="line">use fallback at restart = false</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">running db nodes = [&apos;emq@127.0.0.1&apos;]</span><br><span class="line">stopped db nodes = []</span><br><span class="line">master node tables = []</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remote = []</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ram_copies =</span><br><span class="line">[mqtt_retained,mqtt_route,mqtt_session,mqtt_trie,</span><br><span class="line">mqtt_trie_node]</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">disc_copies = [mqtt_admin,schema]</span><br><span class="line">disc_only_copies = [][&#123;&apos;emq@127.0.0.1&apos;,disc_copies&#125;] = [mqtt_admin,schema][&#123;&apos;emq@127.0.0.1&apos;,ram_copies&#125;] =</span><br><span class="line">[mqtt_retained,mqtt_route,mqtt_trie_node,</span><br><span class="line">mqtt_trie,mqtt_session]</span><br><span class="line">2 transactions committed, 8 aborted, 0 restarted, 0</span><br><span class="line">logged to disc</span><br><span class="line">0 held locks, 0 in queue; 0 local transactions, 0 remote</span><br><span class="line">0 transactions waits for other nodes: []</span><br></pre></td></tr></table></figure>

<h5 id="⑩-⑥admins-命令"><a href="#⑩-⑥admins-命令" class="headerlink" title="⑩+⑥admins 命令"></a>⑩+⑥admins 命令</h5><p>Dashboard 插件会自动注册 admins 命令，用于创建、删除管理员账号，重置<br>管理员密码。</p>
<table>
<thead>
<tr>
<th>ADMINS ADD</th>
<th>创建 ADMIN 账号</th>
</tr>
</thead>
<tbody><tr>
<td>admins passwd</td>
<td>重置 admin 密码</td>
</tr>
<tr>
<td>ADMINS ADD</td>
<td>创建 ADMIN 账号</td>
</tr>
<tr>
<td>admins del</td>
<td>删除 admin 账号</td>
</tr>
</tbody></table>
<p>admins add<br>创建 admin 账户:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl admins add zhendong 666666</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<p>admins passwd<br>重置 admin 账户密码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl admins passwd zhendong 666</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>

<p>admins del<br>删除 admin 账户:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[sc_emq@iZbp1bpj58bdzdomgul98aZ emqttd]$</span><br><span class="line">./bin/emqttd_ctl admins del zhendong</span><br><span class="line">ok</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/08/ELK部署/">
  ELK部署
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/08/ELK部署/"><span class="article-date">
  2019-08-08
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/linux/">linux</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK/">ELK</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="ELK部署准备工作："><a href="#ELK部署准备工作：" class="headerlink" title="ELK部署准备工作："></a>ELK部署准备工作：</h1><h5 id="准备2台机器，这样才能完成分布式集群的实验，当然能有更多机器更好："><a href="#准备2台机器，这样才能完成分布式集群的实验，当然能有更多机器更好：" class="headerlink" title="准备2台机器，这样才能完成分布式集群的实验，当然能有更多机器更好："></a>准备2台机器，这样才能完成分布式集群的实验，当然能有更多机器更好：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">• 192.168.10.31   master</span><br><span class="line"></span><br><span class="line">• 192.168.10.32   data</span><br></pre></td></tr></table></figure>

<h5 id="角色划分："><a href="#角色划分：" class="headerlink" title="角色划分："></a>角色划分：</h5><p>• 2台机器全部安装jdk1.8，因为elasticsearch是java开发的</p>
<p>• 2台全部安装elasticsearch (后续都简称为es)</p>
<p>• master节点上需要安装kibana</p>
<p>• data上安装 logstash</p>
<h5 id="ELK版本信息："><a href="#ELK版本信息：" class="headerlink" title="ELK版本信息："></a>ELK版本信息：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">• Elasticsearch-6.4.1</span><br><span class="line"></span><br><span class="line">• logstash-6.4.1</span><br><span class="line"></span><br><span class="line">• kibana-6.4.1</span><br><span class="line"></span><br><span class="line">• filebeat-6.4.1</span><br></pre></td></tr></table></figure>

<p>所有机器做好解析,关闭防火墙,selinux</p>
<h1 id="elasticsearch安装："><a href="#elasticsearch安装：" class="headerlink" title="elasticsearch安装："></a>elasticsearch安装：</h1><h2 id="1-布署java环境-略-所有节点"><a href="#1-布署java环境-略-所有节点" class="headerlink" title="1.布署java环境(略) - 所有节点"></a>1.布署java环境(略) - 所有节点</h2><p>wget <a href="http://download.oracle.com/otn-pub/java/jdk/8u181-b13/96a7b8442fe848ef90c96a2fad6ed6d1/jdk-8u181-linux-x64.tar.gz?AuthParam=1534736266_209f12f1830b23a1b152e15116e28b4a" target="_blank" rel="noopener">http://download.oracle.com/otn-pub/java/jdk/8u181-b13/96a7b8442fe848ef90c96a2fad6ed6d1/jdk-8u181-linux-x64.tar.gz?AuthParam=1534736266_209f12f1830b23a1b152e15116e28b4a</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#tar xvf jdk-8u181-linux-x64.tar.gz</span><br><span class="line">mkdir /usr/local/java</span><br><span class="line">mv jdk1.8.0_181 /usr/local/java/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line">#RPF install JDK</span><br><span class="line">JAVA_HOME=/usr/local/java/jdk1.8.0_181</span><br><span class="line">JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.</span><br><span class="line">jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">export JAVA_HOME JRE_HOME PATH CLASSPATH</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<h2 id="2-安装elasticsearch-所有节点"><a href="#2-安装elasticsearch-所有节点" class="headerlink" title="2.安装elasticsearch - 所有节点"></a>2.安装elasticsearch - 所有节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">useradd elk      #elasticsearch不能以root用户运行,必须要创建一个普通用户运行</span><br><span class="line">echo 123|passwd --stdin elk</span><br><span class="line">tar xf elasticsearch-6.4.1.tar.gz</span><br><span class="line">mv elasticsearch-6.4.1 /usr/local/elasticsearch</span><br><span class="line">chown -R elk.elk /usr/local/elasticsearch/</span><br><span class="line">mkdir -p /data/es-data</span><br><span class="line">chown -R elk.elk /data/es-data</span><br></pre></td></tr></table></figure>

<h4 id="3-配置es-master"><a href="#3-配置es-master" class="headerlink" title="3.配置es-master"></a>3.配置es-master</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/elasticsearch/</span><br><span class="line">egrep -v &quot;^#&quot; config/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: es-cluster</span><br><span class="line">node.name: master</span><br><span class="line">node.master: true</span><br><span class="line">node.data: true</span><br><span class="line">path.data: /data/es-data         </span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">&lt;http.port:&gt; 9200</span><br><span class="line">dis-covery.zen.ping.unicast.hosts: [&quot;192.168.10.31&quot;, &quot;192.168.10.32&quot;]</span><br></pre></td></tr></table></figure>

<h4 id="4-配置es-data"><a href="#4-配置es-data" class="headerlink" title="4.配置es-data"></a>4.配置es-data</h4><p>在master的基础上作如下修改:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">node.name: data</span><br><span class="line"></span><br><span class="line">node.master: false</span><br><span class="line"></span><br><span class="line">node.data: true</span><br></pre></td></tr></table></figure>

<h4 id="5-启动服务-先启动master-再启动data"><a href="#5-启动服务-先启动master-再启动data" class="headerlink" title="5.启动服务: 先启动master, 再启动data"></a>5.启动服务: 先启动master, 再启动data</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#su - elk</span><br><span class="line">$/usr/local/elasticsearch/bin/elasticsearch -d              #-d 以守护进程方式运行</span><br></pre></td></tr></table></figure>

<h4 id="6-验证"><a href="#6-验证" class="headerlink" title="6.验证"></a>6.验证</h4><p>查看端口: es服务会监听两个端口,其中9200为传输数据用,9300为集群通信用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -tanp |grep java</span><br><span class="line">	tcp6       0      0 :::9200                 :::*                    LISTEN    1238/java           </span><br><span class="line">	tcp6       0      0 :::9300                 :::*                    LISTEN      1238/java</span><br></pre></td></tr></table></figure>

<p>查看服务情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 192.168.10.31：9200</span><br></pre></td></tr></table></figure>

<p>查看集群的详细信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 192.168.10.31:9200/_cluster/state?pretty</span><br></pre></td></tr></table></figure>

<h5 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题:"></a>常见问题:</h5><p>解决方法: 使用普通用户运行</p>
<h5 id="问题-1"><a href="#问题-1" class="headerlink" title="问题[1]:"></a>问题[1]:</h5><p> 进程最大可同时打开文件数太小,至少要65536</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo  &quot;elk soft nofile 65536&quot; &gt;&gt; /etc/security/limits.conf </span><br><span class="line">echo  &quot;elk hard nofile 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - elk</span><br><span class="line">	Last login: Sun Oct  7 12:25:56 CST 2018 on pts/0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n</span><br><span class="line">	65536</span><br></pre></td></tr></table></figure>

<h5 id="问题-2"><a href="#问题-2" class="headerlink" title="问题[2]:"></a>问题[2]:</h5><p>请求锁内存失败,因为linux系统默认能让进程锁住的内存为45k 解决方法: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash ~]# echo &quot;elk soft memlock unlimited&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line">[root@logstash ~]# echo &quot;elk hard memlock unlimited&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>

<h5 id="问题-3"><a href="#问题-3" class="headerlink" title="问题[3]:"></a>问题[3]:</h5><p>解决方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash ~]# echo vm.max_map_count=262144 &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@logstash ~]# sysctl -p</span><br><span class="line">vm.max_map_count = 262144</span><br></pre></td></tr></table></figure>

<p>安装问题汇总: <a href="http://www.cnblogs.com/jstarseven/p/6803054.html" target="_blank" rel="noopener">http://www.cnblogs.com/jstarseven/p/6803054.html</a> </p>
<p>使用curl命令操作elasticsearch:<a href="https://zhaoyanblog.com/archives/732.html" target="_blank" rel="noopener">https://zhaoyanblog.com/archives/732.html</a></p>
<h1 id="Kibana安装："><a href="#Kibana安装：" class="headerlink" title="Kibana安装："></a>Kibana安装：</h1><h4 id="1解压"><a href="#1解压" class="headerlink" title="1解压"></a>1解压</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xf kibana-6.4.1-linux-x86_64.tar.gz</span><br><span class="line">mv kibana-6.4.1-linux-x86_64 /usr/local/kibana</span><br></pre></td></tr></table></figure>

<h4 id="2-配置"><a href="#2-配置" class="headerlink" title="2.配置"></a>2.配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/kibana/</span><br><span class="line">egrep -v &quot;^#|^$&quot; config/kibana.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server.port: 5601</span><br><span class="line">server.host: &quot;0.0.0.0&quot;         </span><br><span class="line">elasticsearch.url: &quot;[http://192.168.10.31:9200&quot;](http://192.168.10.31:9200)         </span><br><span class="line">logging.dest: /usr/local/kibana/logs/kibana.log</span><br></pre></td></tr></table></figure>

<h4 id="3-启动服务"><a href="#3-启动服务" class="headerlink" title="3.启动服务"></a>3.启动服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/kibana/bin/kibana &amp;</span><br></pre></td></tr></table></figure>

<h4 id="4-查看"><a href="#4-查看" class="headerlink" title="4.查看:"></a>4.查看:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -tanp |grep 5601</span><br><span class="line">tcp        0      0 0.0.0.0:5601            0.0.0.0:*               LISTEN      1460/node</span><br><span class="line">kibana是使用node.js开发的，所以进程名称为node</span><br></pre></td></tr></table></figure>

<h4 id="5-浏览器访问"><a href="#5-浏览器访问" class="headerlink" title="5.浏览器访问"></a>5.浏览器访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firefox 192.168.10.31:5601 &amp;</span><br></pre></td></tr></table></figure>

<h1 id="logstash安装"><a href="#logstash安装" class="headerlink" title="logstash安装"></a>logstash安装</h1><h4 id="1-解压"><a href="#1-解压" class="headerlink" title="1.解压"></a>1.解压</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xf logstash-6.4.1.tar.gz</span><br><span class="line">mv logstash-6.4.1 /usr/local/logstash</span><br></pre></td></tr></table></figure>

<h4 id="2-修改配置文件"><a href="#2-修改配置文件" class="headerlink" title="2.修改配置文件"></a>2.修改配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/logstash/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim config/logstash.yml</span><br><span class="line">http.host: &quot;0.0.0.0&quot;</span><br></pre></td></tr></table></figure>

<h4 id="3-测试"><a href="#3-测试" class="headerlink" title="3.测试"></a>3.测试</h4><h5 id="1-配置好后-先不要启动服务-先配置一个收集远程日志的配置文件进行测试"><a href="#1-配置好后-先不要启动服务-先配置一个收集远程日志的配置文件进行测试" class="headerlink" title="1).配置好后,先不要启动服务. 先配置一个收集远程日志的配置文件进行测试"></a>1).配置好后,先不要启动服务. 先配置一个收集远程日志的配置文件进行测试</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cd config/</span><br><span class="line">cp logstash-sample.conf syslog-test.conf</span><br><span class="line">cat config/syslog-test.conf</span><br><span class="line">input &#123;       </span><br><span class="line">    syslog &#123; </span><br><span class="line">	        type =&gt; &quot;system-syslog&quot;           #定义类型,可自定义 </span><br><span class="line">            port =&gt; 51400                        #定义监听端口</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;            </span><br><span class="line">      output &#123;</span><br><span class="line">           stdout &#123;                                    #将接收到的日志输出到标准输出</span><br><span class="line"> 	        codec =&gt; rubydebug                         </span><br><span class="line">  &#125;         </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-检测文件有没有错误"><a href="#2-检测文件有没有错误" class="headerlink" title="2).检测文件有没有错误"></a>2).检测文件有没有错误</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/logstash/bin/logstash  -f syslog-test.conf  --config.test_and_exit</span><br><span class="line">Configuration OK                 #检测成功</span><br><span class="line">选项:         -f                                指定配置文件         </span><br><span class="line">	           --config.test_and_exit   检测配置并退出,如果不加这个就是启动服务了</span><br></pre></td></tr></table></figure>

<h5 id="3-如果检测成功-启动测试服务"><a href="#3-如果检测成功-启动测试服务" class="headerlink" title="3).如果检测成功,启动测试服务"></a>3).如果检测成功,启动测试服务</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/logstash/bin/logstash  -f syslog-test.conf</span><br></pre></td></tr></table></figure>

<h5 id="4-另开一个终端查看端口"><a href="#4-另开一个终端查看端口" class="headerlink" title="4).另开一个终端查看端口"></a>4).另开一个终端查看端口</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -tuanp |grep 51400     </span><br><span class="line">tcp6       0      0 :::51400                 :::*                    LISTEN      10901/java </span><br><span class="line">udp        0      0 0.0.0.0:51400           0.0.0.0:*                           10901/java</span><br></pre></td></tr></table></figure>

<h5 id="5-在另外的机器上配置将日志发送过来-这一步在另外一台机器上操作"><a href="#5-在另外的机器上配置将日志发送过来-这一步在另外一台机器上操作" class="headerlink" title="5).在另外的机器上配置将日志发送过来,这一步在另外一台机器上操作"></a>5).在另外的机器上配置将日志发送过来,这一步在另外一台机器上操作</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/rsyslog.conf</span><br><span class="line">*.*                 @@192.168.10.32:51400</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart rsyslog</span><br><span class="line">su - elk</span><br></pre></td></tr></table></figure>

<h5 id="6-在logstash上看有没有输出"><a href="#6-在logstash上看有没有输出" class="headerlink" title="6).在logstash上看有没有输出"></a>6).在logstash上看有没有输出</h5><p>终端中以JSON的格式打印了收集到的日志，测试成功。</p>
<h4 id="4-以上第3步只是测试，这一步我们需要重新改一下配置文件，让收集的日志信息输出到es服务器中，而不是当前终端"><a href="#4-以上第3步只是测试，这一步我们需要重新改一下配置文件，让收集的日志信息输出到es服务器中，而不是当前终端" class="headerlink" title="4.以上第3步只是测试，这一步我们需要重新改一下配置文件，让收集的日志信息输出到es服务器中，而不是当前终端"></a>4.以上第3步只是测试，这一步我们需要重新改一下配置文件，让收集的日志信息输出到es服务器中，而不是当前终端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cp syslog-test.conf  syslog.conf</span><br><span class="line">cat syslog.conf </span><br><span class="line">input &#123;</span><br><span class="line">  syslog &#123;</span><br><span class="line">    type =&gt; &quot;system-syslog&quot;</span><br><span class="line">    port =&gt; 51400    </span><br><span class="line">&#125;  </span><br><span class="line">  &#125;          </span><br><span class="line">    output &#123;   </span><br><span class="line">      elasticsearch &#123;      </span><br><span class="line">       hosts =&gt; [&quot;[http://192.168.10.31:9200&quot;\]](http://192.168.10.31:9200)         </span><br><span class="line">	    index =&gt; &quot;system-syslog-%&#123;+YYYY.MM.dd&#125;&quot;        </span><br><span class="line">   &#125;         </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-测试配置文件"><a href="#5-测试配置文件" class="headerlink" title="5.测试配置文件"></a>5.测试配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/logstash/bin/logstash -f syslog.conf --config.test_and_exit</span><br></pre></td></tr></table></figure>

<h4 id="6-如果测试没有问题-启动服务"><a href="#6-如果测试没有问题-启动服务" class="headerlink" title="6.如果测试没有问题,启动服务"></a>6.如果测试没有问题,启动服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/logstash/bin/logstash -f syslog.conf  &amp;</span><br></pre></td></tr></table></figure>

<h4 id="7-查看服务启动情况"><a href="#7-查看服务启动情况" class="headerlink" title="7.查看服务启动情况:"></a>7.查看服务启动情况:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">netstat -tanp |grep 9600</span><br><span class="line">	tcp6       0      0 :::9600                 :::*                    LISTEN      11024/java</span><br><span class="line">netstat -tanp |grep 51400</span><br><span class="line">	tcp6       0      0 :::51400                :::*                    LISTEN      11024/java</span><br></pre></td></tr></table></figure>

<h1 id="收集Nginx日志"><a href="#收集Nginx日志" class="headerlink" title="收集Nginx日志"></a>收集Nginx日志</h1><h4 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a><strong>方案一</strong></h4><p><strong>nginx:</strong></p>
<p>修改 nginx server 的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> log_format  json &apos;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&apos;</span><br><span class="line">			&apos;&quot;@version&quot;:&quot;1&quot;,&apos;</span><br><span class="line">			&apos;&quot;client&quot;:&quot;$remote_addr&quot;,&apos;</span><br><span class="line">			&apos;&quot;url&quot;:&quot;$uri&quot;,&apos;</span><br><span class="line">			&apos;&quot;status&quot;:&quot;$status&quot;,&apos;    </span><br><span class="line">                         &apos;&quot;domain&quot;:&quot;$host&quot;,&apos;    </span><br><span class="line">                         &apos;&quot;host&quot;:&quot;$server_addr&quot;,&apos;   </span><br><span class="line">                         &apos;&quot;size&quot;:$body_bytes_sent,&apos; </span><br><span class="line">                         &apos;&quot;responsetime&quot;:$request_time,&apos; </span><br><span class="line">                         &apos;&quot;referer&quot;: &quot;$http_referer&quot;,&apos; </span><br><span class="line">                         &apos;&quot;ua&quot;: &quot;$http_user_agent&quot;&apos;			</span><br><span class="line">&apos;&#125;&apos;;</span><br><span class="line"></span><br><span class="line">access_log  /var/log/nginx/access_json.log  json;</span><br></pre></td></tr></table></figure>

<p><strong>logstash:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">     file &#123;</span><br><span class="line">	path =&gt; &quot;/var/log/nginx/access_json.log&quot;</span><br><span class="line">	codec =&gt; &quot;json&quot;                                               #输入预定义好的 JSON 数据，可以省略掉 filter/grok 配置，从而减轻logstash的负载</span><br><span class="line">	start_position =&gt; &quot;beginning&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">	elasticsearch &#123;</span><br><span class="line">		hosts =&gt; [&quot;192.168.10.31:9200&quot;]</span><br><span class="line">		index =&gt; &quot;nginx-log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">	&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a><strong>方案二</strong></h4><h5 id="Logstash-默认自带了-apache标准日志的-grok正则"><a href="#Logstash-默认自带了-apache标准日志的-grok正则" class="headerlink" title="Logstash 默认自带了 apache标准日志的 grok正则:"></a>Logstash 默认自带了 apache标准日志的 grok正则:</h5><p>COMMONAPACHELOG %{IPORHOST:clientip} %{USER:ident} %{NOTSPACE:auth} [%{HTTPDATE:timestamp}] “(?:%{WORD:verb} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})” %{NUMBER:response} (?:%{NUMBER:bytes}|-)     </p>
<p>COMBINEDAPACHELOG %{COMMONAPACHELOG} %{QS:referrer} %</p>
<p>对于 nginx 标准日志格式，可以发现只是最后多了一个 $http_x_forwarded_for 变量。所以 nginx 标准日志的 grok 正则定义是:</p>
<p>​    MAINNGINXLOG %{COMBINEDAPACHELOG} %{QS:x_forwarded_for}</p>
<h5 id="logstash-直接使用访问日志"><a href="#logstash-直接使用访问日志" class="headerlink" title="logstash:直接使用访问日志"></a>logstash:直接使用访问日志</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">	file &#123;</span><br><span class="line">		path =&gt; &quot;/var/log/nginx/access.log&quot;</span><br><span class="line">		start_position =&gt; beginning	</span><br><span class="line">   &#125;</span><br><span class="line">&#125;	</span><br><span class="line">filter &#123;</span><br><span class="line">	grok &#123;</span><br><span class="line">		match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125; %</span><br><span class="line">&#123;QS:x_forwarded_for&#125;&quot;&#125;    </span><br><span class="line">&#125;</span><br><span class="line">date &#123;</span><br><span class="line">	match =&gt; [ &quot;timestamp&quot; , &quot;dd/MMM/YYYY:HH:mm:ss Z&quot; ]    </span><br><span class="line">&#125;</span><br><span class="line">	geoip &#123;</span><br><span class="line">		source =&gt; &quot;clientip&quot;    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">	elasticsearch &#123;</span><br><span class="line">		hosts =&gt; &quot;192.168.11.10:9200&quot; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Logstash标准日志grok正则:<a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns" target="_blank" rel="noopener">https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns</a> </p>
<h1 id="利用filebeat采集日志"><a href="#利用filebeat采集日志" class="headerlink" title="利用filebeat采集日志"></a>利用filebeat采集日志</h1><h4 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xf filebeat-6.4.1-linux-x86_64.tar.gz</span><br><span class="line">mv filebeat-6.4.1-linux-x86_64 /usr/local/filebeat</span><br></pre></td></tr></table></figure>

<h4 id="2-测试"><a href="#2-测试" class="headerlink" title="2.测试"></a>2.测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/filebeat/</span><br><span class="line">vim filebeat.yml</span><br><span class="line">   filebeat.prospectors:</span><br><span class="line">      -type: log</span><br><span class="line">		#enabled: false            #这一句要注释掉</span><br><span class="line">		paths:</span><br><span class="line">		 -/var/log/messages   #指定需要收集的日志文件的路径</span><br><span class="line">	#output.elasticsearch:      #先将这几句注释掉</span><br><span class="line">	#hosts: [&quot;localhost:9200&quot;]</span><br><span class="line">output.console:              </span><br><span class="line">	enable: true</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -c filebeat.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#看看是否有在终端中打印日志数据，有打印则代表filebeat能够正常收集日志数据</span><br></pre></td></tr></table></figure>

<h4 id="3-测试完成后-修改配置文件-让filebeat以服务的方式启动"><a href="#3-测试完成后-修改配置文件-让filebeat以服务的方式启动" class="headerlink" title="3.测试完成后,修改配置文件,让filebeat以服务的方式启动"></a>3.测试完成后,修改配置文件,让filebeat以服务的方式启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim filebeat.yml         </span><br><span class="line">#output.console:  把这两句注释掉         </span><br><span class="line">#  enable: true         </span><br><span class="line">output.elasticsearch:          </span><br><span class="line">   hosts: [&quot;192.168.10.31:9200&quot;]  #配置es服务器的ip地址</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#./filebeat -c filebeat.yml &amp;</span><br></pre></td></tr></table></figure>

<h4 id="4-启动成功后，到es服务器上查看索引，可以看到新增了一个以filebeat开头的索引，这就代表filesbeat和es能够正常通信了"><a href="#4-启动成功后，到es服务器上查看索引，可以看到新增了一个以filebeat开头的索引，这就代表filesbeat和es能够正常通信了" class="headerlink" title="4.启动成功后，到es服务器上查看索引，可以看到新增了一个以filebeat开头的索引，这就代表filesbeat和es能够正常通信了"></a>4.启动成功后，到es服务器上查看索引，可以看到新增了一个以filebeat开头的索引，这就代表filesbeat和es能够正常通信了</h4>
        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/08/LVM扩容/">
  LVM扩容
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/08/LVM扩容/"><span class="article-date">
  2019-08-08
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/linux/">linux</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LVM/">LVM</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="LVM扩容"><a href="#LVM扩容" class="headerlink" title="LVM扩容"></a>LVM扩容</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p> [隐藏] </p>
<ul>
<li>[1格式化pv分区</li>
<li>[2显示PV分区情况</li>
<li>[3显示LVM卷组的信息</li>
<li>[4添加sdb1分区加入到VolGroup组</li>
<li>[5显示LVM卷组的信息</li>
<li>[6查看/www的容量情况</li>
<li>[7在线扩展逻辑卷/dev/mapper/VolGroup-LogVol02的空间大小为3T</li>
<li>[8增加未加载的ext4文件系统的大小</li>
</ul>
<h2 id="格式化pv分区-编辑"><a href="#格式化pv分区-编辑" class="headerlink" title="格式化pv分区[编辑]"></a>格式化pv分区[<a href="http://wiki.op.9377.com/index.php?title=LVM%E6%89%A9%E5%AE%B9&action=edit&section=1" target="_blank" rel="noopener">编辑</a>]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# pvcreate /dev/sdb1</span><br><span class="line"> Physical volume &quot;/dev/sdb1&quot; successfully created</span><br></pre></td></tr></table></figure>

<p>  显示PV分区情况[<a href="http://wiki.op.9377.com/index.php?title=LVM%E6%89%A9%E5%AE%B9&action=edit&section=2" target="_blank" rel="noopener">编辑</a>]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# pvdisplay</span><br><span class="line"> --- Physical volume ---</span><br><span class="line"> PV Name /dev/sda3</span><br><span class="line"> VG Name VolGroup</span><br><span class="line"> PV Size 263.05 GiB / not usable 3.00 MiB</span><br><span class="line"> Allocatable yes</span><br><span class="line"> PE Size 4.00 MiB</span><br><span class="line"> Total PE 67341</span><br><span class="line"> Free PE 1681</span><br><span class="line"> Allocated PE 65660</span><br><span class="line"> PV UUID Rkl9Mj-4HRj-wyN8-JSjy-3yp1-ODYk-ntKfeU</span><br><span class="line"> </span><br><span class="line"> &quot;/dev/sdb1&quot; is a new physical volume of &quot;3.64 TiB&quot;</span><br><span class="line"> --- NEW Physical volume ---</span><br><span class="line"> PV Name /dev/sdb1</span><br><span class="line"> VG Name </span><br><span class="line"> PV Size 3.64 TiB</span><br><span class="line"> Allocatable NO</span><br><span class="line"> PE Size 0 </span><br><span class="line"> Total PE 0</span><br><span class="line"> Free PE 0</span><br><span class="line"> Allocated PE 0</span><br><span class="line"> PV UUID rDjtHR-6cKJ-5jmG-KiJd-1rwT-p70J-gTvMTL</span><br></pre></td></tr></table></figure>

<h2 id="显示LVM卷组的信息-编辑"><a href="#显示LVM卷组的信息-编辑" class="headerlink" title="显示LVM卷组的信息[编辑]"></a>显示LVM卷组的信息[<a href="http://wiki.op.9377.com/index.php?title=LVM%E6%89%A9%E5%AE%B9&action=edit&section=3" target="_blank" rel="noopener">编辑</a>]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# vgdisplay</span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               VolGroup</span><br><span class="line">  System ID            </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        1</span><br><span class="line">  Metadata Sequence No  8</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                4</span><br><span class="line">  Open LV               4</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                1</span><br><span class="line">  Act PV                1</span><br><span class="line">  VG Size               263.05 GiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              67341</span><br><span class="line">  Alloc PE / Size       65660 / 256.48 GiB</span><br><span class="line">  Free  PE / Size       1681 / 6.57 GiB</span><br><span class="line">  VG UUID               UFyIpG-nG1e-oudK-zKkh-qR3O-NFue-Nyom9s</span><br></pre></td></tr></table></figure>

<h2 id="添加sdb1分区加入到VolGroup组-编辑"><a href="#添加sdb1分区加入到VolGroup组-编辑" class="headerlink" title="添加sdb1分区加入到VolGroup组[编辑]"></a>添加sdb1分区加入到VolGroup组[<a href="http://wiki.op.9377.com/index.php?title=LVM%E6%89%A9%E5%AE%B9&action=edit&section=4" target="_blank" rel="noopener">编辑</a>]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# vgextend  VolGroup /dev/sdb1</span><br><span class="line">  Volume group &quot;VolGroup&quot; successfully extended</span><br></pre></td></tr></table></figure>

<h2 id="显示LVM卷组的信息-编辑-1"><a href="#显示LVM卷组的信息-编辑-1" class="headerlink" title="显示LVM卷组的信息[编辑]"></a>显示LVM卷组的信息[<a href="http://wiki.op.9377.com/index.php?title=LVM%E6%89%A9%E5%AE%B9&action=edit&section=5" target="_blank" rel="noopener">编辑</a>]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# vgdisplay</span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               VolGroup</span><br><span class="line">  System ID            </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        2</span><br><span class="line">  Metadata Sequence No  9</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                4</span><br><span class="line">  Open LV               4</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                2</span><br><span class="line">  Act PV                2</span><br><span class="line">  VG Size               3.90 TiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              1021068</span><br><span class="line">  Alloc PE / Size       65660 / 256.48 GiB</span><br><span class="line">  Free  PE / Size       955408 / 3.64 TiB</span><br><span class="line">  VG UUID               UFyIpG-nG1e-oudK-zKkh-qR3O-NFue-Nyom9s</span><br></pre></td></tr></table></figure>

<h2 id="查看-www的容量情况-编辑"><a href="#查看-www的容量情况-编辑" class="headerlink" title="查看/www的容量情况[编辑]"></a>查看/www的容量情况[<a href="http://wiki.op.9377.com/index.php?title=LVM%E6%89%A9%E5%AE%B9&action=edit&section=6" target="_blank" rel="noopener">编辑</a>]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# df -h</span><br><span class="line">Filesystem            Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/VolGroup-LogVol00</span><br><span class="line">                       39G  3.5G   33G  10% /</span><br><span class="line">/dev/sda1             190M   60M  121M  34% /boot</span><br><span class="line">/dev/mapper/VolGroup-LogVol02</span><br><span class="line">                      165G  115G   42G  74% /www</span><br><span class="line">/dev/mapper/VolGroup-LogVol03</span><br><span class="line">                       40G  766M   37G   3% /data0</span><br><span class="line">/dev/mapper/VolGroup-LogVol01</span><br><span class="line">                      9.5G  451M  8.6G   5% /opt</span><br></pre></td></tr></table></figure>

<h2 id="在线扩展逻辑卷-dev-mapper-VolGroup-LogVol02的空间大小为3T-编辑"><a href="#在线扩展逻辑卷-dev-mapper-VolGroup-LogVol02的空间大小为3T-编辑" class="headerlink" title="在线扩展逻辑卷/dev/mapper/VolGroup-LogVol02的空间大小为3T[编辑]"></a>在线扩展逻辑卷/dev/mapper/VolGroup-LogVol02的空间大小为3T[<a href="http://wiki.op.9377.com/index.php?title=LVM%E6%89%A9%E5%AE%B9&action=edit&section=7" target="_blank" rel="noopener">编辑</a>]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# lvextend -L +3000G /dev/mapper/VolGroup-LogVol02</span><br><span class="line">  Size of logical volume VolGroup/LogVol02 changed from 167.66 GiB (42920 extents) to 3.09 TiB (810920 extents).</span><br><span class="line">  Logical volume LogVol02 successfully resized</span><br></pre></td></tr></table></figure>

<h2 id="增加未加载的ext4文件系统的大小-编辑"><a href="#增加未加载的ext4文件系统的大小-编辑" class="headerlink" title="增加未加载的ext4文件系统的大小[编辑]"></a>增加未加载的ext4文件系统的大小[<a href="http://wiki.op.9377.com/index.php?title=LVM%E6%89%A9%E5%AE%B9&action=edit&section=8" target="_blank" rel="noopener">编辑</a>]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# resize2fs /dev/mapper/VolGroup-LogVol02</span><br><span class="line">resize2fs 1.41.12 (17-May-2010)</span><br><span class="line">Filesystem at /dev/mapper/VolGroup-LogVol02 is mounted on /www; on-line resizing required</span><br><span class="line">old desc_blocks = 11, new_desc_blocks = 198</span><br><span class="line">Performing an on-line resize of /dev/mapper/VolGroup-LogVol02 to 830382080 (4k) blocks.</span><br><span class="line">The filesystem on /dev/mapper/VolGroup-LogVol02 is now 830382080 blocks long.</span><br></pre></td></tr></table></figure>

<h2 id="查看扩容后-www的容量情况-编辑"><a href="#查看扩容后-www的容量情况-编辑" class="headerlink" title="查看扩容后/www的容量情况[编辑]"></a>查看扩容后/www的容量情况[<a href="http://wiki.op.9377.com/index.php?title=LVM%E6%89%A9%E5%AE%B9&action=edit&section=9" target="_blank" rel="noopener">编辑</a>]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# df -h</span><br><span class="line">Filesystem            Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/VolGroup-LogVol00</span><br><span class="line">                       39G  6.2G   31G  17% /</span><br><span class="line">/dev/sda1             190M   60M  121M  34% /boot</span><br><span class="line">/dev/mapper/VolGroup-LogVol02</span><br><span class="line">                      3.1T  135G  2.8T   5% /www</span><br><span class="line">/dev/mapper/VolGroup-LogVol03</span><br><span class="line">                       40G  768M   37G   3% /data0</span><br><span class="line">/dev/mapper/VolGroup-LogVol01</span><br><span class="line">                      9.5G  454M  8.6G   5% /opt</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/08/LVM调整容量/">
  LVM调整容量
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/08/LVM调整容量/"><span class="article-date">
  2019-08-08
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/linux/">linux</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LVM/">LVM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lvm/">lvm</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="LVM调整容量"><a href="#LVM调整容量" class="headerlink" title="LVM调整容量"></a>LVM调整容量</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p> [隐藏] </p>
<ul>
<li><a href="http://wiki.op.9377.com/LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F#.E5.87.86.E5.A4.87.E5.B7.A5.E4.BD.9C" target="_blank" rel="noopener">1准备工作</a></li>
<li>2缩减卷<ul>
<li><a href="http://wiki.op.9377.com/LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F#.E5.8D.B8.E8.BD.BD.E7.BC.A9.E5.87.8F.E5.8D.B7" target="_blank" rel="noopener">2.1卸载缩减卷</a></li>
<li><a href="http://wiki.op.9377.com/LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F#.E6.96.87.E4.BB.B6.E7.B3.BB.E7.BB.9F.E5.8F.98.E6.9B.B4" target="_blank" rel="noopener">2.2文件系统变更</a></li>
<li><a href="http://wiki.op.9377.com/LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F#LVM.E7.BC.A9.E5.87.8F" target="_blank" rel="noopener">2.3LVM缩减</a></li>
<li><a href="http://wiki.op.9377.com/LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F#.E6.8C.82.E8.BD.BD.E7.BC.A9.E5.87.8F.E5.8D.B7" target="_blank" rel="noopener">2.4挂载缩减卷</a></li>
</ul>
</li>
<li>3扩容其它卷<ul>
<li><a href="http://wiki.op.9377.com/LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F#.E6.89.A9.E5.AE.B9LVM" target="_blank" rel="noopener">3.1扩容LVM</a></li>
<li><a href="http://wiki.op.9377.com/LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F#.E6.96.87.E4.BB.B6.E7.B3.BB.E7.BB.9F.E5.8F.98.E6.9B.B4_2" target="_blank" rel="noopener">3.2文件系统变更</a></li>
</ul>
</li>
</ul>
<h2 id="准备工作-编辑"><a href="#准备工作-编辑" class="headerlink" title="准备工作[编辑]"></a>准备工作[<a href="http://wiki.op.9377.com/index.php?title=LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F&action=edit&section=1" target="_blank" rel="noopener">编辑</a>]</h2><p>查看/etc/fstab，确认分区挂载情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root:]# cat /etc/fstab</span><br><span class="line"></span><br><span class="line">/dev/mapper/VolGroup-LogVol02   /data0                  ext4    defaults        1 2</span><br><span class="line">/dev/mapper/VolGroup-LogVol03   /data1                  ext4    defaults        1 2</span><br><span class="line">/dev/mapper/VolGroup-LogVol04   /data2                  ext4    defaults        1 2</span><br><span class="line">/dev/mapper/VolGroup-LogVol05   /data3                  ext4    defaults        1 2</span><br><span class="line">/dev/mapper/VolGroup-LogVol01   /opt                    ext4    defaults        1 2</span><br></pre></td></tr></table></figure>

<p>用vgdisplay查看当初lvm情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root:]# vgdisplay</span><br><span class="line"></span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               VolGroup</span><br><span class="line">  System ID</span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        1</span><br><span class="line">  Metadata Sequence No  9</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                6</span><br><span class="line">  Open LV               6</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                1</span><br><span class="line">  Act PV                1</span><br><span class="line">  VG Size               877.05 GiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              224525</span><br><span class="line">  Alloc PE / Size       224525 / 877.05 GiB</span><br><span class="line">  Free  PE / Size       0 / 0</span><br><span class="line">  VG UUID               0IYC5T-NoQz-z123-m61f-qTni-yfMk-p0x49V</span><br></pre></td></tr></table></figure>

<h2 id="缩减卷-编辑"><a href="#缩减卷-编辑" class="headerlink" title="缩减卷[编辑]"></a>缩减卷[<a href="http://wiki.op.9377.com/index.php?title=LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F&action=edit&section=2" target="_blank" rel="noopener">编辑</a>]</h2><h3 id="卸载缩减卷-编辑"><a href="#卸载缩减卷-编辑" class="headerlink" title="卸载缩减卷[编辑]"></a>卸载缩减卷[<a href="http://wiki.op.9377.com/index.php?title=LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F&action=edit&section=3" target="_blank" rel="noopener">编辑</a>]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount  /data1</span><br></pre></td></tr></table></figure>

<h3 id="文件系统变更-编辑"><a href="#文件系统变更-编辑" class="headerlink" title="文件系统变更[编辑]"></a>文件系统变更[<a href="http://wiki.op.9377.com/index.php?title=LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F&action=edit&section=4" target="_blank" rel="noopener">编辑</a>]</h3><p>缩减为10G容量的大小 (不能超过已存数据的大小，如里边已经有20G数据，最少也要21G保证正常)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resize2fs /dev/mapper/VolGroup-LogVol03 10G</span><br></pre></td></tr></table></figure>

<p>如有提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Please run &apos;e2fsck -f /dev/mapper/VolGroup-LogVol03&apos; first.</span><br></pre></td></tr></table></figure>

<p>请执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e2fsck -f /dev/mapper/VolGroup-LogVol03</span><br></pre></td></tr></table></figure>

<p>再执行缩减为10G容量的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resize2fs /dev/mapper/VolGroup-LogVol03 10G</span><br></pre></td></tr></table></figure>

<h3 id="LVM缩减-编辑"><a href="#LVM缩减-编辑" class="headerlink" title="LVM缩减[编辑]"></a>LVM缩减[<a href="http://wiki.op.9377.com/index.php?title=LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F&action=edit&section=5" target="_blank" rel="noopener">编辑</a>]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvresize -L 10G /dev/mapper/VolGroup-LogVol03</span><br></pre></td></tr></table></figure>

<h3 id="挂载缩减卷-编辑"><a href="#挂载缩减卷-编辑" class="headerlink" title="挂载缩减卷[编辑]"></a>挂载缩减卷[<a href="http://wiki.op.9377.com/index.php?title=LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F&action=edit&section=6" target="_blank" rel="noopener">编辑</a>]</h3><p>缩减完成，把缩减卷挂载到系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount  /data1</span><br></pre></td></tr></table></figure>

<h2 id="扩容其它卷-编辑"><a href="#扩容其它卷-编辑" class="headerlink" title="扩容其它卷[编辑]"></a>扩容其它卷[<a href="http://wiki.op.9377.com/index.php?title=LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F&action=edit&section=7" target="_blank" rel="noopener">编辑</a>]</h2><p>扩容卷不用卸载，可以直接操作</p>
<p>先用vgdisplay查看当初lvm情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root:]# vgdisplay</span><br><span class="line"></span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               VolGroup</span><br><span class="line">  System ID</span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        1</span><br><span class="line">  Metadata Sequence No  9</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                6</span><br><span class="line">  Open LV               6</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                1</span><br><span class="line">  Act PV                1</span><br><span class="line">  VG Size               877.05 GiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              224525</span><br><span class="line">  Alloc PE / Size       224525 / 877.05 GiB</span><br><span class="line">  Free  PE / Size       24320 / 90G</span><br><span class="line">  VG UUID               0IYC5T-NoQz-z123-m61f-qTni-yfMk-p0x49V</span><br></pre></td></tr></table></figure>

<p>可以看到，上边有90G空闲空间</p>
<h3 id="扩容LVM-编辑"><a href="#扩容LVM-编辑" class="headerlink" title="扩容LVM[编辑]"></a>扩容LVM[<a href="http://wiki.op.9377.com/index.php?title=LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F&action=edit&section=8" target="_blank" rel="noopener">编辑</a>]</h3><p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvresize -L +90G /dev/mapper/VolGroup-LogVol05</span><br></pre></td></tr></table></figure>

<h3 id="文件系统变更-编辑-1"><a href="#文件系统变更-编辑-1" class="headerlink" title="文件系统变更[编辑]"></a>文件系统变更[<a href="http://wiki.op.9377.com/index.php?title=LVM%E8%B0%83%E6%95%B4%E5%AE%B9%E9%87%8F&action=edit&section=9" target="_blank" rel="noopener">编辑</a>]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resize2fs /dev/mapper/VolGroup-LogVol05</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/08/Memcached/">
  Memcached
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/08/Memcached/"><span class="article-date">
  2019-08-08
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/Memcached/">Memcached</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Memcached/">Memcached</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="Memcached"><a href="#Memcached" class="headerlink" title="Memcached"></a>Memcached</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p> [隐藏] </p>
<ul>
<li>[1安装依赖包]</li>
<li>[2创建账户]</li>
<li>[3下载安装]</li>
<li>[4配置文件]</li>
<li>[5目录权限]</li>
<li>[6系统服务配置文件]</li>
<li>[7配置为系统服务]</li>
<li>[8启动memcached]</li>
</ul>
<h2 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libevent libevent-devel</span><br></pre></td></tr></table></figure>

<h2 id="创建账户"><a href="#创建账户" class="headerlink" title="创建账户"></a>创建账户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd memcached</span><br><span class="line">useradd -gmemcached -s /sbin/nologin -M memcached</span><br></pre></td></tr></table></figure>

<h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.memcached.org/files/memcached-1.5.12.tar.gz</span><br><span class="line">tar xzf memcached-1.5.12.tar.gz</span><br><span class="line">cd memcached-1.5.12</span><br><span class="line">./configure --prefix=/data/soft/memcached</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">ln -s /data/soft/memcached/bin/memcached /usr/bin/</span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /data/soft/memcached/memcached.conf &lt;&lt; EOF</span><br><span class="line">PORT=&quot;22122&quot;</span><br><span class="line">USER=&quot;memcached&quot;</span><br><span class="line">MAXCONN=&quot;65535&quot;</span><br><span class="line">CACHESIZE=&quot;8192&quot;</span><br><span class="line">OPTIONS=&quot;&quot;</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="目录权限"><a href="#目录权限" class="headerlink" title="目录权限"></a>目录权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/run/memcached</span><br><span class="line">chown -R memcached.memcached /data/soft/memcached</span><br><span class="line">chown -R memcached.memcached /var/run/memcached</span><br></pre></td></tr></table></figure>

<h2 id="系统服务配置文件"><a href="#系统服务配置文件" class="headerlink" title="系统服务配置文件"></a>系统服务配置文件</h2><p>vim /etc/init.d/memcached</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/sh</span><br><span class="line">#</span><br><span class="line"># chkconfig: - 55 45</span><br><span class="line"># description:  The memcached daemon is a network memory cache service.</span><br><span class="line"># processname: memcached</span><br><span class="line"># config: /data/soft/memcached/memcached.conf</span><br><span class="line"># pidfile: /var/run/memcached/memcached.pid</span><br><span class="line"></span><br><span class="line"># Standard LSB functions</span><br><span class="line">#. /lib/lsb/init-functions</span><br><span class="line"></span><br><span class="line"># Source function library.</span><br><span class="line">. /etc/init.d/functions</span><br><span class="line"></span><br><span class="line">PORT=&quot;22122&quot;</span><br><span class="line">USER=&quot;memcached&quot;</span><br><span class="line">MAXCONN=&quot;65535&quot;</span><br><span class="line">CACHESIZE=&quot;8192&quot;</span><br><span class="line">OPTIONS=&quot;&quot;</span><br><span class="line"></span><br><span class="line">if [ -f /data/soft/memcached/memcached.conf ];then</span><br><span class="line">        . /data/soft/memcached/memcached.conf</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Check that networking is up.</span><br><span class="line">. /etc/sysconfig/network</span><br><span class="line"></span><br><span class="line">if [ &quot;$NETWORKING&quot; = &quot;no&quot; ]</span><br><span class="line">then</span><br><span class="line">        exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">RETVAL=0</span><br><span class="line">prog=&quot;memcached&quot;</span><br><span class="line">pidfile=$&#123;PIDFILE-/var/run/memcached/memcached.pid&#125;</span><br><span class="line">lockfile=$&#123;LOCKFILE-/var/lock/subsys/memcached&#125;</span><br><span class="line"></span><br><span class="line">start () &#123;</span><br><span class="line">        [ &quot;$EUID&quot; != &quot;0&quot; ] &amp;&amp; exit 4</span><br><span class="line">        echo -n $&quot;Starting $prog: &quot;</span><br><span class="line">        # Ensure that /var/run/memcached has proper permissions</span><br><span class="line">        if [ &quot;`stat -c %U /var/run/memcached`&quot; != &quot;$USER&quot; ]; then</span><br><span class="line">                chown $USER /var/run/memcached</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        daemon --pidfile $&#123;pidfile&#125; memcached -d -p $PORT -u $USER  -m $CACHESIZE -c $MAXCONN -P $&#123;pidfile&#125; $OPTIONS</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        echo</span><br><span class="line">        [ $RETVAL -eq 0 ] &amp;&amp; touch $&#123;lockfile&#125;</span><br><span class="line">&#125;</span><br><span class="line">stop () &#123;</span><br><span class="line">        [ &quot;$EUID&quot; != &quot;0&quot; ] &amp;&amp; exit 4</span><br><span class="line">        echo -n $&quot;Stopping $prog: &quot;</span><br><span class="line">        killproc -p $&#123;pidfile&#125; /usr/bin/memcached</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        echo</span><br><span class="line">        if [ $RETVAL -eq 0 ] ; then</span><br><span class="line">                rm -f $&#123;lockfile&#125; $&#123;pidfile&#125;</span><br><span class="line">        fi</span><br><span class="line">&#125;</span><br><span class="line">restart () &#123;</span><br><span class="line">        stop</span><br><span class="line">        start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># See how we were called.</span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">  start)</span><br><span class="line">        start</span><br><span class="line">        ;;</span><br><span class="line">  stop)</span><br><span class="line">        stop</span><br><span class="line">        ;;</span><br><span class="line">  status)</span><br><span class="line">        status -p $&#123;pidfile&#125; memcached</span><br><span class="line">        RETVAL=$?</span><br><span class="line">        ;;</span><br><span class="line">  restart|reload|force-reload)</span><br><span class="line">        restart</span><br><span class="line">        ;;</span><br><span class="line">  condrestart|try-restart)</span><br><span class="line">        [ -f $&#123;lockfile&#125; ] &amp;&amp; restart || :</span><br><span class="line">        ;;</span><br><span class="line">  *)</span><br><span class="line">        echo $&quot;Usage: $0 &#123;start|stop|status|restart|reload|force-reload|condrestart|try-restart&#125;&quot;</span><br><span class="line">        RETVAL=2</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">exit $RETVAL</span><br></pre></td></tr></table></figure>

<h2 id="配置为系统服务"><a href="#配置为系统服务" class="headerlink" title="配置为系统服务"></a>配置为系统服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod u+x /etc/init.d/memcached</span><br><span class="line">chkconfig --add memcached</span><br><span class="line">chkconfig memcached on</span><br></pre></td></tr></table></figure>

<h2 id="启动memcached"><a href="#启动memcached" class="headerlink" title="启动memcached"></a>启动memcached</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service memcached start</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/08/MySQL_5.7.24/">
  MySQL 5.7.24
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/08/MySQL_5.7.24/"><span class="article-date">
  2019-08-08
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/MySQL/">MySQL</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/MySQL/centos/">centos</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="MySQL-5-7-24"><a href="#MySQL-5-7-24" class="headerlink" title="MySQL 5.7.24"></a>MySQL 5.7.24</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p> [隐藏] </p>
<ul>
<li>[1添加mysql用户]</li>
<li>[2安装依赖]</li>
<li>[3把系统默认的my.cnf改名，防止冲突]</li>
<li>[4编译MySQL]</li>
<li>[5默认客户端配置]</li>
<li>[6默认配置]</li>
<li>[7初始化数据库]</li>
<li>[8systemd启动脚本]</li>
<li>[9修改连接用户]</li>
</ul>
<h2 id="添加mysql用户"><a href="#添加mysql用户" class="headerlink" title="添加mysql用户"></a>添加mysql用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd mysql</span><br><span class="line">useradd -gmysql -s /sbin/nologin -M mysql</span><br></pre></td></tr></table></figure>

<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc gcc-c++ ncurses ncurses-devel cmake</span><br></pre></td></tr></table></figure>

<h2 id="把系统默认的my-cnf改名，防止冲突"><a href="#把系统默认的my-cnf改名，防止冲突" class="headerlink" title="把系统默认的my.cnf改名，防止冲突"></a>把系统默认的my.cnf改名，防止冲突</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/my.cnf /etc/my.cnf.bak</span><br></pre></td></tr></table></figure>

<h2 id="编译MySQL"><a href="#编译MySQL" class="headerlink" title="编译MySQL"></a>编译MySQL</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.24.tar.gz</span><br><span class="line">tar -xzf mysql-boost-5.7.24.tar.gz</span><br><span class="line">cd mysql-5.7.24/</span><br><span class="line">cmake . \</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/data/soft/mysql \</span><br><span class="line">-DMYSQL_DATADIR=/data/db/mysql \</span><br><span class="line">-DWITH_BOOST=boost \</span><br><span class="line">-DSYSCONFDIR=/data/etc \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_MYISAM_STORAGE_ENGINE=1 \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DENABLE_DTRACE=0 \</span><br><span class="line">-DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">-DWITH_EMBEDDED_SERVER=1</span><br><span class="line"></span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="默认客户端配置"><a href="#默认客户端配置" class="headerlink" title="默认客户端配置"></a>默认客户端配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /data/etc/my.cnf &lt;&lt; EOF</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br><span class="line">host = 127.0.0.1</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">echo &apos;export PATH=$PATH:/data/soft/mysql/bin&apos; &gt;&gt; /etc/bashrc</span><br></pre></td></tr></table></figure>

<h2 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/db/mysql/binlog</span><br><span class="line">chown mysql.mysql /data/db/mysql/binlog</span><br><span class="line"></span><br><span class="line">cat &gt; /data/db/mysql/my.cnf &lt;&lt; EOF</span><br><span class="line">[mysqld]</span><br><span class="line">bind-address = 0.0.0.0</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">basedir=/data/soft/mysql</span><br><span class="line">datadir=/data/db/mysql/data</span><br><span class="line">log-bin=/data/db/mysql/binlog/binlog</span><br><span class="line">server-id=1</span><br><span class="line">skip-name-resolve</span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/soft/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/data/soft/mysql --datadir=/data/db/mysql/data</span><br></pre></td></tr></table></figure>

<h2 id="systemd启动脚本"><a href="#systemd启动脚本" class="headerlink" title="systemd启动脚本"></a>systemd启动脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /lib/systemd/system/mysqld.service &lt;&lt; EOF</span><br><span class="line">#</span><br><span class="line"># Simple MySQL systemd service file</span><br><span class="line">#</span><br><span class="line"># systemd supports lots of fancy features, look here (and linked docs) for a full list:</span><br><span class="line">#  http://www.freedesktop.org/software/systemd/man/systemd.exec.html</span><br><span class="line">#</span><br><span class="line"># Note: this file ( /usr/lib/systemd/system/mysql.service )</span><br><span class="line"># will be overwritten on package upgrade, please copy the file to</span><br><span class="line">#</span><br><span class="line">#  /etc/systemd/system/mysql.service</span><br><span class="line">#</span><br><span class="line"># to make needed changes.</span><br><span class="line">#</span><br><span class="line"># systemd-delta can be used to check differences between the two mysql.service files.</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=MySQL Community Server</span><br><span class="line">After=network.target</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=mysql.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=mysql</span><br><span class="line">Group=mysql</span><br><span class="line"></span><br><span class="line">PermissionsStartOnly=true</span><br><span class="line"></span><br><span class="line">ExecStart=/data/soft/mysql/bin/mysqld --defaults-file=/data/db/mysql/my.cnf</span><br><span class="line"></span><br><span class="line">TimeoutSec=600</span><br><span class="line"></span><br><span class="line">PrivateTmp=false</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod u+x /lib/systemd/system/mysqld.service</span><br><span class="line"></span><br><span class="line">systemctl enable mysqld.service</span><br></pre></td></tr></table></figure>

<h2 id="修改连接用户"><a href="#修改连接用户" class="headerlink" title="修改连接用户"></a>修改连接用户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">update mysql.user set Host=&apos;127.0.0.1&apos; where User=&apos;root&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/08/Nginx调优/">
  Nginx
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/08/Nginx调优/"><span class="article-date">
  2019-08-08
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/Nginx/">Nginx</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="Nginx调优"><a href="#Nginx调优" class="headerlink" title="Nginx调优"></a>Nginx调优</h1><h2 id="一、Nginx调优选项参数"><a href="#一、Nginx调优选项参数" class="headerlink" title="一、Nginx调优选项参数"></a>一、Nginx调优选项参数</h2><h3 id="1-worker-processes"><a href="#1-worker-processes" class="headerlink" title="1.worker_processes"></a>1.worker_processes</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 8;</span><br><span class="line">nginx进程数，建议按照cpu数目来指定，一般跟cpu核数相同或为它的倍</span><br><span class="line">数。</span><br></pre></td></tr></table></figure>

<h3 id="2-worker-cpu-affinity"><a href="#2-worker-cpu-affinity" class="headerlink" title="2.worker_cpu_affinity"></a>2.worker_cpu_affinity</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000</span><br><span class="line">00010000 00100000 01000000 10000000;</span><br><span class="line">为每个进程分配cpu，上例中将8个进程分配到8个cpu，当然可以写多个，或</span><br><span class="line">者将一个进程分配到多个cpu。</span><br></pre></td></tr></table></figure>

<h3 id="3-worker-rlimit-nofile"><a href="#3-worker-rlimit-nofile" class="headerlink" title="3.worker_rlimit_nofile"></a>3.worker_rlimit_nofile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile 65535</span><br><span class="line">下面这个指令是指当一个nginx进程打开的最多文件描述符数目，理论值应该</span><br><span class="line">是系统的最多打开文件数（ulimit -n）与nginx进程数相除，但是nginx</span><br><span class="line">分配请求并不是那么均匀，所以最好与ulimit -n的值保持一致。</span><br></pre></td></tr></table></figure>

<h3 id="4-use-epoll"><a href="#4-use-epoll" class="headerlink" title="4.use epoll;"></a>4.use epoll;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use epoll;</span><br><span class="line">使用epoll的I/O模型，用这个模型来高效处理异步事件</span><br></pre></td></tr></table></figure>

<h3 id="5-accept-mutex"><a href="#5-accept-mutex" class="headerlink" title="5.accept_mutex"></a>5.accept_mutex</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">accept_mutex on;</span><br><span class="line">优化同一时刻只有一个请求而避免多个睡眠进程被唤醒的设置，on为防止被</span><br><span class="line">同时唤醒，默认为off，因此nginx刚安装完以后要进行适当的优化。</span><br></pre></td></tr></table></figure>

<h3 id="6-multi-accept"><a href="#6-multi-accept" class="headerlink" title="6.multi_accept"></a>6.multi_accept</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multi_accept on;</span><br><span class="line">打开同时接受多个新网络连接请求的功能。</span><br></pre></td></tr></table></figure>

<h3 id="7-server-tokens"><a href="#7-server-tokens" class="headerlink" title="7.server_tokens"></a>7.server_tokens</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server_tokens off;</span><br><span class="line">在http 模块当中配置</span><br></pre></td></tr></table></figure>

<h3 id="8-worker-connections"><a href="#8-worker-connections" class="headerlink" title="8.worker_connections"></a>8.worker_connections</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">worker_connections 65535;</span><br><span class="line">每个进程允许的最多连接数，理论上每台nginx服务器的最大连接数为</span><br><span class="line">worker_processes*worker_connections。</span><br></pre></td></tr></table></figure>

<h3 id="9-keepalive-timeout"><a href="#9-keepalive-timeout" class="headerlink" title="9.keepalive_timeout"></a>9.keepalive_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout 60;</span><br><span class="line">http连接超时时间，默认是60s，功能是使客户端到服务器端的连接在设定</span><br><span class="line">的时间内持续有效，当出现对服务器的后继请求时，该功能避免了建立或者重</span><br><span class="line">新建立连接。切记这个参数也不能设置过大！否则会导致许多无效的http连</span><br><span class="line">接占据着nginx的连接数，终nginx崩溃！</span><br><span class="line">keepalive_timeout 65 70;</span><br><span class="line">这是前端keepalive_timeout的一个延伸配置，前面65是告诉客户端我给</span><br><span class="line">你保持多久，后面一个是多久我就给断开连接了。</span><br></pre></td></tr></table></figure>

<h3 id="10-client-header-timeout"><a href="#10-client-header-timeout" class="headerlink" title="10.client_header_timeout"></a>10.client_header_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client_header_timeout 10s</span><br></pre></td></tr></table></figure>

<h3 id="11-client-header-timeout"><a href="#11-client-header-timeout" class="headerlink" title="11.client_header_timeout"></a>11.client_header_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client_body_timeout 10s;</span><br><span class="line">都跟请求相关，就一起理解了说了，这两个参数是对请求头和请求体（想了解</span><br><span class="line">请求头和请求体的概念自己百度）的超时时间，就是从三次握手到第一次读取</span><br><span class="line">请求头和请求体失败的时间。比如当前服务器负载大、网络卡，恰好在第一次</span><br><span class="line">读取请求头或请求提时没有得到且时间超过10s了，tengine就会超时报错，</span><br><span class="line">对于我当前应用而言，60s显而是太长了，优化到10s。</span><br><span class="line">client_body_timeout 10s;</span><br></pre></td></tr></table></figure>

<h3 id="12-proxy-connect-timeout"><a href="#12-proxy-connect-timeout" class="headerlink" title="12.proxy_connect_timeout"></a>12.proxy_connect_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">在收到请求头后，会将请求转发到upstream里面的server，这个呢就是与</span><br><span class="line">对应的server连接的超时时间，设置时最大值不能超过75s，我这里的</span><br><span class="line">server和tengine是放在同一个交换机上的内网，所以将连接时间优化到</span><br><span class="line">10s，超过10s连接不上，说明业务有问题了。</span><br><span class="line">proxy_connect_timeout 10s</span><br></pre></td></tr></table></figure>

<h3 id="13-proxy-send-timeout"><a href="#13-proxy-send-timeout" class="headerlink" title="13.proxy_send_timeout"></a>13.proxy_send_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy_send_timeout 55s;</span><br><span class="line">在与upstream的server建立连接后，就会把请求往server发送，这个时间</span><br><span class="line">是两次数据的发送时间差，不是整个发送过程的。比如说负载大、网络卡，在</span><br><span class="line">tengine向server发送请求时突然卡了一下，然后继续发送，而这两次的时</span><br><span class="line">间差（其实就是两次write的时间差）超过了我设置的55s，tengine就会超</span><br><span class="line">时报错，对于这个参数，我当前优化的是55s。</span><br></pre></td></tr></table></figure>

<h3 id="14-proxy-read-timeout"><a href="#14-proxy-read-timeout" class="headerlink" title="14.proxy_read_timeout"></a>14.proxy_read_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy_read_timeout 60s;</span><br><span class="line">在将请求发送给upstream的server后，后端server就会回传数据，这个时</span><br><span class="line">间是两次收取数据的时间差，不是整个的接收时间。比如说负载大、网络卡，</span><br><span class="line">在第1次收到请求的数据时断了，然后过了60s后才收到后面的数据，这两个</span><br><span class="line">时间差(其实就是两次read的时间差)超过了设置的60s，</span><br><span class="line">tengine（nginx）就会超时报错，我当前走的是默认设置60s。</span><br></pre></td></tr></table></figure>

<h3 id="15-resolver-timeout"><a href="#15-resolver-timeout" class="headerlink" title="15.resolver_timeout"></a>15.resolver_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">resolver_timeout 10s;</span><br><span class="line"></span><br><span class="line">这个是dns解析超时时间，如果用作正向代理时就有用了，同时可以用</span><br><span class="line">resolver 127.0.0.1 valid=10m;指令来指定dns，后面是解析后缓存</span><br><span class="line">的有效时间。</span><br></pre></td></tr></table></figure>

<h3 id="16-fail-timeout"><a href="#16-fail-timeout" class="headerlink" title="16.fail_timeout"></a>16.fail_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server 127.0.0.1:9999 max_fails=20 fail_timeout=10s;</span><br><span class="line">这个是指某一个upstream的server如果失败20次后，不可以操作的时间，</span><br><span class="line">默认就是10s，其实可以另外的写法配在http中，我习惯直接配在server的</span><br><span class="line">后端。</span><br></pre></td></tr></table></figure>

<h3 id="17-send-timeout"><a href="#17-send-timeout" class="headerlink" title="17.send_timeout"></a>17.send_timeout</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">send_timeout 15;</span><br><span class="line">应客户端超时时间，这个超时时间仅限于两个活动之间的时间，如果超过这个</span><br><span class="line">时间，客户端没有任何活动，nginx关闭连接</span><br></pre></td></tr></table></figure>

<h3 id="18-client-header-buffer-size"><a href="#18-client-header-buffer-size" class="headerlink" title="18.client_header_buffer_size"></a>18.client_header_buffer_size</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client_header_buffer_size 4k;</span><br><span class="line">客户端请求头部的缓冲区大小，这个可以根据你的系统分页大小来设置，一般</span><br><span class="line">一个请求的头部大小不会超过1k，不过由于一般系统分页都要大于1k，所以</span><br><span class="line">这里设置为分页大小。分页大小可以用命令getconf PAGESIZE取得。</span><br></pre></td></tr></table></figure>

<h3 id="19-open-file-cache-max"><a href="#19-open-file-cache-max" class="headerlink" title="19.open_file_cache max"></a>19.open_file_cache max</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache max=102400 inactive=20s;</span><br><span class="line">下面这个参数将为打开文件指定缓存，默认是没有启用的，max指定缓存数</span><br><span class="line">量，建议和打开文件数一致，inactive是指经过多长时间文件没被请求后删</span><br><span class="line">除缓存。</span><br><span class="line">open_file_cache_valid 30s;</span><br><span class="line">下面这个是指多长时间检查一次缓存的有效信息。</span><br><span class="line">open_file_cache_min_uses 1;</span><br><span class="line">open_file_cache指令中的inactive参数时间内文件的最少使用次数，如</span><br><span class="line">果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文</span><br><span class="line">件在inactive时间内一次没被使用，它将被移除。</span><br></pre></td></tr></table></figure>

<h3 id="20-sendfile"><a href="#20-sendfile" class="headerlink" title="20.sendfile"></a>20.sendfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sendfile on;</span><br><span class="line">开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数</span><br><span class="line">来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载</span><br><span class="line">应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。</span><br></pre></td></tr></table></figure>

<h3 id="21-tcp-nopush"><a href="#21-tcp-nopush" class="headerlink" title="21.tcp_nopush"></a>21.tcp_nopush</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tcp_nopush on；</span><br><span class="line">必须在sendfile开启模式才有效，防止网路阻塞，积极的减少网络报文段的</span><br><span class="line">数量（将响应头和正文的开始部分一起发送，而不一个接一个的发送。）</span><br></pre></td></tr></table></figure>

<h3 id="22-reset-timeout-connection"><a href="#22-reset-timeout-connection" class="headerlink" title="22.reset_timeout_connection"></a>22.reset_timeout_connection</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reset_timeout_connection on;</span><br><span class="line">告诉nginx关闭不响应的客户端连接。这将会释放那个客户端所占有的内存空</span><br><span class="line">间。</span><br></pre></td></tr></table></figure>

<h3 id="23-gzip-重要"><a href="#23-gzip-重要" class="headerlink" title="23.gzip(重要)"></a>23.gzip(重要)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">一般我们需要压缩的内容有：文本，js，html，css，对于图片，视频，</span><br><span class="line">flash什么的不压缩，同时也要注意，我们使用gzip的功能是需要消耗CPU</span><br><span class="line">的！</span><br><span class="line">gzip on</span><br><span class="line">gzip_min_length 2k;</span><br><span class="line">gzip_buffers 4 32k;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line"></span><br><span class="line">gzip_typestext/plain text/css</span><br><span class="line">text/javascriptapplication/json application/javascript</span><br><span class="line">application/x-javascriptapplication/xml;</span><br><span class="line"></span><br><span class="line">示意</span><br><span class="line"></span><br><span class="line">gzip on; #开启压缩功能</span><br><span class="line">gzip_min_length 1k; 	#设置允许压缩的页面最小字节数，页面字节数从</span><br><span class="line">header头的Content-Length中获取，默认值是0，不管页面多大都进行压</span><br><span class="line">缩，建议设置成大于1K，如果小与1K可能会越压越大。</span><br><span class="line">gzip_buffers 4 32k; 	#压缩缓冲区大小，表示申请4个单位为32K的内存</span><br><span class="line">作为压缩结果流缓存，默认值是申请与原始数据大小相同的内存空间来存储</span><br><span class="line">gzip压缩结果。</span><br><span class="line">gzip_http_version 1.1; 	#压缩版本，用于设置识别HTTP协议版本，默</span><br><span class="line">认是1.1，目前大部分浏览器已经支持GZIP解压，使用默认即可</span><br><span class="line">gzip_comp_level 6; 		#压缩比例，用来指定GZIP压缩比，1压缩比最小，</span><br><span class="line">处理速度最快，9压缩比最大，传输速度快，但是处理慢，也比较消耗CPU资</span><br><span class="line">源。</span><br><span class="line">gzip_types text/css text/xml application/javascript; #用</span><br><span class="line">来指定压缩的类型，‘text/html’类型总是会被压缩。</span><br><span class="line">gzip_proxied expired no-cache no-store private auth;</span><br></pre></td></tr></table></figure>

<h3 id="24-expires"><a href="#24-expires" class="headerlink" title="24.expires"></a>24.expires</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">主要针对于图片，css，js等元素更改机会比较少的情况下使用，特别是图</span><br><span class="line">片，占用带宽大，我们完全可以设置图片在浏览器本地缓存365d，css，</span><br><span class="line">js，html可以缓存个10来天，这样用户第一次打开加载慢一点，第二次，就</span><br><span class="line">非常快了！缓存的时候，我们需要将需要缓存的拓展名列出来， Expires缓</span><br><span class="line">存配置在server字段里面</span><br><span class="line">location ~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$ &#123;</span><br><span class="line">expires 30d;</span><br><span class="line">#log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">&#125;</span><br><span class="line">location ~* \.(js|css)$ &#123;</span><br><span class="line">expires 7d;</span><br><span class="line">log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log_not_found off;是否在error_log中记录不存在的错误。默认</span><br><span class="line"></span><br><span class="line">是。</span><br><span class="line"></span><br><span class="line">expire功能优点 （1）expires可以降低网站购买的带宽，节约成本（2）</span><br><span class="line">同时提升用户访问体验（3）减轻服务的压力，节约服务器成本，是web服务</span><br><span class="line">非常重要的功能。 expire功能缺点：被缓存的页面或数据更新了，用户看</span><br><span class="line">到的可能还是旧的内容，反而影响用户体验。解决办法：第一个缩短缓存时</span><br><span class="line">间，例如：1天，但不彻底，除非更新频率大于1天；第二个对缓存的对象改</span><br><span class="line">名。</span><br></pre></td></tr></table></figure>

<h3 id="25-防盗链"><a href="#25-防盗链" class="headerlink" title="25.防盗链"></a>25.防盗链</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">location ~*^.+\.</span><br><span class="line">(jpg|gif|png|swf|flv|wma|wmv|asf|mp3|mmf|zip|rar)$ &#123;</span><br><span class="line">valid_referers noneblocked www.benet.com benet.com;</span><br><span class="line">if($invalid_referer) &#123;</span><br><span class="line">#return 302 http://www.benet.com/img/nolink.jpg;</span><br><span class="line">return 404;</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">access_log off;</span><br><span class="line">&#125;</span><br><span class="line">参数可以使如下形式：</span><br><span class="line">none 意思是不存在的Referer头(表示空的，也就是直接访问，比如直接在</span><br><span class="line">浏览器打开一个图片)</span><br><span class="line">blocked 意为根据防火墙伪装Referer头，如：“Referer:XXXXXXX”。</span><br><span class="line">server_names 为一个或多个服务器的列表，0.5.33版本以后可以在名称</span><br><span class="line">中使用“*”通配符。</span><br></pre></td></tr></table></figure>

<h3 id="主配置文件"><a href="#主配置文件" class="headerlink" title="主配置文件"></a>主配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> #user root;</span><br><span class="line"></span><br><span class="line">worker_processes 2;</span><br><span class="line">worker_cpu_affinity 0001 0010;</span><br><span class="line">worker_rlimit_nofile 102400;</span><br><span class="line">error_log /home/sc_nginx/logs/errorlog/main-error.log;</span><br><span class="line">error_log /home/sc_nginx/logs/errorlog/main-error.log</span><br><span class="line">notice;</span><br><span class="line">error_log /home/sc_nginx/logs/errorlog/main-error.log</span><br><span class="line">info;</span><br><span class="line">pid /home/sc_nginx/logs/nginx.pid;</span><br><span class="line">events &#123;</span><br><span class="line">use epoll;</span><br><span class="line">worker_connections 102400;</span><br><span class="line">accept_mutex on;</span><br><span class="line">multi_accept on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">include mime.types;</span><br><span class="line">default_type application/octet-stream;</span><br><span class="line">sendfile on;</span><br><span class="line">keepalive_timeout 60 75;</span><br><span class="line">keepalive_requests 1000;</span><br><span class="line">server_tokens off;</span><br><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">default upgrade;</span><br><span class="line">&apos;&apos; close;</span><br><span class="line">&#125;</span><br><span class="line">log_format main &apos;$remote_addr - $remote_user</span><br><span class="line">[$time_local] &quot;$request&quot; &apos;</span><br><span class="line">&apos;$status $body_bytes_sent</span><br><span class="line">&quot;$http_referer&quot; &apos;</span><br><span class="line">&apos;&quot;$http_user_agent&quot;</span><br><span class="line">$http_x_forwarded_for&apos;;</span><br><span class="line">log_format main_json</span><br><span class="line">&apos;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&apos;</span><br><span class="line">&apos;&quot;host&quot;:&quot;$server_addr&quot;,&apos;</span><br><span class="line">&apos;&quot;clientip&quot;:&quot;$remote_addr&quot;,&apos;</span><br><span class="line">&apos;&quot;size&quot;:$body_bytes_sent,&apos;</span><br><span class="line">&apos;&quot;responsetime&quot;:$request_time,&apos;</span><br><span class="line">&apos;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&apos;</span><br><span class="line">&apos;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&apos;</span><br><span class="line">&apos;&quot;http_host&quot;:&quot;$host&quot;,&apos;</span><br><span class="line">&apos;&quot;url&quot;:&quot;$uri&quot;,&apos;</span><br><span class="line">&apos;&quot;domain&quot;:&quot;$host&quot;,&apos;</span><br><span class="line">&apos;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&apos;</span><br><span class="line">&apos;&quot;referer&quot;:&quot;$http_referer&quot;,&apos;</span><br><span class="line">&apos;&quot;agent&quot;:&quot;$http_user_agent&quot;,&apos;</span><br><span class="line">&apos;&quot;status&quot;:&quot;$status&quot;&#125;&apos;;</span><br><span class="line">gzip on;</span><br><span class="line">gzip_min_length 1k;</span><br><span class="line">gzip_buffers 4 16k;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_comp_level 2;</span><br><span class="line">gzip_types text/plain application/javascript</span><br><span class="line">application/x-javascript text/javascript text/css</span><br><span class="line">application/xml application/xml+rss;</span><br><span class="line">gzip_vary on;</span><br><span class="line">gzip_proxied expired no-cache no-store private</span><br><span class="line">auth;</span><br><span class="line">gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br><span class="line"></span><br><span class="line">upstream new_shop_ant &#123; #新商城前端</span><br><span class="line">server 127.0.0.1:8080;</span><br><span class="line">server 127.0.0.1:9080 backup;</span><br><span class="line">&#125;</span><br><span class="line">upstream new_shop &#123; #新商城管理</span><br><span class="line">端</span><br><span class="line">server 127.0.0.1:8081;</span><br><span class="line">server 127.0.0.1:9081 backup;</span><br><span class="line">&#125;</span><br><span class="line">upstream wechat &#123; #微信对接</span><br><span class="line">server 192.168.101.59:6705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">server 192.168.101.61:6705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">upstream open &#123; #开放平台</span><br><span class="line">server 192.168.101.59:7705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">server 192.168.101.61:7705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">upstream ew &#123; #交易平台</span><br><span class="line">server 192.168.101.59:8705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">server 192.168.101.61:8705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">upstream vmims &#123; #商户管理端</span><br><span class="line">server 192.168.101.59:9705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">server 192.168.101.61:9705 max_fails=4</span><br><span class="line">fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">include conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="websocket配置"><a href="#websocket配置" class="headerlink" title="websocket配置"></a>websocket配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">default upgrade;</span><br><span class="line">&apos;&apos; close;</span><br><span class="line">&#125;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line"></span><br><span class="line">子配置文件</span><br></pre></td></tr></table></figure>

<h3 id="①shop-新商城前端展示和后台管理"><a href="#①shop-新商城前端展示和后台管理" class="headerlink" title="①shop(新商城前端展示和后台管理)"></a>①shop(新商城前端展示和后台管理)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name mall.eguagua.cn;</span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/mall_access.log main;</span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/mall_error.log ;</span><br><span class="line">client_header_timeout 120s; #调大点</span><br><span class="line">client_body_timeout 120s; #调大点</span><br><span class="line">client_max_body_size 100m; #主要是这个参</span><br><span class="line">数，限制了上传文件大大小</span><br><span class="line">client_body_buffer_size 256k;</span><br><span class="line">location = /MP_verify_hhvX6XfZQCOwWWpf.txt &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">proxy_pass http://new_shop_ant;</span><br><span class="line">&#125;</span><br><span class="line">location /coalition-admin-api &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://new_shop;</span><br><span class="line">&#125;</span><br><span class="line">location ~* .*\.(css|js)$ &#123;</span><br><span class="line">expires 7d;</span><br><span class="line">log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">proxy_pass http://new_shop_ant;</span><br><span class="line">&#125;</span><br><span class="line">location ~* .*\.(jpg|jpeg|gif|png|ico|pdf|txt)$</span><br><span class="line">&#123;</span><br><span class="line">expires 7d;</span><br><span class="line">log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">proxy_pass http://new_shop_ant;</span><br><span class="line">&#125;</span><br><span class="line">location ~ /coalition-admin-api/.*\.(css|js)$ &#123;</span><br><span class="line">expires 7d;</span><br><span class="line">log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">proxy_pass http://new_shop;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="②ew-交易中心"><a href="#②ew-交易中心" class="headerlink" title="②ew(交易中心)"></a>②ew(交易中心)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name egege.eguagua.cn;</span><br><span class="line"></span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/egege_access.log main;</span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/egege_error.log ;</span><br><span class="line">location = /wifi_welcome.html &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line">location = /MP_verify_hhvX6XfZQCOwWWpf.txt &#123;</span><br><span class="line">root html;</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://ew;</span><br><span class="line"></span><br><span class="line">#try_files $uri /weihu.html;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">location /test/ &#123;</span><br><span class="line">proxy_set_header Host $http_host;</span><br><span class="line"></span><br><span class="line">#proxy_pass http://127.0.0.1:9305/;</span><br><span class="line"></span><br><span class="line">proxy_pass http://10.168.171.105:1994/;</span><br><span class="line">proxy_redirect default;</span><br><span class="line">#try_files $uri /weihu.html;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="③open-开放平台"><a href="#③open-开放平台" class="headerlink" title="③open(开放平台)"></a>③open(开放平台)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name open.eguagua.cn;</span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/open_access.log main;</span><br><span class="line"></span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/open_error.log ;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://open;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="④vmims-商户管理端"><a href="#④vmims-商户管理端" class="headerlink" title="④vmims(商户管理端)"></a>④vmims(商户管理端)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name vmims.eguagua.cn;</span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/vmims_access.log main;</span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/vmims_error.log ;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://vmims;</span><br><span class="line">&#125;</span><br><span class="line">location /ws/ &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line"></span><br><span class="line">⑤wechat(微信调试)</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://vmims/ws/;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="⑤wechat-微信调试"><a href="#⑤wechat-微信调试" class="headerlink" title="⑤wechat(微信调试)"></a>⑤wechat(微信调试)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 1080;</span><br><span class="line">server_name wechat.eguagua.cn;</span><br><span class="line">access_log</span><br><span class="line">/home/sc_nginx/logs/accesslog/wechat_access.log main;</span><br><span class="line">error_log</span><br><span class="line">/home/sc_nginx/logs/errorlog/wechat_error.log ;</span><br><span class="line">if ( $host = wechat.eguagua.cn ) &#123;</span><br><span class="line">rewrite</span><br><span class="line">^/test/egege/hatch_selector/wechatAuth</span><br><span class="line">http://egege.eguagua.cn/egege/hatch_selector/wechatAuth</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_connect_timeout 10s;</span><br><span class="line">proxy_send_timeout 55s;</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">proxy_pass_request_body on;</span><br><span class="line">proxy_pass_request_headers on;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For</span><br><span class="line">$proxy_add_x_forwarded_for;</span><br><span class="line">proxy_pass http://wechat;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、内核参数调优"><a href="#二、内核参数调优" class="headerlink" title="二、内核参数调优"></a>二、内核参数调优</h2><h3 id="1-选项参数"><a href="#1-选项参数" class="headerlink" title="1.选项参数"></a>1.选项参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">fs.file-max = 204800 # 这个参数表示进程（比如一个</span><br><span class="line">worker进程）可以同时打开的最大句柄数，这个参数直线限制最大并发连接</span><br><span class="line">数，需根据实际情况配置。</span><br><span class="line">fs.nr_open = 204800 # nr_open定义是单进程最大</span><br><span class="line">file-handles，file-handles（即文件句柄）</span><br><span class="line">net.ipv4.tcp_syncookies = 1 # 开启SYN</span><br><span class="line">Cookies，当出现SYN等待队列溢出时，启用cookies来处理。</span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line">kernel.shmmax = 68719476736</span><br><span class="line">kernel.shmall = 4294967296</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 3500 # 这个参数表示操作系统允</span><br><span class="line">许TIME_WAIT套接字数量的最大值，如果超过这个数字，TIME_WAIT套接字</span><br><span class="line">将立刻被清除并打印警告信息。该参数默认为180000，过多的TIME_WAIT套</span><br><span class="line">接字会使Web服务器变慢。</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line">net.ipv4.tcp_rmem = 10240 87380 12582912 # 这个参数定义了</span><br><span class="line">TCP接受缓存（用于TCP接受滑动窗口）的最小值、默认值、最大值。</span><br><span class="line">net.ipv4.tcp_wmem = 10240 87380 12582912 # 这个参数定义了</span><br><span class="line">TCP发送缓存（用于TCP发送滑动窗口）的最小值、默认值、最大值。</span><br><span class="line">net.core.wmem_default = 8388608 # 这个参数表示内核套接字接受</span><br><span class="line">缓存区默认的大小。</span><br><span class="line">net.core.rmem_default = 8388608 # 这个参数表示内核套接字发送</span><br><span class="line">缓存区默认的大小。</span><br><span class="line">net.core.rmem_max = 16777216 # 这个参数表示内核套接字接受</span><br><span class="line">缓存区的最大大小。</span><br><span class="line">net.core.wmem_max = 16777216 # 这个参数表示内核套接字发送</span><br><span class="line">缓存区的最大大小。</span><br><span class="line">net.core.netdev_max_backlog = 262144 # 每个网络接口接收数</span><br><span class="line">据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数</span><br><span class="line">目。</span><br><span class="line">net.core.somaxconn = 40960 # web 应用中</span><br><span class="line">listen 函数的 backlog 默认会给我们内核参数的</span><br><span class="line">net.core.somaxconn 限制到128，而nginx定义的</span><br><span class="line">NGX_LISTEN_BACKLOG 默认为511，所以有必要调整这个值。</span><br></pre></td></tr></table></figure>

<h3 id="注：对于一个TCP连接，Server与Client需要通过三次握手来建立网络"><a href="#注：对于一个TCP连接，Server与Client需要通过三次握手来建立网络" class="headerlink" title="注：对于一个TCP连接，Server与Client需要通过三次握手来建立网络"></a>注：对于一个TCP连接，Server与Client需要通过三次握手来建立网络</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">连接.当三次握手成功后,我们可以看到端口的状态由LISTEN转变为</span><br><span class="line">ESTABLISHED,接着这条链路上就可以开始传送数据了.每一个处于监听</span><br><span class="line">(Listen)状态的端口,都有自己的监听队列.监听队列的长度与如</span><br><span class="line">somaxconn参数和使用该端口的程序中listen()函数有关</span><br><span class="line"></span><br><span class="line"># somaxconn参数:定义了系统中每一个端口最大的监听队列的长度,这是个</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">全局的参数,默认值为128，对于一个经常处理新连接的高负载 web服务环境</span><br><span class="line">来说，默认的 128 太小了。大多数环境这个值建议增加到 1024 或者更</span><br><span class="line">多。大的侦听队列对防止拒绝服务 DoS 攻击也会有所帮助。</span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800 # 系统中最多有多少个TCP</span><br><span class="line">套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤儿连接将</span><br><span class="line">即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单的DoS攻击，不</span><br><span class="line">能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之</span><br><span class="line">后)。</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144 # 这个参数标示TCP三次</span><br><span class="line">握手建立阶段接受SYN请求队列的最大长度，默认为1024，将其设置得大一</span><br><span class="line">些可以使出现Nginx繁忙来不及accept新连接的情况时，Linux不至于丢失</span><br><span class="line">客户端发起的连接请求。</span><br><span class="line">net.ipv4.tcp_timestamps = 0 # 时间戳可以避免序列</span><br><span class="line">号的卷绕。一个1Gbps的链路肯定会遇到以前用过的序列号。时间戳能够让内</span><br><span class="line">核接受这种“异常”的数据包。</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144 # 记录的那些尚未收到</span><br><span class="line">客户端确认信息的连接请求的最大值。对于有128M内存的系统而言，缺省值</span><br><span class="line">是1024，小内存的系统则是128。</span><br><span class="line">net.ipv4.tcp_synack_retries = 1 # 为了打开对端的连</span><br><span class="line">接，内核需要发送一个SYN并附带一个回应前面一个SYN的ACK。也就是所谓</span><br><span class="line">三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送SYN+ACK</span><br><span class="line">包的数量。</span><br><span class="line">net.ipv4.tcp_syn_retries = 1 # 在内核放弃建立连接</span><br><span class="line">之前发送SYN包的数量。</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1 # 启用timewait快速回</span><br><span class="line">收。</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1 # 开启重用。允许将</span><br><span class="line">TIME-WAIT sockets重新用于新的TCP连接。这对于服务器来说很有意义，</span><br><span class="line">因为服务器上总会有大量TIME-WAIT状态的连接。</span><br><span class="line">net.ipv4.tcp_mem = 94500000 915000000 927000000</span><br><span class="line">net.ipv4.tcp_fin_timeout = 1 # 如果套接字由本端要</span><br><span class="line">求关闭，这个参数 决定了它保持在FIN-WAIT-2状态的时间。对端可以出错</span><br><span class="line">并永远不关闭连接，甚至意外当机。缺省值是60秒。2.2 内核的通常值是</span><br><span class="line">180秒，你可以按这个设置，但要记住的是，即使你的机器是一个轻载的WEB</span><br><span class="line">服务器，也有因为大量的死套接字而内存溢出的风险，FIN- WAIT-2的危险</span><br><span class="line">性比FIN-WAIT-1要小，因为它最多只能吃掉1.5K内存，但是它们的生存期</span><br><span class="line">长些。</span><br><span class="line">net.ipv4.tcp_keepalive_time = 30 # 这个参数表示当</span><br><span class="line">keepalive启用时，TCP发送keepalive消息的频度。默认是2小时，若将</span><br><span class="line">其设置的小一些，可以更快地清理无效的连接。</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3 # 果对方不予应答，探</span><br><span class="line">测包的发送次数</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 15 # keepalive探测包</span><br><span class="line">的发送间隔</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65535 # 允许系统打开</span><br><span class="line">的端口范围。</span><br><span class="line">net.ipv4.tcp_sack = 1 # 启用有选择的应答</span><br><span class="line">（Selective Acknowledgment），这可以通过有选择地应答乱序接收到</span><br><span class="line">的报文来提高性能（这样可以让发送者只发送丢失的报文段）；（对于广域网</span><br><span class="line">通信来说）这个选项应该启用，但是这会增加对 CPU 的占用。</span><br><span class="line">net.ipv4.tcp_slow_start_after_idle = 0 # 关闭tcp的连接传输</span><br><span class="line">的慢启动，即先休止一段时间，再初始化拥塞窗口。</span><br><span class="line">net.ipv4.icmp_echo_ignore_broadcasts = 1 # 避免放大攻击，拒</span><br><span class="line">绝ping</span><br><span class="line">net.ipv4.icmp_ignore_bogus_error_responses = 1 # 开启恶意</span><br><span class="line">icmp错误消息保护</span><br><span class="line"></span><br><span class="line">net.inet.udp.checksum=1 # 防止不正确的udp</span><br><span class="line">包的攻击</span><br><span class="line"></span><br><span class="line">关于timewait快速回收</span><br><span class="line"></span><br><span class="line">不要轻易打开</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1 # 启用timewait快速回</span><br><span class="line">收。</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_tw_recycle = 0</span><br><span class="line">实际上，net.ipv4.tcp_tw_recycle功能的开启，要需要</span><br><span class="line">net.ipv4.tcp_timestamps（一般系统默认是开启这个功能的）这个开关</span><br><span class="line">开启后才有效果；</span><br><span class="line">当tcp_tw_recycle 开启时（tcp_timestamps 同时开启，快速回收</span><br><span class="line">socket 的效果达到），对于位于NAT设备后面的 Client来说，是一场灾</span><br><span class="line">难！</span><br><span class="line">会导致到NAT设备后面的Client连接Server不稳定（有的 Client 能连接</span><br><span class="line">server，有的 Client 不能连接 server）。</span><br><span class="line">也就是说，tcp_tw_recycle这个功能，是为内部网络（网络环境自己可控 ”</span><br><span class="line">——不存在NAT 的情况）设计的，对于公网环境下，不宜使用。</span><br><span class="line">通常来说，回收TIME_WAIT状态的socket是因为“无法主动连接远端”，因为</span><br><span class="line">无可用的端口，而不应该是要回收内存（没有必要）。</span><br><span class="line">即：需求是Client的需求，Server会有“端口不够用”的问题吗？</span><br><span class="line">除非是前端机，需要大量的连接后端服务，也就是充当着Client的角色。</span><br><span class="line">正确的解决这个总是办法应该是：</span><br><span class="line">net.ipv4.ip_local_port_range = 9000 6553 #默认值范围较小</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 10000 #默认值较小，还可适当调小</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 10</span><br></pre></td></tr></table></figure>

<h3 id="2-方案"><a href="#2-方案" class="headerlink" title="2.方案"></a>2.方案</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">fs.file-max = 204800</span><br><span class="line">fs.nr_open = 204800</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 25600</span><br><span class="line">net.core.netdev_max_backlog = 262144</span><br><span class="line">net.core.rmem_default=262144 # 接收套接字缓冲区大小的默认值</span><br><span class="line">net.core.wmem_default=262144 # 发送套接字缓冲区大小的默认值</span><br><span class="line">net.core.rmem_max=16777216 # 接收套接字缓冲区大小的最大值</span><br><span class="line">net.core.wmem_max=16777216 # 发送套接字缓冲区大小的最大值</span><br><span class="line">net.core.optmem_max=16777216 # socket buffer的最大初始化</span><br><span class="line">值,默认10K</span><br><span class="line">net.core.somaxconn = 40960</span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144</span><br><span class="line">net.ipv4.tcp_timestamps = 0 # 选择不开启</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 0 # 选择不开启</span><br><span class="line">net.ipv4.tcp_tw_reuse = 0 # 选择不开启</span><br><span class="line">net.ipv4.tcp_fin_timeout = 15</span><br><span class="line">net.ipv4.tcp_keepalive_time = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 15</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65535</span><br><span class="line">net.ipv4.tcp_sack = 1 # 谨慎开启</span><br><span class="line">net.ipv4.tcp_slow_start_after_idle = 0</span><br><span class="line">net.ipv4.icmp_echo_ignore_broadcasts = 0 # 选择不开启，允许</span><br><span class="line">ping</span><br><span class="line">net.ipv4.icmp_ignore_bogus_error_responses = 1</span><br><span class="line">net.inet.udp.checksum=1</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/08/Openresty/">
  Openresty
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/08/Openresty/"><span class="article-date">
  2019-08-08
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Openresty/">Openresty</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Openresty/centos/">centos</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Openresty/">Openresty</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="Openresty"><a href="#Openresty" class="headerlink" title="Openresty"></a>Openresty</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p> [隐藏] </p>
<ul>
<li>[1安装依赖]</li>
<li>[2编译安装]</li>
<li>[3systemd启动脚本]</li>
<li>[4默认nginx.conf配置]</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install pcre-devel zlib-devel</span><br></pre></td></tr></table></figure>

<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https://openresty.org/download/openresty-1.13.6.2.tar.gz</span><br><span class="line">tar -xzf openresty-1.13.6.2.tar.gz</span><br><span class="line">cd openresty-1.13.6.2</span><br><span class="line">./configure \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--prefix=/data/soft/openresty</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="systemd启动脚本"><a href="#systemd启动脚本" class="headerlink" title="systemd启动脚本"></a>systemd启动脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /lib/systemd/system/openresty.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=The OpenResty HTTP and reverse proxy server</span><br><span class="line">After=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/data/soft/openresty/nginx/logs/openresty.pid</span><br><span class="line">ExecStartPre=/data/soft/openresty/nginx/sbin/nginx -t</span><br><span class="line">ExecStart=/data/soft/openresty/nginx/sbin/nginx</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">ExecStop=/bin/kill -s QUIT $MAINPID</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod u+x /lib/systemd/system/openresty.service</span><br><span class="line"></span><br><span class="line">systemctl enable openresty.service</span><br><span class="line">systemctl start openresty.service</span><br></pre></td></tr></table></figure>

<h2 id="默认nginx-conf配置"><a href="#默认nginx-conf配置" class="headerlink" title="默认nginx.conf配置"></a>默认nginx.conf配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">user  www;</span><br><span class="line">worker_processes  4;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  102400;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">    include vhosts/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/08/PHP7.2/">
  PHP
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/08/PHP7.2/"><span class="article-date">
  2019-08-08
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/PHP/">PHP</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/PHP/centos/">centos</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="PHP7-2"><a href="#PHP7-2" class="headerlink" title="PHP7.2"></a>PHP7.2</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p> [隐藏] </p>
<ul>
<li>[1安装依赖]</li>
<li>[2编译安装]</li>
<li>[3systemd启动脚本]</li>
<li>[4php-memcached]</li>
<li>[5php-apcu]</li>
<li>[6php-swoole]</li>
<li>[7php-redis]</li>
<li>[8php-yaf]</li>
<li>[9php-imagick]</li>
<li>[10默认php-fpm.conf配置]</li>
</ul>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y libxml2-devel openssl-devel curl-devel libjpeg-turbo-devel libpng-devel gd freetype-devel libicu-devel gcc-c++ autoconf zlib-devel autoconf libmemcached-devel mariadb-devel ImageMagick-devel</span><br></pre></td></tr></table></figure>

<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">wget http://cn2.php.net/distributions/php-7.2.12.tar.bz2</span><br><span class="line">tar -xjf php-7.2.12.tar.bz2</span><br><span class="line">cd php-7.2.12/</span><br><span class="line"></span><br><span class="line">./configure \</span><br><span class="line">--prefix=/data/soft/php7 \</span><br><span class="line">--enable-fpm \</span><br><span class="line">--sysconfdir=/data/soft/php7/etc/ \</span><br><span class="line">--with-config-file-path=/data/soft/php7/etc/ \</span><br><span class="line">--enable-shared \</span><br><span class="line">--with-libxml-dir \</span><br><span class="line">--with-gd \</span><br><span class="line">--with-openssl \</span><br><span class="line">--enable-mbstring \</span><br><span class="line">--with-mysqli=/usr/bin/mysql_config \</span><br><span class="line">--enable-zip \</span><br><span class="line">--enable-intl \</span><br><span class="line">--with-zlib-dir \</span><br><span class="line">--with-pdo-mysql \</span><br><span class="line">--with-jpeg-dir \</span><br><span class="line">--with-freetype-dir \</span><br><span class="line">--with-curl \</span><br><span class="line">--without-pdo-sqlite \</span><br><span class="line">--without-sqlite3</span><br><span class="line"></span><br><span class="line">make -j4</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">rm -rf /data/soft/php7/etc/php-fpm.d/</span><br></pre></td></tr></table></figure>

<h2 id="systemd启动脚本"><a href="#systemd启动脚本" class="headerlink" title="systemd启动脚本"></a>systemd启动脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /lib/systemd/system/php7.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=The NGINX HTTP and reverse proxy server</span><br><span class="line">After=syslog.target network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/data/soft/php7/var/run/php-fpm.pid</span><br><span class="line">ExecStart=/data/soft/php7/sbin/php-fpm</span><br><span class="line">ExecReload=/bin/kill -s USR2 \$MAINPID</span><br><span class="line">ExecStop=/bin/kill -s QUIT \$MAINPID</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod u+x /lib/systemd/system/php7.service</span><br><span class="line"></span><br><span class="line">systemctl enable php7.service</span><br></pre></td></tr></table></figure>

<h2 id="php-memcached"><a href="#php-memcached" class="headerlink" title="php-memcached"></a>php-memcached</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http://pecl.php.net/get/memcached-3.0.4.tgz</span><br><span class="line">tar -xzf memcached-3.0.4.tgz</span><br><span class="line">cd memcached-3.0.4</span><br><span class="line">/data/soft/php7/bin/phpize</span><br><span class="line">./configure --with-php-config=/data/soft/php7/bin/php-config  --with-libmemcached-dir=/usr</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="php-apcu"><a href="#php-apcu" class="headerlink" title="php-apcu"></a>php-apcu</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://pecl.php.net/get/apcu-5.1.14.tgz</span><br><span class="line">tar -xzf apcu-5.1.14.tgz</span><br><span class="line">cd apcu-5.1.14</span><br><span class="line">/data/soft/php7/bin/phpize</span><br><span class="line">./configure --with-php-config=/data/soft/php7/bin/php-config</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="php-swoole"><a href="#php-swoole" class="headerlink" title="php-swoole"></a>php-swoole</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/swoole/swoole-src/archive/v4.2.5.tar.gz</span><br><span class="line">tar -xzf v4.2.5.tar.gz</span><br><span class="line">cd swoole-src-4.2.5</span><br><span class="line">/data/soft/php7/bin/phpize</span><br><span class="line">./configure --with-php-config=/data/soft/php7/bin/php-config</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="php-redis"><a href="#php-redis" class="headerlink" title="php-redis"></a>php-redis</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/phpredis/phpredis/archive/4.2.0.tar.gz</span><br><span class="line">tar -xzf 4.2.0.tar.gz</span><br><span class="line">cd phpredis-4.2.0</span><br><span class="line">/data/soft/php7/bin/phpize</span><br><span class="line">./configure --with-php-config=/data/soft/php7/bin/php-config</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="php-yaf"><a href="#php-yaf" class="headerlink" title="php-yaf"></a>php-yaf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http://pecl.php.net/get/yaf-3.0.7.tgz</span><br><span class="line">tar -xzf yaf-3.0.7.tgz</span><br><span class="line">cd yaf-3.0.7</span><br><span class="line">/data/soft/php7/bin/phpize</span><br><span class="line">./configure --with-php-config=/data/soft/php7/bin/php-config</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="php-imagick"><a href="#php-imagick" class="headerlink" title="php-imagick"></a>php-imagick</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget http://pecl.php.net/get/imagick-3.4.3.tgz </span><br><span class="line">tar -xzf imagick-3.4.3.tgz</span><br><span class="line">cd imagick-3.4.3</span><br><span class="line">/data/soft/php7/bin/phpize</span><br><span class="line">./configure --with-php-config=/data/soft/php7/bin/php-config --with-imagick=/usr</span><br><span class="line">make -j4</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="默认php-fpm-conf配置"><a href="#默认php-fpm-conf配置" class="headerlink" title="默认php-fpm.conf配置"></a>默认php-fpm.conf配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">pid = run/php-fpm.pid</span><br><span class="line"></span><br><span class="line">;error_log = log/php-fpm.log</span><br><span class="line">;syslog.facility = daemon</span><br><span class="line">;syslog.ident = php-fpm</span><br><span class="line">;log_level = notice</span><br><span class="line">;emergency_restart_threshold = 0</span><br><span class="line">;emergency_restart_interval = 0</span><br><span class="line">;process_control_timeout = 0</span><br><span class="line">process.max = 0</span><br><span class="line">daemonize = yes</span><br><span class="line">;rlimit_files = 1024</span><br><span class="line">;rlimit_core = 0</span><br><span class="line">events.mechanism = epoll</span><br><span class="line">;systemd_interval = 10</span><br><span class="line"></span><br><span class="line">[www]</span><br><span class="line">;prefix = /path/to/pools/$pool</span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">;listen.backlog = 511</span><br><span class="line">;listen.owner = nobody</span><br><span class="line">;listen.group = nobody</span><br><span class="line">;listen.mode = 0660</span><br><span class="line">;listen.acl_users =</span><br><span class="line">;listen.acl_groups =</span><br><span class="line">;listen.allowed_clients = 127.0.0.1</span><br><span class="line">pm = static</span><br><span class="line">pm.max_children = 30</span><br><span class="line">pm.start_servers = 30</span><br><span class="line">;pm.process_idle_timeout = 10s;</span><br><span class="line">;pm.max_requests = 500</span><br><span class="line">;pm.status_path = /status</span><br><span class="line">;ping.path = /ping</span><br><span class="line">;ping.response = pong</span><br><span class="line">;access.log = log/$pool.access.log</span><br><span class="line">;access.format = &quot;%R - %u %t \&quot;%m %r%Q%q\&quot; %s %f %&#123;mili&#125;d %&#123;kilo&#125;M %C%%&quot;</span><br><span class="line">;slowlog = log/$pool.log.slow</span><br><span class="line">;request_slowlog_timeout = 0</span><br><span class="line">;request_slowlog_trace_depth = 20</span><br><span class="line">;request_terminate_timeout = 0</span><br><span class="line">;rlimit_files = 1024</span><br><span class="line">;rlimit_core = 0</span><br><span class="line">;chroot =</span><br><span class="line">;chdir = /var/www</span><br><span class="line">;catch_workers_output = yes</span><br><span class="line">;clear_env = no</span><br><span class="line">security.limit_extensions = .php .php7</span><br><span class="line">env[HOSTNAME] = $HOSTNAME</span><br><span class="line">env[PATH] = /usr/local/bin:/usr/bin:/bin</span><br><span class="line">env[TMP] = /data/tmp</span><br><span class="line">env[TMPDIR] = /data/tmp</span><br><span class="line">env[TEMP] = /data/tmp</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  



  <div class="pagination">
    <a class="extend prev" rel="prev" href="/archives/">Prev</a><a class="page-number" href="/archives/">1</a><span class="page-number current">2</span><a class="page-number" href="/archives/page/3/">3</a><a class="extend next" rel="next" href="/archives/page/3/">Next</a>
  </div>




          <div class="main-footer">
  
    © 2020 bibi - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </section></div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

</div></body>
</html>
