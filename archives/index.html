<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    Archive
  
</title>

<meta name="description" content="Testing website">
<meta property="og:type" content="website">
<meta property="og:title" content="bibi">
<meta property="og:url" content="http://yxbibi.com/archives/index.html">
<meta property="og:site_name" content="bibi">
<meta property="og:description" content="Testing website">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="bibi">
<meta name="twitter:description" content="Testing website">


  <link rel="alternative" href="/atom.xml" title="bibi" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">






</head>
<body class="monochrome">
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">bibi</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">bibi</a></h1>
    
    <div class="info">
      <div class="content">
        
          <div class="description">Testing website</div>
        
        
          <div class="author">Mode</div>
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://cn.gravatar.com/avatar/35fef74d731255cd569c2c2b0b9e87e4?s=200"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">Category</a>
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openresty/">Openresty</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zabbix/">Zabbix</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/centos/">centos</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/centos7/">centos7</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rsync/">rsync</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/text/">text</a><span class="category-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">Tag</a>
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNS服务器搭建/">DNS服务器搭建</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELK/">ELK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EMQ/">EMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Filebeat/">Filebeat</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JumpServer/">JumpServer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KONG/">KONG</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LVM/">LVM</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Memcached/">Memcached</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openresty/">Openresty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PXE-Kickstart-Cobbler/">PXE+Kickstart+Cobbler</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis3/">Redis3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rsync-inotify/">Rsync+inotify</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/">Zabbix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/app-install/">app install</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bibi/">bibi</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos7/">centos7</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ftp虚拟用户创建过程/">ftp虚拟用户创建过程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hello/">hello</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lvm/">lvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rsync/">rsync</a><span class="tag-list-count">1</span></li></ul>
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">Archive</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">30</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/niubiya/bibi" title="bibi" target="_blank" rel="noopener">bibi</a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/niubiya" title="niubiya" target="_blank" rel="noopener">niubiya</a>
              </li>
            
          
            
              <li>
                <a href="/atom.xml" title="RSS">RSS</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          

  
  
    
      
      
      <section class="archives-wrap">
        <div class="archive-year-wrap">
          <h1><a href="/archives/2019" class="archive-year">2019</a></h1>
        </div>
        <div class="post-list">
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/12/12/hello-world/">
  Hello World
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/12/12/hello-world/"><span class="article-date">
  2019-12-12
</span>
</a>
        

        

      </div>
      <div class="article-entry">
        
          <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/14/DNSmasq域名服务器搭建/">
  DNS服务器搭建
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/14/DNSmasq域名服务器搭建/"><span class="article-date">
  2019-08-14
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/DNS服务器搭建/">DNS服务器搭建</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DNS服务器搭建/">DNS服务器搭建</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="DNS服务器搭建"><a href="#DNS服务器搭建" class="headerlink" title="DNS服务器搭建"></a>DNS服务器搭建</h1><p>DNSmasq是一个小巧且方便地用于配置DNS和DHCP的工具，适用于小型网络。作为域名解析服务器(DNS)，dnsmasq可以通过<br>缓存DNS来提高对同一网址的访问速度。作为DHCP服务器，dnsmasq可以用于为局域网主机分配内网ip地址、提供路由功能。<br>DNS和DHCP两个功能可以同时或分别单独实现。dnsmasq轻量且易配置，适用于个人用户或少于50台主机的网络，更适用于虚<br>拟化和大数据环境的部署。此外它还自带了一个PXE服务器。</p>
<p>下载地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.thekelleys.org.uk/dnsmasq/</span><br></pre></td></tr></table></figure>

<h3 id="1-下载安装"><a href="#1-下载安装" class="headerlink" title="1.下载安装"></a>1.下载安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install dnsmasq</span><br></pre></td></tr></table></figure>

<h3 id="2-配置dnsmasq"><a href="#2-配置dnsmasq" class="headerlink" title="2.配置dnsmasq"></a>2.配置dnsmasq</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/dnsmasq.conf</span><br><span class="line">修改或添加下列内容：</span><br><span class="line">resolv-file=/etc/resolv.dnsmasq.conf</span><br><span class="line">strict-order</span><br><span class="line">listen-address=192.168.122.131,127.0.0.1</span><br><span class="line">addn-hosts=/etc/dnsmasq.hosts</span><br><span class="line">cache-size=100</span><br><span class="line">bogus-nxdomain=223.5.5.5</span><br><span class="line">log-queries</span><br><span class="line">log-facility=/var/log/dnsmasq.log</span><br></pre></td></tr></table></figure>

<p>开启dnsmasq日志切割</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/logrotate.d/dnsmasq &lt;&lt;-EOF</span><br><span class="line">/var/log/dnsmasq.log &#123;</span><br><span class="line">        daily</span><br><span class="line">        copytruncate</span><br><span class="line">        missingok</span><br><span class="line">        rotate 3</span><br><span class="line">        compress</span><br><span class="line">        notifyempty</span><br><span class="line">        dateext</span><br><span class="line">        size 30M</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="3-编辑-etc-resolv-dnsmasq-conf文件并添加上游DNS服务器地址"><a href="#3-编辑-etc-resolv-dnsmasq-conf文件并添加上游DNS服务器地址" class="headerlink" title="3.编辑/etc/resolv.dnsmasq.conf文件并添加上游DNS服务器地址"></a>3.编辑/etc/resolv.dnsmasq.conf文件并添加上游DNS服务器地址</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;nameserver 223.5.5.5&apos; &gt; /etc/resolv.dnsmasq.conf</span><br></pre></td></tr></table></figure>

<h3 id="4-创建dnsmasq-hosts文件"><a href="#4-创建dnsmasq-hosts文件" class="headerlink" title="4.创建dnsmasq.hosts文件"></a>4.创建dnsmasq.hosts文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/hosts /etc/dnsmasq.hosts</span><br></pre></td></tr></table></figure>

<h3 id="5-启动dnsmasq"><a href="#5-启动dnsmasq" class="headerlink" title="5.启动dnsmasq"></a>5.启动dnsmasq</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start dnsmasq</span><br><span class="line">systemctl enable dnsmasq</span><br></pre></td></tr></table></figure>

<h3 id="6-检测服务是否开启"><a href="#6-检测服务是否开启" class="headerlink" title="6.检测服务是否开启"></a>6.检测服务是否开启</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -tlunp | grep dnsmasq</span><br></pre></td></tr></table></figure>

<h2 id="dnsmasq性能优化"><a href="#dnsmasq性能优化" class="headerlink" title="dnsmasq性能优化"></a>dnsmasq性能优化</h2><p>我们都知道Bind不配合数据库的情况下，经常需要重新载入并读取配置文件，这是造成性能低下的原因。根据这点教训，我们可以考虑不读取/etc/hosts文件。而是另外指定一个在共享内存里的文件,如/dev/shm/dnsrecord.txt ，这样就不费劲了，又由于内存的非持久性，重启就消失，可以定期同步硬盘上的某个内容到内存文件中。</p>
<p>具体实现步骤如下：    </p>
<h3 id="a-配置dnsmasq"><a href="#a-配置dnsmasq" class="headerlink" title="a.配置dnsmasq"></a>a.配置dnsmasq</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/dnsmasq.conf </span><br><span class="line">no-hosts </span><br><span class="line">addn-hosts=/dev/shm/dnsrecord.txt</span><br></pre></td></tr></table></figure>

<h3 id="b-解决同步问题"><a href="#b-解决同步问题" class="headerlink" title="b.解决同步问题"></a>b.解决同步问题</h3><h1 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;cat /etc/hosts &gt; /dev/shm/dnsrecord.txt&quot; &gt;&gt; /etc/rc.local</span><br></pre></td></tr></table></figure>

<h1 id="定时同步内容"><a href="#定时同步内容" class="headerlink" title="定时同步内容"></a>定时同步内容</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;*/10 * * * * root /usr/bin/cat /etc/hosts &gt; /dev/shm/dnsrecord.txt&apos; &gt;&gt; /etc/crontab</span><br><span class="line">systemctl restart crond</span><br></pre></td></tr></table></figure>

<p>Dnsmasq选择最快的上游DNS服务器<br>​    经常会有这样的情景，Dnsmasq服务器配了一堆上游服务器，转发本地的dns请求，缺省是Dnsmasq事实上是只挑了一个上游dns服务器来查询并转发结果，这样如果选错服务器的话会导致DNS响应变慢。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/dnsmasq.conf</span><br><span class="line"></span><br><span class="line">all-servers  </span><br><span class="line">server=223.5.5.5</span><br><span class="line">server=114.114.114.114</span><br></pre></td></tr></table></figure>

<p>all-servers表示对以下设置的所有server发起查询，选择回应最快的一条作为查询结果返回。<br>上面设置了两个dns server，收到解析请求会同时查询这两个服务器，询问dns地址谁返回快就采用谁的结果。</p>
<p>技术参考：<br><a href="https://www.hi-linux.com/posts/30947.html" target="_blank" rel="noopener">https://www.hi-linux.com/posts/30947.html</a><br><a href="https://www.cnblogs.com/wclwcw/p/8806256.html" target="_blank" rel="noopener">https://www.cnblogs.com/wclwcw/p/8806256.html</a></p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/14/PXE+Kickstart+Cobbler/">
  PXE+Kickstart+Cobbler
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/14/PXE+Kickstart+Cobbler/"><span class="article-date">
  2019-08-14
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/PXE-Kickstart-Cobbler/">PXE+Kickstart+Cobbler</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PXE-Kickstart-Cobbler/">PXE+Kickstart+Cobbler</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="搭建PXE-Kickstart-Cobbler无人值守安装"><a href="#搭建PXE-Kickstart-Cobbler无人值守安装" class="headerlink" title="搭建PXE+Kickstart+Cobbler无人值守安装"></a>搭建PXE+Kickstart+Cobbler无人值守安装</h1><p>导读：新来一批机器，需要批量安装系统，搭建一台PXE系统，实现无人主值守安装，方便系统的快速部署。<br>建议：使用虚拟机的话，使用两块网卡，一块设置为NAT模式用于安装软件包，一块设置为仅主机模式，用于DHCP服务用。</p>
<ol>
<li><h3 id="关闭防火墙和selinux"><a href="#关闭防火墙和selinux" class="headerlink" title="关闭防火墙和selinux"></a>关闭防火墙和selinux</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">sed -ri &apos;/^SELINUX=/c SELINUX=disabled&apos; /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install kernel-devel</span><br><span class="line">yum -y install dhcp tftp-server vsftpd xinetd syslinux</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>注：<br>a. syslinux提供pxelinux.0文件<br>b. dhcp为客户机分配IP地址<br>c. xinetd为tftp的超级守护进程<br>d. tftp简单文件传输协议</p>
<ol start="3">
<li><h3 id="挂在光驱"><a href="#挂在光驱" class="headerlink" title="挂在光驱"></a>挂在光驱</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/ftp/centos7</span><br><span class="line">mount /dev/sr0 /var/ftp/centos7</span><br></pre></td></tr></table></figure>

<p>启动vsftpd</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start vsftpd</span><br><span class="line">systemctl enable vsftpd</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><h3 id="配置DHCP"><a href="#配置DHCP" class="headerlink" title="配置DHCP"></a>配置DHCP</h3><p>注意：虚拟机网卡需要取消DHCP服务，而是使用本地安装的DHCP服务</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/dhcp/dhcpd.conf</span><br><span class="line">subnet 192.168.100.0 netmask 255.255.255.0 &#123;</span><br><span class="line">    range 192.168.100.128 192.168.100.254;</span><br><span class="line">    next-server 192.168.100.100;</span><br><span class="line">    filename &quot;pxelinux.0&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable dhcpd</span><br><span class="line">systemctl restart dhcpd</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><h3 id="配置tftp-server"><a href="#配置tftp-server" class="headerlink" title="配置tftp-server"></a>配置tftp-server</h3></li>
</ol>
<p>添加初始启动文件pxelinux.0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/</span><br></pre></td></tr></table></figure>

<p>提供引导菜单所需的文件(从Centos7光盘上的isolinux目录下复制)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp -rf /var/ftp/centos7/isolinux/* /var/lib/tftpboot/</span><br><span class="line">cd /var/lib/tftpboot/</span><br><span class="line">mkdir pxelinux.cfg</span><br><span class="line">cp isolinux.cfg pxelinux.cfg/default</span><br></pre></td></tr></table></figure>

<p>编辑菜单启动项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim pxelinux.cfg/default</span><br><span class="line">label linux</span><br><span class="line">    menu label ^Install centos 7</span><br><span class="line">    kernel vmlinuz</span><br><span class="line">    append initrd=initrd.img  inst.stage2=ftp://192.168.100.100/centos7 inst.repo=ftp://192.168.100.100/centos7</span><br></pre></td></tr></table></figure>

<p>启动超级守护进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &apos;/disable/&#123;s/yes/no/g&#125;&apos; /etc/xinetd.d/tftp</span><br><span class="line">systemctl enable xinetd</span><br><span class="line">systemctl restart xinetd</span><br><span class="line"></span><br><span class="line">ss -anput |egrep &apos;21|67|69&apos;</span><br></pre></td></tr></table></figure>

<p>注意：安装客户机时，最好给客户机分配2G左右的内存</p>
<p>====================================================================================</p>
<h2 id="Kickstart实现自动化安装"><a href="#Kickstart实现自动化安装" class="headerlink" title="Kickstart实现自动化安装"></a>Kickstart实现自动化安装</h2><p>1.kickstart自动化安装脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">vim /var/ftp/centos7u4-ks.cfg</span><br><span class="line">#version=DEVEL</span><br><span class="line"></span><br><span class="line"># System authorization information</span><br><span class="line"></span><br><span class="line">auth --enableshadow --passalgo=sha512</span><br><span class="line">firstboot --enable</span><br><span class="line"></span><br><span class="line"># Install OS instead of upgrade</span><br><span class="line"></span><br><span class="line">install</span><br><span class="line"></span><br><span class="line"># Run the Setup Agent on first boot</span><br><span class="line"></span><br><span class="line">firstboot --enable</span><br><span class="line">ignoredisk --only-use=sda</span><br><span class="line"></span><br><span class="line"># Keyboard layouts</span><br><span class="line"></span><br><span class="line">keyboard --vckeymap=us --xlayouts=&apos;us&apos;</span><br><span class="line"></span><br><span class="line"># System language</span><br><span class="line"></span><br><span class="line">lang en_US.UTF-8</span><br><span class="line"></span><br><span class="line"># Network information</span><br><span class="line"></span><br><span class="line">network  --bootproto=dhcp --device=ens33 --onboot=on</span><br><span class="line">network  --hostname=localhost.localdomain</span><br><span class="line"></span><br><span class="line"># Use network installation</span><br><span class="line"></span><br><span class="line">url --url=&quot;ftp://192.168.100.100/centos7&quot;  </span><br><span class="line"></span><br><span class="line"># Root password</span><br><span class="line"></span><br><span class="line">rootpw --iscrypted $6$EJ65iFvZvzoW7C3g$pBxA6FB1eQ2mTRE0WK7ClyQkBqc9IpZ9FulHWukSLfj7in4gYrLwKvJ3vE/EqYWsIcRNPyA.IHBg2YZYO5pqe0</span><br><span class="line"></span><br><span class="line"># System services</span><br><span class="line"></span><br><span class="line">services --disabled=&quot;chronyd&quot;</span><br><span class="line"></span><br><span class="line"># System timezone</span><br><span class="line"></span><br><span class="line">timezone Asia/Shanghai</span><br><span class="line"></span><br><span class="line"># System bootloader configuration</span><br><span class="line"></span><br><span class="line">bootloader --location=mbr --boot-drive=sda</span><br><span class="line">autopart --type=lvm</span><br><span class="line"></span><br><span class="line"># Partition clearing information</span><br><span class="line"></span><br><span class="line">clearpart --none --initlabel</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">@^minimal</span><br><span class="line">@compat-libraries</span><br><span class="line">@core</span><br><span class="line">@debugging</span><br><span class="line">@development</span><br><span class="line">@security-tools</span><br><span class="line">@smart-card</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%addon com_redhat_kdump --disable --reserve-mb=&apos;auto&apos;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%anaconda</span><br><span class="line">pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class="line">pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok</span><br><span class="line">pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h3 id="添加启动项"><a href="#添加启动项" class="headerlink" title="添加启动项"></a>添加启动项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/tftpboot/pxelinux.cfg/default</span><br><span class="line">最后一行添加：</span><br><span class="line">label linux</span><br><span class="line">    menu label ^Install centos 7</span><br><span class="line">    kernel vmlinuz</span><br><span class="line">    append initrd=initrd.img  inst.stage2=ftp://192.168.100.100/centos7 inst.repo=ftp://192.168.100.100/centos7 inst.ks=ftp://192.168.100.100/centos7u4-ks.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart xinetd</span><br></pre></td></tr></table></figure>

<p>=======================================================================================</p>
<h2 id="cobbler安装配置"><a href="#cobbler安装配置" class="headerlink" title="cobbler安装配置"></a>cobbler安装配置</h2><ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cobbler安装</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install cobbler cobbler-web httpd</span><br><span class="line">systemctl start httpd cobblerd</span><br><span class="line">systemctl enable httpd cobblerd</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置cobbler</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. sed -ri &apos;/^allow_dynamic_settings:.*$/&#123;s/0/1/g&#125;&apos; /etc/cobbler/settings</span><br><span class="line"></span><br><span class="line">cobbler setting edit --name=server --value=192.168.100.100</span><br><span class="line">cobbler setting edit --name=next_server --value=192.168.100.100</span><br><span class="line">cobbler get-loaders</span><br><span class="line">systemctl start rsyncd</span><br></pre></td></tr></table></figure>

</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable rsyncd</span><br><span class="line">yum -y install pykickstart</span><br></pre></td></tr></table></figure>

<h1 id="设置模板密码"><a href="#设置模板密码" class="headerlink" title="设置模板密码"></a>设置模板密码</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd -1 -salt `openssl rand -hex 4` &apos;centos&apos;</span><br><span class="line">$1$980db4b0$q67CuM/JE5VuswCs5HkP./</span><br><span class="line">cobbler setting edit --name=default_password_crypted --value=&apos;$1$980db4b0$q67CuM/JE5VuswCs5HkP./&apos;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install fence-agents</span><br><span class="line">cobbler setting edit --name=manage_dhcp --value=1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/cobbler/dhcp.template</span><br><span class="line">修改一下部分：</span><br><span class="line">subnet 192.168.100.0 netmask 255.255.255.0 &#123;</span><br><span class="line">     #option routers             192.168.1.5;</span><br><span class="line">     #option domain-name-servers 192.168.1.1;</span><br><span class="line">     option subnet-mask         255.255.255.0;</span><br><span class="line">     range dynamic-bootp        192.168.100.128 192.168.100.254;</span><br><span class="line">     default-lease-time         21600;</span><br><span class="line">     max-lease-time             43200;</span><br><span class="line">     next-server                $next_server;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cobbler sync</span><br><span class="line">systemctl restart cobblerd</span><br></pre></td></tr></table></figure>

<p>=======================================================================================</p>
<h2 id="cobbler-web"><a href="#cobbler-web" class="headerlink" title="cobbler web"></a>cobbler web</h2><ol>
<li><h3 id="cobbler认证"><a href="#cobbler认证" class="headerlink" title="cobbler认证"></a>cobbler认证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">useradd weihu</span><br><span class="line">echo &quot;weihu123#1&quot; | passwd --stdin weihu</span><br><span class="line">Changing password for user weihu.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line">vim /etc/cobbler/modules.conf</span><br><span class="line">[authentication]</span><br><span class="line">module = authn_pam</span><br></pre></td></tr></table></figure>

</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/cobbler/users.conf</span><br><span class="line">[admins]</span><br><span class="line">admin = &quot;weihu&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart cobblerd</span><br><span class="line">cobbler sync</span><br></pre></td></tr></table></figure>

<p>HTTP访问地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://192.168.100.100/cobbler_web</span><br></pre></td></tr></table></figure>

<p>======================================================================================</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cobbler kickstart</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="挂在光盘"><a href="#挂在光盘" class="headerlink" title="挂在光盘"></a>挂在光盘</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sr0 /var/ftp/centos7</span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="导入光盘镜像"><a href="#导入光盘镜像" class="headerlink" title="导入光盘镜像"></a>导入光盘镜像</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cobbler import --path=/var/ftp/centos7 --name=centos7.4 --arch=x86_64</span><br><span class="line">cobbler distro list</span><br><span class="line">centos7.4-x86_64</span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="创建ks文件"><a href="#创建ks文件" class="headerlink" title="创建ks文件"></a>创建ks文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">1. cd /var/lib/cobbler/kickstarts</span><br><span class="line">   vim centos7.4.ks</span><br><span class="line">   install</span><br><span class="line">   text</span><br><span class="line">   keyboard us</span><br><span class="line">   lang en_US.UTF-8</span><br><span class="line">   timezone  Asia/ShangHai</span><br><span class="line">   rootpw --iscrypted $default_password_crypted</span><br><span class="line">   auth  --useshadow  --enablemd5</span><br><span class="line">   firewall --disabled</span><br><span class="line">   selinux --disabled</span><br><span class="line">   url --url=$tree</span><br><span class="line"></span><br><span class="line">zerombr</span><br><span class="line">bootloader --location=mbr</span><br><span class="line">clearpart --all --initlabel</span><br><span class="line">part /boot --fstype=xfs --size=500</span><br><span class="line">part swap --size=1024</span><br><span class="line">part / --fstype=xfs --grow --size=200</span><br><span class="line"></span><br><span class="line">$yum_repo_stanza</span><br><span class="line">$SNIPPET(&apos;network_config&apos;)</span><br><span class="line">skipx</span><br><span class="line">firstboot --disable</span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">%pre</span><br><span class="line">$SNIPPET(&apos;log_ks_pre&apos;)</span><br><span class="line">$SNIPPET(&apos;kickstart_start&apos;)</span><br><span class="line">$SNIPPET(&apos;pre_install_network_config&apos;)</span><br><span class="line"></span><br><span class="line"># Enable installation monitoring</span><br><span class="line"></span><br><span class="line">$SNIPPET(&apos;pre_anamon&apos;)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%packages</span><br><span class="line">$SNIPPET(&apos;func_install_if_enabled&apos;)</span><br><span class="line">@^minimal</span><br><span class="line">@core</span><br><span class="line">httpd</span><br><span class="line">wget</span><br><span class="line">lftp</span><br><span class="line">vim-enhanced</span><br><span class="line">bash-completion</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post --nochroot</span><br><span class="line">$SNIPPET(&apos;log_ks_post_nochroot&apos;)</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%post</span><br><span class="line">$SNIPPET(&apos;log_ks_post&apos;)</span><br><span class="line"></span><br><span class="line"># Start yum configuration</span><br><span class="line"></span><br><span class="line">$yum_config_stanza</span><br><span class="line"></span><br><span class="line"># End yum configuration</span><br><span class="line"></span><br><span class="line">$SNIPPET(&apos;post_install_kernel_options&apos;)</span><br><span class="line">$SNIPPET(&apos;post_install_network_config&apos;)</span><br><span class="line">$SNIPPET(&apos;func_register_if_enabled&apos;)</span><br><span class="line">$SNIPPET(&apos;download_config_files&apos;)</span><br><span class="line">$SNIPPET(&apos;koan_environment&apos;)</span><br><span class="line">$SNIPPET(&apos;redhat_register&apos;)</span><br><span class="line">$SNIPPET(&apos;cobbler_register&apos;)</span><br><span class="line"></span><br><span class="line"># Enable post-install boot notification</span><br><span class="line"></span><br><span class="line">$SNIPPET(&apos;post_anamon&apos;)</span><br><span class="line"></span><br><span class="line"># Start final steps</span><br><span class="line"></span><br><span class="line">$SNIPPET(&apos;kickstart_done&apos;)</span><br><span class="line"></span><br><span class="line"># End final steps</span><br><span class="line"></span><br><span class="line">sed -ri &quot;/^#UseDNS/c\UseDNS no&quot; /etc/ssh/sshd_config</span><br><span class="line">sed -ri &quot;/^GSSAPIAuthentication/c\GSSAPIAuthentication no&quot; /etc/ssh/sshd_config</span><br><span class="line">systemctl enable httpd</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">cobbler profile edit --name=centos7.4-x86_64 --kickstart=/var/lib/cobbler/kickstarts/centos7.4.ks</span><br><span class="line">cobbler profile report --name=centos7.4-x86_64 | grep kickstarts</span><br><span class="line">Kickstart                      : /var/lib/cobbler/kickstarts/centos7.4.ks</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>修改网卡名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cobbler profile edit --name=centos7.4-x86_64 --kopts=&apos;net.ifnames=0 biosdevname=0&apos;</span><br><span class="line"></span><br><span class="line">cobbler profile list</span><br><span class="line"></span><br><span class="line">systemctl restart cobblerd</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/14/ftp虚拟用户创建过程/">
  Ftp虚拟用户创建过程
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/14/ftp虚拟用户创建过程/"><span class="article-date">
  2019-08-14
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/ftp虚拟用户创建过程/">ftp虚拟用户创建过程</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ftp虚拟用户创建过程/">ftp虚拟用户创建过程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="ftp虚拟用户创建过程"><a href="#ftp虚拟用户创建过程" class="headerlink" title="ftp虚拟用户创建过程"></a>ftp虚拟用户创建过程</h1><p>需求：<br>​    搭建一台ftp服务器，并且使用虚拟用户登录，虚拟用户具有上传、下载、创建、删除、修改等功能。<br>​<br>过程：</p>
<h3 id="1-安装vsftpd"><a href="#1-安装vsftpd" class="headerlink" title="1.安装vsftpd"></a>1.安装vsftpd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># rpm -qa vsftpd                       //检测是否安装vsftpd</span><br><span class="line"># yum -y install vsftpd               //没有则使用yum方式安装</span><br><span class="line"># chkconfig vsftpd on</span><br><span class="line"># service vsftpd start</span><br><span class="line"># iptables -F</span><br></pre></td></tr></table></figure>

<h2 id="2-创建虚拟用户"><a href="#2-创建虚拟用户" class="headerlink" title="2.创建虚拟用户"></a>2.创建虚拟用户</h2><p>ftp服务器虚拟用户的原理是把虚拟用户的权限映射到系统用户上，而虚拟用户权限是由系统用户对目录的控制得到的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># useradd weihu -s /sbin/nologin              //创建映射的系统用户weihu</span><br><span class="line"># chmod -R 750 /home/weihu                  //修改weihu用户家目录的权限</span><br></pre></td></tr></table></figure>

<h3 id="3-修改vsftpd的配置文件"><a href="#3-修改vsftpd的配置文件" class="headerlink" title="3.修改vsftpd的配置文件"></a>3.修改vsftpd的配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/vsftpd/vsftpd.conf&#123;,.bak&#125;</span><br><span class="line"># vi /etc/vsftpd/vsftpd.conf</span><br><span class="line"></span><br><span class="line">添加如下内容：</span><br><span class="line">pasv_enable=YES</span><br><span class="line">pasv_min_port=30000</span><br><span class="line">pasv_max_port=31000</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">guest_enable=YES</span><br><span class="line">user_config_dir=/etc/vsftpd/config</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line"></span><br><span class="line">其中</span><br><span class="line">pasv_enable=YES 指定开启vsftpd被动模式，在被动模式下只需要vsftpd服务器开启相应端口即可，客户端无需再开启端口。</span><br><span class="line">pasv_min_port=30000 指定被动模式最小端口号。</span><br><span class="line">pasv_max_port=31000 指定被动模式最大端口号。</span><br><span class="line">guest_enable表示是否开启vsftpd虚拟用户的功能，yes表示开启，no表示不开启。</span><br><span class="line">user_config_dir指定每个虚拟用户账号配置目录。</span><br><span class="line">pam_service_name设置PAM使用的名称,该名称就是/etc/pam.d/目录下vsftpd.virtual的文件。</span><br><span class="line">chroot_local_user=YES是否将所有用户锁定在主目录，YES为启用，NO禁用.(包括注释掉也为禁用)。</span><br><span class="line">chroot_list_enable=NO是否启动锁定用户的名单，YES为启用，NO禁用(包括注释掉也为禁用)。</span><br><span class="line">chroot_local_user=YES和chroot_list_enable=NO一起使用表示禁止所有用户切换到上级目录。</span><br></pre></td></tr></table></figure>

<h3 id="4-创建虚拟用户账号的配置目录"><a href="#4-创建虚拟用户账号的配置目录" class="headerlink" title="4.创建虚拟用户账号的配置目录"></a>4.创建虚拟用户账号的配置目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># mkdir /etc/vsftpd/config</span><br><span class="line"></span><br><span class="line"># vim /etc/vsftpd/login.txt</span><br><span class="line"></span><br><span class="line">创建存储虚拟用户账号和密码的文件，并且添加如下内容：</span><br><span class="line">weihu</span><br><span class="line">weihu123</span><br></pre></td></tr></table></figure>

<p>其中，第一行表示虚拟用户的用户名，第二行表示虚拟用户的密码，每个一行，可以写多个。<br>这个文件的虚拟用户和密码的文本文件无法被系统帐号直接调用，所以我们需要使用db_load命令<br>生成db口令数据库文件，生成命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db_load -T -t hash -f /etc/vsftpd/login.txt /etc/vsftpd/login.db</span><br></pre></td></tr></table></figure>

<h3 id="5-虚拟用户的PAM认证"><a href="#5-虚拟用户的PAM认证" class="headerlink" title="5.虚拟用户的PAM认证"></a>5.虚拟用户的PAM认证</h3><p>​    为了使服务器能够使用上述生成的数据库文件，对客户端进行身份验证，需要调用系统的PAM模块。<br>PAM(Plugable Authentication Module)为可插拔认证模块，不必重新安装应用系统，通过修改指定的配置<br>文件，调整对该程序的认证方式。PAM模块配置文件路径为/etc/pam.d/目录，此目录下保存着大量与认<br>证有关的配置文件，并以服务名称命名。</p>
<p>编辑/etc/pam.d/vsftpd文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/pam.d/vsftpd</span><br><span class="line"></span><br><span class="line">进入文件后注释掉原来的内容，添加如下内容：</span><br><span class="line">auth required /lib64/security/pam_userdb.so db=/etc/vsftpd/login</span><br><span class="line">account required /lib64/security/pam_userdb.so db=/etc/vsftpd/login</span><br><span class="line"></span><br><span class="line">auth是指对用户的用户名口令进行验证。</span><br><span class="line">accout是指对用户的帐户有哪些权限哪些限制进行验证。</span><br><span class="line">/lib64/security/pam_userdb.so表示该条审核将调用pam_userdb.so这个库函数进行。</span><br><span class="line">db=/etc/vsftpd/login则指定了验证库函数将到这个指定的数据库中调用数据进行验证。其实该文件指的是/etc/vsftpd/login.db文件。</span><br><span class="line">注意：db=/etc/vsftpd/login格式是这样的，去掉.db后缀。</span><br><span class="line"></span><br><span class="line">32位的系统可能使用下面的认证内容</span><br><span class="line">auth required /lib/security/pam_userdb.so db=/etc/vsftpd/login</span><br><span class="line">account required /lib/security/pam_userdb.so db=/etc/vsftpd/login</span><br></pre></td></tr></table></figure>

<h3 id="6-创建虚拟用户配置文件"><a href="#6-创建虚拟用户配置文件" class="headerlink" title="6.创建虚拟用户配置文件"></a>6.创建虚拟用户配置文件</h3><p>​    PAM配置完毕后，我们现在开始创建虚拟用户与系统用户对应的文件。切换到/etc/vsftpd/config目录下，并创建weihu文件。<br>注意该文件名称一定要与login.txt中的虚拟用户要对应。比如现在login.txt文件有weihu用户，那么在 /etc/vsftpd/config目录下<br>创建一个文件名为weihu的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># cd /etc/vsftpd</span><br><span class="line"># vi config/weihu</span><br><span class="line"></span><br><span class="line">添加如下内容：</span><br><span class="line">guest_username=weihu</span><br><span class="line">local_root=/home/weihu</span><br><span class="line">virtual_use_local_privs=YES</span><br><span class="line">anon_umask=133</span><br><span class="line"></span><br><span class="line">其中，guest_username=weihu    表示的是设置FTP对应的系统用户为weihu，也可以是其他用户，比如创建名为alice的用户</span><br><span class="line">local_root=/home/weihu    表示使用本地用户登录到ftp时的默认目录</span><br><span class="line">virtual_use_local_privs=YES    虚拟用户和本地用户有相同的权限</span><br><span class="line">anon_umask    表示文件上传的默认掩码。计算方式是777减去anon_umask就是上传文件的权限。在此设置的是133，</span><br><span class="line">也就是说上传后文件的权限是644。即上传的文件对所属用户来说只有读写权限，没有执行权限。</span><br><span class="line"></span><br><span class="line">修改完之后，重启vsftpd服务</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service vsftpd restart</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/13/Filebeat_+_ELK日志收集/">
  ELK
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/13/Filebeat_+_ELK日志收集/"><span class="article-date">
  2019-08-13
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/ELK/">ELK</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Filebeat/">Filebeat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="Filebeat-ELK日志收集"><a href="#Filebeat-ELK日志收集" class="headerlink" title="Filebeat + ELK日志收集"></a>Filebeat + ELK日志收集</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p> [隐藏] </p>
<ul>
<li>1说明<ul>
<li>[1.1软件版本]</li>
<li>[1.2架构图]</li>
</ul>
</li>
<li>2各组件安装过程<ul>
<li>2.1ElasticSearch<ul>
<li>[2.1.1安装依赖]</li>
<li>[2.1.2安装软件]</li>
<li>[2.1.3配置环境]</li>
<li>[2.1.4启动服务]</li>
<li>[2.1.5es集群配置]</li>
</ul>
</li>
<li>2.2Logstash<ul>
<li>[2.2.1安装软件]</li>
<li>[2.2.2配置文件]</li>
<li>[2.2.3启动服务]</li>
</ul>
</li>
<li>2.3Kibana<ul>
<li>[2.3.1安装软件]</li>
<li>[2.3.2配置文件]</li>
<li>[2.3.3启动服务]</li>
</ul>
</li>
<li>2.4Filebeat<ul>
<li>[2.4.1安装软件]</li>
<li>[2.4.2配置文件]</li>
<li>[2.4.3启动服务]</li>
</ul>
</li>
</ul>
</li>
<li>3Logstash过滤规则<ul>
<li>[3.1日志格式规范]</li>
<li>3.2grok过滤<ul>
<li>[3.2.1grok配置]</li>
<li>[3.2.2自定义正则表达式]</li>
<li>[3.2.3grok调试器]</li>
</ul>
</li>
<li>3.3geoip过滤<ul>
<li>[3.3.1geoip库下载]</li>
<li>[3.3.2安装geoip插件]</li>
<li>[3.3.3geoip配置]</li>
<li>[3.3.4kibana可视化地图展示]</li>
</ul>
</li>
<li>[3.4multiline过滤]</li>
</ul>
</li>
<li>4kibana汉化<ul>
<li>[4.1下载汉化包]</li>
<li>[4.2汉化方法]</li>
</ul>
</li>
<li>5x-pack启用和破解<ul>
<li>[5.1x-pack启用]</li>
<li>[5.2设置x-pack密码]</li>
<li>[5.3配置kibana]</li>
<li>[5.4配置logstash]</li>
<li>[5.5x-pack破解]</li>
</ul>
</li>
<li>[6定期清除索引]</li>
</ul>
<h2 id="说明-编辑"><a href="#说明-编辑" class="headerlink" title="说明[[编辑]"></a>说明[[编辑]</h2><h4 id="软件版本-编辑"><a href="#软件版本-编辑" class="headerlink" title="软件版本[[编辑]]"></a>软件版本[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">本文档仅针对CentOS 7.2以上版本</span><br><span class="line">软件版本</span><br><span class="line">elasticsearch: 6.5.4</span><br><span class="line">logstash: 6.5.4</span><br><span class="line">kibana: 6.5.4</span><br><span class="line">filebeat: 6.5.4</span><br><span class="line"></span><br><span class="line">官网下载地址：</span><br><span class="line">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.5.4.rpm</span><br><span class="line">https://artifacts.elastic.co/downloads/kibana/kibana-6.5.4-x86_64.rpm</span><br><span class="line">https://artifacts.elastic.co/downloads/logstash/logstash-6.5.4.rpm</span><br><span class="line">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.5.4-x86_64.rpm</span><br></pre></td></tr></table></figure>

<h3 id="架构图-编辑"><a href="#架构图-编辑" class="headerlink" title="架构图[[编辑]"></a>架构图[[编辑]</h3><p><img src="http://www.yxbibi.com/img/Elk.png" alt="Elk.png"></p>
<h2 id="各组件安装过程-编辑"><a href="#各组件安装过程-编辑" class="headerlink" title="各组件安装过程[[编辑]]"></a>各组件安装过程[[编辑]]</h2><h3 id="ElasticSearch-编辑"><a href="#ElasticSearch-编辑" class="headerlink" title="ElasticSearch[[编辑]]"></a>ElasticSearch[[编辑]]</h3><h4 id="安装依赖-编辑"><a href="#安装依赖-编辑" class="headerlink" title="安装依赖[[编辑]]"></a>安装依赖[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk</span><br></pre></td></tr></table></figure>

<h4 id="安装软件-编辑"><a href="#安装软件-编辑" class="headerlink" title="安装软件[[编辑]]"></a>安装软件[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -i https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.5.4.rpm</span><br></pre></td></tr></table></figure>

<h4 id="配置环境-编辑"><a href="#配置环境-编辑" class="headerlink" title="配置环境[[编辑]]"></a>配置环境[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/db/elasticsearch</span><br><span class="line">mkdir -p /data/logs/elasticsearch</span><br><span class="line">chown elasticsearch.elasticsearch /data/db/elasticsearch</span><br><span class="line">chown elasticsearch.elasticsearch /data/logs/elasticsearch</span><br></pre></td></tr></table></figure>

<p>调整系统参数增大vm.max_map_count到至少262144</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim  /etc/sysctl.conf</span><br><span class="line">添加  vm.max_map_count=262144</span><br><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure>

<p>增大文件句柄数至少 65536 ulimit -a查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/security/limits.conf</span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br></pre></td></tr></table></figure>

<p>替换配置文件 节点名称和服务器IP根据节点实际情况填写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/elasticsearch/elasticsearch.yml &lt;&lt; EOF</span><br><span class="line">cluster.name: XXX</span><br><span class="line">node.name: XXX</span><br><span class="line">path.data: /data/db/elasticsearch</span><br><span class="line">path.logs: /data/logs/elasticsearch</span><br><span class="line">network.host: X.X.X.X</span><br><span class="line">http.port: 9200</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="启动服务-编辑"><a href="#启动服务-编辑" class="headerlink" title="启动服务[[编辑]]"></a>启动服务[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start elasticsearch.service</span><br><span class="line">systemctl enable elasticsearch.service</span><br></pre></td></tr></table></figure>

<h4 id="es集群配置-编辑"><a href="#es集群配置-编辑" class="headerlink" title="es集群配置[[编辑]]"></a>es集群配置[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">集群配置中最重要的两项是node.name与network.host，每个节点都必须互通。其中node.name是节点名称主要是在Elasticsearch自己的日志加以区分每一个节点信息。</span><br><span class="line">dis-covery.zen.ping.unicast.hosts是集群中的节点信息，可以使用IP地址、可以使用主机名(必须可以解析)。</span><br><span class="line">dis-covery.zen.ping.unicast.hosts: [&quot;Node1_IP:9300&quot;, &quot;Node2_IP:9300&quot;, &quot;Node3_IP:9300&quot;]</span><br><span class="line"></span><br><span class="line">vim /etc/elasticsearch</span><br><span class="line">cluster.name: es-cluster                                    # 集群名称</span><br><span class="line">node.name: es01                                             # 节点名称，仅仅是描述名称，用于在日志中区分</span><br><span class="line"></span><br><span class="line">network.host: X.X.X.X                                       # 当前节点的IP地址</span><br><span class="line">http.port: 9200                                             # 对外提供服务的端口，9300为集群服务的端口</span><br><span class="line"></span><br><span class="line">dis-covery.zen.ping.unicast.hosts: [&quot;172.18.68.11&quot;, &quot;172.18.68.12&quot;,&quot;172.18.68.13&quot;]       </span><br><span class="line"># 集群个节点IP地址，也可以使用els、els.shuaiguoxia.com等名称，需要各节点能够解析</span><br><span class="line"></span><br><span class="line">dis-covery.zen.minimum_master_nodes: 2                       # 为了避免脑裂，集群节点数最少为 半数+1</span><br></pre></td></tr></table></figure>

<h3 id="Logstash-编辑"><a href="#Logstash-编辑" class="headerlink" title="Logstash[[编辑]]"></a>Logstash[[编辑]]</h3><h4 id="安装软件-编辑-1"><a href="#安装软件-编辑-1" class="headerlink" title="安装软件[[编辑]]"></a>安装软件[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -i https://artifacts.elastic.co/downloads/logstash/logstash-6.5.4.rpm</span><br></pre></td></tr></table></figure>

<h4 id="配置文件-编辑"><a href="#配置文件-编辑" class="headerlink" title="配置文件[[编辑]]"></a>配置文件[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/logstash/conf.d/logstash.conf &lt;&lt; EOF</span><br><span class="line">input &#123;</span><br><span class="line">        beats &#123;</span><br><span class="line">            port =&gt; 5044</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">        date &#123;</span><br><span class="line">            timezone =&gt; &quot;Asia/Shanghai&quot;</span><br><span class="line">            match =&gt; [ &quot;timestamp&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;]</span><br><span class="line">            target =&gt; &quot;@timestamp&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">             hosts =&gt; [ &quot;X.X.X.X:9200&quot; ]</span><br><span class="line">             index =&gt; &quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="启动服务-编辑-1"><a href="#启动服务-编辑-1" class="headerlink" title="启动服务[[编辑]]"></a>启动服务[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable logstash.service</span><br><span class="line">systemctl start logstash.service</span><br></pre></td></tr></table></figure>

<h3 id="Kibana-编辑"><a href="#Kibana-编辑" class="headerlink" title="Kibana[[编辑]]"></a>Kibana[[编辑]]</h3><h4 id="安装软件-编辑-2"><a href="#安装软件-编辑-2" class="headerlink" title="安装软件[[编辑]]"></a>安装软件[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -i https://artifacts.elastic.co/downloads/kibana/kibana-6.5.4-x86_64.rpm</span><br></pre></td></tr></table></figure>

<h4 id="配置文件-编辑-1"><a href="#配置文件-编辑-1" class="headerlink" title="配置文件[[编辑]]"></a>配置文件[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kibana/kibana.yml &lt;&lt; EOF</span><br><span class="line">server.port: 5601</span><br><span class="line">server.host: 0.0.0.0</span><br><span class="line">elasticsearch.url: &quot;http://X.X.X.X:9200&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="启动服务-编辑-2"><a href="#启动服务-编辑-2" class="headerlink" title="启动服务[[编辑]]"></a>启动服务[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable kibana.service</span><br><span class="line">systemctl start kibana.service</span><br></pre></td></tr></table></figure>

<h3 id="Filebeat-编辑"><a href="#Filebeat-编辑" class="headerlink" title="Filebeat[[编辑]]"></a>Filebeat[[编辑]]</h3><h4 id="安装软件-编辑-3"><a href="#安装软件-编辑-3" class="headerlink" title="安装软件[[编辑]]"></a>安装软件[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh http://dl.qe23.com:60022/packages/filebeat-6.5.4-x86_64.rpm</span><br></pre></td></tr></table></figure>

<h4 id="配置文件-编辑-2"><a href="#配置文件-编辑-2" class="headerlink" title="配置文件[[编辑]]"></a>配置文件[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/filebeat/filebeat.yml &lt;&lt; EOF</span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /data/logs/nginx/*.log</span><br><span class="line">  exclude_lines: [&quot;^DBG&quot;,&quot;^$&quot;]</span><br><span class="line">  fields:</span><br><span class="line">        type: nginxlog</span><br><span class="line">        fields_under_root: true</span><br><span class="line">  exclude_files: [&quot;.gz$&quot;]</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;X.X.X.X:5044&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="启动服务-编辑-3"><a href="#启动服务-编辑-3" class="headerlink" title="启动服务[[编辑]]"></a>启动服务[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start filebeat.service</span><br><span class="line">systemctl enable filebeat.service</span><br></pre></td></tr></table></figure>

<h2 id="Logstash过滤规则-编辑"><a href="#Logstash过滤规则-编辑" class="headerlink" title="Logstash过滤规则[[编辑]]"></a>Logstash过滤规则[[编辑]]</h2><h3 id="日志格式规范-编辑"><a href="#日志格式规范-编辑" class="headerlink" title="日志格式规范[[编辑]]"></a>日志格式规范[[编辑]]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">举例一个nginx日志格式</span><br><span class="line">log_format      access  &apos;$http_x_forwarded_for $remote_addr $remote_user $host [$time_local] &quot;$request&quot; &quot;$request_body&quot; &apos;</span><br><span class="line">                        &apos;$status $body_bytes_sent $bytes_sent &quot;$http_referer&quot; $request_length $request_time &apos;</span><br><span class="line">                        &apos;complete:&quot;$request_completion&quot; &quot;$http_user_agent&quot;&apos;;</span><br><span class="line"></span><br><span class="line">相应的日志样例</span><br><span class="line">106.226.248.84 121.10.141.6 - wvw.8888.com [03/Jun/2019:19:53:39 +0800] &quot;POST /h5/api/tj.php HTTP/1.0&quot; &quot;_server=30051&amp;sign=4b62af2babff9a88a13ba10d8126a592&quot; 200 32 418 &quot;http://www.baidu.com&quot; 694 0.086 complete:&quot;OK&quot; &quot;Dalvik/2.1.0 (Linux; U; Android 6.0.1; OPPO R9s Build/MMB29M)&quot;</span><br><span class="line"></span><br><span class="line">logstash有许多的过滤器，其中grok正则匹配把那些看似毫无意义、非结构化的日志数据解析成可查询的结构化数据，是目前 Logstash 解析过滤的最好方式。</span><br></pre></td></tr></table></figure>

<h3 id="grok过滤-编辑"><a href="#grok过滤-编辑" class="headerlink" title="grok过滤[[编辑]]"></a>grok过滤[[编辑]]</h3><h4 id="grok配置-编辑"><a href="#grok配置-编辑" class="headerlink" title="grok配置[[编辑]]"></a>grok配置[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">            patterns_dir =&gt; &quot;/etc/logstash/patterns&quot;</span><br><span class="line">            match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;NGINXACCESS&#125;&quot; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">patterns_dir指定正则表达式的文件目录,不指定话默认读取安装目录的vendor/bundle/jruby/2.3.0/gems/logstash-patterns-core-4.1.2/patterns/grok-patterns</span><br><span class="line">match可以配置多个messages，多条正则匹配，第一条匹配失败会往下匹配</span><br></pre></td></tr></table></figure>

<h4 id="自定义正则表达式-编辑"><a href="#自定义正则表达式-编辑" class="headerlink" title="自定义正则表达式[[编辑]]"></a>自定义正则表达式[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">拷贝一份默认正则到自定义目录，方便修改</span><br><span class="line">mkdir -p /etc/logstash/patterns</span><br><span class="line">cp -raf /usr/share/logstash/vendor/bundle/jruby/2.3.0/gems/logstash-patterns-core-4.1.2/patterns/grok-patterns  /etc/logstash/patterns/grok-patterns</span><br><span class="line"></span><br><span class="line">新增grok正则配置 /etc/logstash/patterns/grok-patterns  (其中IP_XFF为x-forwarded-for的正则表达式，NGINXACCESS为nginx日志的正则表达式)</span><br><span class="line">WZ ([^ ]*)</span><br><span class="line">IP_XFF [\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\,\s]*</span><br><span class="line">NGINXACCESS %&#123;IP_XFF:http_x_forwarded_for&#125; %&#123;IP:proxy_ip&#125; \- %&#123;WZ:domain&#125; \[%&#123;HTTPDATE:timestamp&#125;\] %&#123;QS:request&#125; %&#123;QS:request_body&#125; %&#123;NUMBER:status&#125; %&#123;NUMBER:bytes&#125; %&#123;NUMBER:bytes_sent&#125; %&#123;QS:referer&#125; %&#123;NUMBER:request_length&#125; %&#123;BASE16FLOAT:request_time&#125; %&#123;DATA:complete&#125; %&#123;QS:agent&#125;</span><br></pre></td></tr></table></figure>

<h4 id="grok调试器-编辑"><a href="#grok调试器-编辑" class="headerlink" title="grok调试器[[编辑]]"></a>grok调试器[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">grok正则表达式，可在kibana页面的grok调试器进行调试，能够解析为json数据即可，以下是在grok调试器解析上面日志样子结构化输出的结果</span><br><span class="line">&#123;</span><br><span class="line">  &quot;request&quot;: &quot;\&quot;POST /h5/api/tj.php HTTP/1.0\&quot;&quot;,</span><br><span class="line">  &quot;referer&quot;: &quot;\&quot;http://www.baidu.com\&quot;&quot;,</span><br><span class="line">  &quot;agent&quot;: &quot;\&quot;Dalvik/2.1.0 (Linux; U; Android 6.0.1; OPPO R9s Build/MMB29M)\&quot;&quot;,</span><br><span class="line">  &quot;bytes_sent&quot;: &quot;418&quot;,</span><br><span class="line">  &quot;request_time&quot;: &quot;0.086&quot;,</span><br><span class="line">  &quot;request_body&quot;: &quot;\&quot;_server=30051&amp;sign=4b62af2babff9a88a13ba10d8126a592\&quot;&quot;,</span><br><span class="line">  &quot;request_length&quot;: &quot;694&quot;,</span><br><span class="line">  &quot;bytes&quot;: &quot;32&quot;,</span><br><span class="line">  &quot;domain&quot;: &quot;wvw.8888.com&quot;,</span><br><span class="line">  &quot;http_x_forwarded_for&quot;: &quot;106.226.248.84&quot;,</span><br><span class="line">  &quot;complete&quot;: &quot;complete:\&quot;OK\&quot;&quot;,</span><br><span class="line">  &quot;proxy_ip&quot;: &quot;121.10.141.6&quot;,</span><br><span class="line">  &quot;timestamp&quot;: &quot;03/Jun/2019:19:53:39 +0800&quot;,</span><br><span class="line">  &quot;status&quot;: &quot;200&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">除了grok过滤器外，还有mutate、date、multiline、geoip等过滤器。</span><br></pre></td></tr></table></figure>

<h3 id="geoip过滤-编辑"><a href="#geoip过滤-编辑" class="headerlink" title="geoip过滤[[编辑]]"></a>geoip过滤[[编辑]]</h3><h4 id="geoip库下载-编辑"><a href="#geoip库下载-编辑" class="headerlink" title="geoip库下载[[编辑]]"></a>geoip库下载[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GeoIP库可以根据IP地址提供对应的 大洲，国家，省市，经纬度等地域信息，GeoLite是基于IP来确定IP所在物理地址的一个数据库，可定期更新。</span><br><span class="line">wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</span><br><span class="line">mkdir /etc/logstash/GeoLite2/</span><br><span class="line">tar zxvf GeoLite2-City.tar.gz -C /etc/logstash/GeoLite2/</span><br><span class="line">mv /etc/logstash/GeoLite2/GeoLite2-City_20190716/GeoLite2-City.mmdb /etc/logstash/GeoLite2/</span><br></pre></td></tr></table></figure>

<h4 id="安装geoip插件-编辑"><a href="#安装geoip插件-编辑" class="headerlink" title="安装geoip插件[[编辑]]"></a>安装geoip插件[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/logstash/bin/logstash-plugin install logstash-filter-geoip</span><br></pre></td></tr></table></figure>

<h4 id="geoip配置-编辑"><a href="#geoip配置-编辑" class="headerlink" title="geoip配置[[编辑]]"></a>geoip配置[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            source =&gt; &quot;client_ip&quot;</span><br><span class="line">            database =&gt; &quot;/etc/logstash/GeoLite2/GeoLite2-City.mmdb&quot;</span><br><span class="line">            add_field =&gt; [&quot;[geoip][coordinates]&quot;,&quot;%&#123;[geoip][longitude]&#125;&quot;]</span><br><span class="line">            add_field =&gt; [&quot;[geoip][coordinates]&quot;,&quot;%&#123;[geoip][latitude]&#125;&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            convert =&gt; [ &quot;[geoip][coordinates]&quot;, &quot;float&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="kibana可视化地图展示-编辑"><a href="#kibana可视化地图展示-编辑" class="headerlink" title="kibana可视化地图展示[[编辑]]"></a>kibana可视化地图展示[[编辑]]</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">若要支持中文展示即设置高德地图</span><br><span class="line">kibana.yml配置</span><br><span class="line">timelion.enabled: false</span><br><span class="line">tilemap.url: &apos;http://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&amp;size=1&amp;scale=1&amp;style=7&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;&apos;</span><br><span class="line"></span><br><span class="line">kibana页面添加区域图</span><br><span class="line">Y坐标选择Count请求数</span><br><span class="line">X坐标可选择geoip.region_name.keyword（省份）或geoip.country_name.keyword（国家)来分别展示国内分布和全球分布</span><br></pre></td></tr></table></figure>

<p><img src="http://www.yxbibi.com/img/Map.png" alt="Map.png"></p>
<h3 id="multiline过滤-编辑"><a href="#multiline过滤-编辑" class="headerlink" title="multiline过滤[[编辑]]"></a>multiline过滤[[编辑]]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">用于合并数组结构的日志，默认数组结构的日志会被拆分为多行，查询日志时就没可读性，所以需要把每个数组都合并为一条日志</span><br><span class="line">/usr/share/logstash/bin/logstash-plugin install logstash-filter-multiline</span><br><span class="line"></span><br><span class="line">新增配置</span><br><span class="line">filter &#123;</span><br><span class="line">        multiline &#123;</span><br><span class="line">            pattern =&gt; &quot;^\[\d&#123;4&#125;-|^\d&#123;4&#125;-&quot;</span><br><span class="line">            negate =&gt; true</span><br><span class="line">            what =&gt; &quot;previous&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="kibana汉化-编辑"><a href="#kibana汉化-编辑" class="headerlink" title="kibana汉化[[编辑]]"></a>kibana汉化[[编辑]]</h2><h3 id="下载汉化包-编辑"><a href="#下载汉化包-编辑" class="headerlink" title="下载汉化包[[编辑]]"></a>下载汉化包[[编辑]]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O Kibana_Hanization-master.zip https://codeload.github.com/anbai-inc/Kibana_Hanization/zip/master</span><br><span class="line">unzip Kibana_Hanization-master.zip</span><br><span class="line">cd Kibana_Hanization-master</span><br></pre></td></tr></table></figure>

<h3 id="汉化方法-编辑"><a href="#汉化方法-编辑" class="headerlink" title="汉化方法[[编辑]]"></a>汉化方法[[编辑]]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">### 汉化方法（6.x）</span><br><span class="line">* 1、拷贝此项目中的translations`文件夹`到您的kibana目录下的`src/legacy/core_plugins/kibana/`目录。若您的kibana无此目录，那还是尝试使用此项目old目录下的汉化方法吧。</span><br><span class="line">* 2、修改您的kibana配置文件kibana.yml中的配置项：i18n.locale: &quot;zh-CN&quot;</span><br><span class="line">* 3、重启Kibana，汉化完成</span><br><span class="line">### 汉化方法（7.x）</span><br><span class="line">* 官方自带汉化资源文件（位于您的kibana目录下的`node_modules/x-pack/plugins/translations/translations/`目录。</span><br><span class="line">* 修改您的kibana配置文件kibana.yml中的配置项：`i18n.locale: &quot;zh-CN&quot;`，重启Kibana则汉化完成。</span><br><span class="line"></span><br><span class="line">若上面方法不可用，可采用旧方法</span><br><span class="line">cd Kibana_Hanization-master/old</span><br><span class="line">python main.py Kibana安装目录</span><br><span class="line">**注意：此项目适用于Kibana 5.x-6.x的任意版本，汉化过程不可逆，汉化前请注意备份！** 汉化资源会慢慢更新完善，已汉化过的Kibana可以重复使用此项目汉化更新的资源。除一小部分资源外，大部分资源无需重启Kibana，刷新页面即可看到效果。</span><br><span class="line">意见反馈：redfree@anbai.com  Windows请自行安装Python2.7</span><br></pre></td></tr></table></figure>

<h2 id="x-pack启用和破解-编辑"><a href="#x-pack启用和破解-编辑" class="headerlink" title="x-pack启用和破解[[编辑]]"></a>x-pack启用和破解[[编辑]]</h2><h3 id="x-pack启用-编辑"><a href="#x-pack启用-编辑" class="headerlink" title="x-pack启用[[编辑]]"></a>x-pack启用[[编辑]]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">修改/etc/elasticsearch/elasticsearch.yml</span><br><span class="line">xpack.security.enabled: true</span><br><span class="line">xpack.security.transport.ssl.enabled: true</span><br><span class="line"></span><br><span class="line">systemctl restart elasticsearch.service</span><br></pre></td></tr></table></figure>

<h3 id="设置x-pack密码-编辑"><a href="#设置x-pack密码-编辑" class="headerlink" title="设置x-pack密码[[编辑]]"></a>设置x-pack密码[[编辑]]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto</span><br><span class="line">Initiating the setup of passwords for reserved users elastic,apm_system,kibana,logstash_system,beats_system,remote_monitoring_user.</span><br><span class="line">The passwords will be randomly generated and printed to the console.</span><br><span class="line">Please confirm that you would like to continue [y/N]y</span><br><span class="line"></span><br><span class="line">Changed password for user apm_system</span><br><span class="line">PASSWORD apm_system = C22ZHbO1HqwQKNmi663L</span><br><span class="line"></span><br><span class="line">Changed password for user kibana</span><br><span class="line">PASSWORD kibana = 01ZGYU0sHpHEMVaotka1</span><br><span class="line"></span><br><span class="line">Changed password for user logstash_system</span><br><span class="line">PASSWORD logstash_system = 3CNP0ghxUa1tI0Ph5b3V</span><br><span class="line"></span><br><span class="line">Changed password for user beats_system</span><br><span class="line">PASSWORD beats_system = A7IWv4G1YvqirTF3K8fr</span><br><span class="line"></span><br><span class="line">Changed password for user remote_monitoring_user</span><br><span class="line">PASSWORD remote_monitoring_user = gwZYAvPicXi79KH64hdM</span><br><span class="line"></span><br><span class="line">Changed password for user elastic</span><br><span class="line">PASSWORD elastic = JZYclzSFZO7HJLKM2111</span><br><span class="line"></span><br><span class="line">需要记住elastic密码，用于之后登陆kibana</span><br></pre></td></tr></table></figure>

<h3 id="配置kibana-编辑"><a href="#配置kibana-编辑" class="headerlink" title="配置kibana[[编辑]]"></a>配置kibana[[编辑]]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">修改/etc/kibana/kibana.yml </span><br><span class="line">xpack.security.enabled: true</span><br><span class="line">elasticsearch.username: &quot;elastic&quot;</span><br><span class="line">elasticsearch.password: &quot;JZYclzSFZO7HJLKM2111&quot;</span><br><span class="line"></span><br><span class="line">systemctl restart kibana.service</span><br></pre></td></tr></table></figure>

<h3 id="配置logstash-编辑"><a href="#配置logstash-编辑" class="headerlink" title="配置logstash[[编辑]]"></a>配置logstash[[编辑]]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">修改/etc/logstash/conf.d/logstash.conf</span><br><span class="line">            elasticsearch &#123;</span><br><span class="line">                user =&gt; &quot;elastic&quot;</span><br><span class="line">                password =&gt; &quot;JZYclzSFZO7HJLKM2111&quot;</span><br><span class="line">                hosts =&gt; [ &quot;X.X.X.X:9200&quot; ]</span><br><span class="line">                index =&gt; &quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">systemctl restart logstash.service</span><br></pre></td></tr></table></figure>

<h3 id="x-pack破解-编辑"><a href="#x-pack破解-编辑" class="headerlink" title="x-pack破解[[编辑]]"></a>x-pack破解[[编辑]]</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">重启elk各个组件，之后登录kibana就会多了用户登录和权限管理以及监控部分的功能，但由于免费版本的x-pack只有一个月的试用liscene，下面给破解一下</span><br><span class="line"></span><br><span class="line">license破解</span><br><span class="line">破解前先修改 /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">xpack.security.enabled: false</span><br><span class="line"></span><br><span class="line">systemctl restart elasticsearch</span><br><span class="line"></span><br><span class="line">cd  /usr/share/elasticsearch/modules/x-pack-core</span><br><span class="line">上传改动过的jar包以及json，</span><br><span class="line">x-pack-core-6.5.4.jar   具体修改和jar解包打包这里不说明，网上能找到</span><br><span class="line">liscene.json      liscene文件可以去官网申请 https://register.elastic.co/marvel_register  </span><br><span class="line">将 &quot;type&quot;:&quot;basic&quot; 替换为 &quot;type&quot;:&quot;platinum&quot;    # 基础班变更为铂金版</span><br><span class="line">将 &quot;expiry_date_in_millis&quot;:1561420799999替换为 &quot;expiry_date_in_millis&quot;:3107746200000# 1年变为50年</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">更新许可</span><br><span class="line">curl -H &quot;Content-Type: application/json&quot; -XPUT &apos;X.X.X.X:9200/_xpack/license?acknowledge=true&apos; -d @license.json</span><br><span class="line">也可以在后台许可管理上传，现在可以看到liscene有效期已经到了2050年了。</span><br><span class="line"></span><br><span class="line">Your license will expire on August 16, 2050 10:13 PM CST</span><br></pre></td></tr></table></figure>

<h2 id="定期清除索引-编辑"><a href="#定期清除索引-编辑" class="headerlink" title="定期清除索引[[编辑]]"></a>定期清除索引[[编辑]]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">定期删除过期索引脚本 </span><br><span class="line">crontab -l</span><br><span class="line">0 1 * * * sh /data/scripts/elk_index_clear.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">###################################</span><br><span class="line">#删除早于七天的ES集群的索引</span><br><span class="line">###################################</span><br><span class="line">function delete_indices() &#123;</span><br><span class="line">    comp_date=`date -d &quot;7 day ago&quot; +&quot;%Y-%m-%d&quot;`</span><br><span class="line">    date1=&quot;$1 00:00:00&quot;</span><br><span class="line">    date2=&quot;$comp_date 00:00:00&quot;</span><br><span class="line"></span><br><span class="line">    t1=`date -d &quot;$date1&quot; +%s` </span><br><span class="line">    t2=`date -d &quot;$date2&quot; +%s` </span><br><span class="line"></span><br><span class="line">    if [ $t1 -le $t2 ]; then</span><br><span class="line">        echo &quot;$1时间早于$comp_date，进行索引删除&quot;</span><br><span class="line">        #转换一下格式，将类似2017-10-01格式转化为2017.10.01</span><br><span class="line">        format_date=`echo $1| sed &apos;s/-/\./g&apos;`</span><br><span class="line">        curl -s -XDELETE --user elastic:JZYclzSFZO7HJLKM2LVJ http://10.0.16.3:9200/*$format_date</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">curl -s -XGET --user elastic:JZYclzSFZO7HJLKM2LVJ http://10.0.16.3:9200/_cat/indices | awk -F&quot; &quot; &apos;&#123;print $3&#125;&apos; | awk -F&quot;-&quot; &apos;&#123;print $NF&#125;&apos; | egrep &quot;[0-9]*\.[0-9]*\.[0-9]*&quot; | sort | uniq  | sed &apos;s/\./-/g&apos; | while read LINE</span><br><span class="line">do</span><br><span class="line">    #调用索引删除函数</span><br><span class="line">    delete_indices $LINE</span><br><span class="line">done</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/13/JumpServer部署/">
  JumpServer部署
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/13/JumpServer部署/"><span class="article-date">
  2019-08-13
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/JumpServer/">JumpServer</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JumpServer/">JumpServer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="JumpServer部署"><a href="#JumpServer部署" class="headerlink" title="JumpServer部署"></a>JumpServer部署</h1><p>请参考官方安装文档</p>
<p>不同的是安装目录安装在/data/soft/jumpserver</p>
<p><a href="https://jumpserver.readthedocs.io/zh/docs/step_by_step.html" target="_blank" rel="noopener">https://jumpserver.readthedocs.io/zh/docs/step_by_step.html</a> (推荐 有autoenv安装)<br><a href="http://docs.jumpserver.org/zh/docs/setup_by_centos7.html" target="_blank" rel="noopener">http://docs.jumpserver.org/zh/docs/setup_by_centos7.html</a></p>
<p>一、修改字符集</p>
<p>修改字符集，否则可能报 input/output error的问题，因为日志里打印了中文</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@op-remote ~]# localedef -c -f UTF-8 -i zh_CN</span><br><span class="line">zh_CN.UTF-8</span><br><span class="line">[root@op-remote ~]# export LC_ALL=zh_CN.UTF-8</span><br><span class="line">[root@op-remote ~]# echo &apos;LANG=&quot;zh_CN.UTF-8&quot;&apos; &gt;</span><br><span class="line">/etc/locale.conf</span><br><span class="line"></span><br><span class="line"># 更改回到英文字符集</span><br><span class="line"></span><br><span class="line">[root@op-remote requirements]# localedef -c -f UTF-8 -i</span><br><span class="line">en_US en_US.UTF-8</span><br><span class="line">[root@op-remote requirements]# export LC_ALL=en_US.UTF-8</span><br><span class="line">[root@op-remote requirements]# echo &apos;LANG=&quot;en_US.UTF-</span><br><span class="line">8&quot;&apos; &gt; /etc/locale.conf</span><br></pre></td></tr></table></figure>

<h3 id="二、准备Python3环境"><a href="#二、准备Python3环境" class="headerlink" title="二、准备Python3环境"></a>二、准备Python3环境</h3><p>（这里我们注意可以安装python3.6来防止后面的报错，我也不知道为什么<br>python3.7有什么问题，cao）</p>
<h4 id="1-安装编译环境"><a href="#1-安装编译环境" class="headerlink" title="1.安装编译环境"></a>1.安装编译环境</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@op-remote ~]# yum -y install wget sqlite-devel xz</span><br><span class="line">gcc automake zlib-devel openssl-devel epel-release git</span><br><span class="line">libffi-devel</span><br></pre></td></tr></table></figure>

<h4 id="2-解压安装"><a href="#2-解压安装" class="headerlink" title="2.解压安装"></a>2.解压安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@lp nginx]# wget</span><br><span class="line">https://www.python.org/ftp/python/3.6.6/Python-3.6.6.tgz</span><br><span class="line">[root@lp nginx]# tar xvf Python-3.6.6.tgz</span><br><span class="line">[root@lp nginx]# cd Python-3.6.6/</span><br><span class="line">[root@lp Python-3.6.6]# ./configure --</span><br><span class="line">prefix=/usr/local/python3.6 ; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h4 id="3-安装OpenSSL-1-1-0-（如果编译报错）"><a href="#3-安装OpenSSL-1-1-0-（如果编译报错）" class="headerlink" title="3.安装OpenSSL 1.1.0 （如果编译报错）"></a>3.安装OpenSSL 1.1.0 （如果编译报错）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">报错：./python: /lib64/libssl.so.1.1: version</span><br><span class="line">`OPENSSL_1_1_0&apos;</span><br><span class="line">[root@lp ~]# wget https://www.openssl.org/source/openssl-1.1.0h.tar.gz</span><br><span class="line">[root@lp ~]# tar xvf openssl-1.1.0h.tar.gz</span><br><span class="line">[root@lp openssl-1.1.0h]# cd openssl-1.1.0h/ &amp;&amp; ./config</span><br><span class="line">--prefix=/usr/local/openssl &amp;&amp; make &amp;&amp; make install &amp;&amp;</span><br><span class="line">make depend</span><br><span class="line">[root@lp local]# mv /usr/lib64/libssl.so.1.1</span><br><span class="line">[root@lp local]# mv /usr/lib64/libcrypto.so.1.1</span><br><span class="line">[root@lp local]# ln -s</span><br><span class="line">/usr/local/openssl/lib/libssl.so.1.1</span><br><span class="line">/usr/lib64/libssl.so.1.1</span><br><span class="line">[root@lp local]# ln -s</span><br><span class="line">/usr/local/openssl/lib/libcrypto.so.1.1</span><br><span class="line">/lib64/libcrypto.so.1.1</span><br></pre></td></tr></table></figure>

<h4 id="4-更改Module文件"><a href="#4-更改Module文件" class="headerlink" title="4.更改Module文件"></a>4.更改Module文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@lp Python-3.6.6]# vim Modules/Setup</span><br><span class="line"># Socket module helper for socket(2)</span><br><span class="line">_socket socketmodule.c</span><br><span class="line"># Socket module helper for SSL support; you must comment</span><br><span class="line">out the other</span><br><span class="line"># socket line above, and possibly edit the SSL variable:</span><br><span class="line"></span><br><span class="line">SSL=/usr/local/openssl</span><br><span class="line">_ssl _ssl.c \</span><br><span class="line">-DUSE_SSL -I$(SSL)/include -</span><br><span class="line">I$(SSL)/include/openssl \</span><br><span class="line">-L$(SSL)/lib -lssl -lcrypto</span><br></pre></td></tr></table></figure>

<h5 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">防止出现这个错误：ModuleNotFoundError: No module named</span><br><span class="line">&apos;_ctypes&apos;，需要安装下面的软件</span><br><span class="line">[root@lp Python-3.6.6]# yum install libffi-devel -y</span><br></pre></td></tr></table></figure>

<h4 id="5-正式安装"><a href="#5-正式安装" class="headerlink" title="5.正式安装"></a>5.正式安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@lp Python-3.6.6]# ./configure --</span><br><span class="line">prefix=/usr/local/python3.6 ; make &amp;&amp; make install</span><br><span class="line">[root@lp Python-3.6.6]# vim /etc/profile</span><br><span class="line">export PATH=$PATH:/usr/local/python3.6/bin</span><br><span class="line">[root@lp Python-3.6.6]# source /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="三、下载JumpServer"><a href="#三、下载JumpServer" class="headerlink" title="三、下载JumpServer"></a>三、下载JumpServer</h3><h4 id="1-下载或-Clone-项目"><a href="#1-下载或-Clone-项目" class="headerlink" title="1.下载或 Clone 项目"></a>1.下载或 Clone 项目</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote ~]$ git clone</span><br><span class="line">https://github.com/jumpserver/jumpserver.git &amp;&amp; cd</span><br><span class="line">jumpserver &amp;&amp; git checkout master</span><br></pre></td></tr></table></figure>

<h4 id="2-安装依赖-RPM-包"><a href="#2-安装依赖-RPM-包" class="headerlink" title="2.安装依赖 RPM 包"></a>2.安装依赖 RPM 包</h4><h5 id="需要通过root去安装"><a href="#需要通过root去安装" class="headerlink" title="需要通过root去安装"></a>需要通过root去安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@op-remote ~]$ cd JumpServerPackage/requirements/</span><br><span class="line">[root@op-remote requirements]$ sudo yum -y install $(cat</span><br><span class="line">rpm_requirements.txt)</span><br></pre></td></tr></table></figure>

<h4 id="3-安装-Python-库依赖"><a href="#3-安装-Python-库依赖" class="headerlink" title="3.安装 Python 库依赖"></a>3.安装 Python 库依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote requirements]$ pip3 install -r</span><br><span class="line">requirements.txt</span><br></pre></td></tr></table></figure>

<h5 id="注意：-1"><a href="#注意：-1" class="headerlink" title="注意："></a>注意：</h5><p>这里会遇到一些错误的提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gevent 1.3.6 has requirement greenlet&gt;=0.4.14;</span><br><span class="line">platform_python_implementation == &quot;CPython&quot;, but you&apos;ll</span><br><span class="line">have greenlet 0.4.12 which is incompatible.</span><br></pre></td></tr></table></figure>

<p>greenlet版本不够</p>
<p>但是当你卸载了greenlet以后，系统提示的是卸载了Successfully uninstalled<br>greenlet-0.4.14，可以看到，系统是安装了最新的版本，但是这里却无法识<br>别，这就很奇怪了，然后我尝试安装一个低版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[root@op-remote requirements]# pip3 install</span><br><span class="line">greenlet==0.4.12</span><br><span class="line">Looking in indexes:</span><br><span class="line">http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">Collecting greenlet==0.4.12</span><br><span class="line">Downloading</span><br><span class="line">http://mirrors.aliyun.com/pypi/packages/be/76/82af375d98</span><br><span class="line">724054b7e273b5d9369346937324f9bcc20980b45b068ef0b0/green</span><br><span class="line">let-0.4.12.tar.gz (57kB)</span><br><span class="line">100% |████████████████████████████████| 61kB</span><br><span class="line">58.7MB/s</span><br><span class="line">gevent 1.3.6 has requirement greenlet&gt;=0.4.14;</span><br><span class="line">platform_python_implementation == &quot;CPython&quot;, but you&apos;ll</span><br><span class="line">have greenlet 0.4.12 which is incompatible.</span><br><span class="line">Installing collected packages: greenlet</span><br><span class="line">Running setup.py install for greenlet ... error</span><br><span class="line">Complete output from command</span><br><span class="line">/usr/local/python3.7/bin/python3.7 -u -c &quot;import</span><br><span class="line">setuptools, tokenize;__file__=&apos;/tmp/pip-install-</span><br><span class="line">3pm__ow5/greenlet/setup.py&apos;;f=getattr(tokenize, &apos;open&apos;,</span><br><span class="line">open)(__file__);code=f.read().replace(&apos;\r\n&apos;,</span><br><span class="line">&apos;\n&apos;);f.close();exec(compile(code, __file__, &apos;exec&apos;))&quot;</span><br><span class="line">install --record /tmp/pip-record-whkcmkrj/installrecord.</span><br><span class="line">txt --single-version-externally-managed --</span><br><span class="line">compile:</span><br><span class="line">running install</span><br><span class="line">running build</span><br><span class="line">running build_ext</span><br><span class="line">building &apos;greenlet&apos; extension</span><br><span class="line">creating build</span><br><span class="line">creating build/temp.linux-x86_64-3.7</span><br><span class="line">gcc -pthread -Wno-unused-result -Wsign-compare -</span><br><span class="line">DNDEBUG -g -fwrapv -O3 -Wall -fPIC -</span><br><span class="line">I/usr/local/python3.7/include/python3.7m -c greenlet.c -</span><br><span class="line">o build/temp.linux-x86_64-3.7/greenlet.o</span><br><span class="line">greenlet.c: In function ‘g_switchstack’:</span><br><span class="line">greenlet.c:463:29: error: ‘PyThreadState’ has no</span><br><span class="line">member named ‘exc_type’</span><br><span class="line">current-&gt;exc_type = tstate-&gt;exc_type;</span><br><span class="line">^</span><br><span class="line">greenlet.c:464:30: error: ‘PyThreadState’ has no</span><br><span class="line">member named ‘exc_value’</span><br><span class="line">current-&gt;exc_value = tstate-&gt;exc_value;</span><br><span class="line">^</span><br><span class="line">greenlet.c:465:34: error: ‘PyThreadState’ has no</span><br><span class="line">member named ‘exc_traceback’</span><br><span class="line">current-&gt;exc_traceback = tstate-&gt;exc_traceback;</span><br><span class="line"></span><br><span class="line">greenlet.c:485:9: error: ‘PyThreadState’ has no</span><br><span class="line">member named ‘exc_type’</span><br><span class="line">tstate-&gt;exc_type = target-&gt;exc_type;</span><br><span class="line">^</span><br><span class="line">greenlet.c:487:9: error: ‘PyThreadState’ has no</span><br><span class="line">member named ‘exc_value’</span><br><span class="line">tstate-&gt;exc_value = target-&gt;exc_value;</span><br><span class="line">^</span><br><span class="line">greenlet.c:489:9: error: ‘PyThreadState’ has no</span><br><span class="line">member named ‘exc_traceback’</span><br><span class="line">tstate-&gt;exc_traceback = target-&gt;exc_traceback;</span><br><span class="line">^</span><br><span class="line"></span><br><span class="line">## error: command &apos;gcc&apos; failed with exit status 1</span><br><span class="line"></span><br><span class="line">Command &quot;/usr/local/python3.7/bin/python3.7 -u -c</span><br><span class="line">&quot;import setuptools, tokenize;__file__=&apos;/tmp/pip-install-</span><br><span class="line">3pm__ow5/greenlet/setup.py&apos;;f=getattr(tokenize, &apos;open&apos;,</span><br><span class="line">open)(__file__);code=f.read().replace(&apos;\r\n&apos;,</span><br><span class="line">&apos;\n&apos;);f.close();exec(compile(code, __file__, &apos;exec&apos;))&quot;</span><br><span class="line">install --record /tmp/pip-record-whkcmkrj/installrecord.</span><br><span class="line">txt --single-version-externally-managed --</span><br><span class="line">compile&quot; failed with error code 1 in /tmp/pip-install-</span><br><span class="line">3pm__ow5/greenlet/</span><br></pre></td></tr></table></figure>

<p>报了一个和安装库依赖的时候一样的错误，那么我可以大胆的预测，可能是安<br>装依赖的时候，选择安装了requirements.txt当中的低版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@op-remote requirements]# vim requirements.txt</span><br><span class="line">ephem==3.7.6.0</span><br><span class="line">eventlet==0.22.1</span><br><span class="line">ForgeryPy==0.1</span><br><span class="line">greenlet==0.4.14，然后这个问题就顺利解决啦</span><br><span class="line">gunicorn==19.7.1</span><br><span class="line"></span><br><span class="line"># 很明显的看到，他这里清单默认安装的是greenlet==0.4.12版本，和单</span><br><span class="line"></span><br><span class="line">独安装这个版本是报的一个错误，那么这样就清晰明了了，这是一个很大的错</span><br><span class="line">误，需要我们通</span><br></pre></td></tr></table></figure>

<h4 id="4-安装-Redis"><a href="#4-安装-Redis" class="headerlink" title="4.安装 Redis"></a>4.安装 Redis</h4><p>Jumpserver 使用 Redis 做 cache 和 celery broke</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote ~]$ tar xvf redis-4.0.10.tar.gz</span><br><span class="line">[JumpServer@op-remote ~]$ cd redis-4.0.10/</span><br><span class="line">[JumpServer@op-remote ~]$ mkdir redis</span><br><span class="line">[JumpServer@op-remote redis-4.0.10]$ make</span><br><span class="line">PREFIX=/home/JumpServer/redis install</span><br></pre></td></tr></table></figure>

<h4 id="5-安装MySQL-5-7"><a href="#5-安装MySQL-5-7" class="headerlink" title="5.安装MySQL-5.7"></a>5.安装MySQL-5.7</h4><h5 id="①下载"><a href="#①下载" class="headerlink" title="①下载"></a>①下载</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote ~]$ wget</span><br><span class="line">http://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-</span><br><span class="line">5.7.23.tar.gz</span><br><span class="line">[JumpServer@op-remote ~]$ wget</span><br><span class="line">http://downloads.sourceforge.net/project/boost/boost/1.5</span><br><span class="line">9.0/boost_1_59_0.tar.gz</span><br><span class="line">[JumpServer@op-remote ~]$ tar xvf mysql-5.7.23.tar.gz</span><br><span class="line">[JumpServer@op-remote ~]$ tar xvf boost_1_59_0.tar.gz</span><br></pre></td></tr></table></figure>

<h5 id="②安装必要编译插件"><a href="#②安装必要编译插件" class="headerlink" title="②安装必要编译插件"></a>②安装必要编译插件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@op-remote home]# yum -y install autoconf automake</span><br><span class="line">libtool cmake ncurses-devel openssl-devel lzo-devel</span><br><span class="line">zlib-devel gcc gcc-c++</span><br></pre></td></tr></table></figure>

<h5 id="③编译开始"><a href="#③编译开始" class="headerlink" title="③编译开始"></a>③编译开始</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote mysql-5.7.23]$ cmake . -</span><br><span class="line">DCMAKE_INSTALL_PREFIX=/home/JumpServer/mysql/mysql-</span><br><span class="line">5.7.23 \</span><br><span class="line">-DMYSQL_DATADIR=/home/JumpServer/mysql/mysql-5.7.23 \</span><br><span class="line">-DDOWNLOAD_BOOST=1 \</span><br><span class="line">-DWITH_BOOST=/home/JumpServer/boost_1_59_0 \ #指定boost的</span><br><span class="line">位置</span><br><span class="line">-DSYSCONFDIR=/home/JumpServer/mysql/mysql-5.7.23/etc/ \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_MYISAM_STORAGE_ENGINE=1 \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DENABLE_DTRACE=0 \</span><br><span class="line"></span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DEXTRA_CHARSETS=all \</span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line">-DMYSQL_TCP_PORT=3306;</span><br><span class="line"></span><br><span class="line"># 单行版</span><br><span class="line"></span><br><span class="line">[JumpServer@op-remote mysql-5.7.23]$ cmake . -</span><br><span class="line">DCMAKE_INSTALL_PREFIX=/home/JumpServer/mysql/mysql-</span><br><span class="line">5.7.23 -DMYSQL_DATADIR=/home/JumpServer/mysql/mysql-</span><br><span class="line">5.7.23 -DDOWNLOAD_BOOST=1 -</span><br><span class="line">DWITH_BOOST=/home/JumpServer/boost_1_59_0 -</span><br><span class="line">DSYSCONFDIR=/home/JumpServer/mysql/mysql-5.7.23/etc/ -</span><br><span class="line">DWITH_INNOBASE_STORAGE_ENGINE=1 -</span><br><span class="line">DWITH_PARTITION_STORAGE_ENGINE=1 -</span><br><span class="line">DWITH_FEDERATED_STORAGE_ENGINE=1 -</span><br><span class="line">DWITH_BLACKHOLE_STORAGE_ENGINE=1 -</span><br><span class="line">DWITH_MYISAM_STORAGE_ENGINE=1 -DENABLED_LOCAL_INFILE=1 -</span><br><span class="line">DENABLE_DTRACE=0 -DDEFAULT_CHARSET=utf8 -</span><br><span class="line">DDEFAULT_COLLATION=utf8_general_ci -DEXTRA_CHARSETS=all</span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 -DMYSQL_TCP_PORT=3306;</span><br><span class="line"></span><br><span class="line"># 开始编译</span><br><span class="line"></span><br><span class="line">[JumpServer@op-remote mysql-5.7.23]$ make -j2 &amp;&amp; make</span><br><span class="line">install</span><br></pre></td></tr></table></figure>

<h5 id="④环境变量配置"><a href="#④环境变量配置" class="headerlink" title="④环境变量配置"></a>④环境变量配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote ~]$ vim .bash_profile</span><br><span class="line">export PATH=$PATH:/home/JumpServer/mysql/mysql-</span><br><span class="line">5.7.23/bin</span><br><span class="line">[JumpServer@op-remote ~]$ source .bash_profile</span><br></pre></td></tr></table></figure>

<h5 id="⑤数据库配置文件"><a href="#⑤数据库配置文件" class="headerlink" title="⑤数据库配置文件"></a>⑤数据库配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote ~]$ /home/JumpServer/mysql/mysql-</span><br><span class="line">5.7.23/etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line">socket = /home/JumpServer/mysql/logs/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line"># Skip</span><br><span class="line"></span><br><span class="line">skip-grant-tables = 1 # 跳过授权列表</span><br><span class="line"></span><br><span class="line">skip_name_resolve = 1</span><br><span class="line">skip-external-locking = 1</span><br><span class="line">symbolic-links= 0</span><br><span class="line"></span><br><span class="line"># GENERAL</span><br><span class="line"></span><br><span class="line">user = JumpServer</span><br><span class="line">default_storage_engine = InnoDB</span><br><span class="line">character-set-server = utf8</span><br><span class="line">socket = /home/JumpServer/mysql/logs/mysql.sock</span><br><span class="line">pid_file =/home/JumpServer/mysql/logs/mysqld.pid</span><br><span class="line">basedir = /home/JumpServer/mysql/mysql-5.7.23</span><br><span class="line">port = 3306</span><br><span class="line">bind-address = 0.0.0.0</span><br><span class="line">log-warnings = 2</span><br><span class="line">explicit_defaults_for_timestamp = off</span><br><span class="line">#sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br><span class="line">#read_only=on</span><br><span class="line">sql_mode=NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line"># MyISAM</span><br><span class="line"></span><br><span class="line">key_buffer_size = 32M #size of the</span><br><span class="line">buffer used for index blocks#</span><br><span class="line">#myisam_re-cover = FORCE,BACKUP</span><br><span class="line"></span><br><span class="line"># SAFETY</span><br><span class="line"></span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line">max_connect_errors = 1000000</span><br><span class="line">sysdate_is_now = 1</span><br><span class="line">#innodb = FORCE</span><br><span class="line">#innodb_strict_mode = 1</span><br><span class="line"></span><br><span class="line"># Replice</span><br><span class="line"></span><br><span class="line">server-id = 313306</span><br><span class="line">relay_log = mysqld-relay-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce-gtid-consistency</span><br><span class="line">log-slave-updates = on</span><br><span class="line">master_info_repository =TABLE</span><br><span class="line">relay_log_info_repository =TABLE</span><br><span class="line"></span><br><span class="line"># rpl_semi_sync_master_enabled=1</span><br><span class="line"></span><br><span class="line"># rpl_semi_sync_master_timeout=200 # 0.2 second</span><br><span class="line"></span><br><span class="line"># DATA STORAGE</span><br><span class="line"></span><br><span class="line">datadir = /home/JumpServer/mysql/mysql-5.7.23/data</span><br><span class="line">tmpdir = /home/JumpServer/mysql/mysql-5.7.23/temp/</span><br><span class="line"></span><br><span class="line"># BINARY LOGGING</span><br><span class="line"></span><br><span class="line">log_bin = /home/JumpServer/mysql/logs/mysql-bin</span><br><span class="line">max_binlog_size = 1000M</span><br><span class="line"></span><br><span class="line">binlog_format = row</span><br><span class="line">expire_logs_days = 7</span><br><span class="line"></span><br><span class="line"># sync_binlog = 1</span><br><span class="line"></span><br><span class="line"># CACHES AND LIMITS</span><br><span class="line"></span><br><span class="line">tmp_table_size = 32M</span><br><span class="line">max_heap_table_size = 32M</span><br><span class="line">query_cache_type = 0</span><br><span class="line">query_cache_size = 0</span><br><span class="line">max_connections = 4000</span><br><span class="line">thread_cache_size = 2048</span><br><span class="line">open_files_limit = 65535</span><br><span class="line">table_definition_cache = 4096</span><br><span class="line">table_open_cache = 4096</span><br><span class="line">sort_buffer_size = 20M</span><br><span class="line">read_buffer_size = 2M</span><br><span class="line">read_rnd_buffer_size = 2M</span><br><span class="line">#thread_concurrency = 24</span><br><span class="line">join_buffer_size = 1M</span><br><span class="line"></span><br><span class="line"># table_cache = 32768</span><br><span class="line"></span><br><span class="line">thread_stack = 512k</span><br><span class="line">max_length_for_sort_data = 16k</span><br><span class="line"></span><br><span class="line"># INNODB</span><br><span class="line"></span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_log_buffer_size = 16M</span><br><span class="line">innodb_flush_log_at_trx_commit = 2</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_buffer_pool_size = 2G</span><br><span class="line">innodb_buffer_pool_instances = 8</span><br><span class="line">innodb_stats_on_metadata = off</span><br><span class="line">innodb_open_files = 8192</span><br><span class="line">innodb_read_io_threads = 8</span><br><span class="line">innodb_write_io_threads = 16</span><br><span class="line">innodb_io_capacity = 20000</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_lock_wait_timeout = 60</span><br><span class="line">innodb_old_blocks_time=1000</span><br><span class="line">innodb_use_native_aio = 1</span><br><span class="line">innodb_purge_threads=1</span><br><span class="line">innodb_change_buffering=all</span><br><span class="line">innodb_log_file_size = 128M</span><br><span class="line">innodb_log_files_in_group = 3</span><br><span class="line">innodb_data_file_path = ibdata1:1024M:autoextend</span><br><span class="line"></span><br><span class="line"># LOGGING</span><br><span class="line"></span><br><span class="line">log_error = /home/JumpServer/mysql/logs/mysql-error.log</span><br><span class="line"></span><br><span class="line"># log_queries_not_using_indexes = 1</span><br><span class="line"></span><br><span class="line"># slow_query_log = 1</span><br><span class="line"></span><br><span class="line">slow_query_log_file =</span><br><span class="line">/home/JumpServer/mysql/logs/slowlog_36215.log</span><br><span class="line"></span><br><span class="line"># TimeOut</span><br><span class="line"></span><br><span class="line">interactive_timeout = 30</span><br><span class="line">wait_timeout = 30</span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br><span class="line">[myisamchk]</span><br><span class="line">key_buffer_size = 256M</span><br><span class="line">sort_buffer_size = 256M</span><br><span class="line">read_buffer = 2M</span><br><span class="line">write_buffer = 2M</span><br><span class="line">[mysqlhotcopy]</span><br><span class="line">interactive-timeout</span><br></pre></td></tr></table></figure>

<h5 id="⑥创建文件夹"><a href="#⑥创建文件夹" class="headerlink" title="⑥创建文件夹"></a>⑥创建文件夹</h5><p>要和上面配置文件当中的对应的文件夹的路径一样，一定要提前创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote mysql-5.7.23]$ mkdir</span><br><span class="line">/home/JumpServer/mysql/mysql-5.7.23/&#123;data,temp,etc&#125;</span><br><span class="line">[JumpServer@op-remote mysql-5.7.23]$ mkdir</span><br><span class="line">/home/JumpServer/mysql/logs</span><br></pre></td></tr></table></figure>

<h5 id="⑦初始化数据库"><a href="#⑦初始化数据库" class="headerlink" title="⑦初始化数据库"></a>⑦初始化数据库</h5><p>初始化数据库， –initialize 表示默认生成一个安全的密码，–initializeinsecure<br>表示不生成密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote mysql-5.7.23]$ mysqld --defaultsfile=/</span><br><span class="line">home/JumpServer/mysql/mysql-5.7.23/etc/my.cnf --</span><br><span class="line">initialize-insecure --user=&apos;JumpServer&apos; --</span><br><span class="line">log_error_verbosity --explicit_defaults_for_timestamp --</span><br><span class="line">basedir=/home/JumpServer/mysql/mysql-5.7.23 --</span><br><span class="line">datadir=/home/JumpServer/mysql/mysql-5.7.23/data</span><br></pre></td></tr></table></figure>

<h5 id="⑧初始化data数据库文件"><a href="#⑧初始化data数据库文件" class="headerlink" title="⑧初始化data数据库文件"></a>⑧初始化data数据库文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote mysql-5.7.23]$ mysql_install_db --</span><br><span class="line">user=JumpServer ./mysql_install_db --user=mysql --</span><br><span class="line">basedir=/home/JumpServer/mysql/mysql-5.7.23 --</span><br><span class="line">datadir=/home/JumpServer/mysql/mysql-5.7.23/data</span><br></pre></td></tr></table></figure>

<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><p>出现错误以后，注意看错误日志，尤其是手动初始化数据库的data文件夹的操<br>作</p>
<h5 id="⑨启动MySQL"><a href="#⑨启动MySQL" class="headerlink" title="⑨启动MySQL"></a>⑨启动MySQL</h5><p>指定配置文件启动，和以前的启动的方法有很大的不同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqld_safe --defaultsfile=/</span><br><span class="line">home/JumpServer/mysql/mysql-5.7.23/etc/my.cnf &amp;</span><br></pre></td></tr></table></figure>

<h5 id="⑩修改密码"><a href="#⑩修改密码" class="headerlink" title="⑩修改密码"></a>⑩修改密码</h5><p>在配置文件当中让skip-grant-tables=1，然后重启MySQL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msyql&gt; update mysql.user set authentication_string =</span><br><span class="line">password(&apos;666666&apos;), password_expired = &apos;N&apos;,</span><br><span class="line">password_last_changed = now() where user = &apos;root&apos;;</span><br></pre></td></tr></table></figure>

<h5 id="6-创建函数并授权"><a href="#6-创建函数并授权" class="headerlink" title="6.创建函数并授权"></a>6.创建函数并授权</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">msyql&gt; create database jumpserver default charset</span><br><span class="line">&apos;utf8&apos;;</span><br><span class="line">mysql&gt; grant all on jumpserver.* to</span><br><span class="line">&apos;jumpserver&apos;@&apos;localhost&apos; identified by &apos;666666&apos;;</span><br><span class="line">mysql&gt; grant all on jumpserver.* to</span><br><span class="line">&apos;jumpserver&apos;@&apos;127.0.0.1&apos; identified by &apos;666666&apos;;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">[JumpServer@op-remote logs]$ mysql -ujumpserver -</span><br><span class="line">p&apos;666666&apos;</span><br></pre></td></tr></table></figure>

<h5 id="注意-1"><a href="#注意-1" class="headerlink" title="注意"></a>注意</h5><p>这里进行授权的时候会有jumpserver’@’localhost’，<br>jumpserver’@’127.0.0.1’的区别，由于可能会出现权限的问题，那么最后就<br>是两个host的用户都创建一次</p>
<h5 id="7-修改-Jumpserver-配置文件"><a href="#7-修改-Jumpserver-配置文件" class="headerlink" title="7.修改 Jumpserver 配置文件"></a>7.修改 Jumpserver 配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote JumpServerPackage]$ cp</span><br><span class="line">config_example.py config.py</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote JumpServerPackage]$ vim config.py</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">jumpserver.config</span><br><span class="line"></span><br><span class="line">Jumpserver project setting file</span><br><span class="line">:copyright: (c) 2014-2017 by Jumpserver Team</span><br><span class="line">:license: GPL v2, see LICENSE for more details.</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">import os</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">class Config:</span><br><span class="line"></span><br><span class="line"># Use it to encrypt or decrypt data</span><br><span class="line"></span><br><span class="line"># SECURITY WARNING: keep the secret key used in</span><br><span class="line"></span><br><span class="line">production secret! 请随意输入随机字符串（推荐字符大于等于 50位</span><br><span class="line">SECRET_KEY = os.environ.get(&apos;SECRET_KEY&apos;) or</span><br><span class="line">&apos;p*O8Il8F1+&amp;#CF1uASm+oi(*dc^sd%Gss\.Sg;/Asu)&amp;H%s.O#CIl1*</span><br><span class="line">33;Pzd&apos;</span><br><span class="line"></span><br><span class="line"># Django security setting, if your disable debug</span><br><span class="line"></span><br><span class="line">model, you should setting that</span><br><span class="line">ALLOWED_HOSTS = [&apos;*&apos;]</span><br><span class="line"></span><br><span class="line"># DEBUG 模式 True为开启 False为关闭，默认开启，生产环境推荐</span><br><span class="line"></span><br><span class="line">关闭</span><br><span class="line"></span><br><span class="line"># 注意：如果设置了DEBUG = False，访问8080端口页面会显示不正</span><br><span class="line"></span><br><span class="line">常，需要搭建 nginx 代理才可以正常访问</span><br><span class="line"></span><br><span class="line"># Development env open this, when error occur</span><br><span class="line"></span><br><span class="line">display the full process track, Production disable it</span><br><span class="line">DEBUG = os.environ.get(&quot;DEBUG&quot;) or False</span><br><span class="line"></span><br><span class="line"># 日志级别，默认为DEBUG，可调整为INFO, WARNING, ERROR,</span><br><span class="line"></span><br><span class="line">CRITICAL，默认INFO</span><br><span class="line"></span><br><span class="line"># DEBUG, INFO, WARNING, ERROR, CRITICAL can set. See</span><br><span class="line"></span><br><span class="line">https://docs.djangoproject.com/en/1.10/topics/logging/</span><br><span class="line">LOG_LEVEL = os.environ.get(&quot;LOG_LEVEL&quot;) or &apos;INFO&apos;</span><br><span class="line">LOG_DIR = os.path.join(BASE_DIR, &apos;logs&apos;)</span><br><span class="line"></span><br><span class="line"># Database setting, Support sqlite3, mysql, postgres</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"># See</span><br><span class="line"></span><br><span class="line">https://docs.djangoproject.com/en/1.10/ref/settings/#dat</span><br><span class="line">abases</span><br><span class="line"></span><br><span class="line"># SQLite setting:</span><br><span class="line"></span><br><span class="line"># DB_ENGINE = &apos;sqlite3&apos;</span><br><span class="line"></span><br><span class="line"># DB_NAME = os.path.join(BASE_DIR, &apos;data&apos;,</span><br><span class="line"></span><br><span class="line">&apos;db.sqlite3&apos;)</span><br><span class="line"></span><br><span class="line"># MySQL or postgres setting like:</span><br><span class="line"></span><br><span class="line">DB_ENGINE = os.environ.get(&quot;DB_ENGINE&quot;) or &apos;mysql&apos;</span><br><span class="line">DB_HOST = os.environ.get(&quot;DB_HOST&quot;) or &apos;localhost&apos;</span><br><span class="line">DB_PORT = os.environ.get(&quot;DB_PORT&quot;) or 3306</span><br><span class="line">DB_USER = os.environ.get(&quot;DB_USER&quot;) or &apos;jumpserver&apos;</span><br><span class="line">DB_PASSWORD = os.environ.get(&quot;DB_PASSWORD&quot;) or</span><br><span class="line">&apos;666666&apos;</span><br><span class="line">DB_NAME = os.environ.get(&quot;DB_NAME&quot;) or &apos;jumpserver&apos;</span><br><span class="line"></span><br><span class="line"># When Django start it will bind this host and port</span><br><span class="line"></span><br><span class="line"># ./manage.py runserver 127.0.0.1:8080</span><br><span class="line"></span><br><span class="line">HTTP_BIND_HOST = &apos;127.0.0.1&apos;</span><br><span class="line">HTTP_LISTEN_PORT = 8080</span><br><span class="line"></span><br><span class="line"># Use Redis as broker for celery and web socket</span><br><span class="line"></span><br><span class="line">REDIS_HOST = os.environ.get(&quot;REDIS_HOST&quot;) or</span><br><span class="line">&apos;127.0.0.1&apos;</span><br><span class="line">REDIS_PORT = os.environ.get(&quot;REDIS_PORT&quot;) or 6379</span><br><span class="line"></span><br><span class="line">REDIS_PASSWORD = os.environ.get(&quot;REDIS_PASSWORD&quot;) or</span><br><span class="line">&apos;&apos;</span><br><span class="line">REDIS_DB_CELERY = os.environ.get(&apos;REDIS_DB&apos;) or 3</span><br><span class="line">REDIS_DB_CACHE = os.environ.get(&apos;REDIS_DB&apos;) or 4</span><br><span class="line">def __init__(self):</span><br><span class="line">pass</span><br><span class="line">def __getattr__(self, item):</span><br><span class="line">return None</span><br><span class="line">class DevelopmentConfig(Config):</span><br><span class="line">pass</span><br><span class="line">class TestConfig(Config):</span><br><span class="line">pass</span><br><span class="line">class ProductionConfig(Config):</span><br><span class="line">pass</span><br><span class="line"></span><br><span class="line"># Default using Config settings, you can write if/else</span><br><span class="line"></span><br><span class="line">for different env</span><br><span class="line">config = DevelopmentConfig()</span><br></pre></td></tr></table></figure>

<h5 id="8-生成数据库表结构和初始化数据"><a href="#8-生成数据库表结构和初始化数据" class="headerlink" title="8.生成数据库表结构和初始化数据"></a>8.生成数据库表结构和初始化数据</h5><p>这里很容易报错，所以我们需要注意前面安装的python的环境，尽量是3.6版<br>本的</p>
<h5 id="9-启动JumpServer"><a href="#9-启动JumpServer" class="headerlink" title="9.启动JumpServer"></a>9.启动JumpServer</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote JumpServerPackage]$ ./jms start</span><br><span class="line">all -d</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cd /opt/jumpserver</span><br><span class="line">$ ./jms start all # 后台运行使用 -d 参数./jms start all -d</span><br><span class="line"></span><br><span class="line"># 新版本更新了运行脚本，使用方式./jms</span><br><span class="line"></span><br><span class="line">start|stop|status|restart all 后台运行请添加 -d 参数</span><br></pre></td></tr></table></figure>

<h4 id="四、安装SSH-Server-和-WebSocket-Server-Coco"><a href="#四、安装SSH-Server-和-WebSocket-Server-Coco" class="headerlink" title="四、安装SSH Server 和 WebSocket Server: Coco"></a>四、安装SSH Server 和 WebSocket Server: Coco</h4><h5 id="1-下载或-Clone-项目-1"><a href="#1-下载或-Clone-项目-1" class="headerlink" title="1.下载或 Clone 项目"></a>1.下载或 Clone 项目</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote ~]$ mkdir Coco</span><br><span class="line">[JumpServer@op-remote ~]$ cd Coco</span><br><span class="line">[JumpServer@op-remote Coco]$ git clone</span><br><span class="line">https://github.com/jumpserver/coco.git &amp;&amp; cd coco &amp;&amp; git</span><br><span class="line">checkout master</span><br></pre></td></tr></table></figure>

<h5 id="2-安装依赖"><a href="#2-安装依赖" class="headerlink" title="2.安装依赖"></a>2.安装依赖</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@op-remote Coco]$ cd coco/requirement</span><br><span class="line">[root@op-remote Coco]$ yum -y install $(cat</span><br><span class="line">rpm_requirements.txt)</span><br><span class="line">[root@op-remote Coco]$ pip3 install -r requirements.txt</span><br></pre></td></tr></table></figure>

<h5 id="3-修改配置文件并运行"><a href="#3-修改配置文件并运行" class="headerlink" title="3.修改配置文件并运行"></a>3.修改配置文件并运行</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote coco]# cp conf_example.py conf.py</span><br><span class="line">[JumpServer@op-remote coco]# vim conf.py</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line"></span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">import os</span><br><span class="line">BASE_DIR = os.path.dirname(__file__)</span><br><span class="line">class Config:</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Coco config file, coco also load config from server</span><br><span class="line">update setting below</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"># 项目名称, 会用来向Jumpserver注册, 识别而已, 不能重复</span><br><span class="line"></span><br><span class="line">NAME = &quot;lepai_coco&quot;</span><br><span class="line"></span><br><span class="line"># Jumpserver项目的url, api请求注册会使用</span><br><span class="line"></span><br><span class="line">CORE_HOST = os.environ.get(&quot;CORE_HOST&quot;) or</span><br><span class="line">&apos;http://127.0.0.1:8080&apos;</span><br><span class="line"></span><br><span class="line"># 启动时绑定的ip, 默认 0.0.0.0</span><br><span class="line"></span><br><span class="line"># BIND_HOST = &apos;0.0.0.0&apos;</span><br><span class="line"></span><br><span class="line"># 监听的SSH端口号, 默认2222</span><br><span class="line"></span><br><span class="line"># SSHD_PORT = 2222</span><br><span class="line"></span><br><span class="line"># 监听的HTTP/WS端口号，默认5000</span><br><span class="line"></span><br><span class="line"># HTTPD_PORT = 5000</span><br><span class="line"></span><br><span class="line"># 项目使用的ACCESS KEY, 默认会注册,并保存到</span><br><span class="line"></span><br><span class="line">ACCESS_KEY_STORE中,</span><br><span class="line"></span><br><span class="line"># 如果有需求, 可以写到配置文件中, 格式</span><br><span class="line"></span><br><span class="line">access_key_id:access_key_secret</span><br><span class="line"></span><br><span class="line"># ACCESS_KEY = None</span><br><span class="line"></span><br><span class="line"># ACCESS KEY 保存的地址, 默认注册后会保存到该文件中</span><br><span class="line"></span><br><span class="line"># ACCESS_KEY_STORE = os.path.join(BASE_DIR, &apos;keys&apos;,</span><br><span class="line"></span><br><span class="line">&apos;.access_key&apos;)</span><br><span class="line"></span><br><span class="line"># 加密密钥</span><br><span class="line"></span><br><span class="line"># SECRET_KEY = None</span><br><span class="line"></span><br><span class="line"># 设置日志级别 [&apos;DEBUG&apos;, &apos;INFO&apos;, &apos;WARN&apos;, &apos;ERROR&apos;,</span><br><span class="line"></span><br><span class="line">&apos;FATAL&apos;, &apos;CRITICAL&apos;]</span><br><span class="line">LOG_LEVEL = &apos;INFO&apos;</span><br><span class="line"></span><br><span class="line"># 日志存放的目录</span><br><span class="line"></span><br><span class="line"># LOG_DIR = os.path.join(BASE_DIR, &apos;logs&apos;)</span><br><span class="line"></span><br><span class="line"># Session录像存放目录</span><br><span class="line"></span><br><span class="line"># SESSION_DIR = os.path.join(BASE_DIR, &apos;sessions&apos;)</span><br><span class="line"></span><br><span class="line"># 资产显示排序方式, [&apos;ip&apos;, &apos;hostname&apos;]</span><br><span class="line"></span><br><span class="line"># ASSET_LIST_SORT_BY = &apos;ip&apos;</span><br><span class="line"></span><br><span class="line"># 登录是否支持密码认证</span><br><span class="line"></span><br><span class="line"># PASSWORD_AUTH = True</span><br><span class="line"></span><br><span class="line"># 登录是否支持秘钥认证</span><br><span class="line"></span><br><span class="line"># PUBLIC_KEY_AUTH = True</span><br><span class="line"></span><br><span class="line"># 和Jumpserver 保持心跳时间间隔</span><br><span class="line"></span><br><span class="line"># HEARTBEAT_INTERVAL = 5</span><br><span class="line"></span><br><span class="line"># Admin的名字，出问题会提示给用户</span><br><span class="line"></span><br><span class="line"># ADMINS = &apos;&apos;</span><br><span class="line"></span><br><span class="line">COMMAND_STORAGE = &#123;</span><br><span class="line">&quot;TYPE&quot;: &quot;server&quot;</span><br><span class="line">&#125;</span><br><span class="line">REPLAY_STORAGE = &#123;</span><br><span class="line">&quot;TYPE&quot;: &quot;server&quot;</span><br><span class="line">&#125;</span><br><span class="line">config = Config()</span><br></pre></td></tr></table></figure>

<h4 id="五、安装-Web-Terminal-前端-Luna"><a href="#五、安装-Web-Terminal-前端-Luna" class="headerlink" title="五、安装 Web Terminal 前端: Luna"></a>五、安装 Web Terminal 前端: Luna</h4><h5 id="1-解压-Luna"><a href="#1-解压-Luna" class="headerlink" title="1.解压 Luna"></a>1.解压 Luna</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[JumpServer@op-remote ~]$ mkdir Luna</span><br><span class="line">[JumpServer@op-remote Luna]$ wget</span><br><span class="line">https://github.com/jumpserver/luna/releases/download/1.4</span><br><span class="line">.0/luna.tar.gz</span><br><span class="line">[JumpServer@op-remote Luna]$ tar xvf luna.tar.gz</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/13/KONG/">
  KONG
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/13/KONG/"><span class="article-date">
  2019-08-13
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/KONG/">KONG</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KONG/">KONG</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="KONG"><a href="#KONG" class="headerlink" title="KONG"></a>KONG</h1><h2 id="一、OpenResty安装"><a href="#一、OpenResty安装" class="headerlink" title="一、OpenResty安装"></a>一、OpenResty安装</h2><h3 id="1-编译环境的部署"><a href="#1-编译环境的部署" class="headerlink" title="1.编译环境的部署"></a>1.编译环境的部署</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[nginx@lp home]#yum install -y gcc gcc-c++ make zlib</span><br><span class="line">zlib-devel pcre pcre-devel libjpeg libjpeg-devel libpng</span><br><span class="line">libpng-devel freetype freetype-devel libxml2 libxml2-</span><br><span class="line">devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-</span><br><span class="line">devel ncurses ncurses-devel curl curl-devel e2fsprogs</span><br><span class="line">e2fsprogs-devel krb5 krb5-devel openssl openssl-devel</span><br><span class="line">openldap openldap-devel nss_ldap openldap-clients</span><br><span class="line">openldap-servers # 编译环境</span><br></pre></td></tr></table></figure>

<h3 id="2-必备插件"><a href="#2-必备插件" class="headerlink" title="2.必备插件"></a>2.必备插件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$ yum install -y readline-devel pcredevel</span><br><span class="line">openssl-devel</span><br><span class="line">[kong@nginx1 ~]$ wget</span><br><span class="line">https://openresty.org/download/openresty-1.13.6.2.tar.gz</span><br><span class="line">[kong@nginx1 ~]$ tar xvf openresty-1.13.6.2.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="3-安装"><a href="#3-安装" class="headerlink" title="3.安装"></a>3.安装</h3><p>到openresty下载安装最新的编译版本，然后进行编译。<br>在这之前需要更改.c文件，把响应头当中的nginx的版本号隐藏，这个是必须<br>的！！！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 openresty-1.13.6.2]$ vim ./bundle/nginx-</span><br><span class="line">1.13.6/src/http/ngx_http_header_filter_module.c</span><br><span class="line">static u_char ngx_http_server_string[] = &quot;Server:</span><br><span class="line">opresty &quot; CRLF;</span><br><span class="line">static u_char ngx_http_server_full_string[] = &quot;Server &quot;</span><br><span class="line">NGINX_VER CRLF;</span><br><span class="line">static u_char ngx_http_server_build_string[] = &quot;Server &quot;</span><br><span class="line">NGINX_VER_BUILD CRLF;</span><br><span class="line"></span><br><span class="line"># 更改成下面那样！！！然后再编译</span><br><span class="line"></span><br><span class="line">static u_char ngx_http_server_string[] = &quot;Server: Egaga-</span><br><span class="line">Web&quot; CRLF;</span><br><span class="line">static u_char ngx_http_server_full_string[] = &quot;Server:</span><br><span class="line">Egaga-Web&quot; NGINX_VER CRLF;</span><br><span class="line">static u_char ngx_http_server_build_string[] = &quot;Server:</span><br><span class="line">Egaga-Web&quot; NGINX_VER_BUILD CRLF;</span><br></pre></td></tr></table></figure>

<p>更改404版本的信息，只需要在nginx.conf当中配置server_tokens off;</p>
<h4 id="开始编译"><a href="#开始编译" class="headerlink" title="开始编译"></a>开始编译</h4><p>我在网站当中把这个下载下来了，然后进入到openresty,这里面有很多</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">文件，其中进入bundle,然后下载必要的模块，然后添加到当中</span><br><span class="line">[kong@nginx1 ~]$ cd nginx/openresty-1.13.6.1/</span><br><span class="line">[kong@nginx1 openresty-1.13.6.2]$ ls</span><br><span class="line">build bundle configure COPYRIGHT Makefile patches</span><br><span class="line">README.markdown README-win32.txt util</span><br><span class="line">[kong@nginx1 openresty-1.13.6.2]$ cd bundle/</span><br><span class="line">[kong@nginx1 bundle]$wget</span><br><span class="line">http://labs.frickle.com/files/ngx_cache_purge-2.3.tar.gz</span><br><span class="line">[kong@nginx1 bundle]$ tar -zxvf ngx_cache_purge-</span><br><span class="line">2.3.tar.gz</span><br><span class="line">[kong@nginx1 bundle]$ wget</span><br><span class="line">https://github.com/yaoweibin/nginx_upstream_check_module</span><br><span class="line">/archive/v0.3.0.tar.gz</span><br><span class="line">[kong@nginx1 bundle]$ tar -zxvf v0.3.0.tar.gz</span><br><span class="line">[kong@nginx1 bundle]$ wget</span><br><span class="line">https://codeload.github.com/weibocom/nginx-upsyncmodule/</span><br><span class="line">zip/master</span><br><span class="line">[kong@nginx1 bundle]$ mv master nginx-upsync-modulemaster.</span><br><span class="line">zip</span><br><span class="line">[kong@nginx1 bundle]$ unzip nginx-upsync-modulemaster.</span><br><span class="line">zip</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 bundle]$ wget</span><br><span class="line">https://codeload.github.com/gnosek/nginx-upstreamfair/</span><br><span class="line">zip/master</span><br><span class="line">[kong@nginx1 bundle]$ mv master nginx-upstream-fairmaster.</span><br><span class="line">zip</span><br><span class="line">[kong@nginx1 bundle]$ unzip nginx-upstream-fairmaster.</span><br><span class="line">zip</span><br><span class="line">[kong@nginx1 bundle]$ vim nginx-upstream-fair-master</span><br><span class="line">[kong@nginx1 bundle]$ vim nginx-upstream-fairmaster/</span><br><span class="line">ngx_http_upstream_fair_module.c</span><br><span class="line"></span><br><span class="line"># 注意安装之前，需要更改配置，把其中的一段配置更改为后面的配置，才</span><br><span class="line"></span><br><span class="line">可以顺利编译！！！</span><br><span class="line"></span><br><span class="line"># 更改前：</span><br><span class="line"></span><br><span class="line">if (us-&gt;port == 0 &amp;&amp; us-&gt;default_port == 0) &#123;</span><br><span class="line">ngx_log_error(NGX_LOG_EMERG, cf-&gt;log, 0,</span><br><span class="line">&quot;no port in upstream \&quot;%V\&quot; in</span><br><span class="line">%s:%ui&quot;,</span><br><span class="line">&amp;us-&gt;host, us-&gt;file_name, us-</span><br><span class="line"></span><br><span class="line">&gt; line);</span><br><span class="line">&gt; return NGX_ERROR;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; ngx_memzero(&amp;u, sizeof(ngx_url_t));</span><br><span class="line">&gt; u.host = us-&gt;host;</span><br><span class="line">&gt; u.port = (in_port_t) (us-&gt;port ? us-&gt;port : us-</span><br><span class="line">&gt; default_port);</span><br><span class="line"></span><br><span class="line"># 更改后：</span><br><span class="line"></span><br><span class="line">if (us-&gt;port == 0) &#123;</span><br><span class="line">ngx_log_error(NGX_LOG_EMERG, cf-&gt;log, 0,</span><br><span class="line">&quot;no port in upstream \&quot;%V\&quot; in</span><br><span class="line">%s:%ui&quot;,</span><br><span class="line">&amp;us-&gt;host, us-&gt;file_name, us-</span><br><span class="line"></span><br><span class="line">&gt; line);</span><br><span class="line">&gt; return NGX_ERROR;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; ngx_memzero(&amp;u, sizeof(ngx_url_t));</span><br><span class="line">&gt; u.host = us-&gt;host;</span><br><span class="line">&gt; u.port = us-&gt;port;</span><br><span class="line">&gt; [nginx@lp bundle]# cd ..</span><br><span class="line"></span><br><span class="line"># 编译策略①</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 openresty-1.13.6.2]$ ./configure --</span><br><span class="line">prefix=/home/kong/openresty/openresty_1.13.6.2 --withluajit</span><br><span class="line">--with-http_ssl_module --user=nginx --group=nginx</span><br><span class="line">--with-http_realip_module --with-threads --withhttp_</span><br><span class="line">auth_request_module --with-stream --withstream_</span><br><span class="line">ssl_module --with-stream_realip_module --withpcre</span><br><span class="line">--with-pcre-jit --with-http_stub_status_module -</span><br><span class="line">-add-module=./bundle/ngx_cache_purge-2.3/ --addmodule=./</span><br><span class="line">bundle/nginx_upstream_check_module-0.3.0/ --</span><br><span class="line">add-module=./bundle/nginx-upstream-fair-master --addmodule=./</span><br><span class="line">bundle/nginx-upsync-module-master &amp;&amp; make &amp;&amp;</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h6 id="注意：软件的安装路径一定是提前设定好的，不能再编译安装好了以后，改变"><a href="#注意：软件的安装路径一定是提前设定好的，不能再编译安装好了以后，改变" class="headerlink" title="注意：软件的安装路径一定是提前设定好的，不能再编译安装好了以后，改变"></a>注意：软件的安装路径一定是提前设定好的，不能再编译安装好了以后，改变</h6><h6 id="文件的位置，比如放在更底下的子目录，会导致Nginx无法启动"><a href="#文件的位置，比如放在更底下的子目录，会导致Nginx无法启动" class="headerlink" title="文件的位置，比如放在更底下的子目录，会导致Nginx无法启动"></a>文件的位置，比如放在更底下的子目录，会导致Nginx无法启动</h6><h2 id="二、安装包管理工具"><a href="#二、安装包管理工具" class="headerlink" title="二、安装包管理工具"></a>二、安装包管理工具</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$ wget</span><br><span class="line">https://luarocks.org/releases/luarocks-3.0.4.tar.gz</span><br><span class="line">[kong@nginx1 ~]$ tar xvf luarocks-3.0.4.tar.gz</span><br><span class="line">[kong@nginx1 ~]$ cd luarocks-3.0.4/</span><br><span class="line">[kong@nginx1 ~]$ ./configure --</span><br><span class="line">prefix=/home/kong/luarocks &amp;&amp; make &amp;&amp; make install</span><br><span class="line">[kong@nginx1 ~]$ vim .bash_profile</span><br><span class="line">PATH=$PATH:/home/kong/luarocks/bin</span><br><span class="line">[kong@nginx1 ~]$ source .bash_profile</span><br></pre></td></tr></table></figure>

<h2 id="三、安装KONG"><a href="#三、安装KONG" class="headerlink" title="三、安装KONG"></a>三、安装KONG</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$ wget</span><br><span class="line">https://codeload.github.com/Kong/kong/zip/master</span><br><span class="line">[kong@nginx1 ~]$ mv master kong-master.zip</span><br><span class="line">[kong@nginx1 ~]$ unzip kong-master.zip</span><br><span class="line">[kong@nginx1 ~]$ vim .bash_profile</span><br><span class="line">PATH=$PATH:/home/kong/kong-master/bin</span><br></pre></td></tr></table></figure>

<h2 id="四、安装数据库postgresql"><a href="#四、安装数据库postgresql" class="headerlink" title="四、安装数据库postgresql"></a>四、安装数据库postgresql</h2><h3 id="1-编译安装"><a href="#1-编译安装" class="headerlink" title="1.编译安装"></a>1.编译安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$</span><br><span class="line">https://ftp.postgresql.org/pub/source/v11.0/postgresql-</span><br><span class="line">11.0.tar.gz</span><br><span class="line">[kong@nginx1 ~]$ tar xvf postgresql-11.0.tar.gz</span><br><span class="line">[kong@nginx1 ~]$ cd postgresql-11.0/</span><br><span class="line">[kong@nginx1 ~]$ ./configure --</span><br><span class="line">prefix=/home/kong/postgresql/pgsql11.0 --withpgport=</span><br><span class="line">5432 --with-perl --with-python --with-tcl --withopenssl</span><br><span class="line">--with-pam --without-ldap --with-libxml --</span><br><span class="line">with-libxslt --enable-thread-safety --with-walblocksize=</span><br><span class="line">16 --with-blocksize=16 --enable-dtrace --</span><br><span class="line">enable-debug</span><br></pre></td></tr></table></figure>

<h3 id="2-安装systemtap插件"><a href="#2-安装systemtap插件" class="headerlink" title="2.安装systemtap插件"></a>2.安装systemtap插件</h3><p>[root@nginx1 ~]# yum install systemtap systemtap-sdtdevel<br>[root@nginx1 ~]# yum update -y kernel<br>[root@nginx1 ~]# yum install -y kernel.x86_64 kerneldevel.<br>x86_64</p>
<h1 id="检验是否成功"><a href="#检验是否成功" class="headerlink" title="检验是否成功"></a>检验是否成功</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx1 ~]# stap -ve &apos;probe begin &#123; log(&quot;hello</span><br><span class="line">world&quot;) exit() &#125;&apos;</span><br><span class="line">Pass 1: parsed user script and 473 library scripts using</span><br><span class="line">240244virt/42156res/3428shr/38788data kb, in</span><br><span class="line">150usr/160sys/369real ms.</span><br><span class="line">Pass 2: analyzed script: 1 probe, 2 functions, 0 embeds,</span><br><span class="line">0 globals using 241168virt/43204res/3596shr/39712data</span><br><span class="line">kb, in 0usr/0sys/4real ms.</span><br><span class="line">Pass 3: translated to C into</span><br><span class="line">&quot;/tmp/stapIsCD4v/stap_852a2c38932b1a2bc2f953ac41c15db2_1</span><br><span class="line">139_src.c&quot; using 241168virt/43812res/4176shr/39712data</span><br><span class="line">kb, in 0usr/0sys/0real ms.</span><br><span class="line">Pass 4: compiled C into</span><br><span class="line">&quot;stap_852a2c38932b1a2bc2f953ac41c15db2_1139.ko&quot; in</span><br><span class="line">5760usr/1600sys/7781real ms.</span><br><span class="line">Pass 5: starting run.</span><br><span class="line">hello world</span><br><span class="line">Pass 5: run completed in 10usr/30sys/314real ms.</span><br></pre></td></tr></table></figure>

<h3 id="3-其他常见问题解决方式"><a href="#3-其他常见问题解决方式" class="headerlink" title="3.其他常见问题解决方式"></a>3.其他常见问题解决方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx1 ~]# yum -y install perl-ExtUtils-Embed</span><br><span class="line">readline readline-devel zlib zlib-devel openssl</span><br><span class="line">openssl-devel pam pam-devel libxml2 libxml2-devel</span><br><span class="line">libxslt libxslt-devel tcl tcl-devel openldap openldapdevel</span><br><span class="line">python python-devel gcc-c++</span><br></pre></td></tr></table></figure>

<h3 id="4-开始编译"><a href="#4-开始编译" class="headerlink" title="4.开始编译"></a>4.开始编译</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 postgresql-11.0]$ gmake world &amp;&amp; gmake</span><br><span class="line">install-world</span><br></pre></td></tr></table></figure>

<h3 id="5-添加环境变量"><a href="#5-添加环境变量" class="headerlink" title="5.添加环境变量"></a>5.添加环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$ vim .bash_profile</span><br><span class="line"></span><br><span class="line"># add PG env</span><br><span class="line"></span><br><span class="line">export PGHOME=/home/kong/postgresql/pgsql11.0</span><br><span class="line">export PGDATA=/home/kong/postgresql/db/pgdata</span><br><span class="line">export PATH=$PGHOME/bin:$PATH</span><br><span class="line">export MANPATH=$PGHOME/share/man:$MANPATH</span><br><span class="line">export LANG=en_US.utf8</span><br><span class="line">export DATE=`date +&quot;%Y-%m-%d %H:%M:%S&quot;`</span><br><span class="line">export LD_LIBRARY_PATH=$PGHOME/lib:$LD_LIBRARY_PATH</span><br><span class="line">alias rm=&apos;rm -i&apos;</span><br><span class="line">alias ll=&apos;ls -lh&apos;</span><br><span class="line">#alias pg_start=&apos;pg_ctl start -D $PGDATA&apos;</span><br><span class="line">#alias pg_stop=&apos;pg_ctl stop -D $PGDATA -m fast&apos;</span><br><span class="line">#psql -h 主机名 -p 端口号 -U 用户名 -W(强制口令提示) [-d]数据</span><br><span class="line">库名</span><br><span class="line">#psql -h $GHOST -p $PGPORT -U $PGUSER -W -d $PGDATABASE</span><br><span class="line">#PGHOST 设置数据库服务器名。 如果它以一个斜杠开头，那么它声明一个</span><br><span class="line">Unix 域套接字而不是 TCP/IP 通讯； 其值就是该套接字文件存储的目录</span><br><span class="line">（在缺省安装中，这个目录会是 /tmp）</span><br><span class="line">#export PGHOST=$PGDATA</span><br><span class="line">export PGHOST=localhost</span><br><span class="line">#PGPORT 设置 TCP 端口号或者设置与 PostgreSQL 通讯的 Unix 域套</span><br><span class="line">接字的文件扩展。</span><br><span class="line">export PGPORT=5432</span><br><span class="line">export PGUSER=kong #用于与数据库连接的用户名，initdb -U</span><br><span class="line">posgtres指定</span><br><span class="line">#export PGDATABASE=demo#数据库名</span><br><span class="line">[kong@nginx1 ~]$ source .bash_profile</span><br><span class="line"></span><br><span class="line"># 记得创建相关文件夹</span><br></pre></td></tr></table></figure>

<h3 id="6-检验数据库版本"><a href="#6-检验数据库版本" class="headerlink" title="6.检验数据库版本"></a>6.检验数据库版本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$ psql -V</span><br><span class="line">psql (PostgreSQL) 11.0</span><br></pre></td></tr></table></figure>

<h3 id="7-初始化数据库"><a href="#7-初始化数据库" class="headerlink" title="7.初始化数据库"></a>7.初始化数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$ initdb -D $PGDATA -E UTF8 --locale=C -U</span><br><span class="line">postgres -W</span><br><span class="line">The files belonging to this database system will be</span><br><span class="line">owned by user &quot;kong&quot;.</span><br><span class="line">This user must also own the server process.</span><br><span class="line">The database cluster will be initialized with locale</span><br><span class="line">&quot;C&quot;.</span><br><span class="line">The default text search configuration will be set to</span><br><span class="line">&quot;english&quot;.</span><br><span class="line">Data page checksums are disabled.</span><br><span class="line">Enter new superuser password:</span><br><span class="line">Enter it again:</span><br><span class="line">creating directory /home/kong/db/pgdata ... ok</span><br><span class="line">creating subdirectories ... ok</span><br><span class="line">selecting default max_connections ... 100</span><br><span class="line">selecting default shared_buffers ... 128MB</span><br><span class="line">selecting dynamic shared memory implementation ... posix</span><br><span class="line">creating configuration files ... ok</span><br><span class="line">running bootstrap script ... ok</span><br><span class="line">performing post-bootstrap initialization ... ok</span><br><span class="line">syncing data to disk ... ok</span><br><span class="line">WARNING: enabling &quot;trust&quot; authentication for local</span><br><span class="line">connections</span><br><span class="line">You can change this by editing pg_hba.conf or using the</span><br><span class="line">option -A, or</span><br><span class="line">--auth-local and --auth-host, the next time you run</span><br><span class="line">initdb.</span><br><span class="line">Success. You can now start the database server using:</span><br><span class="line">pg_ctl -D /home/kong/db/pgdata -l logfile start</span><br></pre></td></tr></table></figure>

<h3 id="8-启动数据库"><a href="#8-启动数据库" class="headerlink" title="8.启动数据库"></a>8.启动数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$ pg_ctl start -D $PGDATA -l pgsql.log</span><br><span class="line">waiting for server to start.... done</span><br><span class="line">server started</span><br></pre></td></tr></table></figure>

<h3 id="9-检查启动后的数据库"><a href="#9-检查启动后的数据库" class="headerlink" title="9.检查启动后的数据库"></a>9.检查启动后的数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$ pg_ctl status</span><br><span class="line">pg_ctl: server is running (PID: 12446)</span><br><span class="line">/home/kong/postgresql/pgsql11.0/bin/postgres</span><br><span class="line">[kong@nginx1 ~]$ pg_ctl stop</span><br><span class="line">waiting for server to shut down.... done</span><br><span class="line">server stopped</span><br></pre></td></tr></table></figure>

<h2 id="五、启动KONG"><a href="#五、启动KONG" class="headerlink" title="五、启动KONG"></a>五、启动KONG</h2><h3 id="1-添加OpenResty的环境变量"><a href="#1-添加OpenResty的环境变量" class="headerlink" title="1.添加OpenResty的环境变量"></a>1.添加OpenResty的环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[kong@nginx1 ~]$ vim .bash_profile</span><br><span class="line">PATH=$PATH:/home/kong/openresty/openresty_1.13.6.2/bin/</span><br><span class="line">[kong@nginx1 ~]$ source .bash_profile</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/13/Nginx抢购限流配置实现解析/">
  Nginx
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/13/Nginx抢购限流配置实现解析/"><span class="article-date">
  2019-08-13
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/Nginx/">Nginx</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Filebeat/">Filebeat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="Nginx抢购限流配置实现解析"><a href="#Nginx抢购限流配置实现解析" class="headerlink" title="Nginx抢购限流配置实现解析"></a>Nginx抢购限流配置实现解析</h1><p>因业务需求经常会有抢购业务，因此需要在负载均衡前端进行限流错误。本文同样也适用于防止CC.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">limit_req_zone $server_name zone=sname:10m rate=1r/s;        #限制服务器每秒只能有一次访问成功</span><br><span class="line">    #limit_req_zone $binary_remote_addr zone=one:3m rate=1r/s;    #限制IP，每秒只能访问一次</span><br><span class="line">    #limit_req_zone $binary_remote_addr $uri zone=two:3m rate=1r/s;  #限制IP和路径不带参数，</span><br><span class="line">    #limit_req_zone $binary_remote_addr $request_uri zone=thre:3m rate=1r/s;  #限制IP和带参数的路径 </span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">    listen    80;</span><br><span class="line">    server_name www.abc.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        include host/proxy.cnf;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">    location /api/createOrder &#123;</span><br><span class="line">        limit_req zone=sname;  #不带突发，只能有一次正常请求</span><br><span class="line">        limit_req_status 503;    #设置返回的状态码是503</span><br><span class="line">        #limit_req zone=sname burst=5 nodelay;  #最大并发是5，并且实时处理</span><br><span class="line">        include host/proxy.cnf;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">        error_page 503 =200 /50x.html;   #这里很重要，可以将错误的状态码503，返回结果的时候是200</span><br><span class="line">    &#125;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        if ($http_user_agent ~* &quot;mobile|android|iPhone|iphone|ios|iOS&quot;)&#123;</span><br><span class="line">            #default_type application/json;</span><br><span class="line">            return 200 &apos;&#123;&quot;msg&quot;: &quot;活动过于火爆，请稍后重试!&quot;,&quot;data&quot;: &#123;&#125;,&quot;code&quot;: -1&#125;&apos;;  #设置移动端返回错误的信息显示</span><br><span class="line">        &#125;</span><br><span class="line">        root  html;   #如果是PC端返回一个HTML页面</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>重点: 正常情况下，如果设置了限流，返回是503的状态码，这对于移动端来说即便是你返回JSON数据但是客户端时不认的，这个时候巧妙的通过 error_page 403 =200 /50x.html;将状态码设置为200</p>
<p>以上只是使用了ngx_limit_req_module,同时也可以使用ngx_limit_conn_module模块。</p>
<p>特别是一些咨询类网站如果备爬虫盯上，服务器可能会被爬虫给干死(小网站就是这样)<br>那么怎么办呢，我们可以使用变量去做</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#全局配置</span><br><span class="line">limit_req_zone $spider zone=spider:60m rate=200r/m;  #限制爬虫每分钟只能跑200次</span><br><span class="line">#某个server中</span><br><span class="line">limit_req zone=spider burst=5 nodelay;</span><br><span class="line">if ($http_user_agent ~* “spider|bot”) &#123;</span><br><span class="line">  set $spider $http_user_agent;   #设置变量，进入这里的就进行限速</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/13/Python一键安装全部依赖包的方法/">
  Python
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/13/Python一键安装全部依赖包的方法/"><span class="article-date">
  2019-08-13
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/python/">python</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="Python一键安装全部依赖包的方法"><a href="#Python一键安装全部依赖包的方法" class="headerlink" title="Python一键安装全部依赖包的方法"></a>Python一键安装全部依赖包的方法</h1><p>requirements.txt用来记录项目所有的依赖包和版本号，只需要一个简单的pip命令就能完成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip freeze &gt;requirements.txt</span><br></pre></td></tr></table></figure>

<p>然后就可以用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>来一次性安装requirements.txt里面所有的依赖包，真是非常方便。</p>
<p>但是我最近发现了一个全新的Python包管理器，叫做pipenv，集合了所有编程语言的包管理器的优点，是kennethreitz大神的一个周末项目。它的工作方式就像Node.js里的npm或者yarn，很容易就解决Python2/3混合使用产生的版本问题。</p>
<p>首先用pip install pipenv来安装它，然后在你的项目的根目录下面运行pipenv –three来生成Python3的虚拟环境，或者pipenv –two生成Python2环境。</p>
<p>这样pipenv会在这个项目里创建一个pipfile的文件，就像package.json一样，里面记录了项目所有的依赖包版本信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[[source]]</span><br><span class="line"></span><br><span class="line">url = &quot;https://pypi.python.org/simple&quot;</span><br><span class="line">verify_ssl = true</span><br><span class="line">name = &quot;pypi&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[packages]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[dev-packages]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[requires]</span><br><span class="line"></span><br><span class="line">python_version = &quot;3.6&quot;</span><br></pre></td></tr></table></figure>

<p>要运行pipenv shell进入虚拟环境，可以输入exit退出。pipenv install可以一键安装所有依赖包，还会生成pipfile.lock文件，里面记录了这次安装时的依赖包。</p>
<p>在pipenv install后面加上包名称，比如pipenv install flask可以安装Flask到生产环境，再加参数，比如pipenv install flask –dev就会安装到开发环境。</p>
<p>类似地，把上面的install改成uninstall就会卸载依赖包，pipenv uninstall –all可以卸载项目下所有的包。就是这么用的，更多的命令请查看<strong>pipenv官网</strong>。</p>

        
      </div>
    </div>

  

  
  
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2019/08/13/Python判断变量是否为Json格式的字符串示例/">
  Python
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2019/08/13/Python判断变量是否为Json格式的字符串示例/"><span class="article-date">
  2019-08-13
</span>
</a>
        
	<span class="article-category tagcloud">
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/">centos</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/centos/python/">python</a></li></ul></li></ul>
	</span>


        
	<span class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>
	</span>


      </div>
      <div class="article-entry">
        
          <h1 id="Python判断变量是否为Json格式的字符串示例"><a href="#Python判断变量是否为Json格式的字符串示例" class="headerlink" title="Python判断变量是否为Json格式的字符串示例"></a>Python判断变量是否为Json格式的字符串示例</h1><p>给大家介绍了利用Python判断变量是否为Json格式的字符串的相关资料，文中给出了详细的示例代码供大家参考学习，需要的朋友们下面来一起看看吧。</p>
<p><strong>Json介绍</strong></p>
<p>全名JavaScript Object Notation，是一种轻量级的数据交换格式。Json最广泛的应用是作为AJAX中web服务器和客户端的通讯的数据格式。现在也常用于http请求中，所以对json的各种学习，是自然而然的事情。</p>
<p>本文主要介绍的是利用Python判断变量是否为Json格式的字符串，对大家日常学习工作具有一定的参考价值，下面话不多说，直接来看代码吧。</p>
<p><strong>示例代码如下</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding=utf-8 -*-</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">def check_json_format(raw_msg):</span><br><span class="line"> &quot;&quot;&quot;</span><br><span class="line"> 用于判断一个字符串是否符合Json格式</span><br><span class="line"> :param self:</span><br><span class="line"> :return:</span><br><span class="line"> &quot;&quot;&quot;</span><br><span class="line"> if isinstance(raw_msg, str):  # 首先判断变量是否为字符串</span><br><span class="line">  try:</span><br><span class="line">   json.loads(raw_msg, encoding=&apos;utf-8&apos;)</span><br><span class="line">  except ValueError:</span><br><span class="line">   return False</span><br><span class="line">  return True</span><br><span class="line"> else:</span><br><span class="line">  return False</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line"> print check_json_format(&quot;&quot;&quot;&#123;&quot;a&quot;:1&#125;&quot;&quot;&quot;)</span><br><span class="line"> print check_json_format(&quot;&quot;&quot;&#123;&apos;a&apos;:1&#125;&quot;&quot;&quot;)</span><br><span class="line"> print check_json_format(&#123;&apos;a&apos;: 1&#125;)</span><br><span class="line"> print check_json_format(100)</span><br></pre></td></tr></table></figure>

<p>首先判断变量是否为字符串，否则如果输入为int或这其他类型，会发生错误。 </p>
<p><strong>上述程序的输出为：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">True</span><br><span class="line">False</span><br><span class="line">False</span><br><span class="line">False</span><br></pre></td></tr></table></figure>

<p><strong>总结</strong></p>
<p>以上就是这篇文章的全部内容了，希望本文的内容对大家的学习或者工作能带来一定的帮助，如果有疑问大家可以留言交流.</p>

        
      </div>
    </div>

  



  <div class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/archives/page/2/">2</a><a class="page-number" href="/archives/page/3/">3</a><a class="extend next" rel="next" href="/archives/page/2/">Next</a>
  </div>




          <div class="main-footer">
  
    © 2020 bibi - Powered by <a href="http://hexo.io" target="_blank">Hexo</a> - Theme <a href="https://github.com/denjones/hexo-theme-chan" target="_blank">Chan</a>
  
</div>

      
        </div>
      
    </section></div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

</div></body>
</html>
